<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>强网杯 2025 WEB Writeup | w8nn9z Blog</title>
<meta name="keywords" content="">
<meta name="description" content="强网杯 2025 WEB Writeup - w8nn9z Blog">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/ctf/qwb-2025-web-writeup/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css" integrity="sha256-EqVinQvl&#43;IX9lG13JX5V90An7So1FEop4tsT&#43;PYrXzU=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/ctf/qwb-2025-web-writeup/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/search" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      强网杯 2025 WEB Writeup
    </h1>
    <div class="post-meta"><span title='2025-10-22 00:00:00 +0000 UTC'>October 22, 2025</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details >
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#secretvault" aria-label="SecretVault">SecretVault</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="secretvault">SecretVault<a hidden class="anchor" aria-hidden="true" href="#secretvault">#</a></h2>
<p>反向代理 authorizer main.go：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;crypto/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;encoding/hex&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http/httputil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/golang-jwt/jwt/v5&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SecretKey</span> = <span style="color:#a6e22e">hex</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">RandomBytes</span>(<span style="color:#ae81ff">32</span>))
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AuthClaims</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">RegisteredClaims</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">UID</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;uid&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RandomBytes</span>(<span style="color:#a6e22e">length</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">length</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SignToken</span>(<span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewWithClaims</span>(<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">SigningMethodHS256</span>, <span style="color:#a6e22e">AuthClaims</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">UID</span>: <span style="color:#a6e22e">uid</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RegisteredClaims</span>: <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">RegisteredClaims</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Issuer</span>:    <span style="color:#e6db74">&#34;Authorizer&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Subject</span>:   <span style="color:#a6e22e">uid</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ExpiresAt</span>: <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewNumericDate</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span>)),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">IssuedAt</span>:  <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewNumericDate</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">NotBefore</span>: <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewNumericDate</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tokenString</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">SignedString</span>([]byte(<span style="color:#a6e22e">SecretKey</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tokenString</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUIDFromRequest</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">authHeader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">authHeader</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cookie</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Cookie</span>(<span style="color:#e6db74">&#34;token&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">authHeader</span> = <span style="color:#e6db74">&#34;Bearer &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">cookie</span>.<span style="color:#a6e22e">Value</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">authHeader</span>) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">authHeader</span>, <span style="color:#e6db74">&#34;Bearer &#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tokenString</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(<span style="color:#a6e22e">authHeader</span>[<span style="color:#ae81ff">7</span>:])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tokenString</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseWithClaims</span>(<span style="color:#a6e22e">tokenString</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">AuthClaims</span>{}, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">token</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">Token</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Method</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">SigningMethodHMAC</span>); !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unexpected signing method: %v&#34;</span>, <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Header</span>[<span style="color:#e6db74">&#34;alg&#34;</span>])
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> []byte(<span style="color:#a6e22e">SecretKey</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;failed to parse token: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">claims</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Claims</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">AuthClaims</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Valid</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;invalid token claims&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">UID</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">authorizer</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ReverseProxy</span>{<span style="color:#a6e22e">Director</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Scheme</span> = <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Host</span> = <span style="color:#e6db74">&#34;127.0.0.1:5000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">uid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUIDFromRequest</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Request UID: %s, URL: %s&#34;</span>, <span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;X-User&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;X-Forwarded-For&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;Cookie&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;X-User&#34;</span>, <span style="color:#e6db74">&#34;anonymous&#34;</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;X-User&#34;</span>, <span style="color:#a6e22e">uid</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signRouter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">NewRouter</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signRouter</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/sign&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RemoteAddr</span>, <span style="color:#e6db74">&#34;127.0.0.1:&#34;</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Forbidden&#34;</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusForbidden</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">uid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Query</span>().<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;uid&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">SignToken</span>(<span style="color:#a6e22e">uid</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Failed to sign token: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Failed to generate token&#34;</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#a6e22e">token</span>))
</span></span><span style="display:flex;"><span>	}).<span style="color:#a6e22e">Methods</span>(<span style="color:#e6db74">&#34;GET&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Sign service is running at 127.0.0.1:4444&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;127.0.0.1:4444&#34;</span>, <span style="color:#a6e22e">signRouter</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Authorizer middleware service is running at :5555&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:5555&#34;</span>, <span style="color:#a6e22e">authorizer</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>web服务 vault python app.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> secrets
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> cryptography.fernet <span style="color:#f92672">import</span> Fernet
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    Flask,
</span></span><span style="display:flex;"><span>    flash,
</span></span><span style="display:flex;"><span>    g,
</span></span><span style="display:flex;"><span>    jsonify,
</span></span><span style="display:flex;"><span>    make_response,
</span></span><span style="display:flex;"><span>    redirect,
</span></span><span style="display:flex;"><span>    render_template,
</span></span><span style="display:flex;"><span>    request,
</span></span><span style="display:flex;"><span>    url_for,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_sqlalchemy <span style="color:#f92672">import</span> SQLAlchemy
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.exc <span style="color:#f92672">import</span> IntegrityError
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span> SQLAlchemy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>), unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    password_hash <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">128</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    salt <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">64</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    created_at <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>DateTime, default<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    vault_entries <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>relationship(<span style="color:#e6db74">&#39;VaultEntry&#39;</span>, backref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;user&#39;</span>, lazy<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, cascade<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;all, delete-orphan&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VaultEntry</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;user.id&#39;</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    label <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">120</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    login <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">120</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    password_encrypted <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Text, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    notes <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Text)
</span></span><span style="display:flex;"><span>    created_at <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>DateTime, default<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hash_password</span>(password: str, salt: bytes) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> salt <span style="color:#f92672">+</span> password<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">50</span>):
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha256(data)<span style="color:#f92672">.</span>digest()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>b64encode(data)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_password</span>(password: str, salt_b64: str, digest: str) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    salt <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(salt_b64<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hash_password(password, salt) <span style="color:#f92672">==</span> digest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_salt</span>() <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> secrets<span style="color:#f92672">.</span>token_bytes(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_app</span>() <span style="color:#f92672">-&gt;</span> Flask:
</span></span><span style="display:flex;"><span>    app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> secrets<span style="color:#f92672">.</span>token_hex(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;DATABASE_URL&#39;</span>, <span style="color:#e6db74">&#39;sqlite:///vault.db&#39;</span>)
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SIGN_SERVER&#39;</span>] <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;SIGN_SERVER&#39;</span>, <span style="color:#e6db74">&#39;http://127.0.0.1:4444/sign&#39;</span>)
</span></span><span style="display:flex;"><span>    fernet_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;FERNET_KEY&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> fernet_key:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74">&#39;Missing FERNET_KEY environment variable. Generate one with `python -c &#34;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&#34;`.&#39;</span>)
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;FERNET_KEY&#39;</span>] <span style="color:#f92672">=</span> fernet_key
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>init_app(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fernet <span style="color:#f92672">=</span> Fernet(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;FERNET_KEY&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> app<span style="color:#f92672">.</span>app_context():
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>create_all()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>first():
</span></span><span style="display:flex;"><span>            salt <span style="color:#f92672">=</span> secrets<span style="color:#f92672">.</span>token_bytes(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>            password <span style="color:#f92672">=</span> secrets<span style="color:#f92672">.</span>token_bytes(<span style="color:#ae81ff">32</span>)<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>            password_hash <span style="color:#f92672">=</span> hash_password(password, salt)
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>                id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;admin&#39;</span>,
</span></span><span style="display:flex;"><span>                password_hash<span style="color:#f92672">=</span>password_hash,
</span></span><span style="display:flex;"><span>                salt<span style="color:#f92672">=</span>base64<span style="color:#f92672">.</span>b64encode(salt)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(user)
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            flag <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;/flag&#39;</span>)<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            flagEntry <span style="color:#f92672">=</span> VaultEntry(
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;flag&#39;</span>,
</span></span><span style="display:flex;"><span>                login<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;flag&#39;</span>,
</span></span><span style="display:flex;"><span>                password_encrypted<span style="color:#f92672">=</span>fernet<span style="color:#f92672">.</span>encrypt(flag<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>),
</span></span><span style="display:flex;"><span>                notes<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;This is the flag entry.&#39;</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(flagEntry)
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_required</span>(view_func):
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@wraps</span>(view_func)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapped</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>            uid <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;X-User&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>            print(uid)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> uid <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;anonymous&#39;</span>:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Please sign in first.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                uid_int <span style="color:#f92672">=</span> int(uid)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">TypeError</span>, <span style="color:#a6e22e">ValueError</span>):
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Invalid session. Please sign in again.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(id<span style="color:#f92672">=</span>uid_int)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;User not found. Please sign in again.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            g<span style="color:#f92672">.</span>current_user <span style="color:#f92672">=</span> user
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> view_func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> wrapped
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>        uid <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;X-User&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> uid <span style="color:#f92672">or</span> uid <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;anonymous&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/register&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>            username <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            confirm_password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;confirm_password&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> username <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Username and password are required.&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;register.html&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> password <span style="color:#f92672">!=</span> confirm_password:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Passwords do not match.&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;register.html&#39;</span>)
</span></span><span style="display:flex;"><span>            salt <span style="color:#f92672">=</span> generate_salt()
</span></span><span style="display:flex;"><span>            password_hash <span style="color:#f92672">=</span> hash_password(password, salt)
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>                username<span style="color:#f92672">=</span>username,
</span></span><span style="display:flex;"><span>                password_hash<span style="color:#f92672">=</span>password_hash,
</span></span><span style="display:flex;"><span>                salt<span style="color:#f92672">=</span>base64<span style="color:#f92672">.</span>b64encode(salt)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(user)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> IntegrityError:
</span></span><span style="display:flex;"><span>                db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Username already exists. Please choose another.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;register.html&#39;</span>)
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;Registration successful. Please sign in.&#39;</span>, <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;register.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>            username <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(username<span style="color:#f92672">=</span>username)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> verify_password(password, user<span style="color:#f92672">.</span>salt, user<span style="color:#f92672">.</span>password_hash):
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Invalid username or password.&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
</span></span><span style="display:flex;"><span>            r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SIGN_SERVER&#39;</span>], params<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;uid&#39;</span>: user<span style="color:#f92672">.</span>id}, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Unable to reach the authentication server. Please try again later.&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            token <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> make_response(redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>)))
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>set_cookie(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;token&#39;</span>,
</span></span><span style="display:flex;"><span>                token,
</span></span><span style="display:flex;"><span>                httponly<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                secure<span style="color:#f92672">=</span>app<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;SESSION_COOKIE_SECURE&#39;</span>, <span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>                samesite<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Lax&#39;</span>,
</span></span><span style="display:flex;"><span>                max_age<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3600</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/logout&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>():
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> make_response(redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>)))
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span>delete_cookie(<span style="color:#e6db74">&#39;token&#39;</span>)
</span></span><span style="display:flex;"><span>        flash(<span style="color:#e6db74">&#39;Signed out.&#39;</span>, <span style="color:#e6db74">&#39;info&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/dashboard&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dashboard</span>():
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>current_user
</span></span><span style="display:flex;"><span>        entries <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;id&#39;</span>: entry<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;label&#39;</span>: entry<span style="color:#f92672">.</span>label,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;login&#39;</span>: entry<span style="color:#f92672">.</span>login,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;password&#39;</span>: fernet<span style="color:#f92672">.</span>decrypt(entry<span style="color:#f92672">.</span>password_encrypted<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;notes&#39;</span>: entry<span style="color:#f92672">.</span>notes,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;created_at&#39;</span>: entry<span style="color:#f92672">.</span>created_at,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> entry <span style="color:#f92672">in</span> user<span style="color:#f92672">.</span>vault_entries
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;dashboard.html&#39;</span>, username<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>username, entries<span style="color:#f92672">=</span>entries)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/passwords/new&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_password</span>():
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>current_user
</span></span><span style="display:flex;"><span>        label <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;label&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        login_value <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;login&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        password_plain <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        notes <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;notes&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>strip() <span style="color:#f92672">or</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> label <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> login_value <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password_plain:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;Service name, login, and password are required.&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span><span style="display:flex;"><span>        encrypted_password <span style="color:#f92672">=</span> fernet<span style="color:#f92672">.</span>encrypt(password_plain<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>        entry <span style="color:#f92672">=</span> VaultEntry(
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>            label<span style="color:#f92672">=</span>label,
</span></span><span style="display:flex;"><span>            login<span style="color:#f92672">=</span>login_value,
</span></span><span style="display:flex;"><span>            password_encrypted<span style="color:#f92672">=</span>encrypted_password,
</span></span><span style="display:flex;"><span>            notes<span style="color:#f92672">=</span>notes,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(entry)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        flash(<span style="color:#e6db74">&#39;Password entry saved.&#39;</span>, <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/passwords/&lt;int:entry_id&gt;&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;DELETE&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_password</span>(entry_id: int):
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> g<span style="color:#f92672">.</span>current_user
</span></span><span style="display:flex;"><span>        entry <span style="color:#f92672">=</span> VaultEntry<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(id<span style="color:#f92672">=</span>entry_id, user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> entry:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#39;success&#39;</span>: <span style="color:#66d9ef">False</span>, <span style="color:#e6db74">&#39;message&#39;</span>: <span style="color:#e6db74">&#39;Entry not found&#39;</span>}), <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>delete(entry)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#39;success&#39;</span>: <span style="color:#66d9ef">True</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    flask_app <span style="color:#f92672">=</span> create_app()
</span></span><span style="display:flex;"><span>    flask_app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>, debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>获取flag就要伪造admin身份登录，直接获取密码行不通 entrypoint.sh：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>start_vault<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    cd /app/vault <span style="color:#f92672">&amp;&amp;</span> FERNET_KEY<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>python -c <span style="color:#e6db74">&#34;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&#34;</span><span style="color:#66d9ef">)</span> su vault -s /bin/sh -c <span style="color:#e6db74">&#34;python3 app.py&#34;</span> &amp;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>注意到鉴权是通过 X-User 进行的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_required</span>(view_func):
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@wraps</span>(view_func)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapped</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>            uid <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;X-User&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>            print(uid)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> uid <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;anonymous&#39;</span>:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Please sign in first.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                uid_int <span style="color:#f92672">=</span> int(uid)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">TypeError</span>, <span style="color:#a6e22e">ValueError</span>):
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;Invalid session. Please sign in again.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(id<span style="color:#f92672">=</span>uid_int)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user:
</span></span><span style="display:flex;"><span>                flash(<span style="color:#e6db74">&#39;User not found. Please sign in again.&#39;</span>, <span style="color:#e6db74">&#39;warning&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            g<span style="color:#f92672">.</span>current_user <span style="color:#f92672">=</span> user
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> view_func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> wrapped
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>        uid <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;X-User&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> uid <span style="color:#f92672">or</span> uid <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;anonymous&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span></code></pre></div><p>因此只需要设置 X-User 为0或者能够不带 X-User 访问路由<code>/</code>就能伪造admin用户登录</p>
<p>根据 main.go 中的 GetUIDFromRequest， uid 是通过 jwt 获取的，而 jwt 签名的 SecretKey 又是随机生成的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SecretKey</span> = <span style="color:#a6e22e">hex</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">RandomBytes</span>(<span style="color:#ae81ff">32</span>))
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>无法直接伪造 jwt，直接设置 X-User 为0也不行，在 main.go 的反向代理中会重新设置用户信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">authorizer</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">httputil</span>.<span style="color:#a6e22e">ReverseProxy</span>{<span style="color:#a6e22e">Director</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Scheme</span> = <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Host</span> = <span style="color:#e6db74">&#34;127.0.0.1:5000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">uid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUIDFromRequest</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Request UID: %s, URL: %s&#34;</span>, <span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;X-User&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;X-Forwarded-For&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#e6db74">&#34;Cookie&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;X-User&#34;</span>, <span style="color:#e6db74">&#34;anonymous&#34;</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;X-User&#34;</span>, <span style="color:#a6e22e">uid</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}}
</span></span></code></pre></div><p>唯一能打通的可能就是不带 X-User 访问，reverseproxy.go：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReverseProxy</span>) <span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">rw</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Director</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Director</span>(<span style="color:#a6e22e">outreq</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">outreq</span>.<span style="color:#a6e22e">Form</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">outreq</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">RawQuery</span> = <span style="color:#a6e22e">cleanQueryParams</span>(<span style="color:#a6e22e">outreq</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">RawQuery</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">outreq</span>.<span style="color:#a6e22e">Close</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">reqUpType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">upgradeType</span>(<span style="color:#a6e22e">outreq</span>.<span style="color:#a6e22e">Header</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ascii</span>.<span style="color:#a6e22e">IsPrint</span>(<span style="color:#a6e22e">reqUpType</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">getErrorHandler</span>()(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;client tried to switch to invalid protocol %q&#34;</span>, <span style="color:#a6e22e">reqUpType</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">removeHopByHopHeaders</span>(<span style="color:#a6e22e">outreq</span>.<span style="color:#a6e22e">Header</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// removeHopByHopHeaders removes hop-by-hop headers.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">removeHopByHopHeaders</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Header</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// RFC 7230, section 6.1: Remove headers listed in the &#34;Connection&#34; header.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">h</span>[<span style="color:#e6db74">&#34;Connection&#34;</span>] {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">sf</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">SplitSeq</span>(<span style="color:#a6e22e">f</span>, <span style="color:#e6db74">&#34;,&#34;</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sf</span> = <span style="color:#a6e22e">textproto</span>.<span style="color:#a6e22e">TrimString</span>(<span style="color:#a6e22e">sf</span>); <span style="color:#a6e22e">sf</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#a6e22e">sf</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// RFC 2616, section 13.5.1: Remove a set of known hop-by-hop headers.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// This behavior is superseded by the RFC 7230 Connection header, but</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// preserve it for backwards compatibility.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">hopHeaders</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>根据 ReverseProxy 的这份源码 <code>ServeHTTP-&gt;Director-&gt;removeHopByHopHeaders</code>，只需要将想要删除的 header 放入 Connection 中即可：</p>
<p><img alt="alt" loading="lazy" src="/images/QWB2025/1.png"></p>
<p>再跟随重定向到 <code>/dashboard</code>：</p>
<p><img alt="alt" loading="lazy" src="/images/QWB2025/2.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">w8nn9z Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
